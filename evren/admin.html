<!DOCTYPE html>
<html lang="tr" x-data="adminApp()" x-init="init()">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🎛️ Admin Panel · Film Evreni Ağı — v2</title>

  <!-- Alpine & Tailwind -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- JSZip (future: zip import/export) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>

  <style>
    :root { color-scheme: dark; }
    body { background: #0b1220; color: #e5e7eb; }
    .glass { background: rgba(31,41,55,0.5); border: 1px solid rgba(255,255,255,0.12); backdrop-filter: blur(12px); }
    textarea, input, select { background: rgba(55,65,81,0.5); border: 1px solid rgba(255,255,255,0.12); color: #e5e7eb; }
    textarea::placeholder, input::placeholder { color:#9ca3af }
    .kbd { padding:2px 6px; border:1px solid rgba(255,255,255,0.2); border-bottom-width:2px; border-radius:6px; font-size:12px; }
    /* Tabs */
    .tab-active::after {
      content:''; position:absolute; left:10px; right:10px; bottom:-1px; height:2px; background:#38bdf8; border-radius:2px;
    }
    /* Sticky table header + zebra */
    thead.sticky-head th { position: sticky; top: 0; background: rgba(2,6,23,0.9); backdrop-filter: blur(6px); z-index: 10; }
    tbody tr:nth-child(odd){ background: rgba(255,255,255,0.02); }
    tbody tr:hover{ background: rgba(59,130,246,0.08); }
    /* Nodes table tweaks */
    .nodes-table input,
    .nodes-table select,
    .nodes-table textarea {
      width: 100%;
      border-radius: 0.5rem;
      padding: 0.5rem 0.625rem;
      height: 2.75rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .nodes-table th, .nodes-table td { font-size: 0.8rem; vertical-align: middle; }
    .nodes-table tbody tr { border-top: 1px solid rgba(255,255,255,0.08); }
    .nodes-table tbody tr:hover { background: rgba(255,255,255,0.05); }
    /* Column widths */
    .nodes-table th:nth-child(1), .nodes-table td:nth-child(1){ min-width: 10px; }   /* checkbox */
    .nodes-table th:nth-child(2), .nodes-table td:nth-child(2){ min-width: 120px; }  /* ID */
    .nodes-table th:nth-child(3), .nodes-table td:nth-child(3){ min-width: 240px; }  /* Başlık */
    .nodes-table th:nth-child(4), .nodes-table td:nth-child(4){ min-width: 140px; }  /* Tarih */
    .nodes-table th:nth-child(5), .nodes-table td:nth-child(5){ min-width: 150px; }  /* Tür */
    .nodes-table th:nth-child(6), .nodes-table td:nth-child(6){ min-width: 100px; }  /* IMDb */
    .nodes-table th:nth-child(7), .nodes-table td:nth-child(7){ min-width: 100px; }  /* Tip */
    .nodes-table th:nth-child(8), .nodes-table td:nth-child(8){ min-width: 220px; }  /* Görsel */
    .nodes-table th:nth-child(9), .nodes-table td:nth-child(9){ min-width: 400px; }  /* Kaynaklar */
    .nodes-table th:nth-child(10), .nodes-table td:nth-child(10){ min-width: 120px; } /* İşlem */
    /* Small screens: soften table overflow */
    @media (max-width: 640px){
      .nodes-table th:nth-child(5), .nodes-table td:nth-child(5){ display:none; } /* hide Tür */
      .nodes-table th:nth-child(8), .nodes-table td:nth-child(8){ display:none; } /* hide Görsel */
    }
  
  /* Dashboard charts: keep cards compact and equal height */
  .chart-box{ height:260px; }
  @media (min-width:1280px){ .chart-box{ height:240px; } }
  .chart-box > canvas{ width:100% !important; height:100% !important; }
</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
<script>
// --- Cookie-based Auth Guard + Idle Logout + Fetch 401 handling ---
(function(){
  const CFG = {
    LOGIN_URL: '/evren/login.html',
    COOKIE_NAME: 'admin_token',
    IDLE_MS: 30 * 60 * 1000 // 30 minutes
  };
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  function delCookie(name){
    document.cookie = name + '=; Max-Age=0; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;';
  }
  function redirect(reason){
    if (location.pathname.includes('login')) return; // avoid loop
    const next = encodeURIComponent(location.href);
    location.href = CFG.LOGIN_URL + (CFG.LOGIN_URL.includes('?') ? '&' : '?') + 'reason=' + encodeURIComponent(reason||'unauthorized') + '&next=' + next;
  }

  // Guard on load
  document.addEventListener('DOMContentLoaded', () => {
    const has = !!getCookie(CFG.COOKIE_NAME);
    if (!has) redirect('no-cookie');
  }, { once:true });

  // Intercept fetch to ensure cookies & catch 401/403
  (function(){
    const _fetch = window.fetch;
    window.fetch = async function(input, init){
      init = init || {};
      if (!('credentials' in (init||{}))) init.credentials = 'include';
      const res = await _fetch(input, init);
      if (res && (res.status === 401 || res.status === 403)){
        try { delCookie(CFG.COOKIE_NAME); } catch {}
        redirect('expired');
      }
      return res;
    };
  })();

  // Idle logout
  (function(){
    let t = null;
    const reset = () => {
      if (t) clearTimeout(t);
      t = setTimeout(() => { try { delCookie(CFG.COOKIE_NAME); } catch{} redirect('idle-timeout'); }, CFG.IDLE_MS);
    };
    ['mousemove','mousedown','keydown','touchstart','scroll','visibilitychange'].forEach(ev => window.addEventListener(ev, reset, { passive:true }));
    reset();
  })();

  // Expose a safe logout for the button
  window.__adminLogout = function(){
    try { delCookie(CFG.COOKIE_NAME); } catch {}
    redirect('manual-logout');
  };
})();
</script>
</head>

<noscript><div style="padding:8px;margin:8px;border:1px solid #fca5a5;color:#fecaca;background:#7f1d1d">Bu panel JavaScript olmadan çalışmaz.</div></noscript>
<body class="min-h-screen selection:bg-sky-600/30">
  <!-- Header -->
  <header class="sticky top-0 z-50 glass">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/evren" class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white">⟵ Siteye Dön</a>
      <div class="flex items-center gap-2">
        <h1 class="text-lg font-bold">🎛️ Admin Panel</h1>
        <span x-show="_dirty" class="text-xs px-2 py-0.5 rounded-full border border-amber-400/40 text-amber-300 bg-amber-500/10">Kaydedilmemiş</span>
      </div>
      <div class="ml-auto flex flex-wrap items-center gap-2 text-sm">
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-sky-600 hover:bg-sky-700 border-sky-500/40 text-white shadow" @click="newDraft()">Yeni Taslak</button>
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="importAll()">İçe Aktar</button>
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-emerald-600 hover:bg-emerald-700 border-emerald-500/40 text-white" @click="exportAll()">Dışa Aktar</button>
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="validateAll()">Doğrula</button>
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="zipAll()">Tümünü Zip</button>
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-amber-600 hover:bg-amber-700 border-amber-500/40 text-white" @click="openLinkTester()">Linkleri Test Et</button>
      
        <button id="logoutBtn" class="px-3 py-1.5 rounded-lg font-medium transition border bg-rose-600 hover:bg-rose-700 border-rose-500/40 text-white" onclick="window.__adminLogout?.()">Çıkış</button>
</div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-12 gap-4">
    <!-- Sidebar -->
    <aside class="col-span-12 lg:col-span-3 space-y-4">
      <div class="glass rounded-xl p-4">
        <h2 class="font-semibold mb-3">Evrenler</h2>
        <div class="flex gap-2 mb-3">
          <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="addUniverse()">+ Ekle</button>
          <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="removeUniverse()">– Sil</button>
        </div>
        <select x-model="currentUniverse" class="w-full rounded px-2 py-2">
          <template x-for="u in universes" :key="u">
            <option :value="u" x-text="formatUniverse(u)"></option>
          </template>
        </select>
      </div>

      <div class="glass rounded-xl p-4 space-y-3">
        <h2 class="font-semibold">Arama / Filtre</h2>
        <input x-model.trim.debounce.250ms="q" class="w-full rounded px-3 py-2" placeholder="Yapım ara..." />
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>
            <label class="block mb-1 opacity-80">Yıl (min)</label>
            <input type="number" x-model.number="filters.yearMin" class="w-full rounded px-2 py-1.5" />
          </div>
          <div>
            <label class="block mb-1 opacity-80">Yıl (max)</label>
            <input type="number" x-model.number="filters.yearMax" class="w-full rounded px-2 py-1.5" />
          </div>
        </div>
        <div>
          <label class="block mb-1 opacity-80">IMDb (min)</label>
          <input type="number" step="0.1" x-model.number="filters.imdbMin" class="w-full rounded px-2 py-1.5" />
        </div>
        <div class="flex gap-2 items-center">
          <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="resetFilters()">Sıfırla</button>
          <div class="text-xs opacity-70">Aktif: <span x-text="activeFilterCount"></span></div>
        </div>
      </div>

      <div class="glass rounded-xl p-4">
        <h2 class="font-semibold mb-2">Yardım</h2>
        <ul class="text-sm list-disc list-inside space-y-1 opacity-80">
          <li><span class="kbd">Ctrl</span> + <span class="kbd">S</span> taslağı kaydeder.</li>
          <li>JSON düzenleyicilerinde <em>geçerli</em> JSON zorunludur.</li>
          <li>İçe Aktar → zip veya tek JSON kabul eder.</li>
        </ul>
      </div>
    </aside>

    <!-- Content -->
    <section class="col-span-12 lg:col-span-9 space-y-4">
      <!-- Universe Stats -->
      <div class="glass rounded-xl p-4 grid sm:grid-cols-3 gap-3 text-sm">
        <div>🎬 Yapım: <b x-text="stats.nodes"></b></div>
        <div>🔗 Bağlantı: <b x-text="stats.edges"></b></div>
        <div>🗂️ Kaynaklı Yapım: <b x-text="stats.withSources"></b></div>
      </div>

      <!-- Tabs -->
      
<div class="flex gap-2 border-b border-white/10">
  <button
    :class="tab==='nodes' 
      ? 'px-3 py-2 -mb-px rounded-t-lg border bg-white/10 border-white/20 relative after:content-[\'\'] after:absolute after:left-[10px] after:right-[10px] after:bottom-[-1px] after:h-[2px] after:bg-sky-400 after:rounded' 
      : 'px-3 py-2 -mb-px rounded-t-lg border border-transparent hover:bg-white/5'"
    @click="tab='nodes'">
    Yapımlar
  </button>
  <button
    :class="tab==='edges' 
      ? 'px-3 py-2 -mb-px rounded-t-lg border bg-white/10 border-white/20 relative after:content-[\'\'] after:absolute after:left-[10px] after:right-[10px] after:bottom-[-1px] after:h-[2px] after:bg-sky-400 after:rounded' 
      : 'px-3 py-2 -mb-px rounded-t-lg border border-transparent hover:bg-white/5'"
    @click="tab='edges'">
    Bağlantılar
  </button>
  <button
    :class="tab==='preview' 
      ? 'px-3 py-2 -mb-px rounded-t-lg border bg-white/10 border-white/20 relative after:content-[\'\'] after:absolute after:left-[10px] after:right-[10px] after:bottom-[-1px] after:h-[2px] after:bg-sky-400 after:rounded' 
      : 'px-3 py-2 -mb-px rounded-t-lg border border-transparent hover:bg-white/5'"
    @click="tab='preview'">
    Ön İzleme
  </button>

  <button
    :class="tab==='stats' 
      ? 'px-3 py-2 -mb-px rounded-t-lg border bg-white/10 border-white/20 relative after:content-[\'\'] after:absolute after:left-[10px] after:right-[10px] after:bottom-[-1px] after:h-[2px] after:bg-sky-400 after:rounded' 
      : 'px-3 py-2 -mb-px rounded-t-lg border border-transparent hover:bg-white/5'"
    @click="tab='stats'">
    İstatistikler
  </button>

</div>


      <!-- Nodes Table -->
      <div x-show="tab==='nodes'" class="glass rounded-xl p-4">
        <div class="flex gap-2 mb-3 flex-wrap">
          <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-sky-600 hover:bg-sky-700 border-sky-500/40 text-white shadow" @click="addNode()">+ Yapım</button>
          <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-rose-600 hover:bg-rose-700 border-rose-500/40 text-white" @click="deleteSelectedNodes()" :disabled="!selectedNodeIds.size">Sil (<span x-text="selectedNodeIds.size"></span>)</button>
          <div class="ml-auto flex gap-2">
            <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="bulkFillSources()">Seçilene Kaynak Şablonu</button>
            <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-emerald-600 hover:bg-emerald-700 border-emerald-500/40 text-white" @click="saveDraft()">Taslağı Kaydet</button>
          </div>
        </div>

        <div class="max-h-[70vh] overflow-y-auto overflow-x-auto">
          <table class="w-full text-sm nodes-table">
            <thead class="text-left opacity-80 sticky-head">
              <tr>
                <th class="py-2 pr-2"><input type="checkbox" @change="toggleSelectAll($event, 'nodes')"/></th>
                <th class="py-2 pr-2">ID</th>
                <th class="py-2 pr-2">Başlık</th>
                <th class="py-2 pr-2">Tarih</th>
                <th class="py-2 pr-2">Tür</th>
                <th class="py-2 pr-2">IMDb</th>
                <th class="py-2 pr-2">Tip</th>
                <th class="py-2 pr-2">Görsel</th>
                <th class="py-2 pr-2">Kaynaklar (JSON)</th>
                <th class="py-2 pr-2">İşlem</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(n, idx) in filteredNodes" :key="n.id">
                <tr class="border-t border-white/10">
                  <td class="py-2 pr-2"><input type="checkbox" :checked="selectedNodeIds.has(n.id)" @change="toggleSelect(n.id)"/></td>
                  <td class="py-2 pr-2 w-24"><textarea x-model="n.id" @change="touch()" /></textarea></td>
                  <td class="py-2 pr-2 min-w-52"><textarea x-model="n.label" @change="touch()" /></textarea></td>
                  <td class="py-2 pr-2 w-36"><input type="date" x-model="n.release_date" @change="touch()" /></td>
                  <td class="py-2 pr-2 w-56"><textarea x-model="n.tür" placeholder="Aksiyon, Bilim Kurgu" @change="touch()" /></textarea></td>
                  <td class="py-2 pr-2 w-24"><input type="number" step="0.1" x-model.number="n.imdb_rating" @change="touch()" /></td>
                  <td class="py-2 pr-2 w-28">
                    <select x-model="n.type" @change="touch()">
                      <option value="movie">Film</option>
                      <option value="series">Dizi</option>
                    </select>
                  </td>
                  <td class="py-2 pr-2 w-52"><textarea x-model="n.image" placeholder="Poster URL" @change="touch()" /></textarea></td>
                  <td class="py-2 pr-2 w-[420px]">
                    <div class="flex gap-2 mb-1">
                      <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white text-xs" @click="formatJSON(n)">Biçimlendir</button>
                      <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-emerald-600 hover:bg-emerald-700 border-emerald-500/40 text-white text-xs" @click="openSourceEditor(n)">Güncelle</button>
                    </div>
                    <textarea class="h-28" x-model="n.sourcesText" @change="touch()" placeholder='{"Kaynaklar":[{"name":"...","url":"..."}],"Görsel":[...],"Platform":[...]}'></textarea>
                    <div class="text-xs mt-1">
                      <span :class="isValidJSON(n.sourcesText) ? 'text-emerald-400' : 'text-rose-400'" x-text="isValidJSON(n.sourcesText) ? '✔ Geçerli JSON' : '✖ Geçersiz JSON'"></span>
                    </div>
                  </td>
                  <td class="py-2 pr-2 w-36">
                    <div class="flex flex-col gap-1">
                      <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white text-xs" @click="previewNode(n)">Ön İzleme</button>
                      <div class="relative" x-data="{open:false}">
                        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white text-xs w-full" @click="open=!open">⋯ Aksiyonlar</button>
                        <div x-show="open" @click.outside="open=false" class="absolute right-0 mt-1 w-44 glass rounded-lg p-2 space-y-1 border border-white/10">
                          <button class="w-full text-left px-2 py-1 rounded hover:bg-white/10" @click="duplicateNode(n); open=false">Kopyala</button>
                          <button class="w-full text-left px-2 py-1 rounded hover:bg-white/10" @click="clearSources(n); open=false">Kaynakları Temizle</button>
                          <button class="w-full text-left px-2 py-1 rounded hover:bg-white/10 text-rose-300" @click="removeNode(idx); open=false">Sil</button>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Edges Table -->
      <div x-show="tab==='edges'" class="glass rounded-xl p-4">
        <div class="flex gap-2 mb-3">
          <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-sky-600 hover:bg-sky-700 border-sky-500/40 text-white shadow" @click="addEdge()">+ Bağlantı</button>
          <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-rose-600 hover:bg-rose-700 border-rose-500/40 text-white" @click="deleteSelectedEdges()" :disabled="!selectedEdgeIdx.size">Sil (<span x-text="selectedEdgeIdx.size"></span>)</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="text-left opacity-80 sticky-head">
              <tr>
                <th class="py-2 pr-2"><input type="checkbox" @change="toggleSelectAll($event, 'edges')"/></th>
                <th class="py-2 pr-2">From</th>
                <th class="py-2 pr-2">To</th>
                <th class="py-2 pr-2">Tür</th>
                <th class="py-2 pr-2">Not</th>
                <th class="py-2 pr-2">İşlem</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(e, i) in current.edges" :key="i">
                <tr class="border-t border-white/10 align-top">
                  <td class="py-2 pr-2"><input type="checkbox" :checked="selectedEdgeIdx.has(i)" @change="toggleSelectEdge(i)"/></td>
                  <td class="py-2 pr-2 w-44">
                    <select x-model="e.from" @change="touch()">
                      <template x-for="n in current.nodes" :key="n.id">
                        <option :value="n.id" x-text="n.label"></option>
                      </template>
                    </select>
                  </td>
                  <td class="py-2 pr-2 w-44">
                    <select x-model="e.to" @change="touch()">
                      <template x-for="n in current.nodes" :key="n.id">
                        <option :value="n.id" x-text="n.label"></option>
                      </template>
                    </select>
                  </td>
                  <td class="py-2 pr-2 w-56">
                    <input x-model="e.type" list="edgeTypes" placeholder="Devam, Crossover, ..." @change="touch()"/>
                  </td>
                  <td class="py-2 pr-2 w-[420px]"><textarea class="w-full rounded px-2 py-1 h-20" x-model="e.notes" @change="touch()"></textarea></td>
                  <td class="py-2 pr-2 w-28">
                    <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-rose-600 hover:bg-rose-700 border-rose-500/40 text-white text-xs w-full" @click="removeEdge(i)">Sil</button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <datalist id="edgeTypes">
          <option value="Devam"></option>
          <option value="Doğrudan Devam"></option>
          <option value="Crossover"></option>
          <option value="Ana Hikaye Bağlantısı"></option>
          <option value="Ana Tehdit"></option>
          <option value="Sonsuzluk Taşı"></option>
          <option value="Çoklu Evren"></option>
        </datalist>
      </div>

      <!-- Preview -->
      <div x-show="tab==='preview'" class="glass rounded-xl p-4">
        <h3 class="font-semibold mb-3">Seçili Yapım Önizleme</h3>
        <template x-if="preview">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="sm:col-span-1 space-y-2">
              <img :src="preview.image" class="w-full rounded-xl border border-white/10 object-cover aspect-[2/3]" />
              <div class="text-xs opacity-80">Poster URL: <span class="break-all" x-text="preview.image"></span></div>
              <div class="flex items-center gap-2 text-xs">
                <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white text-xs" @click="checkPoster()">Posteri Kontrol Et</button>
                <span>Durum:</span>
                <span :class="previewPoster.ok===true ? 'text-emerald-400' : (previewPoster.ok===false ? 'text-rose-400' : 'text-amber-300')" x-text="previewPoster.running ? 'Kontrol ediliyor…' : (previewPoster.text || '-')"></span>
              </div>
            </div>
            <div class="sm:col-span-2 space-y-2 text-sm">
              <div class="text-2xl font-bold" x-text="preview.label"></div>
              <div>
                <b>Vizyon:</b> <span x-text="preview.release_date"></span>
                <span class="px-2">•</span>
                <b>IMDb:</b> <span x-text="preview.imdb_rating"></span>
              </div>
              <div><b>Tür:</b> <span x-text="preview.tür"></span></div>
              <div><b>Tip:</b> <span x-text="preview.type"></span></div>
              <div>
                <b>Kaynaklar:</b>
                <div class="mt-2 grid sm:grid-cols-2 gap-3">
                  <template x-for="(arr, k) in normalizeSources(preview.sources)" :key="k">
                    <div class="border border-white/10 rounded-lg p-2">
                      <div class="text-xs font-semibold mb-1 flex items-center gap-1">
                        <span x-text="k"></span>
                        <span class="opacity-60">(<span x-text="arr.length"></span>)</span>
                      </div>
                      <ul class="space-y-1">
                        <template x-for="src in arr" :key="src.url || src.name">
                          <li class="flex items-center gap-2 text-xs">
                            <img :src="favicon(src.url)" class="w-4 h-4 rounded" alt=""/>
                            <a href="#" @click.prevent="window.open(src.url, '_blank','noopener')" class="hover:underline" x-text="src.name || src.url"></a>
                          </li>
                        </template>
                      </ul>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>
        </template>
        <template x-if="!preview">
          <div class="text-sm opacity-70">Tablodan bir yapımı "Ön İzleme" ile aç.</div>
        </template>
      </div>
    
      <!-- Stats / Analytics -->
      <div x-show="tab==='stats'" class="glass rounded-xl p-4 space-y-4">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-lg">İstatistikler</h3>
          <span class="text-xs opacity-70">(Veri + Ziyaretçi)</span>
          <div class="ml-auto flex items-center gap-2 text-sm">
            <select id="analyticsRange" class="rounded px-2 py-1.5">
              <option value="7d">7g</option>
              <option value="30d" selected>30g</option>
              <option value="90d">90g</option>
            </select>
            <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white"
              @click="window.__evrenStats?.renderAll($root)">Yenile</button>
            <button id="exportCsvBtn" class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white">CSV</button>
            <button id="exportJsonBtn" class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white">JSON</button>
            <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-amber-600 hover:bg-amber-700 border-amber-500/40 text-white"
              @click="document.getElementById('trackingModal').showModal()">Takip Kodu</button>
          </div>
        </div>

        <!-- Top KPIs -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 text-sm">
          <div class="glass rounded-xl p-3 border border-white/10">
            <div class="opacity-70">Yapım</div>
            <div class="text-2xl font-bold" x-text="stats.nodes"></div>
          </div>
          <div class="glass rounded-xl p-3 border border-white/10">
            <div class="opacity-70">Bağlantı</div>
            <div class="text-2xl font-bold" x-text="stats.edges"></div>
          </div>
          <div class="glass rounded-xl p-3 border border-white/10">
            <div class="opacity-70">Kaynaklı Yapım</div>
            <div class="text-2xl font-bold" x-text="stats.withSources"></div>
          </div>
          <div class="glass rounded-xl p-3 border border-white/10">
            <div class="opacity-70">IMDb Ort.</div>
            <div class="text-2xl font-bold" x-text="window.__evrenStats?.avgImdb($root) ?? '-'"></div>
          </div>
        </div>

        <!-- Charts: Modern Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 auto-rows-fr">
  <div class="glass rounded-xl p-3 border border-white/10">
    <div class="font-semibold mb-2 text-sm">Film / Dizi</div>
    <div class="chart-box"><canvas id="chartTypeDonut"></canvas></div>
  </div>
  <div class="glass rounded-xl p-3 border border-white/10">
    <div class="font-semibold mb-2 text-sm">Yıllara Göre Yapım</div>
    <div class="chart-box"><canvas id="chartByYearArea"></canvas></div>
  </div>
  <div class="glass rounded-xl p-3 border border-white/10">
    <div class="font-semibold mb-2 text-sm">IMDb Dağılımı</div>
    <div class="chart-box"><canvas id="chartImdbBars"></canvas></div>
  </div>
  <div class="glass rounded-xl p-3 border border-white/10">
    <div class="font-semibold mb-2 text-sm">Ziyaret (Günlük)</div>
    <div class="chart-box"><canvas id="chartVisitsLine"></canvas></div>
  </div>
  <div class="glass rounded-xl p-3 border border-white/10">
    <div class="font-semibold mb-2 text-sm">Cihazlar</div>
    <div class="chart-box"><canvas id="chartDevicesDonut"></canvas></div>
  </div>
  <div class="glass rounded-xl p-3 border border-white/10">
    <div class="font-semibold mb-2 text-sm">En Çok Görüntülenen Sayfalar</div>
    <div class="chart-box"><canvas id="chartTopPagesBarH"></canvas></div>
  </div>

</div>
<div class="text-xs opacity-70">
          Ziyaretçi verileri <code>(__ANALYTICS_BASE||'') + '/api/analytics/summary?range=7d|30d|90d'</code> uç noktasından çekilir. 
          Eğer ulaşılamazsa demo verisi kullanılır.
        </div>
      </div></div>

      <!-- Tracking Code Modal -->
      <dialog id="trackingModal" class="rounded-xl w-[92vw] max-w-2xl p-0">
        <form method="dialog" class="glass border border-white/20 rounded-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">Takip Kodu</div>
            <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white text-xs">Kapat</button>
          </div>
          <div class="text-sm opacity-80 mb-2">Bunu kamuya açık sayfalara ekleyin (</> body kapanışından önce):</div>
          <pre class="text-xs bg-black/40 p-3 rounded border border-white/10 overflow-x-auto"><code>&lt;script&gt;
!function(){
  const payload = {
    ts: Date.now(),
    path: location.pathname + location.search,
    ref: document.referrer || 'direct',
    ua: navigator.userAgent || '',
    lang: navigator.language || '',
    w: screen.width, h: screen.height
  };
  fetch('/api/analytics/collect', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload),
    keepalive: true
  }).catch(()=>{});
}();
&lt;/script&gt;</code></pre>
          <div class="text-xs opacity-70">Sunucu tarafında <code>POST /api/analytics/collect</code> isteğini veritabanına yazmanız gerekir. 
            Admin paneli <code>/api/analytics/summary</code> ile özet çeker.</div>
        </form>
      </dialog>

    </section>
  </main>

  <!-- Source Helper Modal -->

<!-- Source Editor Modal -->
<div x-show="sourceEdit.open" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60">
  <div class="glass rounded-xl p-4 w-[96vw] max-w-3xl border border-white/20">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-semibold">Kaynak Düzenleyici</h3>
      <div class="flex gap-2">
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-emerald-600 hover:bg-emerald-700 border-emerald-500/40 text-white text-xs" @click="saveSourceEditor()">Kaydet</button>
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white text-xs" @click="closeSourceEditor()">Kapat</button>
      </div>
    </div>
    <template x-if="sourceEdit.node">
      <div class="space-y-4 text-sm">
        <template x-for="cat in ['Kaynaklar','Görsel','Platform']" :key="cat">
          <div class="border border-white/10 rounded-lg p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold" x-text="cat"></div>
              <button class="px-2 py-1 rounded border border-white/20 hover:bg-white/10 text-xs" @click="addSourceRow(cat)">+ Satır</button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-12 gap-2">
              <div class="sm:col-span-5 text-xs opacity-70">Ad</div>
              <div class="sm:col-span-6 text-xs opacity-70">URL</div>
              <div class="sm:col-span-1"></div>
              <template x-for="(row, i) in sourceEdit.data[cat]" :key="cat + i">
                <div class="contents">
                  <div class="sm:col-span-5">
                    <input class="w-full rounded px-2 py-1.5" x-model="row.name" placeholder="IMDb / Disney+" />
                  </div>
                  <div class="sm:col-span-6">
                    <input class="w-full rounded px-2 py-1.5" x-model="row.url" placeholder="https://..." />
                  </div>
                  <div class="sm:col-span-1 flex justify-end">
                    <button class="px-2 py-1 rounded border border-rose-400/40 text-rose-300 hover:bg-rose-500/10 text-xs" @click="removeSourceRow(cat, i)">Sil</button>
                  </div>
                </div>
              </template>
              <template x-if="!sourceEdit.data[cat]?.length">
                <div class="sm:col-span-12 text-xs opacity-60">Bu kategoride kayıt yok.</div>
              </template>
            </div>
          </div>
        </template>
      </div>
    </template>
  </div>
</div>

  <div x-show="showSourceHelper" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
    <div class="glass rounded-xl p-4 w-[92vw] max-w-xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Kaynak Yardımcısı</h3>
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="showSourceHelper=false">Kapat</button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
        <div>
          <label class="block mb-1">Kategori</label>
          <select class="w-full rounded px-2 py-1.5" x-model="sourceHelper.category">
            <option>Kaynaklar</option>
            <option>Görsel</option>
            <option>Platform</option>
          </select>
        </div>
        <div class="sm:col-span-2">
          <label class="block mb-1">Ad</label>
          <input class="w-full rounded px-2 py-1.5" x-model="sourceHelper.name" placeholder="IMDb / Disney+ / Box Office Türkiye" />
        </div>
        <div class="sm:col-span-2">
          <label class="block mb-1">URL</label>
          <input class="w-full rounded px-2 py-1.5" x-model="sourceHelper.url" placeholder="https://..." />
          <div class="text-xs opacity-70 mt-1 flex items-center gap-2" x-show="sourceHelper.url">
            <img :src="favicon(sourceHelper.url)" class="w-4 h-4 rounded" alt=""/>
            <span x-text="hostName(sourceHelper.url)"></span>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-sky-600 hover:bg-sky-700 border-sky-500/40 text-white shadow" @click="addSourceEntry()">Ekle</button>
      </div>
    </div>
  </div>

  <!-- Link Test Modal -->
  <div x-show="linkTest.open" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
    <div class="glass rounded-xl p-4 w-[96vw] max-w-3xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Link Testi</h3>
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" @click="closeLinkTester()">Kapat</button>
      </div>
      <div class="text-sm mb-2">
        <div class="flex flex-wrap gap-2 items-center">
          <div>Toplam URL: <b x-text="linkTest.total"></b></div>
          <div>Tamamlanan: <b x-text="linkTest.checked"></b></div>
          <div x-show="linkTest.running" class="text-amber-300">Çalışıyor…</div>
        </div>
      </div>
      <div class="max-h-[60vh] overflow-y-auto">
        <table class="w-full text-xs">
          <thead class="text-left opacity-80 sticky-head">
            <tr>
              <th class="py-2 pr-2">Yapım</th>
              <th class="py-2 pr-2">Kategori</th>
              <th class="py-2 pr-2">Ad</th>
              <th class="py-2 pr-2">URL</th>
              <th class="py-2 pr-2">Durum</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in linkTest.results" :key="row.nodeId + row.url">
              <tr class="border-t border-white/10">
                <td class="py-1 pr-2" x-text="row.label"></td>
                <td class="py-1 pr-2" x-text="row.category"></td>
                <td class="py-1 pr-2" x-text="row.name"></td>
                <td class="py-1 pr-2 break-all">
                  <a href="#" @click.prevent="window.open(row.url, '_blank','noopener')" class="hover:underline" x-text="row.url"></a>
                </td>
                <td class="py-1 pr-2">
                  <span :class="row.ok === true ? 'text-emerald-400' : (row.ok === false ? 'text-rose-400' : 'text-amber-300')" x-text="row.statusText || '-'"></span>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <div class="flex justify-end gap-2 mt-3 text-sm">
        <button class="px-3 py-1.5 rounded-lg font-medium transition border bg-white/5 hover:bg-white/10 border-white/20 text-white" :disabled="linkTest.running" @click="runLinkTests()">Seçilene Ait Linkleri Test Et</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="fileInput" class="hidden" multiple />

  <!-- Toasts -->
  <div class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] space-y-2 w-[92vw] max-w-md">
    <template x-for="t in toasts" :key="t.id">
      <div class="glass rounded-lg px-3 py-2 text-sm border"
           :class="t.type==='success' ? 'border-emerald-400/40 text-emerald-300' : (t.type==='error' ? 'border-rose-400/40 text-rose-300' : 'border-white/20 text-white')">
        <span x-text="t.message"></span>
      </div>
    </template>
  </div>

  <!-- Scripts -->
  <script>
    function adminApp(){
      return {
        // Toasts
        toasts: [],
        toast(msg, type='info', timeout=2200){
          const id = crypto.randomUUID();
          this.toasts.push({ id, message: msg, type });
          setTimeout(()=>{ this.toasts = this.toasts.filter(t => t.id !== id); }, timeout);
        },

        // Poster status for preview
        previewPoster: { running:false, ok:null, text:'' },

        // Link tester state
        linkTest: { open:false, running:false, results:[], total:0, checked:0 },

        // JSON Editor modal state
        jsonEditor: { open:false, node:null, editor:null, valid:true },

        _dirty: false,
        showSourceHelper: false,
        sourceHelper: { node: null, category: 'Kaynaklar', name: '', url: '' },
        sourceEdit: { open:false, node:null, data:{ Kaynaklar:[], Görsel:[], Platform:[] } },

        // state
        universes: ['avatar','dc','harrypotter','marvel','matrix','middleearth','pixar','starwars'],
        currentUniverse: 'marvel',
        dataMap: {}, // evren -> { nodes:[], edges:[] }
        tab: 'nodes',
        q: '',
        filters: { yearMin: null, yearMax: null, imdbMin: null },
        selectedNodeIds: new Set(),
        selectedEdgeIdx: new Set(),
        preview: null,

        get current(){ return this.dataMap[this.currentUniverse] || { nodes: [], edges: [] } },
        get universesLoaded(){ return this.universes.filter(u => !!this.dataMap[u]) },
        get stats(){
          const { nodes = [], edges = [] } = this.current;
          const withSources = nodes.filter(n => !!n.sources || !!n.sourcesText).length;
          return { nodes: nodes.length, edges: edges.length, withSources };
        },
        formatUniverse(u){ const m={avatar:'Avatar',dc:'DC',harrypotter:'Harry Potter',marvel:'Marvel',matrix:'Matrix',middleearth:'Orta Dünya',pixar:'Pixar',starwars:'Star Wars'}; return m[u]||u; },

        // lifecycle
        async init(){
          // klavye kaydet
          window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); this.saveDraft(); }
          });
          // Kısayollar
          window.addEventListener('keydown', (e) => {
            if (e.altKey && e.code === 'KeyT'){ e.preventDefault(); this.openLinkTester(); }
          });
          // LocalStorage taslaklarını yükle
          const stash = localStorage.getItem('adminDraft');
          if (stash) {
            try { this.dataMap = JSON.parse(stash); } catch {}
          }
          // Eğer boşsa fetch ile mevcut dosyaları çekmeyi dene
          if (!Object.keys(this.dataMap).length) {
            await this.loadAllFromDataFolder();
          }
        },

        async loadAllFromDataFolder(){
          for (const u of this.universes) {
            try {
              const r = await fetch(`data/${u}.json`, { cache: 'no-store' });
              if (r.ok){
                const j = await r.json();
                (j.nodes||[]).forEach(n => { n.sourcesText = n.sources ? JSON.stringify(n.sources, null, 2) : (n.sourcesText || ''); });
                this.$nextTick(() => { this.dataMap[u] = j; });
              }
            } catch (e) { console.warn('Yüklenemedi:', u, e); }
          }
        },

        // filters
        get activeFilterCount(){ let c=0; const f=this.filters; if (this.q) c++; if (f.yearMin!=null||f.yearMax!=null) c++; if (f.imdbMin!=null) c++; return c; },
        resetFilters(){ this.q=''; this.filters = { yearMin:null, yearMax:null, imdbMin:null }; },
        get filteredNodes(){
          const q = (this.q||'').toLocaleLowerCase('tr');
          const f = this.current.nodes || [];
          const yMin = this.filters.yearMin != null ? Number(this.filters.yearMin) : null;
          const yMax = this.filters.yearMax != null ? Number(this.filters.yearMax) : null;
          const imdbMin = this.filters.imdbMin != null ? Number(this.filters.imdbMin) : null;
          return f.filter(n => {
            if (q){ const lbl=(n.label||'').toLocaleLowerCase('tr'); if (!lbl.includes(q)) return false; }
            if (yMin!=null||yMax!=null){ const y = n.release_date ? new Date(n.release_date).getFullYear() : null; if (yMin!=null && (y==null||y<yMin)) return false; if (yMax!=null && (y==null||y>yMax)) return false; }
            if (imdbMin!=null){ const r = n.imdb_rating!=null?Number(n.imdb_rating):null; if (r==null||r<imdbMin) return false; }
            return true;
          });
        },

        // nodes ops
        addNode(){
          const id = crypto.randomUUID().slice(0,8);
          const n = { id, label: 'Yeni Yapım', release_date: '', tür: '', imdb_rating: null, type: 'movie', image: '', sourcesText: '' };
          this.current.nodes.unshift(n); this.touch();
        },
        removeNode(idx){ this.current.nodes.splice(idx,1); this.touch(); },
        duplicateNode(n){
          const copy = JSON.parse(JSON.stringify(n));
          copy.id = crypto.randomUUID().slice(0,8);
          this.current.nodes.unshift(copy);
          this.touch(); this.toast('Yapım kopyalandı','success');
        },
        clearSources(n){ n.sourcesText=''; delete n.sources; this.touch(); },
        toggleSelect(id){ this.selectedNodeIds.has(id) ? this.selectedNodeIds.delete(id) : this.selectedNodeIds.add(id); },
        toggleSelectAll(ev, what){
          if (what==='nodes'){
            this.selectedNodeIds.clear();
            if (ev.target.checked){ for (const n of this.filteredNodes) this.selectedNodeIds.add(n.id); }
          } else if (what==='edges'){
            this.selectedEdgeIdx.clear();
            if (ev.target.checked){ for (let i=0;i<(this.current.edges||[]).length;i++) this.selectedEdgeIdx.add(i); }
          }
        },
        deleteSelectedNodes(){ if (!this.selectedNodeIds.size) return; this.current.nodes = this.current.nodes.filter(n => !this.selectedNodeIds.has(n.id)); this.selectedNodeIds.clear(); this.touch(); },
        bulkFillSources(){
          const template = {
            "Kaynaklar": [ { "name": "IMDb", "url": "https://www.imdb.com/" } ],
            "Görsel": [],
            "Platform": []
          };
          this.current.nodes.forEach(n => { if (this.selectedNodeIds.has(n.id) && !n.sourcesText){ n.sourcesText = JSON.stringify(template, null, 2); } });
          this.touch();
        },
        previewNode(n){
          if (this.isValidJSON(n.sourcesText)) n.sources = JSON.parse(n.sourcesText);
          this.preview = JSON.parse(JSON.stringify(n));
          this.tab = 'preview';
          this.previewPoster = { running:false, ok:null, text:'' };
        },

        // edges ops
        addEdge(){ const firstId = this.current.nodes[0]?.id || ''; const e={ from: firstId, to: firstId, type: 'Devam', notes: '' }; (this.current.edges ||= []).unshift(e); this.touch(); },
        removeEdge(i){ this.current.edges.splice(i,1); this.touch(); },
        toggleSelectEdge(i){ this.selectedEdgeIdx.has(i) ? this.selectedEdgeIdx.delete(i) : this.selectedEdgeIdx.add(i); },
        deleteSelectedEdges(){ if (!this.selectedEdgeIdx.size) return; this.current.edges = this.current.edges.filter((_,i)=>!this.selectedEdgeIdx.has(i)); this.selectedEdgeIdx.clear(); this.touch(); },

        // universes ops
        addUniverse(){ const u = prompt('Yeni evren anahtarı (küçük harf, boşluksuz):'); if (!u) return; if (this.universes.includes(u)) return alert('Zaten var'); this.universes.push(u); this.dataMap[u] = { nodes: [], edges: [] }; this.currentUniverse = u; this.touch(); },
        removeUniverse(){ if (!confirm('Seçili evreni silmek istiyor musun?')) return; const u=this.currentUniverse; this.universes = this.universes.filter(x=>x!==u); delete this.dataMap[u]; this.currentUniverse = this.universes[0] || ''; this.touch(); },

        // import/export
        async importAll(){
          const input = document.getElementById('fileInput');
          input.accept = '.json,.zip,application/json,application/zip';
          input.onchange = async (e) => {
            const files = Array.from(e.target.files||[]);
            for (const f of files){
              if (f.name.endsWith('.json')){
                const txt = await f.text();
                try {
                  const j = JSON.parse(txt);
                  if (j.nodes && j.edges){
                    const name = f.name.replace(/\.json$/,'');
                    (j.nodes||[]).forEach(n => { n.sourcesText = n.sources ? JSON.stringify(n.sources, null, 2) : (n.sourcesText || ''); });
                    this.$nextTick(()=>{ this.dataMap[name] = j; if (!this.universes.includes(name)) this.universes.push(name); this.currentUniverse = name; });
                    this.toast('JSON içe aktarıldı','success');
                  } else {
                    this.toast(f.name + ' beklenen formatta değil (nodes/edges).', 'error');
                  }
                } catch(err){ this.toast('JSON okunamadı: '+ f.name, 'error'); }
              } else {
                this.toast('Şimdilik yalnızca .json destekleniyor.', 'error');
              }
            }
            input.value = '';
          };
          input.click();
        },
        exportAll(){
          const map = {};
          for (const u of this.universes){
            const j = JSON.parse(JSON.stringify(this.dataMap[u] || { nodes:[], edges:[] }));
            (j.nodes||[]).forEach(n => { if (n.sourcesText && this.isValidJSON(n.sourcesText)) n.sources = JSON.parse(n.sourcesText); delete n.sourcesText; });
            map[u] = j;
          }
          const one = JSON.stringify(map[this.currentUniverse], null, 2);
          downloadText(`${this.currentUniverse}.json`, one);
          this.toast('JSON dışa aktarıldı','success');
        },

        // validate
        validateAll(){
          const problems = [];
          for (const [u, j] of Object.entries(this.dataMap)){
            const nodeIds = new Set((j.nodes||[]).map(n => String(n.id)));
            for (const n of j.nodes||[]){
              if (!n.id || !n.label) problems.push(`[${u}] Node eksik alan: id/label -> ${JSON.stringify(n)}`);
              if (n.sourcesText && !this.isValidJSON(n.sourcesText)) problems.push(`[${u}] ${n.label} kaynak JSON geçersiz.`);
              if (n.sourcesText && this.isValidJSON(n.sourcesText)){
                const parsed = JSON.parse(n.sourcesText);
                const allowed = ['Kaynaklar','Görsel','Platform'];
                for (const k of Object.keys(parsed||{})){
                  if (!allowed.includes(this.mapCategory(k))) problems.push(`[${u}] ${n.label} kaynak kategorisi tanınmadı: ${k}`);
                }
              }
            }
            for (const [i,e] of (j.edges||[]).entries()){
              if (!nodeIds.has(String(e.from)) || !nodeIds.has(String(e.to))) problems.push(`[${u}] Edge ${i}: from/to id bulunamadı.`);
            }
          }
          if (!problems.length) { this.toast('Her şey yolunda ✔','success'); }
          else { alert('Bulunan sorunlar:\n- ' + problems.join('\n- ')); }
        },

        // JSON helpers
        openJSONEditor(node){
          this.jsonEditor.open = true;
          this.jsonEditor.node = node;
          this.$nextTick(async () => {
            const monaco = await loadMonaco();
            const container = document.getElementById('jsonEditorContainer');
            const value = node.sourcesText || '{\\n  "Kaynaklar": []\\n}';
            if (monaco){
              this.jsonEditor.editor = monaco.editor.create(container, {
                value,
                language: 'json',
                automaticLayout: true,
                minimap: { enabled: false },
                lineNumbers: 'on',
                fontSize: 14,
                theme: 'vs-dark'
              });
              this.jsonEditor.editor.onDidChangeModelContent(() => {
                const v = this.jsonEditor.editor.getValue();
                this.jsonEditor.valid = this.isValidJSON(v);
              });
              this.jsonEditor.valid = this.isValidJSON(value);
            } else {
              // Fallback: simple textarea
              container.innerHTML = '<textarea id="jsonFallback" style="width:100%;height:100%;background:rgba(55,65,81,.5);border:1px solid rgba(255,255,255,.12);color:#e5e7eb;padding:.75rem;border-radius:.5rem;"></textarea>';
              const ta = document.getElementById('jsonFallback');
              ta.value = value;
              ta.addEventListener('input', () => { this.jsonEditor.valid = this.isValidJSON(ta.value); });
              this.jsonEditor.editor = { getValue: ()=>ta.value, setValue: (v)=>{ta.value=v;} };
              this.jsonEditor.valid = this.isValidJSON(value);
            }
          });
        },
        closeJSONEditor(){
    // Monaco varsa kapat
    if (this.jsonEditor.editor && typeof this.jsonEditor.editor.dispose === 'function') {
        this.jsonEditor.editor.dispose();
    }
    // Container'ı temizle
    const container = document.getElementById('jsonEditorContainer');
    if (container) {
        container.innerHTML = '';
    }
    // State reset
    this.jsonEditor.editor = null;
    this.jsonEditor.node = null;
    this.jsonEditor.open = false;
},
        applyJSON(){
          if (!this.jsonEditor.editor) return;
          const v = this.jsonEditor.editor.getValue();
          if (!this.isValidJSON(v)) { this.toast('JSON geçersiz','error'); return; }
          this.jsonEditor.node.sourcesText = v;
          this.touch();
          this.toast('JSON uygulandı','success');
          this.closeJSONEditor();
        },
        formatJSON(node){
          if (!node.sourcesText) return;
          try { node.sourcesText = JSON.stringify(JSON.parse(node.sourcesText), null, 2); this.touch(); }
          catch { /* ignore */ }
        },

        // save
        touch(){ this._dirty = true; },
        saveDraft(){
          localStorage.setItem('adminDraft', JSON.stringify(this.dataMap));
          this._dirty = false;
          this.toast('Taslak kaydedildi','success');
        },
        newDraft(){ if (confirm('Tüm taslakları temizle?')) { localStorage.removeItem('adminDraft'); this.dataMap = {}; this.loadAllFromDataFolder(); this.toast('Yeni taslak oluşturuldu','success'); } },

        // helpers
        isValidJSON(s){ if (!s || typeof s !== 'string') return false; try { JSON.parse(s); return true; } catch { return false; } },
        mapCategory(key){ const k=(key||'').toLowerCase(); if (k.includes('görsel')||k.includes('gorsel')||k.includes('image')||k.includes('poster')) return 'Görsel'; if (k.includes('platform')||k.includes('watch')||k.includes('stream')) return 'Platform'; return 'Kaynaklar'; },
        normalizeItem(it){ if (!it) return null; if (typeof it==='string'){ try{ const url=new URL(it).href; return { name: url, url }; } catch{ return { name: it, url: it }; } } if (typeof it==='object'){ const url=it.url||''; const name=it.name||url||''; return (name||url)?{ name, url }:null; } return null; },
        normalizeSources(src){ const out={ Kaynaklar:[], Görsel:[], Platform:[] }; const push=(cat,it)=>{ const n=this.normalizeItem(it); if(n) out[cat].push(n); }; if (!src) return out; if (typeof src==='object' && !Array.isArray(src)){ for (const [k,v] of Object.entries(src)){ const cat=this.mapCategory(k); const arr=Array.isArray(v)?v:[v]; arr.forEach(it=>push(cat,it)); } return out; } if (Array.isArray(src)){ if (!src.length || typeof src[0] !== 'object' || ('url' in src[0]) || ('name' in src[0])){ src.forEach(it=>push('Kaynaklar', it)); } else { src.forEach(g=>{ const cat=this.mapCategory(g?.category); const items=Array.isArray(g?.items)?g.items:(g?.items?[g.items]:[]); items.forEach(it=>push(cat,it)); }); } return out; } push('Kaynaklar', src); return out; },

        // Poster checker
        async checkPoster(){
          if (!this.preview?.image) { this.previewPoster = { running:false, ok:false, text:'URL yok' }; return; }
          this.previewPoster = { running:true, ok:null, text:'Kontrol ediliyor…' };
          try {
            const img = new Image();
            img.onload = () => { this.previewPoster = { running:false, ok:true, text: img.width + '×' + img.height }; this.toast('Poster yüklendi','success'); };
            img.onerror = () => { this.previewPoster = { running:false, ok:false, text:'Yüklenemedi' }; this.toast('Poster bulunamadı','error'); };
            img.src = this.preview.image + (this.preview.image.includes('?') ? '&' : '?') + 't=' + Date.now();
          } catch (e){
            this.previewPoster = { running:false, ok:false, text:'Hata' };
          }
        },

        // Source helper modal
        addSourceEntry(){
    const n = this.sourceHelper.node;
    if (!n) return;

    let obj = {};
    if (n.sourcesText && this.isValidJSON(n.sourcesText)) {
        obj = JSON.parse(n.sourcesText);
    }

    const cat = this.mapCategory(this.sourceHelper.category);
    obj[cat] = Array.isArray(obj[cat]) ? obj[cat] : [];

    if (typeof this.sourceHelper.editIndex === 'number') {
        obj[cat][this.sourceHelper.editIndex] = { 
            name: this.sourceHelper.name, 
            url: this.sourceHelper.url 
        };
    } else {
        obj[cat].push({ 
            name: this.sourceHelper.name, 
            url: this.sourceHelper.url 
        });
    }

    n.sourcesText = JSON.stringify(obj, null, 2);

    this.$nextTick(() => {
        this.touch();
        this.toast(
            typeof this.sourceHelper.editIndex === 'number' 
                ? 'Kaynak güncellendi' 
                : 'Kaynak eklendi', 
            'success'
        );
    });

    this.showSourceHelper = false;
    this.sourceHelper = { node: null, category: 'Kaynaklar', name: '', url: '', editIndex: null };
},

        openSourceEditor(n){
          if (!n) return;
          this.sourceEdit.node = n;
          // Try sourcesText first; fallback to n.sources if needed
          let obj = {};
          if (n.sourcesText && this.isValidJSON(n.sourcesText)) {
            obj = JSON.parse(n.sourcesText);
          } else if (n.sources) {
            obj = n.sources;
          }
          // Normalize into arrays per category
          const cats = ['Kaynaklar','Görsel','Platform'];
          const data = { Kaynaklar:[], Görsel:[], Platform:[] };
          for (const c of cats){
            const key = this.mapCategory(c);
            const raw = obj[key] ?? obj[c] ?? [];
            const arr = Array.isArray(raw) ? raw : (raw ? [raw] : []);
            data[c] = arr.map(it => (typeof it === 'string'
              ? ({ name: it, url: it })
              : ({ name: (it?.name || it?.url || ''), url: (it?.url || '') })
            ));
          }
          this.sourceEdit.data = data;
          this.sourceEdit.open = true;
        },
        closeSourceEditor(){
          this.sourceEdit.open = false;
          this.sourceEdit.node = null;
          this.sourceEdit.data = { Kaynaklar:[], Görsel:[], Platform:[] };
        },
        saveSourceEditor(){
          const n = this.sourceEdit.node;
          if (!n) return;
          const out = {};
          for (const c of ['Kaynaklar','Görsel','Platform']){
            const cleaned = (this.sourceEdit.data[c]||[]).filter(r => (r.name||'').trim() || (r.url||'').trim())
              .map(r => ({ name: r.name?.trim() || (r.url||'').trim(), url: (r.url||'').trim() }));
            if (cleaned.length) out[c] = cleaned;
          }
          n.sourcesText = JSON.stringify(out, null, 2);
          this.touch();
          this.toast('Kaynaklar güncellendi','success');
          this.closeSourceEditor();
        },
        addSourceRow(cat){
          if (!this.sourceEdit.data[cat]) this.sourceEdit.data[cat] = [];
          this.sourceEdit.data[cat].push({ name:'', url:'' });
        },
        removeSourceRow(cat, i){
          if (!this.sourceEdit.data[cat]) return;
          this.sourceEdit.data[cat].splice(i,1);
        },

        openSourceHelper(node){
    // node: satır referansı, category: kategori adı, index: düzenlenecek kaynak indexi
    if (arguments.length >= 3) {
        const node = arguments[0], category = arguments[1], index = arguments[2];
        this.sourceHelper.node = node;
        this.sourceHelper.category = category || 'Kaynaklar';
        this.sourceHelper.editIndex = index;
        if (node.sourcesText && this.isValidJSON(node.sourcesText)) {
            const obj = JSON.parse(node.sourcesText);
            const arr = Array.isArray(obj[this.mapCategory(category)]) ? obj[this.mapCategory(category)] : [];
            if (arr[index]) {
                this.sourceHelper.name = arr[index].name || '';
                this.sourceHelper.url = arr[index].url || '';
            }
        }
    } else {
        this.sourceHelper.node = arguments[0];
        this.sourceHelper.category = 'Kaynaklar';
        this.sourceHelper.editIndex = null;
    }
    this.showSourceHelper = true;
},

        // Link tester (basic URL HEAD check via fetch)
        openLinkTester(){
          this.linkTest = { open:true, running:false, results:[], total:0, checked:0 };
        },
        closeLinkTester(){ this.linkTest.open=false; },
        async runLinkTests(){
          const selected = new Set(this.selectedNodeIds);
          const nodes = (this.current.nodes||[]).filter(n => selected.size ? selected.has(n.id) : true);
          const results = [];
          const push = (nodeId,label,category,name,url,ok,text) => results.push({ nodeId, label, category, name, url, ok, statusText:text });
          const all = [];
          for (const n of nodes){
            let srcObj = null;
            if (n.sourcesText && this.isValidJSON(n.sourcesText)) srcObj = JSON.parse(n.sourcesText);
            const normalized = this.normalizeSources(srcObj);
            for (const [cat, arr] of Object.entries(normalized)){
              for (const it of arr){
                all.push({ nodeId:n.id, label:n.label, category:cat, name:it.name, url:it.url });
              }
            }
          }
          this.linkTest.total = all.length;
          this.linkTest.running = true;
          for (const item of all){
            try{
              const r = await fetch(item.url, { method:'GET', mode:'no-cors' });
              // no-cors may not expose status; assume ok if no exception
              push(item.nodeId, item.label, item.category, item.name, item.url, true, 'OK');
            } catch(e){
              push(item.nodeId, item.label, item.category, item.name, item.url, false, 'Hata');
            }
            this.linkTest.checked = results.length;
            this.linkTest.results = [...results];
            await new Promise(r => setTimeout(r, 60));
          }
          this.linkTest.running = false;
          this.toast('Link testi tamamlandı','success');
        },
      }
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500);
    }

    // Favicon helpers
    (function(){
      function safeHostname(u){ try { return (new URL(u)).hostname; } catch(e){ return ''; } }
      window.favicon = function(url){ const h = safeHostname(url); return h ? ("https://www.google.com/s2/favicons?domain=" + h) : ""; };
      window.hostName = function(url){ return safeHostname(url); };
    })();
  </script>

  <script>
    // Optional: set this when API is on another origin (e.g. workers.dev)
    window.__ANALYTICS_BASE = 'https://evren-analytics.no-reply-bf4.workers.dev';
  </script>
  
<script>
window.__evrenStats = (function(){
  const charts = {};
  const C = (id) => {
    const el = document.getElementById(id);
    if (!el) return null;
    if (charts[id]) { charts[id].destroy(); delete charts[id]; }
    return el.getContext('2d');
  };

  // ---------- helpers ----------
  function getNodes(app){ try { return (app.current?.nodes) || []; } catch{ return []; } }
  function avgImdb(app){
    const nodes = getNodes(app);
    const ratings = nodes.map(n => Number(n.imdb_rating)).filter(x => !isNaN(x));
    if (!ratings.length) return null;
    const avg = ratings.reduce((a,b)=>a+b,0)/ratings.length;
    return avg.toFixed(2);
  }
  function computeData(app){
    const nodes = getNodes(app);
    const typeCounts = { movie:0, series:0 };
    const yearMap = new Map();
    const genresMap = new Map();
    const imdbBuckets = { '<5':0, '5-5.9':0, '6-6.9':0, '7-7.9':0, '8-8.9':0, '9-10':0 };
    for (const n of nodes){
      if (n.type==='series') typeCounts.series++; else typeCounts.movie++;
      const y = n.release_date ? new Date(n.release_date).getFullYear() : null;
      if (y) yearMap.set(y, (yearMap.get(y)||0)+1);
      const türStr = String(n.tür || '')
      .split(',')
      .map(s => s.trim())
      .filter(Boolean);
      const uniqueGenres = [...new Set(türStr)];
      uniqueGenres.forEach(g => genresMap.set(g, (genresMap.get(g)||0)+1));
      const r = Number(n.imdb_rating);
      if (!isNaN(r)){
        if (r<5) imdbBuckets['<5']++; else if (r<6) imdbBuckets['5-5.9']++;
        else if (r<7) imdbBuckets['6-6.9']++; else if (r<8) imdbBuckets['7-7.9']++;
        else if (r<9) imdbBuckets['8-8.9']++; else imdbBuckets['9-10']++;
      }
    }
    const years = Array.from(yearMap.keys()).sort((a,b)=>a-b);
    const yearCounts = years.map(y => yearMap.get(y));
    return { typeCounts, years, yearCounts,
      imdbLabels: Object.keys(imdbBuckets), imdbCounts: Object.values(imdbBuckets) };
  }

  function baseOpts({legend=true, yTitle='', xTitle='', stacked=false, indexAxis='x'}={}){
    return {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: !!legend, position: 'top' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { grid: { display: false }, stacked, title: xTitle?{display:true,text:xTitle}:undefined },
        y: { grid: { color: 'rgba(255,255,255,0.06)' }, beginAtZero: true, stacked, title: yTitle?{display:true,text:yTitle}:undefined }
      },
      indexAxis
    };
  }

  function colors(n){
    // pleasant default palette
    const palette = [
      'rgba(59,130,246,0.7)',  // blue-500
      'rgba(16,185,129,0.7)',  // emerald-500
      'rgba(236,72,153,0.7)',  // pink-500
      'rgba(234,179,8,0.7)',   // amber-500
      'rgba(168,85,247,0.7)',  // purple-500
      'rgba(244,114,182,0.7)', // pink-400
      'rgba(34,197,94,0.7)',   // green-500
      'rgba(14,165,233,0.7)',  // sky-500
    ];
    return Array.from({length:n}, (_,i)=>palette[i % palette.length]);
  }

  // ---------- analytics ----------
  function rangeDays(range){ return ({'7d':7,'30d':30,'90d':90})[range]||30; }
  function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
  function formatDate(d){ return d.toISOString().slice(0,10); }

  function genDemo(range){
    function rangeDays(r){ return ({'7d':7,'30d':30,'90d':90})[r]||30; }
    const days = rangeDays(range||'30d');
    const base = new Date(); base.setHours(0,0,0,0);
    const out = [];
    let visits = 0, pageviews = 0;
    for (let i=days-1;i>=0;i--){
      const day = new Date(base); day.setDate(base.getDate()-i);
      const v = Math.floor(50 + Math.random()*150);
      const pv = Math.floor(v * (1.4 + Math.random()*0.8));
      out.push({ date: day.toISOString().slice(0,10), visits: v, pageviews: pv });
      visits += v; pageviews += pv;
    }
    const devices = [
      { device:'desktop', count: Math.floor(pageviews*0.55) },
      { device:'mobile',  count: Math.floor(pageviews*0.38) },
      { device:'tablet',  count: Math.max(1, Math.floor(pageviews*0.07)) },
    ];
    const sources = [
      { source:'direct',   count: Math.floor(visits*0.42) },
      { source:'google',   count: Math.floor(visits*0.35) },
      { source:'twitter',  count: Math.floor(visits*0.08) },
      { source:'facebook', count: Math.floor(visits*0.06) },
      { source:'other',    count: Math.max(1, visits - (Math.floor(visits*0.42)+Math.floor(visits*0.35)+Math.floor(visits*0.08)+Math.floor(visits*0.06))) },
    ];
    const pages = [
      { path:'/evren',         views: Math.floor(pageviews*0.22) },
      { path:'/evren/marvel',  views: Math.floor(pageviews*0.18) },
      { path:'/starwars',      views: Math.floor(pageviews*0.12) },
      { path:'/blog',          views: Math.floor(pageviews*0.10) },
      { path:'/hakkimizda',    views: Math.floor(pageviews*0.06) },
    ];
    return { totals: { visits, visitors: Math.floor(visits*0.82), pageviews, bounce_rate: 0.48, avg_session_duration: 73 },
             timeseries: out, devices, sources, pages };
  }

  async function fetchAnalytics(range){
    try{
      const base = (window.__ANALYTICS_BASE || '');
      const url = (base ? (base + '/api/analytics/summary?range=') : '/api/analytics/summary?range=') + (range||'30d');
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('not ok');
      const raw = await r.json();
      return normalizeAnalytics(raw, range||'30d');
    } catch(e){
      return normalizeAnalytics(genDemo(range||'30d'), range||'30d');
    }
  }

  function normalizeAnalytics(raw, range){
    try{
      const root = (raw && typeof raw === 'object' && Array.isArray(raw.data)) ? { ...raw, ...raw.data } : raw;
      const obj = (raw && typeof raw === 'object' && raw.result) ? raw.result : raw;
      const pick = (o, keys) => {
        if (!o || typeof o !== 'object') return undefined;
        for (const k of keys){ if (k in o && o[k]!=null) return o[k]; }
        return undefined;
      };
      const pickArray = (o, keys) => {
        if (!o || typeof o !== 'object') return [];
        for (const k of keys){ if (Array.isArray(o[k])) return o[k]; }
        return [];
      };

      // timeseries
      let ts = pickArray(obj, ['timeseries','time_series','series','timeline','daily','days','history','data']);
      // some APIs nest timeseries under obj.metrics.timeseries etc.
      if (!ts.length && typeof obj === 'object'){
        for (const v of Object.values(obj)){
          if (Array.isArray(v) && v.length && typeof v[0] === 'object' && ('date' in v[0] || 'day' in v[0] || 'ts' in v[0])) { ts = v; break; }
          if (v && typeof v === 'object'){
            const candidate = pickArray(v, ['timeseries','series','timeline','daily','data']); 
            if (candidate.length){ ts = candidate; break; }
          }
        }
      }
      const mapDate = (it) => (it.date || it.day || it.d || (it.ts ? new Date(it.ts).toISOString().slice(0,10) : undefined) || '');
      const mapVisits = (it) => (it.visits ?? it.sessions ?? it.count ?? it.users ?? it.value ?? it.total ?? 0);
      const mapViews  = (it) => (it.pageviews ?? it.views ?? it.pv ?? it.hits ?? 0);
      const timeseries = (ts||[]).map(it => ({
        date: mapDate(it),
        visits: Number(mapVisits(it)) || 0,
        pageviews: Number(mapViews(it)) || 0
      })).filter(x => x.date);

      // devices
      let devArr = pickArray(obj, ['devices','by_device','device','platforms','clients']);
      if (!devArr.length && obj.metrics && typeof obj.metrics==='object'){ devArr = pickArray(obj.metrics, ['devices','by_device']); }
      const devices = (devArr||[]).map(d => ({
        device: d.device || d.name || d.label || d.key || 'other',
        count: Number(d.count ?? d.value ?? d.visits ?? d.views ?? 0) || 0
      }));

      // sources
      let srcArr = pickArray(obj, ['sources','referrers','by_source','channels']);
      const sources = (srcArr||[]).map(s => ({
        source: s.source || s.name || s.label || s.key || 'other',
        count: Number(s.count ?? s.value ?? s.visits ?? s.views ?? 0) || 0
      }));

      // pages
      let pgArr = pickArray(obj, ['pages','top_pages','paths','by_path','urls']);
      const pages = (pgArr||[]).map(p => ({
        path: p.path || p.url || p.page || p.name || p.key || '/',
        views: Number(p.views ?? p.pageviews ?? p.count ?? p.value ?? 0) || 0
      }));

      // totals
      let totals = pick(obj, ['totals','summary','metrics']);
      if (!totals || typeof totals !== 'object'){
        // compute from timeseries
        const visits = timeseries.reduce((a,b)=>a+b.visits,0);
        const pageviews = timeseries.reduce((a,b)=>a+b.pageviews,0);
        totals = { visits, pageviews, visitors: Math.round(visits*0.82), bounce_rate: 0.48, avg_session_duration: 73 };
      }

      // if still empty, generate demo to avoid blank graphs
      if (!timeseries.length){
        const demo = genDemo(range||'30d');
        return demo;
      }

      return { totals, timeseries, devices, sources, pages };
    } catch(e){
      return genDemo(range||'30d');
    }
  }

  // ---------- render charts ----------
  function renderDataCharts(app){
    const d = computeData(app);

    // Film/Dizi donut
    (function(){
      const ctx = C('chartTypeDonut'); if (!ctx) return;
      charts['chartTypeDonut'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Film','Dizi'],
          datasets: [{ data: [d.typeCounts.movie, d.typeCounts.series], backgroundColor: colors(2) }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    })();

    // Years area
    (function(){
      const ctx = C('chartByYearArea'); if (!ctx) return;
      charts['chartByYearArea'] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: d.years,
          datasets: [{ label:'Yapım', data: d.yearCounts, fill:true, tension:0.3, backgroundColor:'rgba(59,130,246,0.25)', borderColor:'rgba(59,130,246,0.9)', pointRadius: 0 }]
        },
        options: baseOpts({ legend:false, yTitle:'Adet', xTitle:'Yıl' })
      });
    })();

    // IMDb bars
    (function(){
      const ctx = C('chartImdbBars'); if (!ctx) return;
      charts['chartImdbBars'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: d.imdbLabels,
          datasets: [{ label:'Yapım', data: d.imdbCounts, backgroundColor: colors(d.imdbLabels.length) }]
        },
        options: baseOpts({ legend:false, yTitle:'Adet' })
      });
    })();
  }

  async function renderAnalyticsCharts(range){
    let a = await fetchAnalytics(range);
    if (!a || !Array.isArray(a.timeseries) || a.timeseries.length === 0) { a = genDemo(range); }

    // Visits line
    (function(){
      const ctx = C('chartVisitsLine'); if (!ctx) return;
      charts['chartVisitsLine'] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: (a.timeseries||[]).map(t=>t.date),
          datasets: [{
            label:'Ziyaret',
            data: (a.timeseries||[]).map(t=>t.visits),
            fill:true, tension:0.35, pointRadius:0,
            backgroundColor:'rgba(16,185,129,0.22)',
            borderColor:'rgba(16,185,129,0.95)'
          }]
        },
        options: baseOpts({ legend:false, yTitle:'Ziyaret' })
      });
    })();

    // Devices donut
    (function(){
      const ctx = C('chartDevicesDonut'); if (!ctx) return;
      const labels = (a.devices||[]).map(d=>d.device);
      const data = (a.devices||[]).map(d=>d.count);
      charts['chartDevicesDonut'] = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: colors(labels.length) }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    })();

    // Top pages horizontal bar (max 5)
    (function(){
      const ctx = C('chartTopPagesBarH'); if (!ctx) return;
      const top = (a.pages||[]).slice(0,5);
      charts['chartTopPagesBarH'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: top.map(p=>p.path),
          datasets: [{ label:'Görüntüleme', data: top.map(p=>p.views), backgroundColor: colors(top.length) }]
        },
        options: baseOpts({ legend:false, xTitle:'Görüntüleme', indexAxis:'y' })
      });
    })();
  }

  // Export (optional; keeps previous capability)
  function buildPayload(app, a){
    const d = computeData(app);
    return { content: { totals: { movies:d.typeCounts.movie, series:d.typeCounts.series, imdbAvg:avgImdb(app) },
                        years: d.years.map((y,i)=>({year:y,count:d.yearCounts[i]})),
                        imdb: d.imdbLabels.map((b,i)=>({bucket:b,count:d.imdbCounts[i]})) },
             analytics: a || null };
  }
  function toCSV(p){
    const L = ['Section,Key,Value'];
    L.push(`Content Totals,Movies,${p.content.totals.movies}`);
    L.push(`Content Totals,Series,${p.content.totals.series}`);
    L.push(`Content Totals,IMDb Avg,${p.content.totals.imdbAvg??''}`);
    p.content.years.forEach(y=>L.push(`Years,${y.year},${y.count}`));
    p.content.imdb.forEach(b=>L.push(`IMDb,${b.bucket},${b.count}`));
    if (p.analytics?.totals){
      Object.entries(p.analytics.totals).forEach(([k,v])=>L.push(`Analytics Totals,${k},${v}`));
    }
    return L.join('\n');
  }
  function download(name, data, mime){
    const blob = new Blob([data], { type: mime });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }
  async function exportAll(app, fmt){
    const sel = document.getElementById('analyticsRange');
    const range = sel ? sel.value : '30d';
    const a = await fetchAnalytics(range);
    const payload = buildPayload(app, a);
    if (fmt==='json') download('istatistikler.json', JSON.stringify(payload,null,2), 'application/json');
    else download('istatistikler.csv', toCSV(payload), 'text/csv');
  }

  // main
  async function renderAll(app){
    renderDataCharts(app);
    const sel = document.getElementById('analyticsRange');
    const range = sel ? sel.value : '30d';
    await renderAnalyticsCharts(range);
    // force visits chart redraw
    if (typeof charts['chartVisitsLine'] === 'undefined') {
      await renderAnalyticsCharts(range);
    }
  }

  // Wire buttons & tab switch
  document.addEventListener('DOMContentLoaded', ()=>{
    const root = document.querySelector('html');
    const getApp = () => (window.Alpine ? Alpine.$data(root) : null);
    const btnCsv  = document.getElementById('exportCsvBtn');
    const btnJson = document.getElementById('exportJsonBtn');
    if (btnCsv)  btnCsv.addEventListener('click',  ()=>{ const app=getApp(); if(app) exportAll(app,'csv'); });
    if (btnJson) btnJson.addEventListener('click', ()=>{ const app=getApp(); if(app) exportAll(app,'json'); });
  });
  document.addEventListener('alpine:init', () => {
    let lastTab = null;
    setInterval(() => {
      try {
        const app = Alpine.$data(document.querySelector('html'));
        const t = app?.tab;
        if (t !== lastTab){
          lastTab = t;
          if (t === 'stats') {
            setTimeout(()=>renderAll(app), 50);
          }
        }
      } catch{}
    }, 350);
  });

  return { renderAll, avgImdb };
})();
</script>


</body>
</html>
