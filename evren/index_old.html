<!DOCTYPE html>
<html lang="tr" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🎬 Film Evreni Ağı</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; color: #d1d5db; font-family: 'Segoe UI', system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial, sans-serif; background: transparent; }

    /* Tam ekran arkaplan IMG (mobil uyumlu) */
    #bgImg{ position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(12px) brightness(0.65); transform: scale(1.06); z-index: -2; backface-visibility: hidden; will-change: transform; }
    #bgOverlay{ position: fixed; inset: 0; z-index:-1; background: rgba(0,0,0,0.35); }

    /* Graph tam ekran; transparan */
    #network { position: fixed; inset: 0; background: transparent; border: none; }

    /* Cam (glass) yüzey */
    .glass { background: rgba(31,41,55,0.45); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 12px 30px rgba(0,0,0,0.35); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); }

    /* Formlar */
    input { color: #e5e7eb; background-color: rgba(55,65,81,0.55); border: 1px solid rgba(255,255,255,0.12); outline: none; }
    input::placeholder { color: #9ca3af; }

    /* Autocomplete paneli */
    .ac-panel { background: rgba(31,41,55,0.9); border: 1px solid rgba(255,255,255,0.14); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 14px 28px rgba(0,0,0,0.5); }
    .ac-item { cursor: pointer; }
    .ac-item:hover { background: rgba(255,255,255,0.08); }

    /* Custom dropdown (glass) */
    .dropdown-btn { cursor: pointer; }
    .dropdown-panel { background: rgba(31,41,55,0.65); border: 1px solid rgba(255,255,255,0.14); box-shadow: 0 16px 40px rgba(0,0,0,0.45); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
    .dropdown-item { cursor: pointer; }
    .dropdown-item:hover { background: rgba(255,255,255,0.06); }

    /* Modal */
    .modal-bg { background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); }
    .modal-content { width: 92vw; max-width: 780px; max-height: 85vh; overflow-y: auto; background: #0f172a; color: #e5e7eb; border-radius: 18px; padding: 0; box-shadow: 0 12px 24px rgba(0,0,0,0.45); position: relative; border: 1px solid rgba(255,255,255,0.08); }
    .modal-header { display: grid; grid-template-columns: 120px 1fr; gap: 16px; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.06); background: radial-gradient(1200px 400px at -20% -40%, rgba(239,68,68,0.08), transparent); }
    .poster { width: 120px; height: 160px; border-radius: 10px; object-fit: cover; background: #111827; border: 1px solid rgba(255,255,255,0.08); }
    .modal-body { padding: 16px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); padding: 4px 10px; border-radius: 999px; font-size: 12px; }

    /* Meta tek kolon */
    .meta-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
    .meta-item { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); padding: 10px 12px; border-radius: 12px; }
    .section-title { font-size: 0.9rem; opacity: 0.85; margin-bottom: 6px; }

    .close-btn { position: absolute; top: 12px; right: 12px; width: 36px; height: 36px; border-radius: 999px; display: grid; place-items: center; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
    .close-btn:hover { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.5); }

    /* Legend: üstte toggle, mobilde kapalı + küçük */
    #legendWrap { position: fixed; left: 16px; bottom: 16px; z-index: 40; }
    #legendToggle { margin-bottom: 8px; background: rgba(31,41,55,0.55); border: 1px solid rgba(255,255,255,0.14); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); }
    #legend { background: rgba(31,41,55,0.45); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 8px 18px rgba(0,0,0,0.35); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: 12px; padding: 12px 16px; max-width: 320px; max-height: 260px; overflow-y: auto; font-size: 0.85rem; }
    @media (max-width: 640px) { #legend { font-size: 0.72rem; max-width: 220px; padding: 8px 10px; } }

    /* Paylaş çubuğu */
    .share-bar { position: absolute; top: 8px; left: 12px; right: 56px; display:flex; align-items:center; gap:8px; opacity:.95; }
    .share-btn { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.14); font-size:12px; }
    .share-btn:hover { background: rgba(255,255,255,0.1); }
  
    /* Gizli scrollbar (mobil yatay kaydırma için) */
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    </style>

</head>
<body class="dark" :class="{ 'overflow-hidden': modalOpen }">

<!-- Dinamik arkaplan (IMG + overlay) -->
<img id="bgImg" :src="bgUrl" alt="" />
<div id="bgOverlay"></div>

<!-- Kompakt CAM NAVBAR -->
<header class="fixed top-4 left-0 right-0 z-50">
  <div class="w-full sm:max-w-md lg:max-w-lg mx-auto px-3">
    <div class="glass rounded-xl px-3 py-2">
      <div class="flex flex-col gap-2">
        <div class="flex items-center justify-center">
          <h1 class="text-base sm:text-lg font-bold text-center">🎬 Film Evreni Ağı</h1>
        </div>

        <div class="flex items-center gap-2">
          <!-- Arama + Autocomplete + X temizle -->
          <div class="relative w-full">
            <input x-model="search" type="search" placeholder="Ara..." class="border rounded-lg px-3 py-1.5 w-full pr-8"
                   @focus="acOpen = true" @blur="setTimeout(() => acOpen = false, 120)" />
            <button x-show="search" @mousedown.prevent @click="search=''; suggestions=[]; applyFilters()"
                    class="absolute inset-y-0 right-2 my-auto h-6 w-6 rounded-full grid place-items-center opacity-80 hover:opacity-100 hover:bg-white/10"
                    aria-label="Temizle">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4Z"/></svg>
            </button>

            <!-- Öneriler -->
            <div x-show="acOpen && search && suggestions.length"
                 class="ac-panel absolute z-50 w-full mt-1 rounded-lg overflow-hidden max-h-56 overflow-y-auto">
              <template x-for="(s, idx) in suggestions" :key="s">
                <div class="ac-item px-3 py-1.5" @mousedown.prevent @click="search = s; acOpen=false; applyFilters();">
                  <span x-text="s"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Universe Dropdown (glass) -->
          <div class="relative min-w-[200px]" x-data="{ open:false, filterText:'' }" @keydown.escape="open=false" @click.outside="open=false">
            <div class="dropdown-btn border rounded-lg px-3 py-1.5 w-full flex items-center justify-between select-none"
                 @click="open=!open" :aria-expanded="open">
              <span class="truncate" x-text="selectedUniverse ? formatUniverseName(selectedUniverse) : 'Tüm Evrenler'"></span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-80 ml-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div x-show="open" x-transition class="dropdown-panel absolute mt-2 left-0 right-0 rounded-xl overflow-hidden" style="z-index:60">
              <div class="p-2 border-b border-white/10">
                <input x-model="filterText" placeholder="Evren ara..." class="w-full px-3 py-2 rounded-lg border" />
              </div>
              <ul class="max-h-64 overflow-y-auto">
                <li class="dropdown-item px-3 py-2" @click="selectedUniverse=''; open=false; filterText=''; applyFilters()">Tüm Evrenler</li>
                <template x-for="u in universeList.filter(u => !filterText || formatUniverseName(u).toLowerCase().includes(filterText.toLowerCase()))" :key="u">
                  <li class="dropdown-item px-3 py-2" @click="selectedUniverse=u; open=false; filterText=''; applyFilters()" x-text="formatUniverseName(u)"></li>
                </template>
              </ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</header>

<!-- Ağ grafiği -->
<div id="network"></div>

<!-- Gelişmiş Modal -->
<div x-show="modalOpen" x-transition class="fixed inset-0 modal-bg flex items-center justify-center z-50 p-4"
     @click.outside="modalOpen = false" @keydown.escape.window="modalOpen=false" aria-labelledby="modalTitle" role="dialog" aria-modal="true">
  <div class="modal-content" @click.stop @click.stop>

    <button class="close-btn" aria-label="Kapat" @click="modalOpen=false">✖</button>

    <div class="modal-header">
      <template x-if="modalNode?.image"><img :src="modalNode.image" alt="" class="poster" loading="lazy" /></template>
      <template x-if="!modalNode?.image"><div class="poster"></div></template>

      <div class="flex flex-col gap-2">
        <h2 id="modalTitle" class="text-xl font-semibold" x-text="modalNode?.label"></h2>
        <div class="flex flex-wrap items-center gap-2">
          <span class="chip">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l4 4-10 10H2v-4L12 2z"/><path d="M3 22h18v-2H3v2z"/></svg>
            <span x-text="formatUniverseName(modalNode?.universe)"></span>
          </span>

          <template x-if="modalNode?.type">
            <span class="chip">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c5.421 0 10-4.579 10-10S17.421 2 12 2 2 6.579 2 12s4.579 10 10 10z"/></svg>
              <span x-text="modalNode.type"></span>
            </span>
          </template>

        <template x-if="modalNode?.lang">
          <span class="chip">
            🌐 <span x-text="modalNode.lang.toUpperCase()"></span>
          </span>
        </template>



<!-- Paylaş -->
        <div class="flex items-center gap-2">
          <span class="text-sm">Paylaş:</span>

          <!-- X (Twitter) -->
          <button @click="shareToX(modalNode)" class="p-1 hover:bg-white/10 rounded-full" title="X'te Paylaş">
            <!-- X icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1227" width="18" height="18" fill="currentColor">
              <path d="M714.163 548.125L1160.89 0H1050.73L672.672 453.5L396.947 0H0L466.46 729.84L0 1227H110.155L512.993 753.975L803.053 1227H1200L714.163 548.125ZM563.279 687.089L518.127 619.865L149.791 79.694H356.3L636.021 490.821L681.173 558.045L1050.73 1147.31H844.224L563.279 687.089Z"/>
            </svg>
          </button>

          <!-- WhatsApp -->
          <button @click="shareToWhatsApp(modalNode)" class="p-1 hover:bg-white/10 rounded-full" title="WhatsApp'ta Paylaş">
            <!-- WhatsApp icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="18" height="18" fill="currentColor">
              <path d="M16 0C7.164 0 0 7.164 0 16c0 2.82.734 5.574 2.133 7.984L.063 32l8.188-2.047C10.492 30.996 13.203 32 16 32c8.836 0 16-7.164 16-16S24.836 0 16 0zm0 29.188c-2.539 0-5.023-.68-7.195-1.973l-.516-.305-4.855 1.215 1.293-4.73-.34-.555C3.688 21.289 3.063 18.68 3.063 16 3.063 8.836 8.836 3.063 16 3.063S28.938 8.836 28.938 16 23.164 28.938 16 28.938z"/><path d="M23.57 18.813c-.402-.203-2.375-1.18-2.746-1.316-.371-.137-.641-.203-.91.203-.27.402-1.043 1.316-1.277 1.586-.234.27-.469.305-.871.102-.402-.203-1.699-.625-3.238-1.992-1.195-1.066-2.004-2.383-2.238-2.785-.234-.402-.023-.621.18-.824.184-.184.402-.48.605-.719.203-.234.27-.402.402-.672.137-.27.066-.508-.027-.711-.098-.203-.91-2.195-1.246-3.012-.328-.789-.664-.68-.91-.691l-.77-.016c-.27 0-.707.102-1.078.508-.371.402-1.418 1.387-1.418 3.387 0 1.996 1.453 3.922 1.66 4.195.203.27 2.855 4.363 6.922 6.113.969.418 1.723.668 2.309.855.969.309 1.848.266 2.547.16.777-.117 2.375-.973 2.711-1.91.34-.938.34-1.742.234-1.91-.102-.168-.367-.27-.77-.473z"/>
            </svg>
          </button>

          <!-- LinkedIn -->
          <button @click="shareToLinkedIn(modalNode)" class="p-1 hover:bg-white/10 rounded-full" title="LinkedIn'de Paylaş">
            <!-- LinkedIn icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="18" height="18" fill="currentColor">
              <path d="M100.28 448H7.4V148.9h92.88zm-46.44-339C24.33 109 0 84.67 0 54.5S24.33 0 54.5 0s54.5 24.33 54.5 54.5S84.67 109 54.5 109zM447.9 448h-92.4V302.4c0-34.7-.7-79.3-48.3-79.3-48.3 0-55.7 37.7-55.7 76.7V448h-92.4V148.9h88.7v40.8h1.3c12.4-23.6 42.6-48.3 87.6-48.3 93.7 0 110.9 61.7 110.9 142V448z"/>
            </svg>
          </button>

          <!-- Link kopyala -->
          <button @click="copyShare(modalNode)" class="p-1 hover:bg-white/10 rounded-full" title="Metni ve Linki Kopyala">
            <!-- Link icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3.9 12a5 5 0 0 1 8.5-3.54l1.06 1.06-1.42 1.42-1.06-1.06a3 3 0 1 0-4.24 4.24l2.12 2.12a3 3 0 0 0 4.24 0l1.06-1.06 1.42 1.42-1.06 1.06a5 5 0 0 1-7.07 0L3.9 15.54A5 5 0 0 1 3.9 12z"/>
              <path d="M20.1 12a5 5 0 0 1-8.5 3.54l-1.06-1.06 1.42-1.42 1.06 1.06a3 3 0 0 0 4.24-4.24l-2.12-2.12a3 3 0 0 0-4.24 0l-1.06 1.06-1.42-1.42 1.06-1.06a5 5 0 0 1 7.07 0l2.12 2.12A5 5 0 0 1 20.1 12z"/>
            </svg>
          </button>
        </div>

          <!-- Daha Sonra İzle (yıldız ikon) -->
          <button
            class="ml-auto p-2 rounded-full hover:bg-white/10"
            @click="toggleWatchLater(modalNode)"
            :title="isInWatchLater(modalNode?.id) ? 'Listeden çıkar' : 'Daha sonra izle'">

            <!-- Boş yıldız (listede değil) -->
            <svg x-show="!isInWatchLater(modalNode?.id)" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>

            <!-- Dolu yıldız (listede) -->
            <svg x-show="isInWatchLater(modalNode?.id)" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
          </button>


        </div>
 
        
        


        <!-- Meta: tek kolon -->
<div class="meta-grid grid-cols-2 sm:grid-cols-2 gap-4 mt-2">
  
  <!-- Vizyon: Grid 1 -->
  <div class="meta-item" style="grid-column: 1;">
    <div class="section-title">Vizyon</div>
    <div x-text="modalNode?.release_date ? toTRDate(modalNode.release_date) : '-'"></div>
  </div>

  <!-- Kaynaklar: Grid 2 -->
  <template x-if="modalNode?.sources?.length">
    <div class="meta-item" style="grid-column: 2;">
      <div class="section-title">Kaynaklar</div>
      <ul class="list-disc list-inside text-sm space-y-1">
        <template x-for="src in modalNode.sources" :key="src.url">
          <li><a class="underline hover:opacity-90" :href="src.url" target="_blank" x-text="src.name"></a></li>
        </template>
      </ul>
    </div>
  </template>

</div>


      
      </div>
    </div>

    <!-- Gövde -->
    <div class="modal-body space-y-4">
      <!-- Film Özeti -->
      <div>
        <div class="flex items-center gap-2 mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-red-400" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v14H4z" fill="none"/><path d="M4 5h16v14H4z"/></svg>
          <span class="font-semibold">Film Özeti</span>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-3 leading-relaxed">
          <span x-text="modalNode?.description || 'Film Özeti yok.'"></span>
        </div>
      </div>

      <!-- Göndermeler -->
      <template x-if="modalNode?.refers_to">
        <div>
          <div class="flex items-center gap-2 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 13.41a1.99 1.99 0 002.82 0l5-5a2 2 0 10-2.82-2.82l-5 5a2 2 0 000 2.82z"/><path d="M13.41 10.59a1.99 1.99 0 000 2.82l5 5a2 2 0 102.82-2.82l-5-5a2 2 0 00-2.82 0z"/></svg>
            <span class="font-semibold">Göndermeler</span>
          </div>
          <div class="bg-white/5 border border-white/10 rounded-lg p-3 italic text-sm leading-relaxed">
            <span x-text="modalNode.refers_to"></span>
          </div>
        </div>
      </template>

<!-- Bağlantılı yapımlar -->
<div>
  <div class="section-title">Bağlantılı Yapımlar</div>
  <div class="flex flex-wrap gap-2">
 
    
    <template x-for="e in edgeList || []" :key="e.otherNodeId || (e.from + '-' + e.to)">
  <div class="flex items-center mb-1">
    <button
      class="chip"
      :style="`background:${edgeColors[e.type] || '#eee'}; color:#fff`"
      @click="__openNode(e.otherNodeId)"
      :title="e.type"
      x-text="nodes.get(e.otherNodeId)?.label || e.otherNodeId"
    ></button>
    <template x-if="e.notes">
      <span class="ml-2 text-xs italic opacity-80" x-text="e.notes"></span>
    </template>
  </div>
</template>


      </button>
    </template>
    <template x-if="!edgeList.length">
      <span class="text-sm opacity-70">Bağlantı bulunamadı.</span>
    </template>
  </div>
</div>





      <!-- Notlar -->
      <div>
        <div class="section-title">Notlar</div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-2 space-y-2" role="list">
          <template x-if="!notes[modalNode?.id] || !notes[modalNode?.id].length">
            <div class="text-sm opacity-70">Henüz not yok.</div>
          </template>

          <template x-for="(c, i) in (notes[modalNode?.id] || [])" :key="i">
            <div class="bg-white/5 rounded p-2 text-sm flex items-start justify-between gap-3" role="listitem">
              <div class="space-y-1">
                <div class="flex items-center gap-2">
                  <span class="text-xs opacity-70" x-text="new Date(c.ts).toLocaleDateString()"></span>
                  <template x-if="c.pin"><span class="text-xs">📌</span></template>
                  <template x-if="c.tags?.length">
                    <div class="flex gap-1 flex-wrap">
                      <template x-for="t in c.tags" :key="t">
                        <span class="px-1.5 py-0.5 rounded bg-white/10 text-[11px]">#<span x-text="t"></span></span>
                      </template>
                    </div>
                  </template>
                </div>
                <div class="leading-relaxed whitespace-pre-wrap" x-text="c.text"></div>
              </div>
              <div class="flex flex-col gap-1">
                <button class="text-xs opacity-80 hover:opacity-100" @click="togglePin(modalNode.id, i)"><span x-text="c.pin ? 'Unpin' : 'Pin'"></span></button>
                <button class="text-xs opacity-80 hover:opacity-100" @click="deleteNote(modalNode.id, i)">Sil</button>
              </div>
            </div>
          </template>

          <div class="flex gap-2">
            <input x-model="newNote" placeholder="Not ekle... #etiket" class="border rounded px-2 py-1 w-full" />
            <button class="px-2 py-1 text-sm rounded border border-white/20 hover:bg-white/10" @click="addNote(modalNode.id)">Ekle</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Watch Later (sağ alt mini panel) -->
<button class="fixed right-4 bottom-4 z-40 glass rounded-full w-12 h-12 grid place-items-center hover:bg-white/10" title="Daha sonra" @click="watchLaterOpen = !watchLaterOpen">★</button>
<div x-show="watchLaterOpen" x-transition class="fixed right-4 bottom-20 z-40 glass rounded-xl p-3 w-64 max-h-72 overflow-y-auto">
  <div class="font-semibold mb-2">Daha sonra</div>
  <template x-if="!watchLater.length"><div class="text-sm opacity-70">Liste boş.</div></template>
  <template x-for="n in watchLater" :key="n.id">
    <div class="flex items-center justify-between gap-2 py-1">
      <button class="text-left hover:underline truncate" @click="__openNode(n.id)"><span x-text="n.label || n.id"></span></button>
      <button class="text-xs opacity-80 hover:opacity-100" @click="removeWatchLater(n.id)">Sil</button>
    </div>
  </template>
</div>




<!-- Notlar FAB & Panel (evren/etiket filtreli, metin GÖSTERMEZ) -->
<button class="fixed right-4 bottom-[7.5rem] z-40 glass rounded-full w-12 h-12 grid place-items-center hover:bg-white/10" title="Notlar" @click="notesOpen = !notesOpen">📝</button>
<div x-show="notesOpen" x-transition class="fixed right-4 bottom-[12.5rem] z-40 glass rounded-xl p-3 w-[22rem] max-h-[70vh] overflow-y-auto">
  <div class="flex items-center justify-between mb-2">
    <div class="font-semibold">Notlar</div>
    <button class="text-sm opacity-80 hover:opacity-100" @click="notesOpen=false">Kapat</button>
  </div>

  <!-- Filtreler -->
  <div class="flex flex-col gap-2 mb-2">
    <select x-model="notesUniverseFilter" class="border rounded px-2 py-1 bg-white/10">
      <option value="">Tüm evrenler</option>
      <template x-for="u in universeList" :key="u">
        <option :value="u" x-text="formatUniverseName(u)"></option>
      </template>
    </select>
    <div class="relative">
      <input x-model="notesTagFilter" placeholder="#etiket ile ara" class="border rounded px-2 py-1 w-full bg-white/10 pr-8" />
      <button x-show="notesTagFilter" @click="notesTagFilter=''" class="absolute right-2 inset-y-0 my-auto text-xs opacity-70 hover:opacity-100">x</button>
    </div>
    <!-- Hızlı etiket önerileri -->
    <div class="flex gap-1 flex-wrap">
      <template x-for="t in topTags" :key="t">
        <button class="text-xs px-2 py-0.5 rounded bg-white/10 hover:bg-white/20" @click="notesTagFilter = '#' + t">#<span x-text="t"></span></button>
      </template>
    </div>
  </div>

  <!-- Liste (yalnızca nerede hangi not var) -->
  <template x-if="!notesSummary.length"><div class="text-sm opacity-70">Not bulunamadı.</div></template>
  <template x-for="item in notesSummary" :key="item.nodeId">
    <div class="bg-white/5 border border-white/10 rounded-lg p-2 mb-2">
      <div class="text-sm">
        <button class="underline hover:opacity-100" @click="__openNode(item.nodeId)">
          <span x-text="item.label || item.nodeId"></span>
        </button>
        <span class="opacity-80"> • </span>
        <span class="opacity-90" x-text="formatUniverseName(item.universe)"></span>
      </div>
      <div class="text-xs opacity-80 mt-1">Not sayısı: <span x-text="item.count"></span></div>
      <template x-if="item.tags && item.tags.length">
        <div class="flex gap-1 flex-wrap mt-1">
          <template x-for="t in item.tags" :key="t">
            <button class="text-[11px] px-1.5 py-0.5 rounded bg-white/10 hover:bg-white/20" @click="notesTagFilter='#'+t">#<span x-text="t"></span></button>
          </template>
        </div>
      </template>
    </div>
  </template>
</div>

<!-- Legend Toggle + Legend (filtreli + çizgi örnekli) -->
<div id="legendWrap">
  <button id="legendToggle" class="glass px-3 py-1.5 rounded-lg text-sm hover:bg-white/10 transition" @click="showLegend = !showLegend">
    Bağlantılar <span x-text="showLegend ? '(Gizle)' : '(Göster)'"></span>
  </button>
  <div id="legend" x-show="showLegend" x-transition>
    <h3 class="font-bold mb-2">Bağlantılar</h3>
    <ul>
      <template x-for="[type, color] in legendEntries" :key="type">
        <li class="flex items-center mb-1">
          <svg width="36" height="8" class="mr-2"><line x1="2" y1="4" x2="34" y2="4" :stroke="color" stroke-width="3" :stroke-dasharray="(edgeStyles[type]?.dashes ? edgeStyles[type].dashes.join(',') : '0')" /></svg>
          <span x-text="type"></span>
        </li>
      </template>
    </ul>
  </div>
</div>

<script>
function app() {
  return {
    /* ----- State ----- */
    network: null, allNodes: [], allEdges: [], nodes: null, edges: null,
    filteredNodes: [], filteredEdges: [],
    search: '', selectedUniverse: '', modalOpen: false, modalNode: null,
    timelineOpen: false,
    universeList: [], fitTimeout: null, showLegend: true,

    /* Autocomplete */
    suggestions: [], acOpen: false,

    /* Watch later */
    watchLater: [], watchLaterOpen: false,

    /* Notlar */
    notes: {}, newNote: '', notesOpen: false, notesUniverseFilter: '', notesTagFilter: '',

    /* Dinamik arkaplan */
    bgUrl: 'images/bg.jpg',
    bgMap: {
      "": "images/bg.jpg",
      "avatar_last_airbender": "images/avatar.jpg",
      "avatar_pandora": "images/pandora.jpg",
      "dc": "images/dc.jpg",
      "harrypotter": "images/harrypotter.jpg",
      "marvel": "images/marvel.jpg",
      "matrix": "images/matrix.jpg",
      "middleearth": "images/middleearth.jpg",
      "pixar": "images/pixar.jpg",
      "starwars": "images/starwars.jpg"
    },



edgeList() {
  if (!this.modalNode || !this.allEdges) return [];
  return this.allEdges
    .filter(e => e.from === this.modalNode.id || e.to === this.modalNode.id)
    .map(e => ({
      ...e,
      otherNodeId: e.from === this.modalNode.id ? e.to : e.from
    }));
}


,


    /* Renkler & stiller */
    edgeColors: {
      "Devam": "#2980b9",
      "Öncesi": "#f39c12", "ön hikaye": "#e67e22", "Yan Hikayee": "#8e44ad",
      "Aynı Evren": "#c0392b", "görsel gönderme": "#7f8c8d", "karakter göndermesi": "#27ae60",
      "kurumsal gönderme": "#6e4b25", "zaman çizgisi bağlantısı": "#1abc9c", "remake": "#2ecc71",
      "Teori Bağlantısı": "#f1c40f", "duygu ve bilinç teması": "#9b59b6", "konseptsel Devam": "#34495e",
      "şehir yaşamı paralelliği": "#d35400", "karakter_bağlantısı": "#7d3c98",
      "Tema Ortaklığı": "#e84393",
    },
    edgeStyles: {
      "Devam": { width: 3, dashes: false },
      "Öncesi": { width: 2, dashes: [4, 6] }, "karakter geçişi": { width: 3, dashes: [10,4] },
      "evren geçişi": { width: 2.5, dashes: [6,4] }, "multiverse birleşmesi": { width: 2.5, dashes: [2,6] },
      "görsel gönderme": { width: 1.8, dashes: [2,6] }, "karakter göndermesi": { width: 2, dashes: [6,6] },
      "ön hikaye": { width: 2.2, dashes: false }, "yan hikaye": { width: 2, dashes: [8,6] },
      "tematik benzerlik": { width: 1.8, dashes: [12,6] }, "Teori Bağlantısı": { width: 1.8, dashes: [4,4] },
      "kurumsal gönderme": { width: 1.8, dashes: [2,8] }, "konseptsel Devam": { width: 2, dashes: false },
      "şehir yaşamı paralelliği": { width: 1.8, dashes: [10,8] }, "iç film/karakter kökeni": { width: 2, dashes: [5,5] },
      "paralel Kang anlatımı": { width: 2.5, dashes: [3,7] }
    },

    /* Legend: sadece kullanılan tipleri göster (evren seçiliyse) */
    
    get timelineSortedNodes(){
      const u = this.selectedUniverse;
      return [...this.allNodes]
        .filter(n => n.release_date && (!u || n.universe === u))
        .sort((a, b) => new Date(a.release_date) - new Date(b.release_date));
    },
    /* Timeline: Yıla göre gruplama (en yeni yıl en üstte) */
    get groupTimelineByYear(){
      const groups = new Map(); // year -> array of nodes
      for (const n of this.timelineSortedNodes) {
        const y = new Date(n.release_date).getFullYear();
        if (!groups.has(y)) groups.set(y, []);
        groups.get(y).push(n);
      }
      // İçerideki her yılı tarihine göre artan sırala
      for (const [y, arr] of groups.entries()) {
        arr.sort((a,b)=> new Date(a.release_date) - new Date(b.release_date));
      }
      // Yılları büyükten küçüğe sıralı bir dizi olarak döndür
      return Array.from(groups.entries())
        .sort((a,b)=> b[0]-a[0]); // [[year, nodes], ...]
    },

    get legendEntries() {
      const usedTypes = new Set(this.filteredEdges.map(e => e.type));
      return Object.entries(this.edgeColors).filter(([t]) => usedTypes.has(t) || !this.selectedUniverse);
    },

    /* Notlar: panel özeti (metinsiz) */
    get notesSummary(){
      // Flat notlar → node bazında grupla
      const groups = new Map(); // nodeId -> {count, tags:Set, label, universe}
      for (const [nodeId, arr] of Object.entries(this.notes)){
        if (!arr || !arr.length) continue;
        const node = this.nodes?.get(nodeId) || this.allNodes.find(n => String(n.id)===String(nodeId));
        const g = groups.get(nodeId) || { count: 0, tags: new Set(), label: node?.label || nodeId, universe: node?.universe || '' };
        g.count += arr.length;
        for (const n of arr) (n.tags||[]).forEach(t => g.tags.add(t));
        groups.set(nodeId, g);
      }
      // Filtreler: evren + etiket
      const u = this.notesUniverseFilter;
      const tagQ = (this.notesTagFilter || '').trim().replace(/^#/, '').toLowerCase();
      const list = Array.from(groups.entries()).map(([nodeId, g]) => ({
        nodeId, label: g.label, universe: g.universe,
        count: g.count,
        tags: Array.from(g.tags)
      }))
      .filter(x => (!u || x.universe === u) && (!tagQ || x.tags.some(t => t.includes(tagQ))))
      .sort((a,b)=> b.count - a.count || a.label.localeCompare(b.label));
      return list;
    },

getAllEdgesWithNotes(nodeId) {
  if (!nodeId) return [];
  // Hem giden hem gelen tüm kenarları al
  const connectedEdges = this.allEdges
    .filter(e => e.from === nodeId || e.to === nodeId)
    .map(e => {
      // Edge'teki diğer düğümün id ve label'ı
      const otherNodeId = e.from === nodeId ? e.to : e.from;
      const otherNode = this.allNodes.find(n => String(n.id) === String(otherNodeId));
      return {
        id: e.id || (e.from + "_" + e.to + "_" + (e.type || "")),
        otherNodeId,
        otherNodeLabel: otherNode?.label || otherNodeId,
        type: e.type,
        edgeHasNotes: !!e.notes,
        edgeNoteText: e.notes || "",
        nodeHasNotes: !!(this.notes && this.notes[otherNodeId] && this.notes[otherNodeId].length)
      };
    });
  return connectedEdges;
},



formatEdgeType(type) {
  // tip label'ını düzenle (örn. "Devam" → "Devam")
  if (!type) return '';
  return type.charAt(0).toUpperCase() + type.slice(1);
},

    
    /* Not etiketleri: en sık geçen ilk 10 etiketi döner (evren filtresi dikkate alınır) */
    get topTags(){
      const counts = new Map();
      const u = this.notesUniverseFilter;
      for (const [nodeId, arr] of Object.entries(this.notes)){
        if (!arr || !arr.length) continue;
        const node = this.allNodes.find(n => String(n.id) === String(nodeId));
        if (u && node?.universe !== u) continue;
        for (const n of arr) for (const t of (n.tags || [])) {
          counts.set(t, (counts.get(t) || 0) + 1);
        }
      }
      return Array.from(counts.entries())
        .sort((a,b) => b[1] - a[1])
        .slice(0, 10)
        .map(([t]) => t);
    },
/* ----- INIT ----- */
    init() {
      // Legend mobilde kapalı
      this.showLegend = window.innerWidth >= 640;

      // Migration: comments -> notes (bir kez)
      try {
        const old = localStorage.getItem('comments');
        if (old && !localStorage.getItem('notes')) { localStorage.setItem('notes', old); localStorage.removeItem('comments'); }
      } catch {}

      // Yerel veriler
      this.loadWatchLater(); this.loadNotes();

      // Arkaplan
      this.setBackgroundFor(this.selectedUniverse);
      this.warmBackgrounds();

      // Veri
      this.loadData();

      // Arama debounce + autocomplete (NOT: not metninde aramaz!)
      let debounceTimeout = null;
      this.$watch('search', (val) => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          this.applyFilters();
          if (val) {
            const lower = val.toLowerCase(), starts = [], contains = [], seen = new Set();
            for (const n of this.allNodes) {
              const lbl = n.label; if (!lbl) continue; const l = lbl.toLowerCase();
              if (l.startsWith(lower)) { if (!seen.has(lbl)) { starts.push(lbl); seen.add(lbl); } }
              else if (l.includes(lower)) { if (!seen.has(lbl)) { contains.push(lbl); seen.add(lbl); } }
              if (starts.length + contains.length >= 10) break;
            }
            this.suggestions = [...starts, ...contains];
          } else this.suggestions = [];
        }, 220);
      });

      // Evren değişince filtre + arkaplan
      this.$watch('selectedUniverse', (val) => { this.applyFilters(); this.setBackgroundFor(val); });
    },



    /* ----- BACKGROUND HELPERS ----- */
    async setBackgroundFor(universe){
      const primary = this.bgMap[universe || ""] || this.bgMap[""];
      const fallbacks = ["images/bg.jpg", "images/bg.jpg"];
      const tried = new Set();
      const tryLoad = (url) => new Promise((resolve,reject)=>{
        if(!url || tried.has(url)) return reject();
        tried.add(url);
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => reject();
        img.decoding = 'async'; img.referrerPolicy = 'no-referrer'; img.src = url;
      });
      for (const url of [primary, ...fallbacks]) {
        try { const ok = await tryLoad(url); this.bgUrl = ok; return; } catch {}
      }
    },
    warmBackgrounds(){ [...new Set(Object.values(this.bgMap))].forEach(u => { const i = new Image(); i.decoding='async'; i.src = u; }); },

    /* ----- WATCH LATER ----- */
    loadWatchLater(){ try { this.watchLater = JSON.parse(localStorage.getItem('watchLater') || '[]'); } catch { this.watchLater = []; } },
    saveWatchLater(){ localStorage.setItem('watchLater', JSON.stringify(this.watchLater)); },
    isInWatchLater(id){ return !!this.watchLater.find(x => String(x.id) === String(id)); },
    toggleWatchLater(node){
      if (!node?.id) return;
      if (this.isInWatchLater(node.id)) this.watchLater = this.watchLater.filter(x => String(x.id) !== String(node.id));
      else this.watchLater.unshift({ id: node.id, label: node.label || String(node.id) });
      this.saveWatchLater();
    },
    removeWatchLater(id){ this.watchLater = this.watchLater.filter(x => String(x.id) !== String(id)); this.saveWatchLater(); },

    /* ----- NOTES ----- */
    loadNotes(){ try { this.notes = JSON.parse(localStorage.getItem('notes')||'{}'); } catch { this.notes = {}; } },
    saveNotes(){ localStorage.setItem('notes', JSON.stringify(this.notes)); },
    extractTags(t){ return Array.from(t.matchAll(/#([\p{L}\d_-]+)/gu)).map(m=>m[1].toLowerCase()); },
    addNote(nodeId){
      const t = (this.newNote || '').trim(); if (!nodeId || !t) return;
      const item = { text: t, tags: this.extractTags(t), pin: false, ts: Date.now(), editedTs: null };
      (this.notes[nodeId] ||= []).unshift(item); this.newNote = ''; this.saveNotes();
    },
    togglePin(nodeId, idx){ const n = this.notes[nodeId]?.[idx]; if (!n) return; n.pin = !n.pin; this.saveNotes(); },
    deleteNote(nodeId, idx){ this.notes[nodeId].splice(idx, 1); this.saveNotes(); },

    /* Paylaşım (modal üstündeki butonlar) */
    buildNodeUrl(nodeId){
      const node = this.nodes?.get(nodeId) || this.allNodes.find(n => String(n.id)===String(nodeId));
      const u = node?.universe || '';
      const base = location.origin + location.pathname;
      const params = new URLSearchParams({ u, node: String(nodeId) });
      return `${base}?${params.toString()}`;
    },
    shareNode(node, platform){
      if (!node?.id) return;
      const url = this.buildNodeUrl(node.id);
      const text = `${node.label || node.id} — ${this.formatUniverseName(node.universe)}\n${url}`;
      const enc = encodeURIComponent(text);
      const shareUrl = platform === 'whatsapp'
        ? `https://api.whatsapp.com/send?text=${enc}`
        : platform === 'x'
          ? `https://twitter.com/intent/tweet?text=${enc}`
          : '';
      if (shareUrl) window.open(shareUrl, '_blank', 'noopener');
    },

    /* ----- DATA & GRAPH ----- */
    async loadData() {
      const evrenler = ["avatar_last_airbender","avatar_pandora","dc","harrypotter","marvel","matrix","middleearth","pixar","starwars"];
      try {
        const results = await Promise.all(evrenler.map(evren =>
          fetch('data/' + evren + '.json', { cache: 'no-store' }).then(r => { if (!r.ok) throw new Error(evren + ' yüklenemedi'); return r.json().then(data => ({ evren, data })); })
        ));
        let nodesTemp = [], edgesTemp = [];
        for (const { evren, data } of results) { nodesTemp = nodesTemp.concat(data.nodes.map(n => ({ ...n, universe: evren }))); edgesTemp = edgesTemp.concat(data.edges); }
        this.allNodes = nodesTemp; this.allEdges = edgesTemp; this.universeList = [...new Set(this.allNodes.map(n => n.universe))];

        // Posterleri ısıt (cache)
        this.allNodes.filter(n => n.image).forEach(n => { const i = new Image(); i.decoding='async'; i.src = n.image; });

        this.setupNetwork(); this.applyFilters();

        // URL deep-link: ?u=&node=
        const params = new URLSearchParams(location.search);
        const qU = params.get('u'); const qNode = params.get('node');
        if (qU && this.universeList.includes(qU)) this.selectedUniverse = qU;
        this.applyFilters();
        if (qNode && (this.nodes?.get(qNode))) {
          this.modalNode = this.nodes.get(qNode); this.modalOpen = true;
          this.network.selectNodes([qNode]); this.network.focus(qNode, { animation: true, scale: 1 });
        }
      } catch (err) { console.error(err); alert('Veri yükleme hatası: ' + err.message); }
    },

   openNode(id) {
      const node = this.nodes?.get(id) || this.allNodes.find(n => String(n.id) === String(id));
      if (node) {
        this.modalNode = node;
        this.modalOpen = true;
        this.network?.selectNodes([id]);
        this.network?.focus(id, { animation: true, scale: 1 });
      }
    },

    makeOptions() {
      return {
        nodes: { size: 25, font: { color: '#e5e7eb', size: 14 }, borderWidthSelected: 6, color: { border: '#ef4444' } },
        edges: { arrows: { to: { enabled: true, scaleFactor: 0.5 } }, smooth: { enabled: true, type: 'dynamic' } },
        interaction: { hover: true, tooltipDelay: 200, zoomView: true, dragView: true },
        physics: { stabilization: true, barnesHut: { gravitationalConstant: -4000 } },
        layout: { improvedLayout: true }
      };
    },

    setupNetwork() {
      this.nodes = new vis.DataSet(); this.edges = new vis.DataSet();
      const container = document.getElementById('network');
      this.network = new vis.Network(container, { nodes: this.nodes, edges: this.edges }, this.makeOptions());
      this.network.on('click', params => {
        if (params.nodes.length > 0) {
          const node = this.nodes.get(params.nodes[0]);
          requestAnimationFrame(() => {
            this.modalNode = node;
            this.modalOpen = true;
          });
        }
      });
    },

    applyFilters() {
      const searchTerm = (this.search || '').toLowerCase(); const universe = this.selectedUniverse;

      // NOT: Not metninde arama YAPMA
      this.filteredNodes = this.allNodes.filter(n =>
        (!universe || n.universe === universe) &&
        (!searchTerm || (n.label && n.label.toLowerCase().includes(searchTerm)))
      );

      const nodeIds = new Set(this.filteredNodes.map(n => n.id));
      this.filteredEdges = this.allEdges.filter(e => nodeIds.has(e.from) && nodeIds.has(e.to));

      this.updateNetwork();
      if (this.network) {
        if (this.fitTimeout) clearTimeout(this.fitTimeout);
        this.fitTimeout = setTimeout(() => this.network.fit({ animation: true }), 220);
      }
    },

    updateNetwork() {
      this.nodes.clear(); this.edges.clear();

      // Node’lar + not sayısı rozeti
      this.nodes.add(this.filteredNodes.map(n => {
        const hasImage = !!n.image; const noteCount = (this.notes[n.id]?.length || 0);
        return {
          ...n,
          label: noteCount ? `${n.label}\n📝 ${noteCount}` : n.label,
          font: { color: '#e5e7eb', size: 14, multi: true, vadjust: 4 },
          shape: hasImage ? 'circularImage' : 'dot',
          borderWidth: 2, borderWidthSelected: 6,
          color: hasImage ? { border: '#ef4444' } : { background: '#ef4444', border: '#ef4444' }
        };
      }));

      // Edge’ler (renk + çizgi stili)
      this.edges.add(this.filteredEdges.map(e => {
        const color = this.edgeColors[e.type] || '#9ca3af';
        const s = this.edgeStyles[e.type] || { width: 1.5, dashes: false };
        return { ...e, arrows: 'to', color: { color }, width: s.width, dashes: s.dashes };
      }));
    },

    neighborChips(nodeId) {
      if (!nodeId || !this.network) return '';
      const neighbors = this.network.getConnectedNodes(nodeId).map(id => this.nodes.get(id)).filter(Boolean);
      if (!neighbors.length) return '<span class="text-sm opacity-70">Bağlantı bulunamadı.</span>';
      return neighbors.map(n => `<button class="chip hover:brightness-110" onclick="window.__openNode('${String(n.id).replace(/'/g,'&#39;')}')">${n.label ? n.label.replace(/</g,'&lt;') : 'ID ' + n.id}</button>`).join('');
    },

    formatUniverseName(name) {
      const map = { "avatar_last_airbender": "Avatar: Son Hava Bükücü", "avatar_pandora": "Avatar (Pandora)", "dc": "DC", "marvel": "Marvel", "harrypotter": "Harry Potter", "matrix": "Matrix", "middleearth": "Orta Dünya", "pixar": "Pixar", "starwars": "Star Wars" };
      return map[name] || name;
    }
  }
}
window.openNode = function(id) {
  const scope = document.querySelector('html')?.__x?.$data;
  if (!scope?.openNode) return;
  scope.openNode(id);
};


window.__openNode = function(id) {
  // HTML ana elemanında __x yoksa tüm x-data alanlarını tara
  let scope = document.querySelector('html')?.__x?.$data;
  if (!scope?.nodes) {
    // Fallback: Herhangi bir x-data (app) scope’u bul
    for (const el of document.querySelectorAll('[x-data]')) {
      if (el.__x && el.__x.$data?.nodes) {
        scope = el.__x.$data;
        break;
      }
    }
  }
  if (!scope?.nodes) return;
  const node = scope.nodes.get(id);
  if (node) {
    requestAnimationFrame(() => {
      scope.modalNode = node;
      scope.modalOpen = true;
      scope.network.selectNodes([id]);
      scope.network.focus(id, { animation: true, scale: 1 });
    });
  }
};

</script>


<!-- Service Worker kaydı -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered', reg.scope))
      .catch(err => console.warn('SW register failed', err));
  });
}
</script>

<script>
  const SHARE_PHRASES = {
    more: 'Devamı için ziyaret et:',
    farewell: 'Sinemayla kalın.',
    dash: ' — ',
  };

  const EMOJI = {
    title: '🎬',     // film adı başı
    date: '📅',      // tarih başı
    summary: '📝',   // 3. satır başı
    more: '👉',      // CTA sonu
    link: '🔗',      // link başı
    bye: '🍿',       // uğurlama sonu
  };

  function preferredUrl(node) {
    const base = typeof window !== 'undefined'
      ? window.location.origin + window.location.pathname
      : '';
    const id = node?.id ? `#${node.id}` : '';
    return node?.url || base + id;
  }

  // YYYY-MM-DD → gg/aa/yyyy (sadece 2. satır için)
  function toTRDate(value) {
    if (!value) return '';
    const s = String(value).trim();
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if (m) return `${m[3]}/${m[2]}/${m[1]}`;
    const d = new Date(s);
    if (isNaN(d)) return s;
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  // Kısaltma: en fazla max karakter, keserse "..." ekler
  function truncateDots(text, max) {
    const t = (text || '').trim();
    if (!t) return '';
    if (t.length <= max) return t;
    return t.slice(0, Math.max(0, max - 3)).trimEnd() + '...';
  }

  // Satırın sonunda nokta yoksa ekle
  function ensurePeriod(line) {
    if (!line) return '';
    return /[.!?…]$/.test(line.trim()) ? line : line.trim() + '.';
  }

  function composeShareText(node) {
    // 1) Film adı (etiketsiz, başında emoji)
    const filmAdi  = node?.label || node?.title || node?.name || 'Bu yapım';
    const line1 = `${EMOJI.title} ${filmAdi}`;

    // 2) Tarih (gg/aa/yyyy, başında emoji)
    const takvimTR = toTRDate(node?.release_date || node?.date);
    const line2 = takvimTR ? `${EMOJI.date} ${takvimTR}` : '';

    // 3) Film Özeti & Göndermeler (etiketli, kısaltılmış, sonu "...")
    const aciklamaFull    = (node?.description || '').trim();
    const gondermelerFull = (node?.refers_to || '').trim();

    // kısaltma limitleri (istersen değiştir)
    const aciklama    = truncateDots(aciklamaFull, 120);
    const gondermeler = truncateDots(gondermelerFull, 100);

    let line3 = '';
    if (aciklama && gondermeler) {
      line3 = `${EMOJI.summary} Film Özeti: ${aciklama}${SHARE_PHRASES.dash}Göndermeler: ${gondermeler}`;
    } else if (aciklama) {
      line3 = `${EMOJI.summary} Film Özeti: ${aciklama}`;
    } else if (gondermeler) {
      line3 = `${EMOJI.summary} Göndermeler: ${gondermeler}`;
    }
    if (line3) line3 = ensurePeriod(line3); // satırı noktayla bitir

    // 4–6) CTA, link, uğurlama
    const url = preferredUrl(node);
    const line4 = `${SHARE_PHRASES.more} ${EMOJI.more}`;
    const line5 = `${EMOJI.link} ${url}`;
    const line6 = `${SHARE_PHRASES.farewell} ${EMOJI.bye}`;

    return [line1, line2, line3, line4, line5, line6]
      .filter(Boolean)
      .join('\n');
  }

  // X için tek satır (URL ayrı parametre)
  function composeShareTextForX(node, max = 240) {
    const url = preferredUrl(node);
    const single = composeShareText(node).replace(/\n+/g, ' | ');
    const withoutUrl = single.replace(url, '').replace(/\s*\|\s*\|\s*/g, ' | ').trim();
    return withoutUrl.length <= max ? withoutUrl : (withoutUrl.slice(0, max - 1) + '…');
  }

  // Paylaş işlevleri
  window.shareToX = function(node) {
    const url = preferredUrl(node);
    const text = composeShareTextForX(node);
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
      '_blank','noopener,noreferrer');
  };
  window.shareToWhatsApp = function(node) {
    const text = composeShareText(node);
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`,
      '_blank','noopener,noreferrer');
  };
  window.shareToLinkedIn = function(node) {
    const url  = preferredUrl(node);
    const name = node?.label || node?.title || node?.name || 'Bu yapım';
    const sum  = composeShareText(node);
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(name)}&summary=${encodeURIComponent(sum)}`,
      '_blank','noopener,noreferrer');
  };
  window.copyShare = async function(node) {
    const full = composeShareText(node) + '\n';
    try { await navigator.clipboard.writeText(full); alert('Paylaşım metni ve link kopyalandı.'); }
    catch {
      const ta = document.createElement('textarea'); ta.value = full; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      alert('Paylaşım metni ve link kopyalandı.');
    }
  };
</script>

<script>
  window.toTRDate = function(value) {
    if (!value) return '';
    const s = String(value).trim();
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if (m) return `${m[3]}/${m[2]}/${m[1]}`;
    const d = new Date(s);
    if (isNaN(d)) return s;
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  };
</script>

</template>
    </div>
  </div>
</div>

</body>
</html>
