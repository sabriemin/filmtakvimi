<!DOCTYPE html>
<html lang="tr" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film Evreni Aƒüƒ± - Legend Dahil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    html, body, #network {
      height: 100%; margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    #network {
      border-radius: 12px; margin: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      border: 1px solid #e2e8f0;
    }
    select, input {
      color: black;
    }
    body.dark select, body.dark input {
      color: white;
    }
    select option {
      color: black;
    }
    body.dark select option {
      color: white;
    }
    .modal-bg { background: rgba(0,0,0,0.75); backdrop-filter: blur(3px); }
    .modal-content {
      max-width: 600px; width: 90vw;
      max-height: 80vh; overflow-y: auto;
      background: white; border-radius: 16px;
      padding: 24px; box-shadow: 0 12px 24px rgba(0,0,0,0.25);
      position: relative;
    }
    .close-btn {
      position: absolute; top: 16px; right: 16px;
      font-size: 28px; font-weight: 700; cursor: pointer;
      color: #374151;
    }
    .close-btn:hover { color: #ef4444; }
    #legend {
      position: fixed; bottom: 16px; left: 16px;
      background: white; border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      max-width: 320px; max-height: 240px;
      overflow-y: auto; padding: 12px 16px;
      font-size: 0.85rem; z-index: 40;
    }
    body.dark {
      background-color: #111827; color: #d1d5db;
    }
    body.dark #network {
      background-color: #1f2937; border-color: #374151;
    }
    body.dark header {
      background-color: #1f2937; color: #d1d5db;
    }
    body.dark .modal-content {
      background-color: #1f2937; color: #d1d5db;
    }
    body.dark #legend { background-color: #1f2937; color: #d1d5db; }
  </style>
</head>
<body :class="{ dark: isDarkMode, 'overflow-hidden': modalOpen }">

<header class="bg-white dark:bg-gray-800 shadow sticky top-0 z-50 p-4 flex flex-wrap gap-2 justify-between items-center">
  <h1 class="text-xl font-bold" x-text="lang === 'tr' ? 'üé¨ Film Evreni Aƒüƒ±' : 'üé¨ Film Universe Network'"></h1>
  <div class="w-full sm:w-auto flex flex-col sm:flex-row gap-2 items-stretch sm:items-center justify-end">
    <input x-model="search" :placeholder="lang === 'tr' ? 'Ara...' : 'Search...'" class="border rounded px-3 py-1 text-black dark:text-white bg-white dark:bg-gray-700" />

    <select x-model="selectedUniverse" class="border rounded px-2 py-1 text-black dark:text-white bg-white dark:bg-gray-700">
      <option value="" x-text="lang === 'tr' ? 'T√ºm Evrenler' : 'All Universes'"></option>
      <template x-for="u in universeList" :key="u">
        <option :value="u" x-text="formatUniverseName(u)"></option>
      </template>
    </select>

    <select x-model="selectedEdgeType" class="border rounded px-2 py-1 text-black dark:text-white bg-white dark:bg-gray-700">
      <option value="" x-text="lang === 'tr' ? 'T√ºm Baƒülantƒ±lar' : 'All Edges'"></option>
      <template x-for="t in edgeTypeList" :key="t">
        <option :value="t" x-text="t"></option>
      </template>
    </select>

    <input type="range" min="1950" max="2030" x-model.number="maxYear" class="w-32" />

    <button @click="toggleTimeline" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">
      <span x-text="timelineMode ? (lang === 'tr' ? 'üîÑ Normal' : 'üîÑ Normal') : (lang === 'tr' ? '‚è≥ Zaman' : '‚è≥ Timeline')"></span>
    </button>

    <button @click="toggleTheme" class="bg-yellow-400 text-black px-2 py-1 rounded">
      <span x-text="isDarkMode ? (lang === 'tr' ? 'üåô Koyu' : 'üåô Dark') : (lang === 'tr' ? 'üåû A√ßƒ±k' : 'üåû Light')"></span>
    </button>

    <select x-model="lang" class="border rounded px-2 py-1 text-black dark:text-white bg-white dark:bg-gray-700">
      <option value="tr">T√ºrk√ße</option>
      <option value="en">English</option>
    </select>
  </div>
</header>

<div id="network" class="flex-grow"></div>

<!-- Modal -->
<div x-show="modalOpen" x-transition class="fixed inset-0 modal-bg flex items-center justify-center z-50 p-4" @click.away="modalOpen = false">
  <div class="modal-content" role="dialog" aria-modal="true" @click.stop>
    <button class="close-btn" @click="modalOpen = false">‚úñ</button>
    <h2 class="text-xl font-bold" x-text="modalNode?.label"></h2>
    <p x-text="(lang === 'tr' ? 'Evren: ' : 'Universe: ') + modalNode?.universe"></p>
    <p><strong x-text="lang === 'tr' ? 'Vizyon: ' : 'Release: '"></strong><span x-text="modalNode?.release_date || '-' "></span></p>
    <p><strong x-text="lang === 'tr' ? 'T√ºr: ' : 'Type: '"></strong><span x-text="modalNode?.type"></span></p>
    <p class="mt-2 whitespace-pre-wrap" x-text="modalNode?.description || (lang === 'tr' ? 'A√ßƒ±klama yok.' : 'No description.')"></p>
    <p class="italic border-l-4 border-red-500 pl-2 mt-2 text-sm" x-text="(lang === 'tr' ? 'G√∂ndermeler: ' : 'References: ') + (modalNode?.refers_to || '-')"></p>
  </div>
</div>

<!-- Legend -->
<div id="legend">
  <h3 class="font-bold mb-2" x-text="lang === 'tr' ? 'Baƒülantƒ± T√ºrleri' : 'Edge Types'"></h3>
  <ul>
    <template x-for="(color, type) in edgeColors" :key="type">
      <li class="flex items-center mb-1">
        <span class="w-4 h-4 rounded mr-2" :style="`background-color: ${color}`"></span>
        <span x-text="type"></span>
      </li>
    </template>
  </ul>
</div>

<script>

function app() {
  return {
    network: null,
    allNodes: [],
    allEdges: [],
    nodes: null,
    edges: null,
    filteredNodes: [],
    filteredEdges: [],
    search: '',
    selectedUniverse: '',
    selectedEdgeType: '',
    maxYear: new Date().getFullYear(),
    timelineMode: false,
    modalOpen: false,
    modalNode: null,
    universeList: [],
    edgeTypeList: [],
    isDarkMode: false,
    lang: 'tr',

    edgeColors: {
      "devam": "#2980b9",
      "√∂n hikaye": "#e67e22",
      "yan hikaye": "#8e44ad",
      "evren ge√ßi≈üi": "#c0392b",
      "g√∂rsel g√∂nderme": "#7f8c8d",
      "karakter g√∂ndermesi": "#27ae60",
      "kurumsal g√∂nderme": "#6e4b25",
      "zaman √ßizgisi baƒülantƒ±sƒ±": "#1abc9c",
      "karakter ge√ßi≈üi": "#2ecc71",
      "tematik benzerlik": "#f1c40f",
      "duygu ve bilin√ß temasƒ±": "#9b59b6",
      "konseptsel devam": "#34495e",
      "≈üehir ya≈üamƒ± paralelliƒüi": "#d35400",
      "i√ß film/karakter k√∂keni": "#7d3c98",
      "multiverse birle≈ümesi": "#e84393",
      "paralel Kang anlatƒ±mƒ±": "#16a085"
    },

    init() {
      this.loadData();
      this.isDarkMode = localStorage.getItem('darkMode') === 'true';
      this.lang = localStorage.getItem('lang') || 'tr';

      let debounceTimeout = null;
      this.$watch('search', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          this.applyFilters();
        }, 300);
      });

      this.$watch('selectedUniverse', () => this.applyFilters());
      this.$watch('selectedEdgeType', () => this.applyFilters());
      this.$watch('maxYear', () => this.applyFilters());
    },

    async loadData() {
      const evrenler = [
        "avatar_last_airbender",
        "avatar_pandora",
        "dc",
        "harrypotter",
        "marvel",
        "matrix",
        "middleearth",
        "pixar",
        "starwars"
      ];
      let nodesTemp = [];
      let edgesTemp = [];
      for (const evren of evrenler) {
        const res = await fetch('data/' + evren + '.json');
        const data = await res.json();
        nodesTemp = nodesTemp.concat(data.nodes.map(n => ({...n, universe: evren})));
        edgesTemp = edgesTemp.concat(data.edges);
      }
      this.allNodes = nodesTemp;
      this.allEdges = edgesTemp;

      this.universeList = [...new Set(this.allNodes.map(n => n.universe))];
      this.edgeTypeList = [...new Set(this.allEdges.map(e => e.type))].filter(t => t);

      this.setupNetwork();
      this.applyFilters();
    },

    setupNetwork() {
      this.nodes = new vis.DataSet();
      this.edges = new vis.DataSet();
      const container = document.getElementById('network');
      const data = { nodes: this.nodes, edges: this.edges };
      const options = {
        nodes: {
          size: 25,
          font: { color: '#fff', size: 14 },
          borderWidthSelected: 6,
          color: { border: '#ef4444' }
        },
        edges: {
          arrows: { to: { enabled: true, scaleFactor: 0.5 } },
          smooth: {
            enabled: true,
            type: 'dynamic'
          }
        },
        interaction: { hover: true, tooltipDelay: 200 },
        physics: {
          stabilization: true,
          barnesHut: { gravitationalConstant: -4000 }
        },
        layout: { improvedLayout: true }
      };
      this.network = new vis.Network(container, data, options);

      this.network.on('click', params => {
        if(params.nodes.length > 0){
          const node = this.nodes.get(params.nodes[0]);
          this.modalNode = node;
          this.modalOpen = true;
        }
      });
    },

    applyFilters() {
      const searchTerm = this.search.toLowerCase();
      const universe = this.selectedUniverse;
      const edgeType = this.selectedEdgeType;
      const maxYear = this.maxYear;

      this.filteredNodes = this.allNodes.filter(n =>
        (!universe || n.universe === universe) &&
        (!searchTerm || (n.label && n.label.toLowerCase().includes(searchTerm))) &&
        (!maxYear || !n.release_date || new Date(n.release_date).getFullYear() <= maxYear)
      );

      const nodeIds = new Set(this.filteredNodes.map(n => n.id));

      this.filteredEdges = this.allEdges.filter(e =>
        nodeIds.has(e.from) && nodeIds.has(e.to) &&
        (!edgeType || e.type === edgeType)
      );

      this.updateNetwork();
      if(this.network) {
        if(this.fitTimeout) clearTimeout(this.fitTimeout);
        this.fitTimeout = setTimeout(() => {
          this.network.fit({animation: true});
        }, 300);
      }
    },

    updateNetwork() {
      this.nodes.clear();
      this.edges.clear();

      this.nodes.add(this.filteredNodes.map(n => ({
        ...n,
        shape: 'circularImage',
        borderWidth: 2,
        borderWidthSelected: 6,
        color: { border: '#ef4444' }
      })));

      this.edges.add(this.filteredEdges.map(e => {
        let color = this.edgeColors[e.type] || '#888';
        let width = (e.type === 'devam' || e.type === 'karakter ge√ßi≈üi') ? 3 : 1.5;
        return {
          ...e,
          arrows: 'to',
          color: { color },
          width
        };
      }));
    },

    toggleTimeline() {
      this.timelineMode = !this.timelineMode;
      this.applyFilters();
    },

    toggleTheme() {
      this.isDarkMode = !this.isDarkMode;
    },
      formatUniverseName(name) {
      const map = {
        "avatar_last_airbender": "Avatar: Son Hava B√ºk√ºc√º",
        "avatar_pandora": "Avatar (Pandora)",
        "dc": "DC",
        "marvel": "Marvel",
        "harrypotter": "Harry Potter",
        "matrix": "Matrix",
        "middleearth": "Orta D√ºnya",
        "pixar": "Pixar",
        "starwars": "Star Wars"
      };
      return map[name] || name;
    },
  }
}
</script>

</body>
</html>
