<!DOCTYPE html>

<html lang="tr" x-data="app()" x-init="init()">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Film Evreni Ağı</title>
<script src="assets/js/easter-eggs-ids.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.4.1/dist/js/shepherd.min.js"></script>
<script src="assets/js/shepherd.min.js"></script>


<style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; color: #d1d5db; font-family: 'Segoe UI', system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial, sans-serif; background: transparent; }
    #bgImg{ position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(12px) brightness(0.65); transform: scale(1.06); z-index: -2; backface-visibility: hidden; will-change: transform; }
    #bgOverlay{ position: fixed; inset: 0; z-index:-1; background: rgba(0,0,0,0.35); }
    #network { position: fixed; inset: 0; background: transparent; border: none; }
    .glass { background: rgba(31,41,55,0.45); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 12px 30px rgba(0,0,0,0.35); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); }
    input { color: #e5e7eb; background-color: rgba(55,65,81,0.55); border: 1px solid rgba(255,255,255,0.12); outline: none; }
    input::placeholder { color: #9ca3af; }
    .ac-panel { background: rgba(31,41,55,0.9); border: 1px solid rgba(255,255,255,0.14); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 14px 28px rgba(0,0,0,0.5); }
    .ac-item { cursor: pointer; }
    .ac-item:hover { background: rgba(255,255,255,0.08); }
    .dropdown-btn { cursor: pointer; }
    .dropdown-panel { background: rgba(31,41,55,0.95); border: 1px solid rgba(255,255,255,0.14); box-shadow: 0 16px 40px rgba(0,0,0,0.45); backdrop-filter :blur(6px); -webkit-backdrop-filter: blur(6px); }
    .dropdown-item { cursor: pointer; }
    .dropdown-item:hover { background: rgba(255,255,255,0.06); }
    .modal-bg { background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); }
    .modal-content { width: 92vw; max-width: 780px; max-height: 85vh; overflow-y: auto; background: #0f172a; color: #e5e7eb; border-radius: 18px; padding: 0; box-shadow: 0 12px 24px rgba(0,0,0,0.45); position: absolute; top: 10px; border: 1px solid rgba(255,255,255,0.08); }
    .modal-header { display: grid; grid-template-columns: 120px 1fr; gap: 16px; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.06); background: radial-gradient(1200px 400px at -20% -40%, rgba(239,68,68,0.08), transparent); }
    .poster { width: 120px; height: 160px; border-radius: 10px; object-fit: cover; background: #111827; border: 1px solid rgba(255,255,255,0.08); }
    .modal-body { padding: 16px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); padding: 4px 10px; border-radius: 999px; font-size: 12px; }
    .meta-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
    .meta-item { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); padding: 10px 12px; border-radius: 12px; }
    .section-title { font-size: 0.9rem; opacity: 0.85; margin-bottom: 6px; }
    .close-btn { position: absolute; top: 12px; right: 12px; width: 36px; height: 36px; border-radius: 999px; display: grid; place-items: center; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
    .close-btn:hover { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.5); }
    #legendWrap { position: fixed; left: 16px; bottom: 4.5rem; z-index: 40; }
    #legendToggle { margin-bottom: 8px; background: rgba(31,41,55,0.55); border: 1px solid rgba(255,255,255,0.14); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); }
    #legend { background: rgba(31,41,55,0.45); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 8px 18px rgba(0,0,0,0.35); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: 12px; padding: 12px 16px; max-width: 320px; max-height: 260px; overflow-y: auto; font-size: 0.85rem; }
    @media (max-width: 640px) { #legend { font-size: 0.72rem; max-width: 220px; padding: 8px 10px; } }
    .share-bar { position: absolute; top: 8px; left: 12px; right: 56px; display:flex; align-items:center; gap:8px; opacity:.95; }
    .share-btn { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.14); font-size:12px; }
    .share-btn:hover { background: rgba(255,255,255,0.1); }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  </style>

<style>
  #network {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    border: none;
    z-index: 0;
  }
</style>


<!-- Shepherd.js CSS ve JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.4.1/dist/js/shepherd.min.js"></script>


<style>
  
  .shepherd-cancel-icon {
    color: #fff !important;
  }
</style>
<style>
  
  .shepherd-cancel-icon {
    color: #fff !important;
  }
</style>


<style>
.shepherd-element {
  max-width: 85vw;
  min-width: auto;
  max-height: 20vh;
  height: auto;
  overflow-y: auto;
  padding: 0.5rem;
  font-size: 0.2rem;
  backdrop-filter: blur(12px);
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  color: white;
}

@media (min-width: 640px) {
  .shepherd-element {
    max-width: 260px;
  }
}

  .shepherd-text,
  .shepherd-title,
  .shepherd-button {
    color: white !important;
  }

  .shepherd-header {
    background: transparent !important;
    border-bottom: none !important;
  }

  .shepherd-button {
    background-color: #2564eb73;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.7rem;
    border: none;
    margin-left: 0.2rem;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }

  .shepherd-button:hover {
    background-color: #1d4ed8;
  }

  .shepherd-cancel-icon {
    color: white !important;
  }
</style>


<style>
  .tl-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); z-index: 70; }
  .tl-panel { position: fixed; left: 0; right: 0; bottom: 0; background: rgba(17,24,39,0.98); border-top: 1px solid rgba(255,255,255,0.1); z-index: 80; max-height: 70vh; }
  .tl-year { font-weight: 700; opacity: .9; }
  .tl-col { min-width: 260px; max-width: 280px; }
  .tl-card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 10px; cursor: pointer; transition: transform .15s ease, background .15s ease; }
  .tl-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.06); }
  .tl-poster { width: 52px; height: 72px; border-radius: 8px; object-fit: cover; background: #0b1220; border: 1px solid rgba(255,255,255,0.08); }
  .tl-badge { font-size: 10px; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); }
</style>


<style>
  .tl-scroll { -webkit-overflow-scrolling: touch; overscroll-behavior-inline: contain; }
</style>

<style>
  /* IMDb slider custom look */
  .imdb-range { -webkit-appearance: none; appearance: none; height: 6px; border-radius: 999px; background: #334155; outline: none; }
  .imdb-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 999px; background: white; border: 2px solid rgba(234,179,8,0.9); box-shadow: 0 0 0 4px rgba(234,179,8,0.15); cursor: pointer; }
  .imdb-range::-moz-range-thumb { width: 18px; height: 18px; border-radius: 999px; background: white; border: 2px solid rgba(234,179,8,0.9); box-shadow: 0 0 0 4px rgba(234,179,8,0.15); cursor: pointer; }
  .imdb-range::-webkit-slider-runnable-track { height: 6px; border-radius: 999px; background: transparent; }
  .imdb-range::-moz-range-track { height: 6px; border-radius: 999px; background: transparent; }
  .imdb-badge { backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
</style>


<style>
  .lazy-blur { filter: blur(10px) brightness(0.9); transition: filter .25s ease; }
  .lazy-blur.lazy-done { filter: none; }
  /* Focus ring for accessibility */
  :is(a, button, [role="button"], input, select, textarea):focus-visible {
    outline: 2px solid #22c55e; /* emerald-500 */
    outline-offset: 2px;
  }
</style>


<style>
  #legend [data-edge-type] { cursor: pointer; user-select: none; }
  #legend [data-edge-type].is-active {
    background: rgba(16,185,129,0.18); /* emerald-500 at low opacity */
    border-color: rgba(16,185,129,0.4) !important;
    box-shadow: 0 0 0 1px rgba(16,185,129,0.35) inset;
  }
</style>


<style>
  .share-sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 9999; }
  .share-sheet { position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%); width: 92vw; max-width: 520px;
                 background: rgba(17,24,39,0.98); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px;
                 box-shadow: 0 20px 40px rgba(0,0,0,0.5); padding: 16px; color: #fff; z-index: 10000; }
  .share-grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 8px; }
  .share-tile { display:flex; flex-direction:column; align-items:center; gap:6px; padding:10px; border-radius:12px;
                background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); cursor:pointer; }
  .share-tile:hover { background: rgba(255,255,255,0.12); }
  .share-input { width:100%; padding:8px 10px; border-radius:10px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.15); color:#fff; }
  .share-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
</style>


<style>
  /* share-brand icon sizing */
  .share-tile img.share-icon { width: 22px; height: 22px; border-radius: 4px; }
  .share-tile svg.share-icon { width: 22px; height: 22px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  .share-opt { display:flex; align-items:center; gap:.5rem; }
  .share-opt input[type="checkbox"] { width: 14px; height: 14px; }
  .share-row { display:grid; grid-template-columns: 1fr auto; gap:.5rem; align-items:center; }
  .share-textarea { width:100%; min-height:72px; max-height:160px; resize:vertical;
    padding:10px;border-radius:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);color:#fff; }
  .counter { font-size:11px; opacity:.75; }
  .chip-mini { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.08); cursor:pointer; }
  .chip-mini:hover { background: rgba(255,255,255,.15); }
</style>


<script>
// TMDB-first image resolver
window.getNodeImage = function(node) {
  try {
    if (!node) return 'assets/images/default.jpg';
    // explicit tmdb_image field has top priority
    if (node.tmdb_image && typeof node.tmdb_image === 'string' && node.tmdb_image.trim()) {
      return node.tmdb_image;
    }
    // if generic image points to TMDB, keep as-is
    if (node.image && typeof node.image === 'string' && node.image.includes('image.tmdb.org')) {
      return node.image;
    }
    // optional poster_path from TMDB payloads (if present)
    if (node.poster_path && typeof node.poster_path === 'string' && node.poster_path.trim()) {
      // allow both full and relative paths
      if (node.poster_path.startsWith('http')) return node.poster_path;
      // default TMDB base for w342 size (balanced quality/weight)
      return 'https://image.tmdb.org/t/p/w342' + (node.poster_path.startswith('/') ? node.poster_path : '/' + node.poster_path);
    }
    // fallback to local image or a default placeholder
    return node.image || 'assets/images/default.jpg';
  } catch (e) {
    return (node && node.image) || 'assets/images/default.jpg';
  }
};

// At runtime, if Alpine app exposes node lists, normalize their image fields
document.addEventListener('alpine:init', () => {
  queueMicrotask(() => {
    try {
      const rootEl = document.querySelector('[x-data]');
      if (!rootEl || !window.Alpine) return;
      const root = Alpine.$data(rootEl);
      // If nodes already loaded, rewrite image URLs to TMDB-first
      const rewrite = (n) => ({ ...n, image: window.getNodeImage(n) });
      if (Array.isArray(root?.allNodes)) {
        root.allNodes = root.allNodes.map(rewrite);
      }
      if (Array.isArray(root?.nodesRaw)) {
        root.nodesRaw = root.nodesRaw.map(rewrite);
      }
      // If there is a method that rebuilds the graph, try to call it
      if (typeof root?.applyFilters === 'function') {
        try { root.applyFilters(); } catch {}
      } else if (typeof root?.renderGraph === 'function') {
        try { root.renderGraph(); } catch {}
      }
    } catch (e) { /* silent */ }
  });
});
</script>


<script>
// Ensure vis-network node images are also TMDB-first
(function () {
  function rewriteNode(n) {
    if (!n || typeof n !== 'object') return n;
    // Only touch if looks like a node
    if ('image' in n || 'tmdb_image' in n || 'poster_path' in n) {
      n = { ...n, image: (window.getNodeImage ? window.getNodeImage(n) : n.image) };
      // If the graph relies on a specific shape for images, enforce it (non-destructive)
      if (!n.shape) n.shape = 'circularImage';
      if (!n.brokenImage) n.brokenImage = 'assets/images/default.jpg';
    }
    return n;
  }

  function patchDataSet() {
    try {
      if (!window.vis || !window.vis.DataSet) return false;
      const DS = window.vis.DataSet;
      const pa = DS.prototype.add;
      const pu = DS.prototype.update;

      if (!DS.__tmdb_patched) {
        DS.prototype.add = function (data, id) {
          if (Array.isArray(data)) data = data.map(rewriteNode);
          else data = rewriteNode(data);
          return pa.call(this, data, id);
        };
        DS.prototype.update = function (data, id) {
          if (Array.isArray(data)) data = data.map(rewriteNode);
          else data = rewriteNode(data);
          return pu.call(this, data, id);
        };
        DS.__tmdb_patched = true;
      }
      return true;
    } catch (e) { return false; }
  }

  function retrofitExisting() {
    // Try common locations used by apps to store the nodes DataSet
    const candidates = [
      window.nodes,
      window.networkNodes,
      window.graphNodes,
      (window.Alpine && (function() {
        try {
          const el = document.querySelector('[x-data]');
          return el ? Alpine.$data(el).nodes : null;
        } catch(e){ return null; }
      })())
    ].filter(Boolean);

    candidates.forEach(ds => {
      try {
        if (typeof ds.getIds === 'function' && typeof ds.update === 'function' && typeof ds.get === 'function') {
          const all = ds.get();
          const fixed = all.map(rewriteNode);
          ds.update(fixed);
        }
      } catch (e) {}
    });
  }

  // Try immediately, then again on DOM ready, then after a short delay
  (function spinTries(tries) {
    if (patchDataSet()) {
      retrofitExisting();
      return;
    }
    if (tries <= 0) return;
    setTimeout(() => spinTries(tries - 1), 200);
  })(15);

  document.addEventListener('DOMContentLoaded', () => {
    patchDataSet();
    setTimeout(retrofitExisting, 400);
  });
})();
</script>


<script>
// Sync modal's resolved poster back into the graph + lazy upgrade on hover
(function () {
  // Modal -> graph sync (whenever modalNode changes and modal is open)
  document.addEventListener('alpine:init', () => {
    queueMicrotask(() => {
      try {
        const rootEl = document.querySelector('[x-data]');
        if (!rootEl || !window.Alpine) return;
        const root = Alpine.$data(rootEl);

        // Watcher using MutationObserver fallback for robustness
        let lastId = null;
        const syncFromModal = () => {
          try {
            if (!root.modalOpen || !root.modalNode) return;
            const node = root.modalNode;
            if (!node.id) return;
            if (!window.nodes || typeof window.nodes.update !== 'function') return;

            // Prefer whatever the modal currently shows; fallback to helper
            let prefer = null;
            try {
              const posterEl = document.querySelector('#modal_container img[src]');
              if (posterEl && posterEl.src) prefer = posterEl.src;
            } catch(e) {}
            if (!prefer && window.getNodeImage) prefer = window.getNodeImage(node);
            if (!prefer && node.image) prefer = node.image;

            if (prefer && node.id !== lastId) {
              lastId = node.id;
            }
            if (prefer) {
              window.nodes.update({
                id: node.id,
                image: prefer,
                shape: 'circularImage',
                brokenImage: 'assets/images/default.jpg'
              });
            }
          } catch (e) {}
        };

        // Alpine $watch if available
        try {
          root.$watch('modalOpen', syncFromModal);
          root.$watch('modalNode', syncFromModal);
        } catch (e) {
          // Fallback: poll briefly
          setInterval(syncFromModal, 400);
        }

        // Also run once shortly after init
        setTimeout(syncFromModal, 600);
      } catch (e) {}
    });
  });

  // Hover-based lazy upgrade
  (function waitNet(tries) {
    if (window.network && window.nodes && typeof window.nodes.get === 'function') {
      try {
        window.network.on('hoverNode', function (params) {
          try {
            const n = window.nodes.get(params.node);
            if (!n) return;
            const better = (window.getNodeImage ? window.getNodeImage(n) : n.image);
            if (better && better !== n.image) {
              window.nodes.update({
                id: n.id,
                image: better,
                shape: n.shape || 'circularImage',
                brokenImage: n.brokenImage || 'assets/images/default.jpg'
              });
            }
          } catch (e) {}
        });
      } catch (e) {}
      return;
    }
    if (tries <= 0) return;
    setTimeout(() => waitNet(tries - 1), 250);
  })(20);
})();
</script>

</head>



<body :class="{ 'overflow-hidden': modalOpen }" class="dark flex-col min-h-[100dvh] flex">

<!-- GH Pages SPA redirect consumer -->
<script>
(function(){
  try {
    var r = sessionStorage.getItem('redirect');
    if (r) {
      sessionStorage.removeItem('redirect');
      // Put the original path back into the address bar (no reload)
      if (history && history.replaceState) history.replaceState({}, '', r);
    }
  } catch(e) { /* ignore */ }
})();
</script>

<img :src="bgUrl" alt="" id="bgImg" class="lazy-blur" @load="$event.target.classList.add(\'lazy-done\')" loading="lazy"/>
<div id="bgOverlay"></div>
<style>
@media (max-width: 639px) {
  .mobile-centered {
    max-height: 60vh;          /* Daha kısa */
    overflow-y: auto;
    position: relative;
    top: 10%;
    transform: translateY(-10%);
    padding: 0.75rem;          /* p-3 boyutunda */
    font-size: 0.8rem;         /* text-xs ile text-sm arası */
    border-radius: 0.75rem;    /* Köşeleri biraz daha yuvarlak */
  }

  .mobile-centered h2 {
    font-size: 1.1rem;         /* Başlık küçülsün */
  }

  .mobile-centered p {
    font-size: 0.78rem;        /* Paragraflar daha küçük */
    line-height: 1.3;
  }

  .mobile-centered .grid > div {
    padding: 0.5rem;           /* İç kartlar daha dar */
  }
}


</style>

<!-- Hoş Geldin Bilgilendirmesi -->
<div x-show="!selectedUniverse && !panel"
     class="fixed inset-0 flex items-center justify-center z-50">
  <div style="max-height: 70vh; overflow-y: auto; " class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-xl sm:text-2xl font-bold text-center">🎬 Film Evreni Ağı'na Hoş Geldin!</h2>
    <p class="text-base text-center text-white/80">Bu platform, farklı sinematik evrenler arasında bağ kurmanı ve yapımları daha derinlemesine keşfetmeni sağlar.</p>
    <div class="grid grid-cols-1 gap-2 text-xs mt-1 sm:grid-cols-2 sm:gap-4 sm:text-sm">
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">🗺️ Etkileşimli Harita</h3>
        <p>Seçtiğin evrene ait yapımlar arasındaki bağlantıları grafik olarak görebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">🎞️ Yapım Detayları</h3>
        <p>Her film veya diziye tıklayarak özet, oyuncular, göndermeler ve notları görüntüleyebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">📝 Kendi Notlarını Ekle</h3>
        <p>Yapımlara kişisel notlar ekleyebilir, düzenleyebilir veya silebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">⭐ Favorilerine Ekle</h3>
        <p>İzlemek istediğin veya beğendiğin yapımları favori listene ekleyebilirsin.</p>
      </div>
    </div>
    <p class="text-center text-white/60 text-sm pt-2">Başlamak için yukarıdan bir <strong>film evreni</strong> seç 🌌</p>
<div class="text-center">
  <button @click="startTour()" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">
    <span aria-hidden="true">🚀</span> Rehbere Başla
  </button>
</div>

  </div>
</div>

<header class="fixed top-4 left-0 right-0 z-50">
<div class="w-full sm:max-w-md lg:max-w-lg mx-auto px-3">
<div class="glass rounded-xl px-3 py-2">
  <div class="flex flex-col gap-2">
    <div class="flex items-center justify-center">
<h1 id="secretAdminTap" class="text-base sm:text-lg font-bold text-center">🎬 Film Evreni Ağı</h1>

    </div>

    <!-- Mobilde arama ve anasayfa yanyana, dropdown altta olacak sekilde yeniden yapılandırıldı -->
<div class="flex flex-col sm:flex-row gap-2">

  <!-- Mobil/masaüstü: Anasayfa + Arama + Mobil Filtre aynı satır -->
  <div class="flex flex-row items-center gap-2 w-full sm:flex-1 sm:basis-0 sm:min-w-0">

    <!-- Anasayfa -->
    <a href="./" title="Anasayfa"
       class="text-white border border-white/30 hover:bg-white/10 rounded-md p-2 transition w-9 h-9 flex items-center justify-center"">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
           stroke-width="2" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 10v10h6v-6h4v6h6V10L12 3z"/>
      </svg>
    </a>
<a class="text-white border border-white/30 hover:bg-white/10 rounded-md p-2 transition w-9 h-9 flex items-center justify-center"  id="quizBtn"  title="Bulmaca">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M19 13v-2a3 3 0 00-3-3h-1V6a2 2 0 10-4 0v2H8a3 3 0 00-3 3v1H3a2 2 0 100 4h2v1a3 3 0 003 3h1v2a2 2 0 104 0v-2h1a3 3 0 003-3v-1h2a2 2 0 100-4h-2z" />
  </svg>
</a>
    <!-- Arama -->
    <div class="relative flex-1 min-w-0">
      <input
        @blur="setTimeout(() => acOpen = false, 120)"
        @focus="acOpen = true"
        class="border rounded-lg px-3 py-1.5 w-full pr-10"
        placeholder="Ara..."
        type="search"
        x-model="search"
      />
      <button
        @click="search=''; suggestions=[]; applyFilters()"
        @mousedown.prevent
        aria-label="Temizle"
        class="absolute inset-y-0 right-2 my-auto h-6 w-6 rounded-full grid place-items-center opacity-80 hover:opacity-100 hover:bg-white/10"
        x-show="search"
        style="display:none;">
        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4Z"/>
        </svg>
      </button>
      <!-- AC panel -->
      <div class="ac-panel absolute z-50 w-full mt-1 rounded-lg overflow-hidden max-h-56 overflow-y-auto"
           x-show="acOpen && search && suggestions.length" style="display:none;">
        <template x-for="(s, idx) in suggestions" :key="s">
          <div @click="search = s; acOpen=false; applyFilters();" @mousedown.prevent class="ac-item px-3 py-1.5">
            <span x-text="s"></span>
          </div>
        </template>
      </div>
    </div>

                <!-- Filtre butonu: mobil -->
                <button
                  @click="openFilterPanel = !openFilterPanel"
                  class="relative flex h-9 w-9 items-center justify-center rounded-md border border-white/30 transition hover:bg-white/10 sm:hidden"
                  title="Filtreler" aria-label="Filtreleri aç"
                >
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
           stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h18v2l-6 6v4.6l-4 2V12L3 6z"/>
      </svg>
      <span x-show="activeFilterCount" class="absolute -top-1 -right-1 text-[10px] px-1.5 py-[1px] rounded-full bg-emerald-500 text-black font-semibold">
        <span x-text="activeFilterCount"></span>
      </span>
    </button>
  </div>

  <!-- Evren Seçimi -->
  <div class="relative flex-1 basis-0 min-w-0" x-data="{ open:false, filterText:'' }">
    <div :aria-expanded="open" @click="open=!open"
         class="dropdown-btn border rounded-lg px-3 py-1.5 w-full flex items-center justify-between select-none">
      <span class="truncate" x-text="selectedUniverse ? formatUniverseName(selectedUniverse) : 'Tüm Evrenler'">Tüm Evrenler</span>
      <svg class="h-4 w-4 opacity-80 ml-2" fill="currentColor" viewBox="0 0 20 20">
        <path clip-rule="evenodd" fill-rule="evenodd"
              d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/>
      </svg>
    </div>
    <div class="dropdown-panel absolute mt-2 left-0 right-0 rounded-xl overflow-hidden"
         style="z-index:60; display:none;" x-show="open" x-transition>
      <div class="p-2 border-b border-white/10">
        <input class="w-full px-3 py-2 rounded-lg border" placeholder="Evren ara..." x-model="filterText">
      </div>
      <ul class="max-h-64 overflow-y-auto">
        <template x-for="u in universeList.filter(u => !filterText || formatUniverseName(u).toLowerCase().includes(filterText.toLowerCase()))" :key="u">
          <li
  @click="selectedUniverse=u; open=false; filterText=''; applyFilters()"
  class="dropdown-item px-3 py-2 flex items-center justify-between gap-2 hover:bg-white/10 hover:shadow transition"
>
  <div class="flex items-center gap-2 min-w-0">
    <img
      :src="(() => {
        try {
          const root = Alpine.raw(Alpine.$data(document.querySelector('[x-data]')));
          const m = root?.bgMap || {};
          return m[u] || 'assets/images/bg.jpg';
        } catch(e) { return 'assets/images/bg.jpg'; }
      })()"
      alt=""
      class="w-5 h-5 rounded object-cover border border-white/20 lazy-blur"
      @load="$event.target.classList.add('lazy-done')"
      loading="lazy"
    />
    <span class="truncate" x-text="formatUniverseName(u)"></span>
    <span x-show="u===selectedUniverse" class="text-emerald-400 ml-1">✔</span>
  </div>
  <span
    class="ml-2 shrink-0 text-xs px-2 py-0.5 rounded-full bg-white/10 border border-white/20"
    x-text="(() => {
      try {
        const root = Alpine.raw(Alpine.$data(document.querySelector('[x-data]')));
        const nodes = root?.allNodes || [];
        return nodes.filter(n => n && n.universe === u).length || 0;
      } catch(e) { return 0; }
    })()"
  ></span>
</li>
        </template>
      </ul>
    </div>
  </div>

              <button
                @click="openFilterPanel = !openFilterPanel"
                id="filter_btn"
                class="relative hidden h-9 w-9 items-center justify-center rounded-md border border-white/30 transition hover:bg-white/10 sm:flex"
                title="Filtreler" aria-label="Filtreleri aç"
              >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
         stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h18v2l-6 6v4.6l-4 2V12L3 6z"/>
    </svg>
    <span x-show="activeFilterCount" class="absolute -top-1 -right-1 text-[10px] px-1.5 py-[1px] rounded-full bg-emerald-500 text-black font-semibold">
      <span x-text="activeFilterCount"></span>
    </span>
  </button>

</div>



  </div>
</div>
</div>
</header>
<!-- Overlay -->
<div
  x-show="openFilterPanel"
  @click="openFilterPanel = false"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70]"
  x-transition.opacity
></div>

<!-- Drawer (Filtre Paneli) -->
<aside
  x-show="openFilterPanel"
  @keydown.escape.window="openFilterPanel=false"
  x-data="{preset:null}"
  class="fixed right-0 top-0 bottom-0 w-[92vw] sm:w-[360px] z-[80] glass border-l border-white/20 p-4 overflow-y-auto"
  x-transition:enter="transition ease-out duration-200"
  x-transition:enter-start="translate-x-full"
  x-transition:enter-end="translate-x-0"
  x-transition:leave="transition ease-in duration-150"
  x-transition:leave-start="translate-x-0"
  x-transition:leave-end="translate-x-full"
>
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Filtreler</h3>
    <button @click="openFilterPanel=false" class="w-8 h-8 rounded-full bg-white/10 border border-white/20">✕</button>
  </div>

  <!-- Yapım Tipi -->
  <div class="mb-4">
    <div class="text-sm font-medium mb-2">Yapım Tipi</div>
    <div class="inline-flex rounded-lg overflow-hidden border border-white/20">
      <button @click="filters.type='all'"  :class="filters.type==='all'  ? 'bg-white/20' : 'bg-white/5'" class="px-3 py-1.5 text-sm">Hepsi</button>
      <button @click="filters.type='film'" :class="filters.type==='film' ? 'bg-white/20' : 'bg-white/5'" class="px-3 py-1.5 text-sm">Film</button>
      <button @click="filters.type='dizi'" :class="filters.type==='dizi' ? 'bg-white/20' : 'bg-white/5'" class="px-3 py-1.5 text-sm">Dizi</button>
    </div>
  </div>

<!-- Tür (Genre) -->
<div class="mb-4">
  <div class="text-sm font-medium mb-2">Tür</div>
  <div class="flex flex-wrap gap-2">
    <template x-for="g in availableGenres" :key="g">
      <label
        class="px-2 py-1 rounded-full border cursor-pointer select-none text-xs transition"
        :class="filters.genres.includes(g)
          ? 'bg-emerald-500 border-emerald-500 text-black'
          : 'bg-white/5 border-white/20 text-white hover:bg-white/10'">
        
        <input type="checkbox" class="hidden" :value="g" x-model="filters.genres">
        <span x-text="g"></span>
      </label>
    </template>
  </div>
</div>


  <!-- Yıl aralığı -->
  <div class="mb-4 grid grid-cols-2 gap-2">
    <div>
      <div class="text-sm font-medium mb-1">Yıl (min)</div>
      <input type="number" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" placeholder="2008" x-model.number="filters.yearMin" @input="preset=null">
    </div>
    <div>
      <div class="text-sm font-medium mb-1">Yıl (max)</div>
      <input type="number" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" placeholder="2025" x-model.number="filters.yearMax" @input="preset=null">
    </div>
  </div>

  
  <!-- Hazır Yıl Aralıkları -->
  <div class="mb-4">
    <div class="text-sm font-medium mb-2">Hazır Yıl Filtreleri</div>
    <div class="flex flex-wrap gap-2">
      <button
        @click="filters.yearMin = new Date().getFullYear() - 1; filters.yearMax = new Date().getFullYear(); preset='last1'; applyFilters()"
        class="px-2 py-1 rounded text-xs border"
        :class="preset==='last1' ? 'bg-emerald-600 border-emerald-600 text-black' : 'bg-white/10 hover:bg-white/20 border-white/20'"
      >Son 1 Yıl</button>

      <button
        @click="filters.yearMin = new Date().getFullYear() - 5; filters.yearMax = new Date().getFullYear(); preset='last5'; applyFilters()"
        class="px-2 py-1 rounded text-xs border"
        :class="preset==='last5' ? 'bg-emerald-600 border-emerald-600 text-black' : 'bg-white/10 hover:bg-white/20 border-white/20'"
      >Son 5 Yıl</button>

      <button
        @click="filters.yearMin = 2010; filters.yearMax = 2019; preset='2010s'; applyFilters()"
        class="px-2 py-1 rounded text-xs border"
        :class="preset==='2010s' ? 'bg-emerald-600 border-emerald-600 text-black' : 'bg-white/10 hover:bg-white/20 border-white/20'"
      >2010–2019</button>

      <button
        @click="filters.yearMin = 2000; filters.yearMax = 2009; preset='2000s'; applyFilters()"
        class="px-2 py-1 rounded text-xs border"
        :class="preset==='2000s' ? 'bg-emerald-600 border-emerald-600 text-black' : 'bg-white/10 hover:bg-white/20 border-white/20'"
      >2000–2009</button>

      <button
        @click="filters.yearMin = null; filters.yearMax = 1999; preset='pre2000'; applyFilters()"
        class="px-2 py-1 rounded text-xs border"
        :class="preset==='pre2000' ? 'bg-emerald-600 border-emerald-600 text-black' : 'bg-white/10 hover:bg-white/20 border-white/20'"
      >2000 Öncesi</button>
    </div>
  </div>

  <!-- IMDb -->
  <div class="mb-6"
     x-data="{
       get val(){ return (filters.imdbMin ?? 0); },
       get pct(){ const v=this.val; const p=Math.max(0, Math.min(10, +v))/10*100; return p; },
       get grad(){
         const p=this.pct;
         // left gold -> right slate
         return `linear-gradient(90deg, rgba(234,179,8,0.9) ${p}%, rgba(51,65,85,0.6) ${p}%)`;
       }
     }">
  <div class="flex items-center justify-between mb-2">
    <div class="flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"
           :class="(filters.imdbMin ?? 0) >= 7 ? 'text-yellow-400' : 'text-slate-300'"
           fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
      </svg>
      <div class="text-sm font-medium">IMDb (en az)</div>
    </div>
    <div class="imdb-badge text-xs px-2 py-0.5 rounded-full border border-white/20 bg-white/10">
      <span x-text="(filters.imdbMin ?? 0).toFixed(1)"></span>
    </div>
  </div>

  <input type="range" min="0" max="10" step="0.1"
         x-model.number="filters.imdbMin"
         class="w-full imdb-range"
         :style="{ background: grad }"
         :title="`IMDb en az ${ (filters.imdbMin ?? 0).toFixed(1) }`"
  >

  <div class="mt-2 flex items-center justify-between text-[11px] opacity-70">
    <span>0</span>
    <div class="flex items-center gap-2">
      <button class="px-2 py-1 rounded border border-white/20 bg-white/5 hover:bg-white/10"
              @click="filters.imdbMin = 7.0">7+</button>
      <button class="px-2 py-1 rounded border border-white/20 bg-white/5 hover:bg-white/10"
              @click="filters.imdbMin = 8.0">8+</button>
      <button class="px-2 py-1 rounded border border-white/20 bg-white/5 hover:bg-white/10"
              @click="filters.imdbMin = 9.0">9+</button>
      <button class="px-2 py-1 rounded border border-white/30 bg-white/10 hover:bg-white/20"
              @click="filters.imdbMin = null">Sıfırla</button>
    </div>
    <span>10</span>
  </div>
</div>

  <!-- Aksiyonlar -->
  <div class="flex gap-2">
    <button @click="applyFilters(); openFilterPanel=false" class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white text-sm">Uygula</button>
    <button @click="preset=null; resetFilters()" class="px-3 py-2 rounded bg-white/10 border border-white/20 text-sm">Sıfırla</button>
  </div>
</aside>
<div id="network" x-show="selectedUniverse" x-transition x-show="showGraph" x-transition></div>

<div @click.outside="if (!window.Shepherd?.activeTour) modalOpen=false; resetPrettyUrl && resetPrettyUrl()" @keydown.escape.window="modalOpen=false; resetPrettyUrl && resetPrettyUrl()" aria-labelledby="modalTitle" aria-modal="true" class="fixed inset-0 modal-bg flex items-center justify-center z-50 p-4" role="dialog" id="modal_container" x-show="modalOpen" x-transition="">
<div @click.stop="" class="modal-content" style="overflow-y: visible;">
<div class="relative rounded-xl overflow-hidden backdrop-blur-md bg-black/50 text-white max-h-[90vh] overflow-y-visible">
<!-- Üst blur görsel alanı -->
<div class="relative h-64">
<img :src="getNodeImage(modalNode)" alt="" class="absolute inset-0 w-full h-full object-cover blur-sm brightness-50 scale-105" class="lazy-blur" @load="$event.target.classList.add(\'lazy-done\')" loading="lazy"/>
<div class="absolute inset-0 flex flex-col justify-between p-4 z-10"><div class="absolute top-3 left-3 flex gap-2 items-center">
  <button @click="openShare(modalNode)" id="share-btn" class="share-btn" title="Paylaşım seçenekleri" aria-label="Paylaşım seçenekleri">
    <span aria-hidden="true">🔗</span><span class="hidden sm:inline">Paylaş</span>
  </button>
</div><div class="absolute top-3 right-3 flex gap-2 items-center z-20"><div @click="modalOpen=false; resetPrettyUrl && resetPrettyUrl()" class="close-btn" id="modal-close" role="button" aria-label="Paneli kapat">✕</div></div>
<!-- Üst çubuk -->
<div class="flex justify-between items-start"><div class="absolute top-3 right-3 flex gap-2 items-center z-20"></div></div>
<!-- Alt bilgi -->
<div class="flex justify-between mt-4">
<div class="text-xs bg-black/40 px-3 py-1 rounded-full">
<div class="font-semibold text-white/70 text-[10px]">Vizyon Tarihi</div>
<span x-text="toTRDate(modalNode.release_date)">-</span>
</div>
<div class="text-xs flex gap-2 items-center bg-black/40 px-3 py-1 rounded-full">
<span x-text="modalNode.type || '-'"></span>
<span class="text-white/80">|</span>
<span x-text="'IMDB: ' + (modalNode.imdb_rating || '-')">IMDB</span>
</div>
</div>
</div>
<template x-if="showPosterDialog">
<div @click.self="showPosterDialog = false" class="fixed inset-0 z-\[9999\] z-\[999\] z-50 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center">
<div class="p-4 rounded-xl shadow-2xl max-w-[90vw] max-h-[85vh]" style="z-index:10000;" style="z-index:1000;" style="z-index:60;">
<button @click="showPosterDialog = false" class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/10 border border-white/20 text-white text-sm">✕</button>
<img :src="getNodeImage(modalNode)" class="max-w-[75vw] max-h-[70vh] rounded-xl shadow-lg object-cover"/>
</div>
</div>
</template>
<!-- Poster -->
<div class="absolute left-1/2 top-full -translate-x-1/2 -translate-y-1/2 z-20"><div @click="showPosterDialog = true" class="cursor-pointer">
<div @click="showPosterDialog = true" class="cursor-pointer">
<div @click="showPosterDialog = true" class="cursor-pointer"><img :src="getNodeImage(modalNode)" alt=""
class="w-32 h-32 rounded-full object-cover drop-shadow-[0_0_20px_rgba(168,85,247,0.5)] ring-2 ring-purple-400/30"/></div></div>
</div>
</div>
</div>
<!-- İçerik alanı -->
<div class="p-6 pt-20 space-y-6 overflow-hidden">
<h2 class="text-2xl font-bold text-center" x-text="modalNode.label">
</h2>
<div class="flex justify-center mt-2" aria-live="polite">
<button :class="isInWatchLater(modalNode?.id) ? 'bg-green-500 border-green-500 text-white' : 'bg-white/10 border-white/20 text-white hover:bg-white/20'" @click="toggleWatchLater(modalNode)" class="px-4 py-2 rounded border text-sm transition" x-text="isInWatchLater(modalNode?.id) ? '✔ Favorilere Eklendi' : 'Favorilere Ekle'">
</button>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
<div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-1"><div><strong>Tür:</strong> <span x-text="modalNode.tür || '-'"></span></div>
<div><strong>Yönetmen:</strong> <span x-text="modalNode.yönetmen || '-'"></span></div>
<div><strong>Oyuncular:</strong> <span x-text="modalNode.oyuncular || '-'"></span></div>
</div>
<div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-1">
<div><strong>Evren:</strong> <span x-text="formatUniverseName(modalNode.universe)"></span></div>
<template x-if="Array.isArray(modalNode.sources) ? modalNode.sources.length : Object.keys(modalNode.sources || {}).length">


<!-- Kaynaklar -->
<div
  class="mt-4"
  x-data="{ groups: [] }"
  x-effect="
    (() => {
      const raw =
        modalNode?.sources
        || modalNode?.source
        || modalNode?.links
        || null;

      const normalized = normalizeSources(raw);
      const order = ['Kaynaklar','Görsel','Platform'];

      groups = order
        .map(cat => ({ cat, items: (normalized?.[cat] || []) }))
        .filter(g => g.items.length);
    })()
  "
  x-show="groups.length"
>


  <template x-for="g in groups" :key="g.cat">
    <div class="mb-3">
      <h4 class="text-sm font-medium mb-1 inline-flex items-center gap-1">
        <span x-text="getSourceIcon(g.cat)"></span>
        <span x-text="g.cat"></span>
      </h4>
      <ul class="list-disc list-inside text-sm space-y-0.5">
        <template x-for="src in g.items" :key="src.url || src.name">
          <li class="flex items-center gap-2"
    x-data="{
      idx: 0,
      list: [],
      // Normalize to lower, strip diacritics
      nrm(s) {
        try {
          return String(s || '')
            .toLocaleLowerCase('tr')
            .normalize('NFD')
            .replace(/\p{Diacritic}/gu, '')
            .trim();
        } catch(e) { return String(s || '').toLowerCase().trim(); }
      },
      // Known brand names -> canonical domains
      brandDomain(name) {
        const k = this.nrm(name);
        const map = {
          'imdb': 'imdb.com',
          'internet movie database': 'imdb.com',
          'wikipedia': 'wikipedia.org',
          'box office turkiye': 'boxofficeturkiye.com',
          'box office turchiye': 'boxofficeturkiye.com',
          'box office turkey': 'boxofficeturkiye.com',
          'marvel studios official site': 'marvel.com',
          'marvel studios': 'marvel.com',
          'disney+': 'disneyplus.com',
          'disney plus': 'disneyplus.com',
          'disneyplus': 'disneyplus.com',
          'x': 'x.com',
          'twitter': 'x.com',
          'linkedin': 'linkedin.com'
        };
        return map[k] || null;
      },
      // Map CDN or sub-brands to canonical domains
      canonHost(hostname) {
        if (!hostname) return null;
        const h = hostname.toLowerCase();
        const canon = {
          'm.media-amazon.com': 'imdb.com',
          'media-amazon.com': 'imdb.com',
          'upload.wikimedia.org': 'wikipedia.org',
          'en.wikipedia.org': 'wikipedia.org',
          'tr.wikipedia.org': 'wikipedia.org',
          'images.boxofficeturkiye.com': 'boxofficeturkiye.com',
          'boxofficeturkiye.com': 'boxofficeturkiye.com',
          'disneyplus.com': 'disneyplus.com',
          'www.disneyplus.com': 'disneyplus.com',
        };
        return canon[h] || null;
      },
      root(d) {
        if (!d) return d;
        const parts = d.split('.').filter(Boolean);
        if (parts.length >= 2) return parts.slice(-2).join('.');
        return d;
      },
      makeList(u, n) {
        // Priority: explicit iconDomain on item -> brandDomain(name) -> URL host (canonicalized/rooted) -> guess from name
        const domains = [];
        try {
          const url = new URL(u || '');
          const canon = this.canonHost(url.hostname) || this.root(url.hostname);
          if (canon) domains.push(canon);
        } catch(e) {}

        const fromBrand = this.brandDomain(n);
        if (fromBrand) domains.unshift(fromBrand);

        const guess = this.root(String(n || '')
          .replace(/^https?:\/\/(www\.)?/i,'')
          .split('/')[0]
          .trim());
        if (guess) domains.push(guess);

        const uniq = Array.from(new Set(domains.filter(Boolean)));

        const providers = (d) => [
          `https://icons.duckduckgo.com/ip3/${d}.ico`,
          `https://www.google.com/s2/favicons?sz=32&domain=${d}`,
          `https://favicone.com/${d}`,
        ];

        const list = [];
        uniq.forEach(d => list.push(...providers(d)));

        // final fallback: simple inline SVG
        const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'>
          <rect x='2' y='2' width='20' height='20' rx='6' ry='6' fill='rgba(255,255,255,0.08)'/>
          <path d='M7 12h10' stroke='rgba(255,255,255,0.9)' stroke-width='2' stroke-linecap='round'/>
        </svg>`);
        list.push('data:image/svg+xml;utf8,' + svg);
        return list;
      },
      init() { this.list = this.makeList(src?.url, src?.name); },
      get icon() { return this.list[this.idx] || this.list[this.list.length - 1]; },
      next() { if (this.idx < this.list.length - 1) this.idx++; }
    }">
  <img
    :src="icon"
    @error="next()"
    alt=""
    class="w-4 h-4 rounded lazy-blur"
    @load="$event.target.classList.add('lazy-done')"
    loading="lazy"
    referrerpolicy="no-referrer"
  />
  <a href="#"
     @click.prevent="confirmExternal(src.url)"
     class="text-emerald-400 hover:underline"
     x-text="src.name || src.url"></a>
</li>
        </template>
      </ul>
    </div>
  </template>
</div>

<!-- Hiç kaynak yoksa nazik mesaj -->
<div class="mt-4 text-sm text-white/70" x-show="!groups?.length">
  Bu yapım için kayıtlı bir kaynak bulunamadı.
</div>




</template>
</div>
</div>
<!-- Özet -->
<div>
<h3 @click="summaryOpen = !summaryOpen" id="content-summary" class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">İçerik Özeti
<svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="!summaryOpen"></path>
<path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="summaryOpen"></path>
</svg>
</h3>
<div class="bg-white/5 p-4 rounded-lg border border-white/10" x-show="summaryOpen" x-text="modalNode.description || '-'"></div>
</div>
<!-- Göndermeler -->
<template x-if="modalNode.refers_to">
  <div>
    <h3 @click="refersOpen = !refersOpen" id="göndermeler"
        class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">
      Göndermeler
      <svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
           xmlns="http://www.w3.org/2000/svg">
        <path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              x-show="!refersOpen"></path>
        <path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              x-show="refersOpen"></path>
      </svg>
    </h3>

    <div class="text-sm text-red-400 italic mb-2" x-show="refersOpen">
      ⚠ Bu alan spoiler içerebilir.
    </div>

    <div class="bg-white/5 p-4 rounded-lg border border-white/10 italic text-sm"
         x-show="refersOpen"
         x-html="(() => {
           const t = modalNode.refers_to == null ? '' : String(modalNode.refers_to);

           // Güvenlik: HTML escape
           const esc = t
             .replace(/&/g,'&amp;')
             .replace(/</g,'&lt;')
             .replace(/>/g,'&gt;');

           // **Kalın** -> renkli span
           let out = esc.replace(/\*\*(.+?)\*\*/g,
             '<span class=&quot;text-sky-300 font-semibold underline decoration-dotted&quot;>$1</span>'
           );
           return out;
         })()">
    </div>
  </div>
</template>



<!-- Bağlantılı Yapımlar -->


<h3 @click="linkedOpen = !linkedOpen" id="related-works" class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">Bağlantılı Yapımlar
<svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="!linkedOpen"></path>
<path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="linkedOpen"></path>
</svg>
</h3>
<div x-show="linkedOpen" class="bg-white/5 p-4 rounded-lg border border-white/10">

<template x-if="edgeList.length">
<div class="flex flex-wrap gap-2" x-show="linkedOpen">
<template :key="e.otherNodeId" x-for="e in edgeList">
<div :class="{
'bg-blue-900/40 border-blue-500/30': e.type === 'Devam',
'bg-emerald-900/30 border-emerald-500/20': e.type === 'Takım Kurulumu',
'bg-slate-900/30 border-slate-500/20': e.type === 'Karakter Geçişi',
'bg-purple-900/30 border-purple-500/20': e.type === 'Gizli Bağlantı',
'bg-red-900/30 border-red-500/20': e.type === 'Psikolojik Etki',
'bg-violet-900/30 border-violet-500/20': e.type === 'Karakter Bağlantısı',
'bg-rose-900/30 border-rose-500/20': e.type === 'Yeni Tehdit',
'bg-amber-900/30 border-amber-400/20': e.type === 'Sonsuzluk Taşı',
'bg-orange-900/30 border-orange-500/20': e.type === 'Siyasi Çözülme',
'bg-teal-900/30 border-teal-500/20': e.type === 'Kozmik Katılım',
'bg-pink-900/30 border-pink-500/20': e.type === 'Anahtar Karakter',
'bg-orange-800/30 border-orange-400/20': e.type === 'Önemli Olay',
'bg-yellow-900/30 border-yellow-500/20': e.type === 'Mekan Bağlantısı',
'bg-gray-800/30 border-gray-500/20': e.type === 'Paralel Olay',
'bg-amber-800/30 border-amber-500/20': e.type === 'Anahtar Olay',
'bg-violet-800/30 border-violet-400/20': e.type === 'Sonrası Etki',
'bg-teal-800/30 border-teal-400/20': e.type === 'Kozmik Genişleme',
'bg-cyan-900/30 border-cyan-500/20': e.type === 'Çoklu Evren',
'bg-red-800/30 border-red-400/20': e.type === 'Evrensel Gelişme',
'bg-indigo-900/30 border-indigo-500/20': e.type === 'Ana Hikaye Bağlantısı',
'bg-red-950/30 border-red-600/20': e.type === 'Ana Tehdit',
'bg-sky-900/30 border-sky-500/20': e.type === 'Doğrudan Devam',
'bg-emerald-950/30 border-emerald-600/20': e.type === 'Evrensel Bağlantı',
'bg-stone-900/30 border-stone-500/20': e.type === 'Geçmiş Hikayesi',
'bg-green-900/30 border-green-500/20': e.type === 'Hikaye Devamı',
'bg-cyan-800/30 border-cyan-400/20': e.type === 'Hikaye Öncesi',
'bg-slate-800/30 border-slate-400/20': e.type === 'Karakter Devamı',
'bg-orange-700/30 border-orange-300/20': e.type === 'Siyasi Etki',
'bg-fuchsia-900/30 border-fuchsia-500/20': e.type === 'Crossover',
'bg-gray-700/30 border-gray-400/20': e.type === 'Tarihsel Bağlantı',
'bg-purple-800/30 border-purple-300/20': e.type === 'Türsel Bağlantı',

'bg-white/10 border-white/20': !e.type

         }" @click="__openNode(e.otherNodeId)" class="rounded-xl p-3 text-sm cursor-pointer transition relative border space-y-1">
<div class="font-semibold" x-text="nodes.get(e.otherNodeId)?.label || e.otherNodeId">
</div>
<div class="text-xs text-white/70 italic" x-text="e.type"></div>
<template x-if="e.notes">
<div class="border-l-4 border-blue-500 pl-2 ml-1 text-[12px] text-white/80 italic mt-1">
<span class="text-blue-300">Not:</span>
<span x-text="e.notes"></span>
</div>
</template>
</div>
</template>
</div>
</template>
<template x-if="!edgeList.length">
<p class="text-sm opacity-70">Bağlantı bulunamadı.</p>
</template>
</div>
<!-- Notlar -->
<div class="bg-white/5 p-4 rounded-lg border border-white/10">
<h3 class="text-lg font-semibold mb-2">Notlar</h3>
<template x-if="!notes[modalNode.id] || !notes[modalNode.id].length">
<p class="text-sm opacity-70">Henüz not eklenmemiş.</p>
</template>

<template :key="i" x-for="(c, i) in (notes[modalNode.id] || [])">
  <div class="bg-white/10 p-2 rounded mb-2">
    <div class="text-xs opacity-70 mb-1">
      <span x-text="new Date(c.ts).toLocaleDateString()"></span>
    </div>
    <template x-if="editingNoteIndex === i">
      <div class="flex flex-col gap-2">
        <textarea x-model="editedNoteText" class="w-full p-2 rounded bg-black/20 text-sm text-white border border-white/20"></textarea>
        <div class="flex justify-end gap-2 text-xs">
          <button @click="saveEditedNote(modalNode.id, i)" class="px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white">Kaydet</button>
          <button @click="cancelEditNote()" class="px-2 py-1 rounded bg-white/20 text-white">Vazgeç</button>
        </div>
      </div>
    </template>
    <template x-if="editingNoteIndex !== i">
      <div>
        <div class="whitespace-pre-wrap text-sm" x-text="c.text"></div>
        <div class="flex justify-end gap-2 mt-1 text-xs opacity-80">
          <button @click="startEditNote(i, c.text)">✏️</button>
          <button @click="deleteNote(modalNode.id, i)">🗑️</button>
        </div>
      </div>
    </template>
  </div>
</template>

<div class="flex gap-2 mt-2">
<input class="w-full px-3 py-2 rounded bg-white/10 text-white" placeholder="Not ekle... #etiket" x-model="newNote"/>
<button @click="addNote(modalNode.id)" class="px-3 py-2 text-sm border border-white/20 rounded hover:bg-white/20">Ekle</button>

<!-- Advanced Share Sheet -->
<template x-if="shareOpen">
  <div @keydown.escape.window="shareOpen=false">
    <div class="share-sheet-overlay" @click="shareOpen=false"></div>
    <div class="share-sheet" role="dialog" aria-modal="true" aria-label="Paylaşım seçenekleri">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-semibold">Paylaş</div>
        <button class="w-8 h-8 rounded-full bg-white/10 border border-white/20" @click="shareOpen=false" aria-label="Paylaşımı kapat">✕</button>
      </div>

      <div class="mb-3 text-sm opacity-80">
        <div class="mb-1">Bağlantı</div>
        <input class="share-input" type="text" readonly :value="buildShareUrl(modalNode, true)">
      </div>

      <div class="grid share-grid mb-3">
  <div class="share-tile" @click="shareNative(modalNode)" title="Cihazla Paylaş" aria-label="Cihazla Paylaş">
    <svg class="share-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M14 3l7 7-1.41 1.41L15 8.83V17a4 4 0 01-4 4H5v-2h6a2 2 0 002-2V8.83l-4.59 2.58L7 10l7-7z"/>
    </svg>
    <span class="text-xs">Cihazla Paylaş</span>
  </div>

  <div class="share-tile" @click="shareToX(modalNode)" title="X" aria-label="X">
    <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=x.com" alt="X">
    <span class="text-xs">X (Twitter)</span>
  </div>

  <div class="share-tile" @click="shareToWhatsApp(modalNode)" title="WhatsApp" aria-label="WhatsApp">
    <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=whatsapp.com" alt="WhatsApp">
    <span class="text-xs">WhatsApp</span>
  </div>

  <div class="share-tile" @click="shareToLinkedIn(modalNode)" title="LinkedIn" aria-label="LinkedIn">
    <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=linkedin.com" alt="LinkedIn">
    <span class="text-xs">LinkedIn</span>
  </div>

  <div class="share-tile" @click="shareToTelegram(modalNode)" title="Telegram" aria-label="Telegram">
    <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=telegram.org" alt="Telegram">
    <span class="text-xs">Telegram</span>
  </div>

  <div class="share-tile" @click="shareToReddit(modalNode)" title="Reddit" aria-label="Reddit">
    <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=reddit.com" alt="Reddit">
    <span class="text-xs">Reddit</span>
  </div>

  <div class="share-tile" @click="copyShare(modalNode)" title="Bağlantıyı Kopyala" aria-label="Bağlantıyı Kopyala">
    <svg class="share-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M16 1H4a2 2 0 00-2 2v12h2V3h12V1zm3 4H8a2 2 0 00-2 2v14a2 2 0 002 2h11a2 2 0 002-2V7a2 2 0 00-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <span class="text-xs">Kopyala</span>
  </div>

  <div class="share-tile" @click="copyMarkdown(modalNode)" title="Markdown Olarak Kopyala" aria-label="Markdown Olarak Kopyala">
    <svg class="share-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M2 5a2 2 0 012-2h16a2 2 0 012 2v14H2V5zm2 0v12h16V5H4zm3 3h2l2 3 2-3h2v6h-2V9l-2 3-2-3v6H7V8z"/>
    </svg>
    <span class="text-xs">Markdown</span>
  </div>
</div>
        <div class="share-tile" @click="shareToX(modalNode)">
          <span>𝕏</span><span class="text-xs">X (Twitter)</span>
        </div>
        <div class="share-tile" @click="shareToWhatsApp(modalNode)">
          <span>🟢</span><span class="text-xs">WhatsApp</span>
        </div>
        <div class="share-tile" @click="shareToLinkedIn(modalNode)">
          <span>in</span><span class="text-xs">LinkedIn</span>
        </div>
        <div class="share-tile" @click="shareToTelegram(modalNode)">
          <span>✈️</span><span class="text-xs">Telegram</span>
        </div>
        <div class="share-tile" @click="shareToReddit(modalNode)">
          <span>👽</span><span class="text-xs">Reddit</span>
        </div>
        <div class="share-tile" @click="copyShare(modalNode)">
          <span>📋</span><span class="text-xs">Bağlantıyı Kopyala</span>
        </div>
        <div class="share-tile" @click="copyMarkdown(modalNode)">
          <span>📝</span><span class="text-xs">Markdown</span>
        </div>
      </div>

      <div class="mb-2 text-sm opacity-80">QR Kod</div>
      <div class="flex items-center justify-center">
        <img :src="'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(buildShareUrl(modalNode, true))"
             alt="QR" width="180" height="180" class="rounded border border-white/10"/>
      </div>

      <div class="share-actions">
        <button class="px-3 py-1.5 rounded bg-white/10 border border-white/20 hover:bg-white/20 text-sm" @click="shareOpen=false">Kapat</button>
      </div>
    </div>
  </div>
</template>
</div>
</div>
</div>
</div>
</div>
</div>

<div x-show="selectedUniverse">
</div>


</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.querySelector('input[placeholder="Not ekle... #etiket"]');
    if (input) {
      input.addEventListener('focus', () => {
        setTimeout(() => {
          input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    }
  });
</script>


    <script>
      function app() {
        return {
          
          openShare(node){
            try{
              this.shareCustomText = this.formatShareDefault(node || this.modalNode);
              this.shareOpen = true;
              this.$nextTick(() => {
                try {
                  const ta = document.querySelector('.share-textarea');
                  ta && ta.focus();
                } catch(e){}
              });
            } catch(e){
              this.shareOpen = true;
            }
          },
init(){
            try{
              // Prefill when panel opens
              this.$watch('shareOpen', (v) => {
                if(v){ this.shareCustomText = this.formatShareDefault(this.modalNode); }
              });
              // Prefill when modalNode changes
              this.$watch('modalNode', (n) => {
                if(n){ this.shareCustomText = this.formatShareDefault(n); }
              });
              // Persist share prefs
              this.$watch('sharePrefs.useUtm', () => this.saveSharePrefs());
              this.$watch('sharePrefs.includeHashtags', () => this.saveSharePrefs());
              this.$watch('sharePrefs.includeSummary', () => this.saveSharePrefs());
            }catch(e){ /* no-op */ }
          },
    
          
          
          
          
          
          // --- Structured default share text helpers ---
          formatShareDefault(node){
            try {
              const title = node?.label || 'Bir yapım';
              const sum = this.takeSummary(node?.description, 140);
              const ref = this.takeReference(node?.refers_to, 100);
              const link = this.buildShareUrl(node, this.sharePrefs?.useUtm ?? true);
              const bye = this.randomFarewell();
              const lines = [title];
              if (sum) lines.push(sum);
              if (ref) lines.push('Gönderme: ' + ref);
              lines.push(link);
              lines.push(bye);
              return lines.filter(Boolean).join('\n');
            } catch(e){ return this.getShareText(node) + '\n' + this.buildShareUrl(node, true); }
          },
          takeSummary(t, maxLen=140){
            return this._shorten(t, maxLen);
          },
          takeReference(t, maxLen=100){
            if (!t) return '';
            let s = String(t);
            // strip markdown ** and any html tags
            s = s.replace(/\*\*/g, '').replace(/<[^>]*>/g, '');
            return this._shorten(s, maxLen);
          },
          _shorten(t, maxLen=140){
            if (!t) return '';
            const clean = String(t).replace(/\s+/g, ' ').trim();
            if (!clean) return '';
            let first = clean.split(/[.!?]/)[0] || clean;
            if (first.length > maxLen) first = first.slice(0, maxLen-1) + '…';
            return first;
          },
          randomFarewell(){
            const list = [
              'İyi seyirler! 🎬',
              'Sence nasıl? Yorumunu yaz.',
              'Listene eklemeyi unutma! ⭐',
              'Bir göz at derim!'
            ];
            return list[0];
          },
// Share prefs & helpers
          sharePrefs: JSON.parse(localStorage.getItem('sharePrefs') || '{"useUtm":true,"includeHashtags":true,"includeSummary":false}'),
          shareCustomText: '',
          saveSharePrefs(){ try{ localStorage.setItem('sharePrefs', JSON.stringify(this.sharePrefs)); }catch(e){} },
          $watch: {
            'modalNode'(n){ if(n){ this.shareCustomText = this.formatShareDefault(n); } },
            'shareOpen'(v){ if(v){ if(!this.shareCustomText){ this.shareCustomText = this.formatShareDefault(this.modalNode); } } },  'sharePrefs.useUtm'(){ this.saveSharePrefs(); },
            'sharePrefs.includeHashtags'(){ this.saveSharePrefs(); },
            'sharePrefs.includeSummary'(){ this.saveSharePrefs(); },
          },
          shareSuggestedTags(node){
            const tags = [];
            const uni = this.formatUniverseName?.(node?.universe) || node?.universe || '';
            if (uni) tags.push('#' + String(uni).replace(/\s+/g,''));
            const genres = (node?.tür || '').toString().split(/,|\/|•/).map(s=>s.trim()).filter(Boolean);
            genres.slice(0,3).forEach(g => tags.push('#' + g.replace(/\s+/g,'')));
            return Array.from(new Set(tags));
          },
          appendToShare(s){ this.shareCustomText = (this.shareCustomText + ' ' + s).trim(); },
          buildShareText(node){
            const base = (this.shareCustomText && this.shareCustomText.trim())
              ? this.shareCustomText
              : this.formatShareDefault(node);
            return base;
          },
          xRemaining(node){
            const limit = 280;
            const txt = this.buildShareText(node);
            return (limit - txt.length);
          },
          shareToEmail(node){
            const subject = encodeURIComponent(node?.label || 'Öneri');
            const body = encodeURIComponent(this.buildShareText(node));
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
          },
          async captureShareImage(){
            try {
              const modal = document.querySelector('.modal-content');
              if (!modal) return alert('Poster bulunamadı');
              const target = modal.querySelector('img[alt=""]') || modal;
              const canvas = await html2canvas(target, {useCORS:true, backgroundColor:null, scale: 2});
              const data = canvas.toDataURL('image/png');
              const a = document.createElement('a');
              a.href = data; a.download = (this.modalNode?.label || 'poster') + '.png'; a.click();
              // Clipboard (best-effort)
              if (navigator.clipboard && window.ClipboardItem) {
                const res = await fetch(data); const blob = await res.blob();
                await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
                this.showFavMsg = true; setTimeout(()=> this.showFavMsg=false,1200);
              }
            } catch(e){ console.error(e); alert('Görsel oluşturulamadı'); }
          },
          // Overwrite social share builders to use composed text
          shareToX(node){
            const url = encodeURIComponent(this.buildShareUrl(node, this.sharePrefs.useUtm));
            const text = encodeURIComponent(this.buildShareText(node));
            window.open(`https://x.com/intent/tweet?text=${text}`,'_blank','noopener,noreferrer');
          },
          shareToWhatsApp(node){
            const text = encodeURIComponent(this.buildShareText(node));
            window.open(`https://wa.me/?text=${text}`,'_blank','noopener,noreferrer');
          },
          shareToLinkedIn(node){
            const url = encodeURIComponent(this.buildShareUrl(node, this.sharePrefs?.useUtm ?? true));
            const title = encodeURIComponent(node?.label || 'Paylaş');
            const summary = encodeURIComponent(this.buildShareText(node));
            // Prefer shareArticle to include text
            window.open(`https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${title}&summary=${summary}`,'_blank','noopener,noreferrer');
          },
          shareToTelegram(node){
            const url = encodeURIComponent(this.buildShareUrl(node, this.sharePrefs.useUtm));
            const text = encodeURIComponent(this.buildShareText(node));
            window.open(`https://t.me/share/url?url=${url}&text=${text}`,'_blank','noopener,noreferrer');
          },
          shareToReddit(node){
            const url = encodeURIComponent(this.buildShareUrl(node, this.sharePrefs.useUtm));
            const title = encodeURIComponent(this.getShareText(node));
            window.open(`https://www.reddit.com/submit?url=${url}&title=${title}`,'_blank','noopener,noreferrer');
          },
shareOpen: false,
          buildShareUrl(node, withUtm=false){
            try{
              const url = new URL(window.location.href);
              if (node?.id != null) url.searchParams.set('work', node.id);
              if (withUtm){
                url.searchParams.set('utm_source','film-evreni');
                url.searchParams.set('utm_medium','share');
                url.searchParams.set('utm_campaign', String(node?.universe || 'genel'));
              }
              return url.toString();
            }catch(e){ return window.location.href; }
          },
          getShareText(node){
            const title = node?.label || 'Bunu bir gör!';
            const uni = this.formatUniverseName?.(node?.universe) || node?.universe || '';
            const genres = (node?.tür || '').toString();
            const tags = [uni, genres].filter(Boolean).map(s => '#' + s.replace(/\s+/g,'')).slice(0,3).join(' ');
            return `${title} ${tags}`.trim();
          },
          async shareNative(node){
            const url = this.buildShareUrl(node, this.sharePrefs?.useUtm ?? true);
            const text = this.buildShareText(node);
            try {
              if (navigator.share) {
                await navigator.share({ title: node?.label || 'Paylaş', text, url });
              } else {
                await navigator.clipboard.writeText(text + '\n' + url);
                alert('Cihaz paylaşımı desteklemiyor. Metin + bağlantı kopyalandı.');
              }
            } catch(e){ /* kullanıcı iptal edebilir */ }
          },
          shareToTelegram(node){
            const url = encodeURIComponent(this.buildShareUrl(node, true));
            const text = encodeURIComponent(this.getShareText(node));
            window.open(`https://t.me/share/url?url=${url}&text=${text}`,'_blank','noopener,noreferrer');
          },
          shareToReddit(node){
            const url = encodeURIComponent(this.buildShareUrl(node, true));
            const title = encodeURIComponent(this.getShareText(node));
            window.open(`https://www.reddit.com/submit?url=${url}&title=${title}`,'_blank','noopener,noreferrer');
          },
          async copyMarkdown(node){
            try{
              const url = this.buildShareUrl(node, true);
              const md = `[${node?.label || 'Bağlantı'}](${url})`;
              await navigator.clipboard.writeText(md);
              this.showFavMsg = true; setTimeout(()=> this.showFavMsg=false,1200);
            }catch(e){ alert('Kopyalanamadı'); }
          },
// --- Share helpers ---
          getShareUrl(node){
            try {
              const url = new URL(window.location.href);
              // keep existing params, add/replace 'work' with node.id
              if (node?.id != null) url.searchParams.set('work', node.id);
              return url.toString();
            } catch(e){
              return window.location.href;
            }
          },
          shareToX(node){
            try{
              const url = encodeURIComponent(this.getShareUrl(node));
              const text = encodeURIComponent(`${node?.label || 'Bunu bir gör!'} 🎬`);
              const share = `https://x.com/intent/tweet?text=${text}&url=${url}`;
              window.open(share, '_blank', 'noopener,noreferrer');
            }catch(e){ console.error(e); }
          },
          shareToWhatsApp(node){
            try{
              const url = encodeURIComponent(this.getShareUrl(node));
              const text = encodeURIComponent(`${node?.label || ''} ${decodeURIComponent(url)}`.trim());
              const share = `https://wa.me/?text=${text}`;
              window.open(share, '_blank', 'noopener,noreferrer');
            }catch(e){ console.error(e); }
          },
          shareToLinkedIn(node){
            const url = encodeURIComponent(this.buildShareUrl(node, this.sharePrefs?.useUtm ?? true));
            const title = encodeURIComponent(node?.label || 'Paylaş');
            const summary = encodeURIComponent(this.buildShareText(node));
            // Prefer shareArticle to include text
            window.open(`https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${title}&summary=${summary}`,'_blank','noopener,noreferrer');
          },
          async copyShare(node){
            try {
              const link = this.getShareUrl(node);
              if (navigator?.clipboard?.writeText) {
                await navigator.clipboard.writeText(link);
              } else {
                const ta = document.createElement('textarea');
                ta.value = link; document.body.appendChild(ta);
                ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
              }
              // ufak bir bildirim
              this.showFavMsg = true;
              setTimeout(()=> this.showFavMsg=false, 1200);
            } catch(e){ console.error(e); alert('Bağlantı kopyalanamadı'); }
          },
selectedEdgeType: null,
          highlightEdgeType(type) {
            try {
              this.selectedEdgeType = (this.selectedEdgeType === type) ? null : type;
              if (!this.edges || !this.network) return;
              // Update edges styling
              const updates = [];
              this.edges.forEach((e) => {
                const isMatch = !type || e.type === type;
                const baseColor = this.edgeColors?.[e.type] || '#94a3b8';
                const style = this.edgeStyles?.[e.type] || { width: 2, dashes: false };
                updates.push({
                  id: e.id ?? `${e.from}-${e.to}-${e.type || ''}`,
                  color: { color: baseColor, opacity: isMatch ? 1 : 0.25 },
                  width: isMatch ? Math.max(3, style.width || 2) : 1,
                  dashes: style.dashes || false
                });
              });
              if (updates.length && this.network && this.network.body && this.network.body.data && this.network.body.data.edges) {
                this.network.body.data.edges.update(updates);
              }
            } catch(e) { /* no-op */ }
          },
    panel: null,
          startTour() {
            const dropdown = document.querySelector(".dropdown-btn");
            dropdown?.classList.add("pointer-events-none", "opacity-50");
            dropdown?.setAttribute("disabled", "true");
            // Shepherd rehberi: Baştan sona adımlar

            const tour = new Shepherd.Tour({
              defaultStepOptions: {
                scrollTo: true,
                cancelIcon: { enabled: true },
              },
            });

            // 1. Hoş Geldin
            tour.addStep({
              title: "Hoş Geldin 🎬",
              text: "Film Evreni Ağı’na hoş geldin!",
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 2. Evren Seç
            tour.addStep({
              title: "Evren Seç 🌌",
              text: "Buradan bir evren seçebilirsin.",
              attachTo: { element: ".dropdown-btn", on: "bottom" },
              buttons: [
                {
                  text: "İleri",
                  action: function () {
                    const dropdown = document.querySelector(".dropdown-btn");
                    dropdown?.classList.remove("pointer-events-none", "opacity-50");
                    dropdown?.removeAttribute("disabled");
                    tour.next();
                  },
                },
              ],
            });

            // 3. Şimdi Evren Seç
            const isMobile = window.innerWidth < 640;

            tour.addStep({
              title: "🌌 Evren Seç",
              text: "Lütfen bir evren seç.",
              attachTo: {
                element: ".dropdown-btn",
                on: isMobile ? "top" : "left",
              },
              scrollTo: true,
              buttons: [],
              when: {
                show() {
                  const geçerliMi = (val) => val && val !== "" && val !== "all";

                  const kontrolEt = () => {
                    try {
                      const selected =
                        Alpine.store("selectedUniverse") ||
                        Alpine.raw(Alpine.$data(document.querySelector("[x-data]")))
                          .selectedUniverse;

                      if (geçerliMi(selected)) {
                        clearInterval(interval);
                        tour.next();
                      }
                    } catch (e) {
                      // Alpine hazır değilse sessizce bekle
                    }
                  };

                  kontrolEt();
                  const interval = setInterval(kontrolEt, 400);
                },
              },
            });

            // 4. Arama
            tour.addStep({
              title: "Film Ara 🔍",
              text: "Film veya dizi aramak için burayı kullan.",
              attachTo: { element: "input[type=search]", on: "bottom" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 5. Yapım Grafiği
            tour.addStep({
              title: "Yapım Grafiği 📊",
              text: "Seçilen evrene ait yapımlar bu ağ grafiğinde gösterilir. <br><br> Bir yapıma tıklayarak yapım bilgi panelini aç.",
              attachTo: { element: "#network", on: "top" },
              scrollTo: false,
              buttons: [], // Buton göstermiyoruz
              when: {
                show() {
                  const checkModalOpen = () => {
                    const modal = document.querySelector(".modal-content");
                    const h2 = modal?.querySelector("h2");
                    const isVisible = modal && getComputedStyle(modal).display !== "none";
                    const hasTitle = h2 && h2.textContent.trim().length > 0;
                    return isVisible && hasTitle;
                  };

                  if (checkModalOpen()) {
                    tour.next(); // Zaten açık ve içerik varsa direkt geç
                    return;
                  }

                  // Aralıkla kontrol et
                  const interval = setInterval(() => {
                    if (checkModalOpen()) {
                      clearInterval(interval);
                      tour.next();
                    }
                  }, 400);
                },
              },
            });

            // 8. Paylaşım
            tour.addStep({
              title: "Paylaşım 🚀",
              text: "Bu butonla yapım bağlantısını kopyalayabilir veya sosyal medyada paylaşabilirsin.",
              attachTo: { element: "#share-btn", on: "bottom" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 9. Vizyon Tarihi
            tour.addStep({
              title: "🎬 Vizyon Tarihi",
              text: "Burada yapımın vizyon tarihini görebilirsin.",
              attachTo: { element: ".modal-content [x-text*=toTRDate]", on: "bottom" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 10. Tür ve IMDB
            tour.addStep({
              title: "⭐ Tür ve IMDB",
              text: "Yapımın türü ve IMDB puanı burada.",
              attachTo: { element: ".modal-content .text-xs.flex", on: "bottom" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 6. Favorilere Ekle
            tour.addStep({
              title: "Favorilere Ekle ⭐",
              text: "Bir yapımı favorilerine eklemek için bu butonu kullan.",
              attachTo: { element: "[x-text*=Favorilere]", on: "bottom" },
              buttons: [
                {
                  text: "İleri",
                  action: function () {
                    const btn = document.querySelector("[x-text*=Favorilere]");
                    if (btn && btn.textContent.includes("✔ Favorilere Eklendi")) {
                      return tour.next();
                    } else {
                      alert("Lütfen önce favorilere ekle.");
                    }
                  },
                },
              ],
            });

            // 11. Tür / Yönetmen / Oyuncular
            tour.addStep({
              title: "🎭 Tür, Yönetmen, Oyuncular",
              text: "Bu bölümde temel bilgiler yer alır.",
              attachTo: { element: ".modal-content .grid > div:nth-child(1)", on: "bottom" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 12. Evren ve Kaynaklar
            tour.addStep({
              title: "🌌 Evren ve Kaynaklar",
              text: "Yapımın ait olduğu evreni ve kaynakları burada görebilirsin.",
              attachTo: { element: ".modal-content .grid > div:nth-child(2)", on: "bottom" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 13. İçerik Özeti
            tour.addStep({
              title: "📝 İçerik Özeti",
              text: "Burada filmin kısa özeti yer alır.",
              attachTo: {
                element: "#content-summary",
                on: "bottom",
              },
              scrollTo: true,
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 14. Göndermeler
            tour.addStep({
              title: "🎯 Göndermeler",
              text: "Filmde yapılan diğer yapımlara göndermeleri burada görebilirsiniz.",
              attachTo: {
                element: "#göndermeler",
                on: "bottom",
              },
              scrollTo: true,
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 15. Bağlantılı Yapımlar
            tour.addStep({
              title: "🔗 Bağlantılı Yapımlar",
              text: "İlgili evrende geçen diğer yapımlar bu bölümde gösterilir.",
              attachTo: {
                element: "#related-works",
                on: "bottom",
              },
              scrollTo: true,
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 7. Not Ekle
            tour.addStep({
              title: "Not Ekle 📝",
              text: "Buraya kişisel notlarını yazabilir, #etiket ekleyebilirsin.",
              attachTo: {
                element: 'input[placeholder="Not ekle... #etiket"]',
                on: "bottom",
              },
              scrollTo: true,
              buttons: [
                {
                  text: "İleri",
                  action: () => tour.next(),
                },
              ],
            });

            // 16. Yapım Panelini Kapat
            tour.addStep({
              title: "📕 Yapım Panelini Kapat",
              text: "Bu paneli kapatarak bir sonraki adıma geçebilirsin.",
              attachTo: { element: "#modal-close", on: "top" },
              scrollTo: true,
              buttons: [],
              when: {
                show() {
                  let modal;

                  const interval = setInterval(() => {
                    modal = document.querySelector("#modal_container");

                    // Modal DOM'da bile değilse → kapandı demektir
                    if (!modal) {
                      clearInterval(interval);
                      tour.next();
                      return;
                    }

                    // Modal DOM'da ama görünmüyorsa
                    const style = window.getComputedStyle(modal);
                    const isHidden =
                      style.display === "none" ||
                      style.visibility === "hidden" ||
                      style.opacity === "0" ||
                      modal.classList.contains("hidden") ||
                      modal.offsetWidth === 0 ||
                      modal.offsetHeight === 0;

                    if (isHidden) {
                      clearInterval(interval);
                      tour.next();
                    }
                  }, 300);
                },
              },
            });

            // 17. Oklar (İlişkiler)
            tour.addStep({
              title: "Oklar Neyi Gösterir? 🔁",
              text: "Grafikteki oklar yapımlar arasındaki ilişkiyi gösterir.",
              attachTo: { element: "#network canvas", on: "top" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 18. Legend Alanı
            tour.addStep({
              title: "📘 Bağlantılar Açıklaması",
              text: "Bağlantılar alanı evren renklerini ve türlerini açıklar.",
              attachTo: { element: "#legend_bar", on: "top" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // Yardımcı: ekranda görünen filtre butonunu bul
            function getVisibleFilterBtn() {
              const btns = document.querySelectorAll('button[title="Filtreler" aria-label="Filtreleri aç"]');
              for (const el of btns) {
                const r = el.getBoundingClientRect();
                const st = getComputedStyle(el);
                const visible =
                  r.width > 0 &&
                  r.height > 0 &&
                  st.visibility !== "hidden" &&
                  st.display !== "none";
                if (visible) return el;
              }
              return null;
            }

            // (startTour() içindeki mevcut "Filtreler" adımını bununla değiştir)
            tour.addStep({
              title: "🎯 Filtreler",
              text: "Yapımları tür, yıl, IMDb ve tipine göre daraltabilirsin.",
              // İlk bağlama denemesi; show()’da kesinleştireceğiz
              attachTo: { element: "#filter_btn", on: "bottom" },
              buttons: [
                {
                  text: "İleri",
                  action: function () {
                    const btn = getVisibleFilterBtn();
                    tour.next();
                  },
                },
              ],
              when: {
                show() {
                  // Görünür butonu bul ve adımı ona yeniden bağla
                  const btn = getVisibleFilterBtn();
                  if (btn) {
                    const step = tour.currentStep;
                    step.updateStepOptions({
                      attachTo: { element: btn, on: "bottom" },
                    });
                  }
                },
              },
            });

            // Timeline
            tour.addStep({
              title: "📅 Zaman Çizelgesi",
              text: "Seçili evrendeki yapımları çıkış yıllarına göre sırayla burada görebilirsin.",
              attachTo: { element: "#timeline_bar", on: "top" },
              buttons: [
                {
                  text: "İleri",
                  action: function () {
                    const btn = document.querySelector("#timeline_bar");
                    if (!btn) return tour.next();

                    tour.next();
                  },
                },
              ],
            });

            // 19. Favori ve Not Paneli
            tour.addStep({
              title: "📂 Sağ Alt Panel",
              text: "Sağ altta favori ve notları görmek için bu alanı kullanabilirsin.",
              attachTo: { element: "#panel_bar", on: "top" },
              scrollTo: false,
              buttons: [
                {
                  text: "İleri",
                  action: function () {
                    // Panel içeriği DOM'da görünür mü kontrol et
                    const panel = document.querySelector('[x-show="panelOpen"]');

                    const isVisible = panel && window.getComputedStyle(panel).display !== "none";

                    if (isVisible) {
                      tour.next();
                      return;
                    }

                    alert("Lütfen önce paneli açmalısın.");

                    // Panel açıldığında bekle ve sonra ilerle
                    const interval = setInterval(() => {
                      const nowVisible = panel && window.getComputedStyle(panel).display !== "none";
                      if (nowVisible) {
                        clearInterval(interval);
                        tour.next();
                      }
                    }, 400); // her 0.4 sn'de bir kontrol et
                  },
                },
              ],
            });

            // 20. Favori Yönetimi
            tour.addStep({
              title: "⭐ Favorileri Gör ve Sil",
              text: "Bu alanda favori yapımları görebilir ve silebilirsin.",
              attachTo: { element: "#fav_bar", on: "left" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 21. Not Yönetimi
            tour.addStep({
              title: "📝 Notları Gör, Düzenle, Sil",
              text: "Notlarını bu alanda görüntüleyebilir, düzenleyebilir ya da silebilirsin.",
              attachTo: { element: "#notlar_bar", on: "left" },
              buttons: [{ text: "İleri", action: tour.next }],
            });

            // 22. Tur Bitti 🎉
            tour.addStep({
              title: "Tebrikler! 🎉",
              text: "Film Evreni Ağı rehberini başarıyla tamamladın. Keşfetmeye hazırsın!",
              buttons: [{ text: "Kapat", action: tour.complete }],
            });
            tour.start();

            document.addEventListener("keydown", function (e) {
              if (e.key === "Enter") {
                // Eğer aktif bir step varsa ve ileri butonu varsa ilerlet
                const step = tour.currentStep;
                if (step) {
                  // Eğer adımda butonlar varsa ilk "next" action'ını çalıştır
                  const nextBtn = step.options.buttons?.find((b) => b.action === tour.next);
                  if (nextBtn) {
                    tour.next();
                  } else {
                    // Eğer özel action varsa onu çalıştır
                    const btnWithAction = step.options.buttons?.[0];
                    btnWithAction?.action?.();
                  }
                }
              }
            });
          },



    editingNoteIndex: null,
    editedNoteText: '',
    startEditNote(i, text) {
      this.editingNoteIndex = i;
      this.editedNoteText = text;
    },
    cancelEditNote() {
      this.editingNoteIndex = null;
      this.editedNoteText = '';
    },
    saveEditedNote(nodeId, i) {
      if (this.notes[nodeId] && this.notes[nodeId][i]) {
        this.notes[nodeId][i].text = this.editedNoteText;
        this.notes[nodeId][i].ts = Date.now();
        this.cancelEditNote();
        if (this.saveNotesToStorage) this.saveNotesToStorage();
      }
    },
    openTimelineNode(id) {
      try {
        if (typeof this.__openNode === 'function') {
          this.__openNode(id);
        } else if (this.nodes && typeof this.nodes.get === 'function') {
          const it = this.nodes.get(id);
          if (it) { this.modalNode = it; this.modalOpen = true; this.$nextTick(()=>{ try{ this.pushPrettyUrl && this.pushPrettyUrl(this.modalNode); }catch(e){} }); }
        } else if (Array.isArray(this.allNodes)) {
          const it = this.allNodes.find(x => x && x.id === id);
          if (it) { this.modalNode = it; this.modalOpen = true; }
        }
      } catch (e) {
        // no-op: fail silently
      } finally {
        this.timelineOpen = false;
      }
    },

    
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
    
        network: null, allNodes: [], allEdges: [], nodes: null, edges: null,
        filteredNodes: [], filteredEdges: [],
        search: '', selectedUniverse: '', modalOpen: false, modalNode: null,
        timelineOpen: false,
        universeList: [], fitTimeout: null, showLegend: true,
        suggestions: [], acOpen: false,
        watchLater: [], watchLaterOpen: false, panelOpen: false, activeTab: 'watch', showGraph: false,
        notes: {}, newNote: '', notesOpen: false, notesUniverseFilter: '', notesTagFilter: '', editingNoteIndex: null, editedNoteText: '',
        bgUrl: 'assets/images/bg.jpg',
        bgMap: {
          "": "assets/images/bg.jpg",
          "avatar": "assets/images/pandora.jpg",
          "dc": "assets/images/dc.jpg",
          "harrypotter": "assets/images/harrypotter.jpg",
          "marvel": "assets/images/marvel.jpg",
          "matrix": "assets/images/matrix.jpg",
          "middleearth": "assets/images/middleearth.jpg",
          "pixar": "assets/images/pixar.jpg",
          "starwars": "assets/images/starwars.jpg"
        },
        get edgeList(){
          if (!this.modalNode || !this.allEdges) return [];
          return this.allEdges
            .filter(e => e.from === this.modalNode.id || e.to === this.modalNode.id)
            .map(e => ({ ...e, otherNodeId: e.from === this.modalNode.id ? e.to : e.from }));
        },
edgeColors: {
  "Ana Hikaye Bağlantısı": "#2c3e50",
  "Ana Tehdit": "#ff0000",
  "Anahtar Karakter": "#e84393",
  "Anahtar Olay": "#f39c12",
  "Crossover": "#8e44ad",
  "Devam": "#2980b9",
  "Doğrudan Devam": "#3498db",
  "Evrensel Bağlantı": "#16a085",
  "Evrensel Gelişme": "#c0392b",
  "Geçmiş Hikayesi": "#6e4b25",
  "Gizli Bağlantı": "#8e44ad",
  "Hikaye Devamı": "#27ae60",
  "Hikaye Öncesi": "#1abc9c",
  "Karakter Bağlantısı": "#9b59b6",
  "Karakter Devamı": "#34495e",
  "Karakter Geçişi": "#34495e",
  "Kozmik Genişleme": "#1abc9c",
  "Kozmik Katılım": "#16a085",
  "Mekan Bağlantısı": "#6e4b25",
  "Paralel Olay": "#7f8c8d",
  "Psikolojik Etki": "#e74c3c",
  "Siyasi Etki": "#d35400",
  "Siyasi Çözülme": "#d35400",
  "Sonrası Etki": "#9b59b6",
  "Sonsuzluk Taşı": "#f1c40f",
  "Takım Kurulumu": "#27ae60",
  "Tarihsel Bağlantı": "#95a5a6",
  "Türsel Bağlantı": "#8e44ad",
  "Yeni Tehdit": "#c0392b",
  "Çoklu Evren": "#00bcd4",
  "Önemli Olay": "#e67e22"
},

edgeStyles: {
  "Ana Hikaye Bağlantısı": { width: 3, dashes: false },
  "Ana Tehdit": { width: 3, dashes: [6,4] },
  "Anahtar Karakter": { width: 2.3, dashes: [8,4] },
  "Anahtar Olay": { width: 2.6, dashes: [2,4] },
  "Crossover": { width: 2.5, dashes: [4,8] },
  "Devam": { width: 3, dashes: false },
  "Doğrudan Devam": { width: 3, dashes: [2,6] },
  "Evrensel Bağlantı": { width: 2.3, dashes: [5,5] },
  "Evrensel Gelişme": { width: 2.5, dashes: [4,4] },
  "Geçmiş Hikayesi": { width: 2.2, dashes: [6,6] },
  "Gizli Bağlantı": { width: 2.2, dashes: [3,7] },
  "Hikaye Devamı": { width: 2.8, dashes: false },
  "Hikaye Öncesi": { width: 2.5, dashes: [4,6] },
  "Karakter Bağlantısı": { width: 2.2, dashes: [6,4] },
  "Karakter Devamı": { width: 3, dashes: [6,4] },
  "Karakter Geçişi": { width: 3, dashes: [10,4] },
  "Kozmik Genişleme": { width: 2.5, dashes: [4,6] },
  "Kozmik Katılım": { width: 2.3, dashes: [5,5] },
  "Mekan Bağlantısı": { width: 2, dashes: [8,6] },
  "Paralel Olay": { width: 2, dashes: [12,6] },
  "Psikolojik Etki": { width: 2.5, dashes: [2,6] },
  "Siyasi Etki": { width: 2.4, dashes: [6,8] },
  "Siyasi Çözülme": { width: 2.8, dashes: [6,6] },
  "Sonrası Etki": { width: 2.4, dashes: [6,8] },
  "Sonsuzluk Taşı": { width: 2.5, dashes: [2,6] },
  "Takım Kurulumu": { width: 2.8, dashes: false },
  "Tarihsel Bağlantı": { width: 2.3, dashes: [5,7] },
  "Türsel Bağlantı": { width: 2.5, dashes: [4,6] },
  "Yeni Tehdit": { width: 2.5, dashes: [4,4] },
  "Çoklu Evren": { width: 2.8, dashes: [6,3] },
  "Önemli Olay": { width: 3, dashes: [2,6] }
},

// ---- yardımcılar (return {...} içine) ----
normUrl(u) { try { return new URL(u).href; } catch { return u || ''; } },
hostName(u) { try { return new URL(u).hostname.replace(/^www\./,''); } catch { return u || ''; } },
normalizeItem(it) {
  if (!it) return null;
  if (typeof it === 'string') {
    const url = this.normUrl(it);
    return url ? { name: this.hostName(url) || url, url } : null;
  }
  if (typeof it === 'object') {
    const url = this.normUrl(it.url || '');
    const name = it.name || this.hostName(url) || url;
    return (url || name) ? { name, url } : null;
  }
  return null;
},
mapCategory(key) {
  const k = (key || '').toLowerCase();
  if (k.includes('görsel') || k.includes('gorsel') || k.includes('image') || k.includes('poster')) return 'Görsel';
  if (k.includes('platform') || k.includes('watch') || k.includes('stream')) return 'Platform';
  // default
  return 'Kaynaklar';
},
normalizeSources(src) {
  // Her durumda şu yapıyı döndür: { Kaynaklar:[], Görsel:[], Platform:[] }
  const out = { Kaynaklar: [], Görsel: [], Platform: [] };

  const push = (cat, item) => {
    const n = this.normalizeItem(item);
    if (n) out[cat].push(n);
  };

  if (!src) return out;

  // Obje: { "Kaynaklar": [...], "Görsel": [...], "Platform": [...] , ... }
  if (typeof src === 'object' && !Array.isArray(src)) {
    for (const [k, v] of Object.entries(src)) {
      const cat = this.mapCategory(k);
      const arr = Array.isArray(v) ? v : [v];
      arr.forEach(it => push(cat, it));
    }
    return out;
  }

  // Dizi:
  // - Düz link listesi: [{name,url}] ya da ["https://..."] -> Kaynaklar
  // - Gruplu: [{category:'...', items:[...]}]
  if (Array.isArray(src)) {
    if (!src.length || typeof src[0] !== 'object' || ('url' in src[0]) || ('name' in src[0])) {
      src.forEach(it => push('Kaynaklar', it));
    } else {
      src.forEach(g => {
        const cat = this.mapCategory(g?.category);
        const items = Array.isArray(g?.items) ? g.items : (g?.items ? [g.items] : []);
        items.forEach(it => push(cat, it));
      });
    }
    return out;
  }

  // String / tek obje vs:
  push('Kaynaklar', src);
  return out;
},

getSourceIcon(cat) {
  if (cat === 'Görsel') return '🖼️';
  if (cat === 'Platform') return '🎬';
  return '📚'; // Kaynaklar
},
confirmExternal(url) {
  const msg = 'Bu bağlantı sizi harici bir siteye yönlendirecek. Devam etmek istiyor musunuz?';
  if (url && confirm(msg)) window.open(url, '_blank', 'noopener');
},


norm(s) {
  if (!s) return '';
  // TR küçültme + ı→i düzeltmesi + aksan temizleme
  return s
    .toLocaleLowerCase('tr')   // İ→i, I→ı
    .replace(/ı/g, 'i')        // 'ı'ları da 'i' yap
    .normalize('NFD')          // aksanları ayır
    .replace(/[\u0300-\u036f]/g, ''); // aksanları sil
},


        get timelineSortedNodes(){
          const u = this.selectedUniverse;
          return [...this.allNodes]
            .filter(n => n.release_date && (!u || n.universe === u))
            .sort((a, b) => new Date(a.release_date) - new Date(b.release_date));
        },
        get groupTimelineByYear(){
          const groups = new Map();
          for (const n of this.timelineSortedNodes) {
            const y = new Date(n.release_date).getFullYear();
            if (!groups.has(y)) groups.set(y, []);
            groups.get(y).push(n);
          }
          for (const [y, arr] of groups.entries()) { arr.sort((a,b)=> new Date(a.release_date) - new Date(b.release_date)); }
          return Array.from(groups.entries()).sort((a,b)=> b[0]-a[0]);
        },
        
get legendEntries() {
  const usedTypes = new Set(this.filteredEdges.map(e => e.type));
  return Object.entries(this.edgeColors).filter(([t]) =>
    usedTypes.has(t) || this.filteredEdges.length === 0
  );
}
,

openFilterPanel: false,

filters: {
  genres: [],     // ["Aksiyon","Bilim Kurgu"] gibi
  yearMin: null,  // 2008
  yearMax: null,  // 2025
  imdbMin: null,  // 7.0
  type: 'all',    // 'all' | 'film' | 'dizi'
},

get activeFilterCount() {
  let c = 0;
  if (this.filters.genres?.length) c++;
  if (this.filters.yearMin != null || this.filters.yearMax != null) c++;
  if (this.filters.imdbMin != null) c++;
  if (this.filters.type && this.filters.type !== 'all') c++;
  return c;
},

resetFilters() {
  this.filters = { genres: [], yearMin: null, yearMax: null, imdbMin: null, type: 'all' };
  this.applyFilters();
  this.openFilterPanel = false;
},

get availableGenres() {
  const s = new Set();
  for (const n of this.allNodes) {
    const raw = (n.tür || n.genre || n.genres || '').toString();
    raw.split(/[,\|/]/).map(x => x.trim()).filter(Boolean).forEach(g => s.add(g));
  }
  return s.size ? Array.from(s).sort() : [
    "Aksiyon","Macera","Bilim Kurgu","Dram","Fantastik","Animasyon","Komedi","Gerilim"
  ];
},

        get notesSummary(){
          const groups = new Map();
          for (const [nodeId, arr] of Object.entries(this.notes)){
            if (!arr || !arr.length) continue;
            const node = this.nodes?.get(nodeId) || this.allNodes.find(n => String(n.id)===String(nodeId));
            const g = groups.get(nodeId) || { count: 0, tags: new Set(), label: node?.label || nodeId, universe: node?.universe || '' };
            g.count += arr.length;
            for (const n of arr) (n.tags||[]).forEach(t => g.tags.add(t));
            groups.set(nodeId, g);
          }
          const u = this.notesUniverseFilter;
          const tagQ = (this.notesTagFilter || '').trim().replace(/^#/, '').toLowerCase();
          return Array.from(groups.entries()).map(([nodeId, g]) => ({ nodeId, label: g.label, universe: g.universe, count: g.count, tags: Array.from(g.tags) }))
            .filter(x => (!u || x.universe === u) && (!tagQ || x.tags.some(t => t.includes(tagQ))))
            .sort((a,b)=> b.count - a.count || a.label.localeCompare(b.label));
        },
        getAllEdgesWithNotes(nodeId) {
          if (!nodeId) return [];
          return this.allEdges
            .filter(e => e.from === nodeId || e.to === nodeId)
            .map(e => {
              const otherNodeId = e.from === nodeId ? e.to : e.from;
              const otherNode = this.allNodes.find(n => String(n.id) === String(otherNodeId));
              return {
    panel: null,
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     id: e.id || (e.from + "_" + e.to + "_" + (e.type || "")), otherNodeId, otherNodeLabel: otherNode?.label || otherNodeId, type: e.type, edgeHasNotes: !!e.notes, edgeNoteText: e.notes || "", nodeHasNotes: !!(this.notes && this.notes[otherNodeId] && this.notes[otherNodeId].length) };
            });
        },
        formatEdgeType(type) { if (!type) return ''; return type.charAt(0).toUpperCase() + type.slice(1); },
        get topTags(){
          const counts = new Map();
          const u = this.notesUniverseFilter;
          for (const [nodeId, arr] of Object.entries(this.notes)){
            if (!arr || !arr.length) continue;
            const node = this.allNodes.find(n => String(n.id) === String(nodeId));
            if (u && node?.universe !== u) continue;
            for (const n of arr) for (const t of (n.tags || [])) counts.set(t, (counts.get(t) || 0) + 1);
          }
          return Array.from(counts.entries()).sort((a,b) => b[1] - a[1]).slice(0, 10).map(([t]) => t);
        },
        init() {
          
this.resetFilters();


this.$watch && this.$watch('filters', (v) => {
  localStorage.setItem('filters', JSON.stringify(v));
});

  if (window.innerWidth < 640) {
    this.showLegend = false;
  } else {
    this.showLegend = true;
  }
          try { const old = localStorage.getItem('comments'); if (old && !localStorage.getItem('notes')) { localStorage.setItem('notes', old); localStorage.removeItem('comments'); } } catch {}
          this.loadWatchLater(); this.loadNotes(); this.network = null;
          this.setBackgroundFor(this.selectedUniverse); this.warmBackgrounds();
          this.loadData();

this.setupNetwork();
this.applyFilters();



          let debounceTimeout = null;
this.$watch('search', (val) => {
  clearTimeout(debounceTimeout);
  debounceTimeout = setTimeout(() => {
    this.applyFilters();
    if (val) {
      const q = this.norm(val);
      const starts = [], contains = [], seen = new Set();
      for (const n of this.allNodes) {
        const lbl = n.label || '';
        const l = this.norm(lbl);
        if (l.startsWith(q)) {
          if (!seen.has(lbl)) { starts.push(lbl); seen.add(lbl); }
        } else if (l.includes(q)) {
          if (!seen.has(lbl)) { contains.push(lbl); seen.add(lbl); }
        }
        if (starts.length + contains.length >= 10) break;
      }
      this.suggestions = [...starts, ...contains];
    } else {
      this.suggestions = [];
    }
  }, 220);
});

this.$watch('modalOpen', (isOpen) => {
  try {
    if (isOpen && this.modalNode) {
      this.pushPrettyUrl && this.pushPrettyUrl(this.modalNode);
    } else {
      this.resetPrettyUrl && this.resetPrettyUrl();
    }
  } catch(e) { console.warn('modalOpen watch', e); }
});



          
this.$watch('selectedUniverse', (val) => {
  if (val) {
    this.setBackgroundFor(val);
    if (!this.network) this.setupNetwork();
    this.applyFilters();
  }
  this.notesUniverseFilter = val;

  try { this.setParams({ u: val || '', clearNode: true }); } catch {}
});

        },
        async setBackgroundFor(universe){
          const primary = this.bgMap[universe || ""] || this.bgMap[""];
          const fallbacks = ["assets/images/bg.jpg", "assets/images/bg.jpg"];
          const tried = new Set();
          const tryLoad = (url) => new Promise((resolve,reject)=>{ if(!url || tried.has(url)) return reject(); tried.add(url); const img = new Image(); img.onload = () => resolve(url); img.onerror = () => reject(); img.decoding = 'async'; img.referrerPolicy = 'no-referrer'; img.src = url; });
          for (const url of [primary, ...fallbacks]) { try { const ok = await tryLoad(url); this.bgUrl = ok; return; } catch {} }
        },
        warmBackgrounds(){ [...new Set(Object.values(this.bgMap))].forEach(u => { const i = new Image(); i.decoding='async'; i.src = u; }); },
        loadWatchLater(){ try { this.watchLater = JSON.parse(localStorage.getItem('watchLater') || '[]'); } catch { this.watchLater = []; } },
        saveWatchLater(){ localStorage.setItem('watchLater', JSON.stringify(this.watchLater)); },
        isInWatchLater(id){ return !!this.watchLater.find(x => String(x.id) === String(id)); },
        toggleWatchLater(node){ if (!node?.id) return; if (this.isInWatchLater(node.id)) this.watchLater = this.watchLater.filter(x => String(x.id) !== String(node.id)); else this.watchLater.unshift({ id: node.id, label: node.label || String(node.id) }); this.saveWatchLater(); },
        removeWatchLater(id){ this.watchLater = this.watchLater.filter(x => String(x.id) !== String(id)); this.saveWatchLater(); },
        loadNotes(){ try { this.notes = JSON.parse(localStorage.getItem('notes')||'{}'); } catch { this.notes = {}; } },
        saveNotes(){ localStorage.setItem('notes', JSON.stringify(this.notes)); },
        extractTags(t){ return Array.from(t.matchAll(/#([\p{L}\d_-]+)/gu)).map(m=>m[1].toLowerCase()); },
        addNote(nodeId){ const t = (this.newNote || '').trim(); if (!nodeId || !t) return; const item = { text: t, tags: this.extractTags(t), pin: false, ts: Date.now(), editedTs: null }; (this.notes[nodeId] ||= []).unshift(item); this.newNote = ''; this.saveNotes(); },
        togglePin(nodeId, idx){ const n = this.notes[nodeId]?.[idx]; if (!n) return; n.pin = !n.pin; this.saveNotes(); },
        deleteNote(nodeId, idx){ this.notes[nodeId].splice(idx, 1); this.saveNotes(); },
        startEditNote(index, text) {
          this.editingNoteIndex = index;
          this.editedNoteText = text;
        },
        cancelEditNote() {
          this.editingNoteIndex = null;
          this.editedNoteText = '';
        },
        saveEditedNote(nodeId, index) {
          if (!this.notes[nodeId] || !this.notes[nodeId][index]) return;
          const updatedText = (this.editedNoteText || '').trim();
          if (!updatedText) return;
          this.notes[nodeId][index].text = updatedText;
          this.notes[nodeId][index].tags = this.extractTags(updatedText);
          this.notes[nodeId][index].editedTs = Date.now();
          this.saveNotes();
          this.cancelEditNote();
        },

        
makeSlug(str) {
  return (str || '')
    .toLocaleLowerCase('tr')
    .normalize('NFD').replace(/[̀-\u036f]/g, '')
    .replace(/ı/g,'i').replace(/İ/g,'i').replace(/ş/g,'s')
    .replace(/ç/g,'c').replace(/ğ/g,'g').replace(/ö/g,'o').replace(/ü/g,'u')
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/(^-|-$)/g,'');
},
nodeYear(n) {
  const y = (n?.release_date || n?.date || '').toString();
  const m = y.match(/\d{4}/);
  return m ? m[0] : '';
},
prettyNodePath(node) {
  const name = node?.label || node?.title || node?.name || '';
  const raw = this.makeSlug(name);
  const m = raw.match(/-(\d{4})$/);
  const slugNoYear = m ? raw.slice(0, -5) : raw;
  const yrFromSlug = m ? m[1] : null;
  const yr = yrFromSlug || this.nodeYear(node);
  const finalSlug = yr ? `${slugNoYear}-${yr}` : slugNoYear;

  const parts = location.pathname.split('/').filter(Boolean);
  const base = parts.length ? `/${parts[0]}` : '/evren';
  return `${base}/${finalSlug}`;
},

pushPrettyUrl(node) {
  try {
    const u = node?.universe || '';
    const id = node?.id != null ? String(node.id) : '';
    const url = new URL(location.href);
    url.searchParams.set('u', u);
    url.searchParams.set('node', id);
    history.replaceState({}, '', url);
  } catch (e) {
    console.warn('pushPrettyUrl error', e);
  }
},


resetPrettyUrl() {
  try {
    const url = new URL(location.href);
    url.search = '';
    history.replaceState({}, '', url.origin + url.pathname);
  } catch (e) {
    console.warn('resetPrettyUrl error', e);
  }
}
,

buildNodeUrl(nodeId){ const node = this.nodes?.get(nodeId) || this.allNodes.find(n => String(n.id)===String(nodeId)); const u = node?.universe || ''; const base = location.origin + location.pathname; const params = new URLSearchParams({ u, node: String(nodeId) }); return `${base}?${params.toString()}`; },
        shareNode(node, platform){ if (!node?.id) return; const url = this.buildNodeUrl(node.id); const text = `${node.label || node.id} — ${this.formatUniverseName(node.universe)}\n${url}`; const enc = encodeURIComponent(text); const shareUrl = platform === 'whatsapp' ? `https://api.whatsapp.com/send?text=${enc}` : platform === 'x' ? `https://twitter.com/intent/tweet?text=${enc}` : ''; if (shareUrl) window.open(shareUrl, '_blank', 'noopener'); },
        

async loadData() {
  const evrenler = ["avatar","dc","harrypotter","marvel","matrix","middleearth","pixar","starwars"];
  try {
    const results = await Promise.all(
      evrenler.map(evren =>
        fetch('assets/data/' + evren + '.json', { cache: 'no-store' })
          .then(r => { if (!r.ok) throw new Error(evren + ' yüklenemedi'); return r.json().then(data => ({ evren, data })); })
      )
    );
    let nodesTemp = [], edgesTemp = [];
    for (const { evren, data } of results) {
      nodesTemp = nodesTemp.concat(data.nodes.map(n => ({ ...n, universe: evren })));
      edgesTemp = edgesTemp.concat(data.edges);
    }
    this.allNodes = nodesTemp;
    this.allEdges = edgesTemp;
    this.universeList = [...new Set(this.allNodes.map(n => n.universe))];

    // Parametreleri oku (hata güvenli)
    let qU = null, qNode = null;
    try {
      const params = new URLSearchParams(location.search);
      qU = params.get('u');
      qNode = params.get('node');
    } catch(_) {}

    if (qU && this.universeList.includes(qU)) {
      this.selectedUniverse = qU;
    }

    // Filtre uygula (network hazır değilse sorun yok)
    this.applyFilters?.();

    if (qNode) {
      const node = this.allNodes.find(n => String(n.id) === String(qNode));
      if (node) {
        this.$nextTick?.(() => {
          try {
            this.modalNode = node;
            this.modalOpen = true;
            if (this.network) {
              try { this.network.selectNodes([qNode]); } catch {}
              try { this.network.focus(qNode, { animation: true, scale: 1 }); } catch {}
            }
          } catch (e) {
            console.warn('Modal açma sırasında hata:', e);
          }
        });
      }
    }
  } catch (err) {
    console.error('loadData hata:', err);
    alert('Veri yükleme hatası: ' + (err && err.message ? err.message : String(err)));
  }
},


        openNode(id) { const node = this.nodes?.get(id) || this.allNodes.find(n => String(n.id) === String(id)); if (node) { this.modalNode = node; this.modalOpen = true; window.__modalWasOpened = true; this.network?.selectNodes([id]); this.network?.focus(id, { animation: true, scale: 1 }); } },
        makeOptions() { return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     nodes: { size: 25, font: { color: '#e5e7eb', size: 14 }, borderWidthSelected: 6, color: { border: '#ef4444' } }, edges: { arrows: { to: { enabled: true, scaleFactor: 0.5 } }, smooth: { enabled: true, type: 'dynamic' } }, interaction: { hover: true, tooltipDelay: 200, zoomView: true, dragView: true }, physics: { stabilization: true, barnesHut: { gravitationalConstant: -4000 } }, layout: { improvedLayout: true } }; },
        setupNetwork() { this.nodes = new vis.DataSet(); this.edges = new vis.DataSet(); const container = document.getElementById('network'); this.network = new vis.Network(container, { nodes: this.nodes, edges: this.edges }, this.makeOptions()); this.network.on('click', params => { if (params.nodes.length > 0) { const node = this.nodes.get(params.nodes[0]); requestAnimationFrame(() => { this.modalNode = node; this.modalOpen = true; }); } }); },
        applyFilters() {
  if (!this.nodes || !this.edges) return;

const searchTerm = this.norm(this.search);

  const universe = this.selectedUniverse;

  const f = this.filters || {};
  const yearMin = f.yearMin != null ? Number(f.yearMin) : null;
  const yearMax = f.yearMax != null ? Number(f.yearMax) : null;
  const imdbMin = f.imdbMin != null ? Number(f.imdbMin) : null;
  const chosenGenres = new Set(((f.genres || [])).map(g => (g||'').toLowerCase()));
  const wantedType = (f.type || 'all');

  this.filteredNodes = (this.allNodes || []).filter(n => {
    // Evren + arama
    if (universe && n.universe !== universe) return false;
  if (searchTerm) {
  const lbl = this.norm(n.label);
  if (!lbl.includes(searchTerm)) return false;
}

    // Yıl
    if (yearMin != null || yearMax != null) {
      const y = n.release_date ? new Date(n.release_date).getFullYear() : null;
      if (yearMin != null && (y == null || y < yearMin)) return false;
      if (yearMax != null && (y == null || y > yearMax)) return false;
    }

    // IMDb
    if (imdbMin != null) {
      const r = n.imdb_rating != null ? Number(n.imdb_rating) : null;
      if (r == null || r < imdbMin) return false;
    }

    // Tür (genre)
    if (chosenGenres.size) {
      const raw = (n.tür || n.genre || n.genres || '').toString().toLowerCase();
      const nodeGenres = raw.split(/[,\|/]/).map(x => x.trim()).filter(Boolean);
      const hasAny = nodeGenres.some(g => chosenGenres.has(g));
      if (!hasAny) return false;
    }

    // Yapım tipi (film/dizi)
    if (wantedType !== 'all') {
      const nodeType = (n.type || n.tip || '').toString().trim().toLowerCase();
      const mapped = nodeType == 'movie' ? 'film'
                   : nodeType == 'series' ? 'dizi'
                   : nodeType;
      if (mapped !== wantedType) return false;
    }

    return true;
  });

  const nodeIds = new Set(this.filteredNodes.map(n => n.id));
  this.filteredEdges = (this.allEdges || []).filter(e => nodeIds.has(e.from) && nodeIds.has(e.to));

  this.updateNetwork && this.updateNetwork();
  if (this.network) {
    if (this.fitTimeout) clearTimeout(this.fitTimeout);
    this.fitTimeout = setTimeout(() => this.network.fit({ animation: true }), 220);
  }
},
        updateNetwork() {

            // Çıkış yılına göre renk skalası (mavi -> kırmızı)
            const getColorByYear = (year) => {
              if (!year) return '#888';
              const minYear = 1980;
              const maxYear = new Date().getFullYear();
              const ratio = Math.max(0, Math.min(1, (year - minYear) / (maxYear - minYear)));
              const r = Math.round(255 * ratio);
              const b = Math.round(255 * (1 - ratio));
              return `rgb(${r},50,${b})`;
            };

          this.nodes.clear(); this.edges.clear();
          this.nodes.add(this.filteredNodes.map(n => { const hasImage = !!n.image; const noteCount = (this.notes[n.id]?.length || 0); return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     ...n, label: noteCount ? `${n.label}\n📝 ${noteCount}` : n.label, font: { color: '#e5e7eb', size: 14, multi: true, vadjust: 4 }, shape: hasImage ? 'circularImage' : 'dot', borderWidth: 2, borderWidthSelected: 6, color: hasImage ? { border: getColorByYear(n.release_date ? new Date(n.release_date).getFullYear() : null) } : { background: getColorByYear(n.release_date ? new Date(n.release_date).getFullYear() : null), border: getColorByYear(n.release_date ? new Date(n.release_date).getFullYear() : null) } }; }));
          this.edges.add(this.filteredEdges.map(e => { const color = this.edgeColors[e.type] || '#9ca3af'; const s = this.edgeStyles[e.type] || { width: 1.5, dashes: false }; return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     ...e, arrows: 'to', color: { color }, width: s.width, dashes: s.dashes }; }));
        },
        neighborChips(nodeId) { if (!nodeId || !this.network) return ''; const neighbors = this.network.getConnectedNodes(nodeId).map(id => this.nodes.get(id)).filter(Boolean); if (!neighbors.length) return '<span class="text-sm opacity-70">Bağlantı bulunamadı.</span>'; return neighbors.map(n => `<button class="chip hover:brightness-110" onclick="window.__openNode('${String(n.id).replace(/'/g,'&#39;')}')">${n.label ? n.label.replace(/</g,'&lt;') : 'ID ' + n.id}</button>`).join(''); },
        formatUniverseName(name) { const map = { "avatar": "Avatar", "dc": "DC", "marvel": "Marvel", "harrypotter": "Harry Potter", "matrix": "Matrix", "middleearth": "Orta Dünya", "pixar": "Pixar", "starwars": "Star Wars" }; return map[name] || name; }
      }
    }
    window.openNode = function(id) { const scope = document.querySelector('html')?.__x?.$data; if (!scope?.openNode) return; scope.openNode(id); };
    window.__openNode = function(id) { let scope = document.querySelector('html')?.__x?.$data; if (!scope?.nodes) { for (const el of document.querySelectorAll('[x-data]')) { if (el.__x && el.__x.$data?.nodes) { scope = el.__x.$data; break; } } } if (!scope?.nodes) return; const node = scope.nodes.get(id); if (node) { requestAnimationFrame(() => { scope.modalNode = node; scope.modalOpen = true; scope.network.selectNodes([id]); scope.network.focus(id, { animation: true, scale: 1 }); }); } };
  </script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered', reg.scope))
          .catch(err => console.warn('SW register failed', err));
      });
    }
  </script>
<script>
    const SHARE_PHRASES = { more: 'Devamı için ziyaret et:', farewell: 'Sinemayla kalın.', dash: ' — ' };
    const EMOJI = { title: '🎬', date: '📅', summary: '📝', more: '👉', link: '🔗', bye: '🍿' };
    function preferredUrl(node){
  try {
    const url = new URL(location.href);
    url.searchParams.set('u', node?.universe || '');
    url.searchParams.set('node', String(node?.id ?? ''));
    return url.origin + url.pathname + '?' + url.searchParams.toString();
  } catch (_) {
    // Eski tarayıcılar için basit fallback
    var u = (node && node.universe) ? node.universe : '';
    var i = (node && node.id != null) ? String(node.id) : '';
    return location.pathname + '?u=' + encodeURIComponent(u) + '&node=' + encodeURIComponent(i);
  }
};
  const slugNoYear = m ? raw.slice(0, -5) : raw;
  const yrFromSlug = m ? m[1] : null;
  const yr = yrFromSlug || (window.app?.nodeYear ? window.app.nodeYear(node) : '');
  const finalSlug = yr ? `${slugNoYear}-${yr}` : slugNoYear;

  const parts = location.pathname.split('/').filter(Boolean);
  const base = parts.length ? `/${parts[0]}` : '/evren';
  return location.origin + `${base}/${finalSlug}`;

    function composeShareText(node) {
      const filmAdi  = node?.label || node?.title || node?.name || 'Bu yapım';
      const line1 = `${EMOJI.title} ${filmAdi}`;
      const takvimTR = toTRDate(node?.release_date || node?.date);
      const line2 = takvimTR ? `${EMOJI.date} ${takvimTR}` : '';
      const aciklamaFull = (node?.description || '').trim();
      const gondermelerFull = (node?.refers_to || '').trim();
      const aciklama = aciklamaFull.length > 120 ? aciklamaFull.slice(0,117).trimEnd() + '...' : aciklamaFull;
      const gondermeler = gondermelerFull.length > 100 ? gondermelerFull.slice(0,97).trimEnd() + '...' : gondermelerFull;
      let line3 = '';
      if (aciklama && gondermeler) line3 = `${EMOJI.summary} Film Özeti: ${aciklama}${SHARE_PHRASES.dash}Göndermeler: ${gondermeler}`;
      else if (aciklama) line3 = `${EMOJI.summary} Film Özeti: ${aciklama}`;
      else if (gondermeler) line3 = `${EMOJI.summary} Göndermeler: ${gondermeler}`;
      if (line3 && !/[.!?…]$/.test(line3.trim())) line3 = line3.trim() + '.';
      const url = preferredUrl(node);
      const line4 = `${SHARE_PHRASES.more} ${EMOJI.more}`;
      const line5 = `${EMOJI.link} ${url}`;
      const line6 = `${SHARE_PHRASES.farewell} ${EMOJI.bye}`;
      return [line1, line2, line3, line4, line5, line6].filter(Boolean).join('\n');
    }
    function composeShareTextForX(node, max = 240) { const url = preferredUrl(node); const single = composeShareText(node).replace(/\n+/g, ' | '); const withoutUrl = single.replace(url, '').replace(/\s*\|\s*\|\s*/g, ' | ').trim(); return withoutUrl.length <= max ? withoutUrl : (withoutUrl.slice(0, max - 1) + '…'); }
    window.shareToX = function(node) { const url = preferredUrl(node); const text = composeShareTextForX(node); window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,'_blank','noopener,noreferrer'); };
    window.shareToWhatsApp = function(node) { const text = composeShareText(node); window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`,'_blank','noopener,noreferrer'); };
    window.shareToLinkedIn = function(node) { const url  = preferredUrl(node); const name = node?.label || node?.title || node?.name || 'Bu yapım'; const sum  = composeShareText(node); window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(name)}&summary=${encodeURIComponent(sum)}`,'_blank','noopener,noreferrer'); };
    window.copyShare = async function(node) { const full = composeShareText(node) + '\n'; try { await navigator.clipboard.writeText(full); alert('Paylaşım metni ve link kopyalandı.'); } catch { const ta = document.createElement('textarea'); ta.value = full; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('Paylaşım metni ve link kopyalandı.'); } };
  </script>
<script>
    window.toTRDate = function(value) { if (!value) return ''; const s = String(value).trim(); const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s); if (m) return `${m[3]}/${m[2]}/${m[1]}`; const d = new Date(s); if (isNaN(d)) return s; const dd = String(d.getDate()).padStart(2, '0'); const mm = String(d.getMonth() + 1).padStart(2, '0'); const yyyy = d.getFullYear(); return `${dd}/${mm}/${yyyy}`; };
  </script>

</div>
<div id="legendWrap" x-show="selectedUniverse">
<button id="legend_bar" @click="showLegend = !showLegend" class="glass px-3 py-1.5 rounded-lg text-sm hover:bg-white/10 transition" id="legendToggle">Bağlantılar <span x-text="showLegend ? '(Gizle)' : '(Göster)'"></span></button>
<div id="legend" role="list" x-show="showLegend" x-transition="">
<h3 class="font-bold mb-2">Bağlantılar</h3>
<ul>
<template :key="type" x-for="[type, color] in legendEntries">
<li class="flex items-center mb-1"><svg class="mr-2" height="8" width="36"><line :stroke="color" :stroke-dasharray="(edgeStyles[type]?.dashes ? edgeStyles[type].dashes.join(',') : '0')" stroke-width="3" x1="2" x2="34" y1="4" y2="4"></line></svg><span x-text="type"></span></li>
</template>
</ul>
</div>






<!-- Timeline button above Notes & Favorites -->
<button
  id="timeline_bar"
  @click="timelineOpen = !timelineOpen"
  class="fixed right-4 bottom-[8rem] z-[50] glass rounded-full w-12 h-12 grid place-items-center hover:bg-white/10 pointer-events-auto"
  title="Zaman Çizelgesi"
>
  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v3H2V6a2 2 0 0 1 2-2h1V3a1 1 0 1 1 2 0v1z"/>
    <path d="M2 10h20v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8zm6 3a1 1 0 1 0 0 2h5a1 1 0 1 0 0-2H8z"/>
  </svg>
</button>

<!-- Yeni panel açma butonu -->
<button @click="panelOpen = !panelOpen" id="panel_bar" class="fixed right-4 bottom-[4.5rem] z-50 glass rounded-full w-12 h-12 grid place-items-center hover:bg-white/10" title="Notlar ve Favoriler">📁</button>


<!-- Notlar & Favoriler Paneli -->
<div class="fixed right-4 bottom-[9rem] z-[60] glass rounded-xl p-4 w-[22rem] max-h-[45vh] overflow-y-auto text-white text-sm space-y-4"
     x-show="panelOpen" x-transition>

  <!-- Sekmeler -->
  <div class="flex gap-2 mb-1">
    <button id="fav_bar" @click="activeTab = 'watch'" :class="activeTab === 'watch' ? 'bg-white/20 px-3 py-1 rounded' : 'px-3 py-1 rounded hover:bg-white/10'">⭐ Favoriler</button>
    <button id="notlar_bar" @click="activeTab = 'notes'" :class="activeTab === 'notes' ? 'bg-white/20 px-3 py-1 rounded' : 'px-3 py-1 rounded hover:bg-white/10'">📝 Notlar</button>
  </div>

  <!-- Favoriler Sekmesi -->
  <div x-show="activeTab === 'watch'" class="space-y-3">
    <template x-if="!watchLater.length">
      <p class="text-sm opacity-70">Henüz favori yok.</p>
    </template>

    <template x-for="item in watchLater" :key="item.id">
      <div class="border border-white/10 rounded-lg overflow-hidden">
        <div class="flex justify-between items-center px-3 py-2 bg-white/10">
          <span class="font-semibold truncate" x-text="item.label || item.id"></span>
          <button @click="removeWatchLater(item.id)" class="text-red-400 hover:text-red-600 text-xs">Sil</button>
        </div>
      </div>
    </template>
  </div>

  <!-- Notlar Sekmesi -->
  <div x-show="activeTab === 'notes'" class="space-y-3">
    <template x-if="!Object.keys(notes).some(k => notes[k]?.length)">
      <p class="text-sm opacity-70">Not bulunamadı.</p>
    </template>

    <template x-for="(entries, nodeId) in Object.fromEntries(Object.entries(notes).filter(([k, arr]) => arr.length))" :key="nodeId">
      <div class="border border-white/10 rounded-lg overflow-hidden">
        <button @click="notesOpen = notesOpen === nodeId ? null : nodeId" class="w-full text-left px-3 py-2 bg-white/10 hover:bg-white/20 font-semibold">
          <span x-text="nodes.get(nodeId)?.label || nodeId"></span>
        </button>

        <div x-show="notesOpen === nodeId" x-transition class="p-3 space-y-2 max-h-[45vh] overflow-y-auto">
          <template x-for="(n, i) in entries" :key="i">
            <div class="bg-white/10 p-2 rounded">
              <div class="text-xs opacity-70 mb-1" x-text="new Date(n.ts).toLocaleDateString()"></div>

              <template x-if="editingNoteIndex === `${nodeId}_${i}`">
                <div class="flex flex-col gap-2">
                  <textarea x-model="editedNoteText" class="w-full p-2 rounded bg-black/20 text-sm text-white border border-white/20"></textarea>
                  <div class="flex justify-end gap-2 text-xs">
                    <button @click="saveEditedNote(nodeId, i)" class="px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white">Kaydet</button>
                    <button @click="cancelEditNote()" class="px-2 py-1 rounded bg-white/20 text-white">Vazgeç</button>
                  </div>
                </div>
              </template>

              <template x-if="editingNoteIndex !== `${nodeId}_${i}`">
                <div>
                  <div class="whitespace-pre-wrap text-sm mb-1" x-text="n.text"></div>
                  <div class="flex justify-end gap-2 text-xs opacity-80">
                    <button @click="startEditNote(`${nodeId}_${i}`, n.text)">✏️</button>
                    <button @click="deleteNote(nodeId, i)">🗑️</button>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </template>
  </div>
</div>
        </template>
      </div>
    </template>
  </div>
</div>

<!-- Bilgi Panelleri -->
<div x-show="panel === 'hakkimizda'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">ℹ️ Hakkımızda</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p><strong>Film Evreni Ağı</strong>, sinema ve dizi evrenlerini etkileşimli ve görsel bir biçimde keşfetmek isteyenler için tasarlanmış bir bilgi platformudur.</p>
  <p>Amacımız, sinema tutkunlarının evrenler arası ilişkileri kolayca anlamasını sağlamak ve her yapımın birbirine nasıl bağlandığını sezgisel olarak sunmaktır.</p>
  <ul class="list-disc list-inside space-y-1">
    <li>Farklı sinematik evrenleri merkezden uca, zaman çizgisi ya da karakter bağlantılarıyla görselleştirir.</li>
    <li>Kullanıcılara kişisel notlar alma, favori yapımlarını işaretleme imkanı tanır.</li>
    <li>Yapım bilgileri, karakter ilişkileri ve göndermeler gibi içerikleri zenginleştirir.</li>
    <li>Kullanıcıların yorum yazmasına değil, bilgiye odaklanmasına olanak sağlar.</li>
    <li>Hafif, reklamsız ve üyelik gerektirmeyen bir deneyim sunar.</li>
  </ul>
  <p>Film Evreni Ağı bağımsız bir girişimdir ve herhangi bir stüdyo veya yayıncıyla bağlantısı yoktur.</p>
</div>
    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri Dön</button>
    </div>
  </div>
</div>

<div x-show="panel === 'gizlilik'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">🔐 Gizlilik Politikası</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p>Film Evreni Ağı olarak gizliliğinizi ciddiye alıyoruz. Platformumuz, anonim kullanıcı deneyimi sunar ve size ait verileri ifşa etmez.</p>

  <h3 class="font-semibold mt-4 mb-1">Toplanan Bilgiler</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Kullanıcıdan aktif olarak <strong>hiçbir kişisel bilgi</strong> talep edilmez.</li>
    <li>Ad, e-posta, üyelik, şifre vb. sistemde <strong>tutulmaz</strong>.</li>
    <li>Favoriler ve notlar yalnızca tarayıcı (localStorage) üzerinde saklanır.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Veri Kullanımı</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Veriler yalnızca size görünür şekilde cihazınızda tutulur.</li>
    <li>Kullanıcı davranışı izlenmez, analiz yapılmaz.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">3. Taraflar ve İzleme</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Google Analytics, Facebook Pixel gibi izleme araçları <strong>kullanılmaz</strong>.</li>
    <li>Reklam, takip veya sponsor sistemleri entegre edilmemiştir.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Veri Paylaşımı</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Hiçbir veri 3. şahıslarla <strong>paylaşılmaz</strong>.</li>
    <li>Yasal bir zorunluluk olmadıkça veri kaydı yoktur.</li>
  </ul>

 <div class="text-center mt-4">
  <button @click="panel = 'iletisim'" class="px-4 py-2 bg-white/10 border border-white/20 text-white text-sm rounded hover:bg-white/20">
    İletişim Formunu Aç
  </button>
</div>
</div>
    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri Dön</button>
    </div>
  </div>
</div>

<div x-show="panel === 'cerez'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">🍪 Çerez Politikası</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p>Web sitemiz yalnızca <strong>zorunlu ve deneyimi iyileştiren çerezler</strong> kullanır.</p>

  <h3 class="font-semibold mt-4 mb-1">Kullandığımız Çerez Türleri</h3>
  <ul class="list-disc list-inside space-y-1">
    <li><strong>Oturum Çerezleri:</strong> Geçici olarak tutulur, oturum kapandığında silinir.</li>
    <li><strong>Tercih Çerezleri:</strong> Tema ayarları, notlar, favoriler gibi verileri saklar.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Kullanım Amaçları</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Karanlık/aydınlık tema tercihini hatırlama</li>
    <li>Son seçilen evreni veya yapımı hatırlama</li>
    <li>Kişisel not ve favori listesini koruma</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Toplamadığımız Veriler</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Davranış analizi, IP adresi, konum, geçmiş gibi veriler toplanmaz.</li>
    <li>Reklam çerezi veya sosyal medya takibi <strong>yoktur</strong>.</li>
  </ul>

  <p class="mt-4">Çerezleri tarayıcınızdan temizleyebilir veya engelleyebilirsiniz. Bu durumda bazı özellikler çalışmayabilir.</p>
</div>
    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri Dön</button>
    </div>
  </div>
</div>

<div x-show="panel === 'kullanim'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">📜 Kullanım Koşulları</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p>Platformu kullanarak aşağıdaki koşulları kabul etmiş sayılırsınız:</p>

  <h3 class="font-semibold mt-4 mb-1">Kullanım Amacı</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Yalnızca <strong>kişisel ve eğitsel</strong> kullanım içindir.</li>
    <li>Herhangi bir ticari faaliyet amacıyla kullanılamaz.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">İçerik ve Sorumluluk</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Bilgiler kamuya açık kaynaklardan derlenmiştir.</li>
    <li>İçerik doğruluğu garanti edilmez; referans amaçlıdır.</li>
    <li>Telifli materyallerin sahibi yapım şirketleridir.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Kısıtlamalar</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>İçerik izinsiz kopyalanamaz, dağıtılamaz, satılamaz.</li>
    <li>Kod yapısı ve veri yapıları izinsiz çoğaltılamaz.</li>
  </ul>

  <p class="mt-4">Kuralları ihlal eden kullanıcıların erişimi engellenebilir.</p>
</div>
    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri Dön</button>
    </div>
  </div>
</div>

<div x-show="panel === 'dmca'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">⚖️ DMCA Bildirimi</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p>Film Evreni Ağı telif hakkı sahiplerine saygı duyar ve ihlal bildirimlerini ciddiyetle ele alır.</p>

  <h3 class="font-semibold mt-4 mb-1">Bildiriminizde Bulunması Gerekenler</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Hak sahibinin adı ve iletişim bilgileri</li>
    <li>İhlal ettiği düşünülen içeriğin tam bağlantısı (URL)</li>
    <li>Telif hakkı sahibi olduğunuza dair açık beyan</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Süreç</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Bildirimin ardından en geç 48 saat içinde yanıt verilir.</li>
    <li>Uygun görüldüğü takdirde içerik yayından kaldırılır.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Yasal Uyarı</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Yanlış beyanla gönderilen bildirimler yasal sorumluluk doğurur.</li>
  </ul>

  <div class="text-center mt-4">
  <button @click="panel = 'iletisim'" class="px-4 py-2 bg-white/10 border border-white/20 text-white text-sm rounded hover:bg-white/20">
    İletişim Formunu Aç
  </button>
</div>
</div>

    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri Dön</button>
    </div>
  </div>
</div>

<div x-show="panel === 'iletisim'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">📬 İletişim Formu</h2>

    <form id="iletisimForm" class="space-y-4">
      <div>
        <label class="block mb-1">Adınız</label>
        <input type="text" name="name" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" required>
      </div>
      <div>
        <label class="block mb-1">E-posta Adresiniz</label>
        <input type="email" name="email" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" required>
      </div>
      <div>
        <label class="block mb-1">Konu</label>
        <select name="subject" required class="w-full px-3 py-2 rounded bg-white/10 border border-white/20">
          <option disabled selected>Seçin</option>
          <option>İstek-Öneri</option>
          <option>DMCA</option>
          <option>İletişim</option>
        </select>
      </div>
      <div>
        <label class="block mb-1">Mesajınız</label>
        <textarea name="message" rows="5" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" required></textarea>
      </div>
      <div class="text-center">
        <button type="submit" class="px-4 py-2 bg-white/10 border border-white/20 text-white text-sm rounded hover:bg-white/20">Gönder</button>
      </div>
    </form>

    <div class="text-center">
      <button @click="panel = null" class="mt-2 px-4 py-1 text-sm text-white border border-white/20 rounded hover:bg-white/20">İptal</button>
    </div>
  </div>

  <!-- EmailJS entegrasyonu -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("7UKhuE7htA-_Kgs1q"); // public key
    })();

    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("iletisimForm");
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        emailjs.sendForm("service_7klkor6", "template_7shk4yl", form)
          .then(() => {
            alert("Mesajınız başarıyla gönderildi. Teşekkür ederiz!");
            form.reset();
            panel = null;
          })
          .catch((error) => {
            alert("Bir hata oluştu: " + JSON.stringify(error));
          });
      });
    });
  </script>
</div>



<footer class="bg-black/70 text-white/70 text-xs text-center py-4 border-t border-white/10 mt-auto relative z-50">
  <div class="space-y-2">
    <div>© 2025 Film Evreni Ağı</div>
    <div class="flex flex-wrap justify-center gap-x-4 gap-y-1 text-xs">
      <a href="#" @click.prevent="panel='hakkimizda'" class="underline hover:text-white block">Hakkımızda</a>
      <a href="#" @click.prevent="panel='gizlilik'" class="underline hover:text-white block">Gizlilik</a>
      <a href="#" @click.prevent="panel='cerez'" class="underline hover:text-white block">Çerez Politikası</a>
      <a href="#" @click.prevent="panel='kullanim'" class="underline hover:text-white block">Kullanım Koşulları</a>
      <a href="#" @click.prevent="panel='dmca'" class="underline hover:text-white block">DMCA</a>
    </div>
  </div>
</footer>

<script>
// Sağ tık kapatma
document.addEventListener('contextmenu', e => e.preventDefault(), {passive:false});

// Seçimi ve kopyayı zorlaştır (tam güvenlik sağlamaz)
document.addEventListener('copy', e => e.preventDefault());
document.addEventListener('cut',  e => e.preventDefault());

// Yaygın kısayolları engelle (F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S vs.)
document.addEventListener('keydown', function(e){
  const k = e.key.toLowerCase();
  const ctrl = e.ctrlKey || e.metaKey;
  if (
    k === 'f12' ||
    (ctrl && k === 'u') ||              // Ctrl+U: View Source
    (ctrl && k === 's') ||              // Ctrl+S: Save
    (ctrl && k === 'p') ||              // Ctrl+P: Print
    (ctrl && e.shiftKey && k === 'i') ||// DevTools
    (ctrl && e.shiftKey && k === 'j') ||// DevTools console
    (ctrl && e.shiftKey && k === 'c')   // Open element picker (bazı eklentiler)
  ){
    e.preventDefault();
    e.stopPropagation();
  }
}, {capture:true});
</script> 



<!-- Hidden admin redirect snippet: begin -->
<script>
(function(){
  var target = "./src/admin.html";
  function go(){ try { window.location.href = target; } catch(e){} }

  // 1) Hotkey: Ctrl/Cmd + Alt + A
  window.addEventListener("keydown", function(e){
    var isA = (e.key || "").toLowerCase() === "a";
    if (isA && e.altKey && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      go();
    }
  }, { passive: false });

  // 2) Hash trigger: #admin
  if ((location.hash || "").toLowerCase() === "#admin") {
    go();
  }

  // 3) Type sequence: "admin" within 1.5s anywhere
  var buffer = "";
  var timer = null;
  window.addEventListener("keydown", function(e){
    var k = (e.key || "");
    if (k.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
      buffer += k.toLowerCase();
      if (timer) clearTimeout(timer);
      timer = setTimeout(function(){ buffer = ""; }, 1500);
      if (buffer.endsWith("admin")) {
        go();
      }
    }
  });
})();
</script>
<!-- Hidden admin redirect snippet: end -->
<script>
(function(){
  var logo = document.getElementById('secretAdminTap');
  var tapCount = 0;
  var tapTimer;

  if(logo){
    logo.addEventListener('click', function(){
      tapCount++;
      clearTimeout(tapTimer);
      tapTimer = setTimeout(function(){ tapCount = 0; }, 1000); // 1 sn içinde tıklama sayılır

      if(tapCount >= 5){
        window.location.href = "./src/admin.html";
      }
    });
  }
})();
</script>





<!-- Timeline Overlay -->
<div x-show="timelineOpen" @click="timelineOpen=false" class="tl-overlay" x-transition.opacity></div>

<!-- Timeline Panel -->
<section x-show="timelineOpen"
         @keydown.escape.window="timelineOpen=false"
         class="tl-panel glass rounded-t-2xl p-4 no-scrollbar overflow-y-auto"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="translate-y-full"
         x-transition:enter-end="translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="translate-y-0"
         x-transition:leave-end="translate-y-full">

  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">📅 Zaman Çizelgesi</h3>
    <button @click="timelineOpen=false" class="w-8 h-8 rounded-full bg-white/10 border border-white/20">✕</button>
  </div>

  <div x-ref="tlScroll"
     x-data="{ isDown:false, startX:0, scrollLeft:0 }"
     @mousedown="isDown=true; startX=$event.pageX - $refs.tlScroll.getBoundingClientRect().left; scrollLeft=$refs.tlScroll.scrollLeft"
     @mouseleave="isDown=false"
     @mouseup="isDown=false"
     @mousemove="if(isDown){ $event.preventDefault(); const x=$event.pageX - $refs.tlScroll.getBoundingClientRect().left; $refs.tlScroll.scrollLeft = scrollLeft - (x - startX) }"
     class="tl-scroll overflow-x-auto overflow-y-hidden no-scrollbar whitespace-nowrap cursor-grab"
     :class="isDown ? 'cursor-grabbing' : 'cursor-grab'"
     @wheel.passive="if ($event.deltaY) { $refs.tlScroll.scrollLeft += $event.deltaY }"
     style="touch-action: pan-x;">
    <div class="flex gap-4 pr-4">
      <template x-for="pair in Array.from(groupTimelineByYear)" :key="pair[0]">
        <div class="tl-col">
          <div class="sticky top-0 backdrop-blur-sm bg-black/20 border-b border-white/10 py-1 mb-2">
            <div class="tl-year text-emerald-300 text-xl" x-text="pair[0]"></div>
          </div>
          <div class="space-y-2">
            <template x-for="n in pair[1]" :key="n.id">
              <div class="tl-card" @click="openTimelineNode(n.id)">
                <div class="flex gap-3">
                  <img class="tl-poster" :src="getNodeImage(n)" alt="">
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold truncate" x-text="n.label"></div>
                    <div class="text-xs opacity-80">
                      <span x-text="toTRDate(n.release_date)"></span>
                      <span class="mx-1">•</span>
                      <span x-text="n.type || '-'"></span>
                    </div>
                    <div class="mt-1 flex flex-wrap gap-1">
                      <span class="tl-badge" x-text="formatUniverseName(n.universe)"></span>
                      <template x-if="n.imdb_rating">
                        <span class="tl-badge">IMDb <span x-text="n.imdb_rating"></span></span>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
</section>
<script>
!function(){
  const payload = {
    path: location.pathname + location.search,
    ref: document.referrer || 'direct',
    ua: navigator.userAgent || '',
    lang: navigator.language || '',
    w: screen.width,
    h: screen.height
  };
  // Yeni backend endpoint - IP anonimleştirme backend tarafında yapılır
  fetch('https://senin-domain.com/api/analytics/collect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
    keepalive: true
  }).catch(()=>{});
}();
</script>



<script>
  function setParams(patch = {}) {
    const url = new URL(location.href);
    const qs = url.searchParams;
    Object.entries(patch).forEach(([k, v]) => {
      if (v === undefined || v === null || v === '') qs.delete(k);
      else qs.set(k, String(v));
    });
    if (patch.clearNode) qs.delete('node');
    url.search = qs.toString();
    history.replaceState({}, '', url);
  }
  window.pushPrettyUrl = function pushPrettyUrl(node) {
    try {
      const u = node?.universe || '';
      const id = node?.id != null ? String(node.id) : '';
      setParams({ u, node: id });
    } catch(e) { console.warn('pushPrettyUrl', e); }
  };
  window.resetPrettyUrl = function resetPrettyUrl() {
    try { setParams({ clearNode: true }); } catch(e) { console.warn('resetPrettyUrl', e); }
  };
  window.buildNodeUrl = function buildNodeUrl(nodeId){
    const url = new URL(location.href);
    const u = (window.app?.selectedUniverse) || '';
    url.searchParams.set('u', u || '');
    url.searchParams.set('node', String(nodeId));
    return url.origin + url.pathname + '?' + url.searchParams.toString();
  };
  window.preferredUrl = function preferredUrl(node){
  try {
    const url = new URL(location.href);
    url.searchParams.set('u', node?.universe || '');
    url.searchParams.set('node', String(node?.id ?? ''));
    return url.origin + url.pathname + '?' + url.searchParams.toString();
  } catch (_) {
    // Eski tarayıcılar için basit fallback
    var u = (node && node.universe) ? node.universe : '';
    var i = (node && node.id != null) ? String(node.id) : '';
    return location.pathname + '?u=' + encodeURIComponent(u) + '&node=' + encodeURIComponent(i);
  }
};
</script>


<script>
  document.addEventListener('click', (e) => {
    const el = e.target.closest('[data-edge-type]');
    if (!el) return;
    const type = el.getAttribute('data-edge-type') || null;
    try {
      const root = Alpine.raw(Alpine.$data(document.querySelector('[x-data]')));
      if (root && typeof root.highlightEdgeType === 'function') {
        root.highlightEdgeType(type);
      }
    } catch(err) {}
  });
</script>


<script>
(function(){
  function getRoot(){
    try { return Alpine && Alpine.raw(Alpine.$data(document.querySelector('[x-data]'))); }
    catch(e){ return null; }
  }

  function autowireLegend(){
    const root = getRoot();
    const legend = document.getElementById('legend');
    if (!legend || !root) return;

    // Known edge type keys from app (edgeColors or edgeStyles)
    const keys = Object.keys(root.edgeColors || {}).concat(Object.keys(root.edgeStyles || {}));
    const uniq = Array.from(new Set(keys.filter(Boolean)));

    // Scan all child elements; if innerText equals one of the keys, attach data-edge-type
    const all = legend.querySelectorAll('*:not([data-edge-type])');
    all.forEach(el => {
      const t = (el.textContent || '').trim();
      if (!t) return;
      // exact match first
      if (uniq.includes(t)) {
        el.setAttribute('data-edge-type', t);
        el.setAttribute('role', 'button');
        el.setAttribute('aria-pressed', 'false');
      }
    });
  }

  // Visual active toggle + call highlighter (document-level listener already installed)
  document.addEventListener('click', (e) => {
    const el = e.target.closest('#legend [data-edge-type]');
    if (!el) return;
    const legend = document.getElementById('legend');
    const type = el.getAttribute('data-edge-type') || '';
    const root = getRoot();
    if (!root) return;

    // Toggle UI class
    const isActive = el.classList.contains('is-active');
    legend.querySelectorAll('[data-edge-type].is-active').forEach(x => {
      x.classList.remove('is-active');
      x.setAttribute('aria-pressed', 'false');
    });
    if (!isActive) {
      el.classList.add('is-active');
      el.setAttribute('aria-pressed', 'true');
    }

    // Call highlighter
    if (typeof root.highlightEdgeType === 'function') {
      root.highlightEdgeType(isActive ? null : type);
    }
  });

  // Run when DOM ready and whenever legend content changes
  const init = () => {
    autowireLegend();
    const legend = document.getElementById('legend');
    if (!legend) return;
    const mo = new MutationObserver(() => autowireLegend());
    mo.observe(legend, { childList: true, subtree: true, characterData: true });
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>



<!-- Global Advanced Share Sheet (always available) -->
<template x-if="shareOpen">
  <div class="share-sheet-overlay" @click="shareOpen=false" @keydown.escape.window="shareOpen=false">
    <div class="share-sheet" role="dialog" aria-modal="true" aria-label="Paylaşım seçenekleri" @click.stop>
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-semibold">Paylaş</div>
        <button class="w-8 h-8 rounded-full bg-white/10 border border-white/20" @click="shareOpen=false" aria-label="Paylaşımı kapat">✕</button>
      </div>

      <!-- Link satırı -->
      <div class="mb-2 text-sm opacity-80">
        <div class="mb-1">Bağlantı</div>
        <div class="share-row">
          <input class="share-input" type="text" readonly :value="buildShareUrl(modalNode, sharePrefs.useUtm)">
          <div class="flex gap-2">
            <button class="px-2 py-1 rounded bg-white/10 border border-white/20 hover:bg-white/20 text-xs"
                    @click="copyShare(modalNode)">Kopyala</button>
            <button class="px-2 py-1 rounded bg-white/10 border border-white/20 hover:bg-white/20 text-xs"
                    @click="copyMarkdown(modalNode)">Markdown</button>
          </div>
        </div>
      </div>

      <!-- Metin düzenleyici -->
      <div class="mb-2">
        <div class="flex items-center justify-between mb-1"><div class="flex items-center gap-2"><div class="text-sm opacity-80">Mesaj</div><button class="px-2 py-0.5 rounded border border-white/20 bg-white/5 hover:bg-white/10 text-[11px]" @click="shareCustomText = formatShareDefault(modalNode)">Varsayılanı Doldur</button></div><div class="counter"><span>𝕏: </span><span x-text="xRemaining(modalNode)"></span></div></div>
        <textarea class="share-textarea"
                  x-model="shareCustomText"
                  :placeholder="getShareText(modalNode)"></textarea>
        <div class="mt-1 flex flex-wrap gap-2">
          <template x-for="tag in shareSuggestedTags(modalNode)" :key="tag">
            <button class="chip-mini" @click="appendToShare(tag)">+ <span x-text="tag"></span></button>
          </template>
        </div>
      </div>

      <!-- Seçenekler -->
      <div class="mb-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
        <label class="share-opt">
          <input type="checkbox" x-model="sharePrefs.useUtm">
          <span class="text-sm">UTM ekle</span>
        </label>
        <label class="share-opt">
          <input type="checkbox" x-model="sharePrefs.includeHashtags">
          <span class="text-sm">Hashtag ekle</span>
        </label>
        <label class="share-opt">
          <input type="checkbox" x-model="sharePrefs.includeSummary">
          <span class="text-sm">Kısa özet ekle</span>
        </label>
      </div>

      <!-- Platformlar -->
      <div class="grid share-grid mb-3">
        <div class="share-tile" @click="shareNative(modalNode)" title="Cihazla Paylaş" aria-label="Cihazla Paylaş">
          <svg class="share-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M14 3l7 7-1.41 1.41L15 8.83V17a4 4 0 01-4 4H5v-2h6a2 2 0 002-2V8.83l-4.59 2.58L7 10l7-7z"/>
          </svg>
          <span class="text-xs">Cihazla Paylaş</span>
        </div>

        <div class="share-tile" @click="shareToX(modalNode)" title="X" aria-label="X">
          <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=x.com" alt="X">
          <span class="text-xs">X (Twitter)</span>
        </div>
        <div class="share-tile" @click="shareToWhatsApp(modalNode)" title="WhatsApp" aria-label="WhatsApp">
          <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=whatsapp.com" alt="WhatsApp">
          <span class="text-xs">WhatsApp</span>
        </div>
        <div class="share-tile" @click="shareToLinkedIn(modalNode)" title="LinkedIn" aria-label="LinkedIn">
          <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=linkedin.com" alt="LinkedIn">
          <span class="text-xs">LinkedIn</span>
        </div>
        <div class="share-tile" @click="shareToTelegram(modalNode)" title="Telegram" aria-label="Telegram">
          <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=telegram.org" alt="Telegram">
          <span class="text-xs">Telegram</span>
        </div>
        <div class="share-tile" @click="shareToReddit(modalNode)" title="Reddit" aria-label="Reddit">
          <img class="share-icon" src="https://www.google.com/s2/favicons?sz=32&domain=reddit.com" alt="Reddit">
          <span class="text-xs">Reddit</span>
        </div>
        <div class="share-tile" @click="shareToEmail(modalNode)" title="E-Posta" aria-label="E-Posta">
          <svg class="share-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          <span class="text-xs">E-Posta</span>
        </div>
        <div class="share-tile" @click="captureShareImage()" title="Poster Görseli" aria-label="Poster Görseli">
          <svg class="share-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14l4-4h12l2 2zM8 11l2.5 3.01L13 12l3 4H7l1-1.99z"/></svg>
          <span class="text-xs">Poster Görseli</span>
        </div>
      </div>

      <!-- QR Kod -->
      <div class="mb-2 text-sm opacity-80">QR Kod</div>
      <div class="flex items-center justify-center">
        <img :src="'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(buildShareUrl(modalNode, sharePrefs.useUtm))"
             alt="QR" width="180" height="180" class="rounded border border-white/10"/>
      </div>
    </div>
  </div>
</template>



<script>
  document.addEventListener('keydown', (e) => {
    if ((e.key === 'p' || e.key === 'P')) {
      try {
        const root = Alpine && Alpine.raw(Alpine.$data(document.querySelector('[x-data]')));
        if (root?.modalOpen) { e.preventDefault(); root.shareOpen = true; }
      } catch(err) {}
    }
  });
</script>


<!-- Injected: Force %0A newlines on all platforms -->
<script>
window.addEventListener('load', () => {
  try {
    const comp = document.querySelector('[x-data]');
    if (!comp || !window.Alpine) return;
    const root = Alpine.raw(Alpine.$data(comp));
    if (!root) return;

    // Uyumlu emoji seti
    const E = { film:"🎥", cal:"📅", memo:"📝", target:"🎯", link:"🔗", popcorn:"🍿", point:"👉" };

    // Kısa özet
    root._snippet = function(s, limit=160){
      try{
        const text = String(s || '').replace(/\s+/g, ' ').trim();
        if (!text) return '';
        if (text.length <= limit) return text;
        let cut = text.slice(0, limit);
        const lastSpace = cut.lastIndexOf(' ');
        if (lastSpace > 40) cut = cut.slice(0, lastSpace);
        return cut.replace(/[.,;:!\-–—\s]+$/, '') + '…';
      }catch(e){ return ''; }
    };

    // Alt alta metin
    root.formatShareDefault = function(node){
      try {
        const n = node || this.modalNode || {};
        const year = (n.release_date || '').slice(0,4);
        let titleText = n.label || '';
if (year && !titleText.includes(`(${year})`)) {
  titleText += ` (${year})`;
}
const title = `${E.film} ${titleText}`.trim();

        const date = n.release_date ? `${E.cal} ${this.toTRDate ? this.toTRDate(n.release_date) : n.release_date}` : '';
        const summaryRaw = n.description ? String(n.description) : '';
        const summary = summaryRaw ? `${E.memo} Film Özeti: ${this._snippet(summaryRaw, 160)}` : '';
        const hint = `${E.target} Göndermeler & atıflar için siteyi ziyaret et:`;
        const link = `${E.link} ${this.buildShareUrl ? this.buildShareUrl(n, true) : (location.href)}`;
        const outro = `Sinemayla kalın. ${E.popcorn}`;
        return [title, date, summary, hint, link, '', outro].filter(Boolean).join('\n');
      } catch(e){ return ''; }
    };

    // Tek metin
    root._getShareTextOnly = function(node){
      const n = node || this.modalNode;
      const custom = (this.shareCustomText && String(this.shareCustomText).trim()) || null;
      const text = custom || (this.formatShareDefault ? this.formatShareDefault(n) : '');
      return { text };
    };

    // Encoder: tüm satır sonlarını %0A'ya çevir (CRLF/LF/CR hepsi)
    function encAll(text){
      return encodeURIComponent(text).replace(/%0D%0A|%0A|%0D/g, '%0A');
    }

    // Platformlar (hepsinde %0A zorluyoruz)
    root.shareNative = function(node){
      const { text } = this._getShareTextOnly(node);
      if (navigator.share) {
        navigator.share({ title: (node?.label)||'Paylaş', text }).catch(()=>{});
      } else {
        navigator.clipboard && navigator.clipboard.writeText(text);
        alert('Metin panoya kopyalandı.');
      }
    };

    root.shareToWhatsApp = function(node){
      const { text } = this._getShareTextOnly(node);
      window.open(`https://api.whatsapp.com/send?text=${encAll(text)}`, '_blank');
    };

    root.shareToTelegram = function(node){
      const { text } = this._getShareTextOnly(node);
      window.open(`https://t.me/share/url?text=${encAll(text)}`, '_blank');
    };

    root.shareToX = function(node){
      const { text } = this._getShareTextOnly(node);
      window.open(`https://x.com/intent/tweet?text=${encAll(text)}`, '_blank');
    };

    root.shareToReddit = function(node){
      const { text } = this._getShareTextOnly(node);
      // Reddit başlıkta yeni satırı render etmez ama %0A gönderiyoruz
      window.open(`https://www.reddit.com/submit?title=${encAll(text)}`, '_blank');
    };

    root.shareToLinkedIn = function(node){
      const { text } = this._getShareTextOnly(node);
      window.open(`https://www.linkedin.com/sharing/share-offsite/?mini=true&summary=${encAll(text)}`, '_blank');
    };

    root.copyShare = function(node){
      const { text } = this._getShareTextOnly(node);
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text);
        alert('Metin panoya kopyalandı.');
      } else {
        prompt('Kopyalamak için Ctrl/Cmd+C:', text);
      }
    };

    root.copyMarkdown = function(node){
      const { text } = this._getShareTextOnly(node);
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text);
        alert('Metin panoya kopyalandı.');
      } else {
        prompt('Kopyalamak için Ctrl/Cmd+C:', text);
      }
    };
  } catch(e) {
    console.warn('Emoji/share (force %0A) override failed:', e);
  }
});
</script>


<!-- Injected: vis-network performance preset -->
<script>
(function(){
  function onReady(fn){
    if (document.readyState === 'complete' || document.readyState === 'interactive') { setTimeout(fn,0); }
    else document.addEventListener('DOMContentLoaded', fn);
  }
  onReady(function(){
    if (!window.vis || !window.vis.Network) return;

    const fastOptions = {
      layout: { improvedLayout: false, randomSeed: 42 },
      physics: {
        solver: 'barnesHut',
        barnesHut: {
          gravitationalConstant: -12000,
          centralGravity: 0.2,
          springLength: 90,
          springConstant: 0.03,
          avoidOverlap: 0.3
        },
        stabilization: { enabled: true, iterations: 150, updateInterval: 25 }
      },
      nodes: { shape: 'dot', size: 10, borderWidth: 1, shadow: false },
      edges: { smooth: false, shadow: false, selectionWidth: 1, hoverWidth: 0 },
      interaction: {
        hover: false, tooltipDelay: 200, keyboard: false, multiselect: false,
        navigationButtons: false, hideEdgesOnDrag: true, hideEdgesOnZoom: true,
        zoomView: true, dragView: true, dragNodes: true
      }
    };

    // Tek seferlik resize debounce
    let __rsTimer = null;
    function attachGlobalResize(net){
      if (attachGlobalResize.__done) return;
      attachGlobalResize.__done = true;
      window.addEventListener('resize', () => {
        clearTimeout(__rsTimer);
        __rsTimer = setTimeout(() => {
          try {
            (window.__visNetworks || []).forEach(n => {
              n.redraw();
              n.fit({ animation: false });
            });
          } catch(e){}
        }, 150);
      });
    }

    // Basit zoom-tabanlı cluster (opsiyonel)
    function unclusterAll(net){
      try {
        const clusters = net.getClusters?.() || [];
        clusters.forEach(id => net.openCluster(id));
      } catch(e){}
    }
    function clusterByZoom(net){
      try {
        const scale = net.getScale();
        unclusterAll(net);
        const total = (net.body?.nodeIndices || []).length;
        if (total < 300) return; // küçük graph'lara dokunma
        if (scale < 0.3) {
          net.cluster({
            joinCondition: () => true,
            clusterNodeProperties: { shape:'dot', size:18, color:'#64748b', borderWidth:1 }
          });
        } else if (scale < 0.6) {
          net.cluster({
            joinCondition: n => !!n.universe,
            processProperties: (opts, children) => { opts.label = `Grup (${children.length})`; return opts; },
            clusterNodeProperties: { shape:'dot', size:14, color:'#475569', borderWidth:1 }
          });
        }
      } catch(e){}
    }

    // vis.Network wrap
    const OrigNetwork = window.vis.Network;
    window.vis.Network = function(container, data, options){
      const net = new OrigNetwork(container, data, options || {});
      try {
        // Hız ayarlarını uygula
        net.setOptions(fastOptions);
        // Stabilizasyon bittiğinde fiziği kapat + fit et
        net.once('stabilizationIterationsDone', () => {
          net.setOptions({ physics: false });
          requestAnimationFrame(() => net.fit({ animation: false }));
        });
        // İlk çizimden sonra clustering
        net.once('afterDrawing', () => clusterByZoom(net));
        net.on('zoom', () => clusterByZoom(net));
        // Görünür olduktan sonra tazele
        setTimeout(() => { try { net.redraw(); } catch(e){} }, 0);
        // Global liste
        window.__visNetworks = window.__visNetworks || [];
        window.__visNetworks.push(net);
        attachGlobalResize(net);
      } catch(e){ /* no-op */ }
      return net;
    };
    // Prototip metoda erişim lazım olursa devral
    window.vis.Network.prototype = OrigNetwork.prototype;
  });
})();
</script>


<!-- Çerez Uyarısı -->
<div
    x-data="{ showCookie: localStorage.getItem('cookiesAccepted') !== 'true' }"
    x-show="showCookie"
    x-transition
    class="fixed bottom-0 inset-x-0 z-[100] bg-black/85 text-white p-4 sm:p-5 flex flex-col sm:flex-row items-center justify-between gap-3 border-t border-white/10 backdrop-blur-md"
>
    <p class="text-sm text-center sm:text-left">
        Web sitemizde size en iyi deneyimi sunabilmek için çerezleri kullanıyoruz.
        Detaylı bilgi için <a href="./src/cerez-politikasi.html" class="text-emerald-400 hover:underline">Çerez Politikası</a>.
    </p>
    <button
        @click="localStorage.setItem('cookiesAccepted', 'true'); showCookie = false"
        class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm rounded-lg transition rounded-lg"
    >
        Kabul Et
    </button>
</div>
<!-- Quiz Modal -->
<div id="quizModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl w-[50%] h-[80%] overflow-hidden relative">
    <button id="closeQuiz" class="absolute top-2 right-2 bg-red-500 text-white px-3 py-1 rounded">X</button>
    <iframe src="src/quiz.html" class="w-full h-full border-0"></iframe>
  </div>
</div>

<script>
document.getElementById("quizBtn").addEventListener("click", () => {
    document.getElementById("quizModal").classList.remove("hidden");
});
document.getElementById("closeQuiz").addEventListener("click", () => {
    document.getElementById("quizModal").classList.add("hidden");
});
</script>

<!-- Sync node cover images with the modal poster -->
<script>
document.addEventListener('alpine:init', () => {
  // Run an Alpine reactive effect that keeps node images in sync with modal poster
  Alpine.effect(() => {
    try {
      const rootEl = document.querySelector('[x-data]');
      if (!rootEl) return;
      const root = Alpine.$data(rootEl);
      if (!root) return;

      const ds = root.nodes;           // vis.DataSet for nodes (used elsewhere in template)
      const current = root.modalNode;  // currently open node in modal

      // 1) When a modal is open, enforce the same image on the graph node
      if (ds && current && current.id && current.image && typeof ds.update === 'function') {
        try { ds.update({ id: current.id, image: current.image }); } catch (e) {}
      }

      // 2) On first runs, normalize all nodes so that their image matches their poster field (if any)
      if (Array.isArray(root.allNodes) && ds && typeof ds.update === 'function') {
        const batch = [];
        for (const n of root.allNodes) {
          if (!n || !n.id) continue;
          const poster =
            n.image || n.poster || n.poster_url || n.kapak || n.cover || n.thumbnail;
          if (poster && n.image !== poster) {
            batch.push({ id: n.id, image: poster });
          }
        }
        if (batch.length) {
          try { ds.update(batch); } catch (e) {}
        }
      }
    } catch (err) { /* noop */ }
  });
});
</script>

</body>


</html>

<!-- TMDB Auto-Enrichment -->
<script>
(() => {
  const TMDB_KEY = "2a083ff9dbe83ec7c2b33f3a1bac4b01";
  const IMG_BASE = "https://image.tmdb.org/t/p/w500";

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const safeLower = (s) => (s||"").toLowerCase();

  function cleanTitle(raw) {
    if (!raw) return "";
    return String(raw).replace(/\(\d{4}\)$/, '').trim();
  }

  function yearFrom(node) {
    const rd = node.release_date || "";
    return rd ? rd.slice(0,4) : "";
  }

  function isTV(node) {
    const t = safeLower(node.type || "");
    return t.includes("dizi") || t.includes("tv") || t.includes("series");
  }

  async function tmdbSearch(node) {
    const tv = isTV(node);
    const ep = tv ? "search/tv" : "search/movie";
    const title = cleanTitle(node.title || node.label || "");
    if (!title) return null;
    const year = yearFrom(node);
    const params = new URLSearchParams({ api_key: TMDB_KEY, language: "tr-TR", query: title });
    if (year) params.set(tv ? "first_air_date_year" : "year", year);
    const url = `https://api.themoviedb.org/3/${ep}?` + params.toString();
    const res = await fetch(url);
    if (!res.ok) return null;
    const data = await res.json();
    if (!data.results || !data.results.length) return null;
    return { type: tv ? "tv" : "movie", id: data.results[0].id };
  }

  async function tmdbDetails(type, id) {
    const params = new URLSearchParams({ api_key: TMDB_KEY, language: "tr-TR", append_to_response: "external_ids" });
    const url = `https://api.themoviedb.org/3/${type}/${id}?` + params.toString();
    const res = await fetch(url);
    if (!res.ok) return null;
    return res.json();
  }

  function mergeSources(oldSources, additions) {
    const out = { Kaynaklar: [], Görsel: [], Platform: [] };
    const norm = (arr) => Array.isArray(arr) ? arr : arr ? [arr] : [];
    for (const [k,v] of Object.entries(oldSources || {})) {
      const cat = /görsel/i.test(k) ? "Görsel" : /platform/i.test(k) ? "Platform" : "Kaynaklar";
      norm(v).forEach(item => {
        if (item && item.url && !out[cat].some(o => o.url === item.url)) out[cat].push(item);
      });
    }
    for (const [k,v] of Object.entries(additions || {})) {
      const cat = /görsel/i.test(k) ? "Görsel" : /platform/i.test(k) ? "Platform" : "Kaynaklar";
      norm(v).forEach(item => {
        if (item && item.url && !out[cat].some(o => o.url === item.url)) out[cat].push(item);
      });
    }
    return out;
  }

  async function enrichNode(node) {
    if (!node || node.__tmdb_done) return;
    node.__tmdb_done = true;
    const hit = await tmdbSearch(node);
    if (!hit) return;
    const det = await tmdbDetails(hit.type, hit.id);
    if (!det) return;
    if (det.poster_path) node.image = IMG_BASE + det.poster_path;
    if (node.imdb_rating == null && det.vote_average != null) {
      node.imdb_rating = Math.round(det.vote_average * 10) / 10;
    }
    const imdbUrl = det.external_ids?.imdb_id ? { name: "IMDb", url: `https://www.imdb.com/title/${det.external_ids.imdb_id}/` } : null;
    const tmdbUrl = { name: "TMDB", url: `https://www.themoviedb.org/${hit.type}/${hit.id}` };
    const home = det.homepage ? { name: "Resmi Site", url: det.homepage } : null;
    node.sources = mergeSources(node.sources, { Kaynaklar: [imdbUrl, tmdbUrl, home].filter(Boolean), Görsel: det.poster_path ? [{ name: "TMDB Poster", url: IMG_BASE + det.poster_path }] : [] });
  }

  function getRoot() {
    try {
      return Alpine && Alpine.raw(Alpine.$data(document.querySelector("[x-data]")));
    } catch(e) { return null; }
  }

  const interval = setInterval(() => {
    const root = getRoot();
    if (!root) return;
    clearInterval(interval);
    if (typeof root.$watch === "function") {
      root.$watch("modalNode", (n) => { if (n) enrichNode(n); });
    }
    if (Array.isArray(root.filteredNodes)) {
      root.filteredNodes.slice(0,10).forEach(n => enrichNode(n));
    }
  }, 500);
})();
</script>


<!-- Sync node cover images with the modal poster -->
<script>
document.addEventListener('alpine:init', () => {
  // Run an Alpine reactive effect that keeps node images in sync with modal poster
  Alpine.effect(() => {
    try {
      const rootEl = document.querySelector('[x-data]');
      if (!rootEl) return;
      const root = Alpine.$data(rootEl);
      if (!root) return;

      const ds = root.nodes;           // vis.DataSet for nodes (used elsewhere in template)
      const current = root.modalNode;  // currently open node in modal

      // 1) When a modal is open, enforce the same image on the graph node
      if (ds && current && current.id && current.image && typeof ds.update === 'function') {
        try { ds.update({ id: current.id, image: current.image }); } catch (e) {}
      }

      // 2) On first runs, normalize all nodes so that their image matches their poster field (if any)
      if (Array.isArray(root.allNodes) && ds && typeof ds.update === 'function') {
        const batch = [];
        for (const n of root.allNodes) {
          if (!n || !n.id) continue;
          const poster =
            n.image || n.poster || n.poster_url || n.kapak || n.cover || n.thumbnail;
          if (poster && n.image !== poster) {
            batch.push({ id: n.id, image: poster });
          }
        }
        if (batch.length) {
          try { ds.update(batch); } catch (e) {}
        }
      }
    } catch (err) { /* noop */ }
  });
});
</script>

</body>
