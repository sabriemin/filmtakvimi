<!DOCTYPE html>

<html lang="tr" x-data="app()" x-init="init()">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>üé¨ Film Evreni Aƒüƒ±</title>
<script src="app.obf.js"></script>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.4.1/dist/js/shepherd.min.js"></script>
<script src="assets/js/shepherd.min.js"></script>


<style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; color: #d1d5db; font-family: 'Segoe UI', system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial, sans-serif; background: transparent; }
    #bgImg{ position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(12px) brightness(0.65); transform: scale(1.06); z-index: -2; backface-visibility: hidden; will-change: transform; }
    #bgOverlay{ position: fixed; inset: 0; z-index:-1; background: rgba(0,0,0,0.35); }
    #network { position: fixed; inset: 0; background: transparent; border: none; }
    .glass { background: rgba(31,41,55,0.45); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 12px 30px rgba(0,0,0,0.35); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); }
    input { color: #e5e7eb; background-color: rgba(55,65,81,0.55); border: 1px solid rgba(255,255,255,0.12); outline: none; }
    input::placeholder { color: #9ca3af; }
    .ac-panel { background: rgba(31,41,55,0.9); border: 1px solid rgba(255,255,255,0.14); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 14px 28px rgba(0,0,0,0.5); }
    .ac-item { cursor: pointer; }
    .ac-item:hover { background: rgba(255,255,255,0.08); }
    .dropdown-btn { cursor: pointer; }
    .dropdown-panel { background: rgba(31,41,55,0.65); border: 1px solid rgba(255,255,255,0.14); box-shadow: 0 16px 40px rgba(0,0,0,0.45); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
    .dropdown-item { cursor: pointer; }
    .dropdown-item:hover { background: rgba(255,255,255,0.06); }
    .modal-bg { background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); }
    .modal-content { width: 92vw; max-width: 780px; max-height: 85vh; overflow-y: auto; background: #0f172a; color: #e5e7eb; border-radius: 18px; padding: 0; box-shadow: 0 12px 24px rgba(0,0,0,0.45); position: absolute; top: 10px; border: 1px solid rgba(255,255,255,0.08); }
    .modal-header { display: grid; grid-template-columns: 120px 1fr; gap: 16px; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.06); background: radial-gradient(1200px 400px at -20% -40%, rgba(239,68,68,0.08), transparent); }
    .poster { width: 120px; height: 160px; border-radius: 10px; object-fit: cover; background: #111827; border: 1px solid rgba(255,255,255,0.08); }
    .modal-body { padding: 16px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); padding: 4px 10px; border-radius: 999px; font-size: 12px; }
    .meta-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
    .meta-item { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); padding: 10px 12px; border-radius: 12px; }
    .section-title { font-size: 0.9rem; opacity: 0.85; margin-bottom: 6px; }
    .close-btn { position: absolute; top: 12px; right: 12px; width: 36px; height: 36px; border-radius: 999px; display: grid; place-items: center; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
    .close-btn:hover { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.5); }
    #legendWrap { position: fixed; left: 16px; bottom: 4.5rem; z-index: 40; }
    #legendToggle { margin-bottom: 8px; background: rgba(31,41,55,0.55); border: 1px solid rgba(255,255,255,0.14); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); }
    #legend { background: rgba(31,41,55,0.45); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 8px 18px rgba(0,0,0,0.35); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: 12px; padding: 12px 16px; max-width: 320px; max-height: 260px; overflow-y: auto; font-size: 0.85rem; }
    @media (max-width: 640px) { #legend { font-size: 0.72rem; max-width: 220px; padding: 8px 10px; } }
    .share-bar { position: absolute; top: 8px; left: 12px; right: 56px; display:flex; align-items:center; gap:8px; opacity:.95; }
    .share-btn { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.14); font-size:12px; }
    .share-btn:hover { background: rgba(255,255,255,0.1); }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  </style>

<style>
  #network {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    border: none;
    z-index: 0;
  }
</style>


<!-- Shepherd.js CSS ve JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.4.1/dist/js/shepherd.min.js"></script>


<style>
  
  .shepherd-cancel-icon {
    color: #fff !important;
  }
</style>
<style>
  
  .shepherd-cancel-icon {
    color: #fff !important;
  }
</style>


<style>
.shepherd-element {
  max-width: 85vw;
  min-width: auto;
  max-height: 20vh;
  height: auto;
  overflow-y: auto;
  padding: 0.5rem;
  font-size: 0.2rem;
  backdrop-filter: blur(12px);
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  color: white;
}

@media (min-width: 640px) {
  .shepherd-element {
    max-width: 260px;
  }
}

  .shepherd-text,
  .shepherd-title,
  .shepherd-button {
    color: white !important;
  }

  .shepherd-header {
    background: transparent !important;
    border-bottom: none !important;
  }

  .shepherd-button {
    background-color: #2564eb73;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.7rem;
    border: none;
    margin-left: 0.2rem;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }

  .shepherd-button:hover {
    background-color: #1d4ed8;
  }

  .shepherd-cancel-icon {
    color: white !important;
  }
</style>


<style>
  .tl-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); z-index: 70; }
  .tl-panel { position: fixed; left: 0; right: 0; bottom: 0; background: rgba(17,24,39,0.98); border-top: 1px solid rgba(255,255,255,0.1); z-index: 80; max-height: 70vh; }
  .tl-year { font-weight: 700; opacity: .9; }
  .tl-col { min-width: 260px; max-width: 280px; }
  .tl-card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 10px; cursor: pointer; transition: transform .15s ease, background .15s ease; }
  .tl-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.06); }
  .tl-poster { width: 52px; height: 72px; border-radius: 8px; object-fit: cover; background: #0b1220; border: 1px solid rgba(255,255,255,0.08); }
  .tl-badge { font-size: 10px; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); }
</style>


<style>
  .tl-scroll { -webkit-overflow-scrolling: touch; overscroll-behavior-inline: contain; }
</style>
</head>



<body :class="{ 'overflow-hidden': modalOpen }" class="dark flex-col min-h-[100dvh] flex">

<!-- GH Pages SPA redirect consumer -->
<script>
(function(){
  try {
    var r = sessionStorage.getItem('redirect');
    if (r) {
      sessionStorage.removeItem('redirect');
      // Put the original path back into the address bar (no reload)
      if (history && history.replaceState) history.replaceState({}, '', r);
    }
  } catch(e) { /* ignore */ }
})();
</script>

<img :src="bgUrl" alt="" id="bgImg"/>
<div id="bgOverlay"></div>
<style>
@media (max-width: 639px) {
  .mobile-centered {
    max-height: 60vh;          /* Daha kƒ±sa */
    overflow-y: auto;
    position: relative;
    top: 10%;
    transform: translateY(-10%);
    padding: 0.75rem;          /* p-3 boyutunda */
    font-size: 0.8rem;         /* text-xs ile text-sm arasƒ± */
    border-radius: 0.75rem;    /* K√∂≈üeleri biraz daha yuvarlak */
  }

  .mobile-centered h2 {
    font-size: 1.1rem;         /* Ba≈ülƒ±k k√º√ß√ºls√ºn */
  }

  .mobile-centered p {
    font-size: 0.78rem;        /* Paragraflar daha k√º√ß√ºk */
    line-height: 1.3;
  }

  .mobile-centered .grid > div {
    padding: 0.5rem;           /* ƒ∞√ß kartlar daha dar */
  }
}


</style>

<!-- Ho≈ü Geldin Bilgilendirmesi -->
<div x-show="!selectedUniverse && !panel"
     class="fixed inset-0 flex items-center justify-center z-50">
  <div style="max-height: 70vh; overflow-y: auto; " class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-xl sm:text-2xl font-bold text-center">üé¨ Film Evreni Aƒüƒ±'na Ho≈ü Geldin!</h2>
    <p class="text-base text-center text-white/80">Bu platform, farklƒ± sinematik evrenler arasƒ±nda baƒü kurmanƒ± ve yapƒ±mlarƒ± daha derinlemesine ke≈üfetmeni saƒülar.</p>
    <div class="grid grid-cols-1 gap-2 text-xs mt-1 sm:grid-cols-2 sm:gap-4 sm:text-sm">
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">üó∫Ô∏è Etkile≈üimli Harita</h3>
        <p>Se√ßtiƒüin evrene ait yapƒ±mlar arasƒ±ndaki baƒülantƒ±larƒ± grafik olarak g√∂rebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">üéûÔ∏è Yapƒ±m Detaylarƒ±</h3>
        <p>Her film veya diziye tƒ±klayarak √∂zet, oyuncular, g√∂ndermeler ve notlarƒ± g√∂r√ºnt√ºleyebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">üìù Kendi Notlarƒ±nƒ± Ekle</h3>
        <p>Yapƒ±mlara ki≈üisel notlar ekleyebilir, d√ºzenleyebilir veya silebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">‚≠ê Favorilerine Ekle</h3>
        <p>ƒ∞zlemek istediƒüin veya beƒüendiƒüin yapƒ±mlarƒ± favori listene ekleyebilirsin.</p>
      </div>
    </div>
    <p class="text-center text-white/60 text-sm pt-2">Ba≈ülamak i√ßin yukarƒ±dan bir <strong>film evreni</strong> se√ß üåå</p>
<div class="text-center">
  <button @click="startTour()" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">
    üöÄ Rehbere Ba≈üla
  </button>
</div>

  </div>
</div>

<header class="fixed top-4 left-0 right-0 z-50">
<div class="w-full sm:max-w-md lg:max-w-lg mx-auto px-3">
<div class="glass rounded-xl px-3 py-2">
  <div class="flex flex-col gap-2">
    <div class="flex items-center justify-center">
<h1 id="secretAdminTap" class="text-base sm:text-lg font-bold text-center">üé¨ Film Evreni Aƒüƒ±</h1>

    </div>

    <!-- Mobilde arama ve anasayfa yanyana, dropdown altta olacak sekilde yeniden yapƒ±landƒ±rƒ±ldƒ± -->
<div class="flex flex-col sm:flex-row gap-2">

  <!-- Mobil/masa√ºst√º: Anasayfa + Arama + Mobil Filtre aynƒ± satƒ±r -->
  <div class="flex flex-row items-center gap-2 w-full sm:flex-1 sm:basis-0 sm:min-w-0">

    <!-- Anasayfa -->
    <a href="./" title="Anasayfa"
       class="text-white border border-white/30 hover:bg-white/10 rounded-md p-2 transition w-9 h-9 flex items-center justify-center"">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
           stroke-width="2" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 10v10h6v-6h4v6h6V10L12 3z"/>
      </svg>
    </a>

    <!-- Arama -->
    <div class="relative flex-1 min-w-0">
      <input
        @blur="setTimeout(() => acOpen = false, 120)"
        @focus="acOpen = true"
        class="border rounded-lg px-3 py-1.5 w-full pr-10"
        placeholder="Ara..."
        type="search"
        x-model="search"
      />
      <button
        @click="search=''; suggestions=[]; applyFilters()"
        @mousedown.prevent
        aria-label="Temizle"
        class="absolute inset-y-0 right-2 my-auto h-6 w-6 rounded-full grid place-items-center opacity-80 hover:opacity-100 hover:bg-white/10"
        x-show="search"
        style="display:none;">
        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4Z"/>
        </svg>
      </button>
      <!-- AC panel -->
      <div class="ac-panel absolute z-50 w-full mt-1 rounded-lg overflow-hidden max-h-56 overflow-y-auto"
           x-show="acOpen && search && suggestions.length" style="display:none;">
        <template x-for="(s, idx) in suggestions" :key="s">
          <div @click="search = s; acOpen=false; applyFilters();" @mousedown.prevent class="ac-item px-3 py-1.5">
            <span x-text="s"></span>
          </div>
        </template>
      </div>
    </div>

                <!-- Filtre butonu: mobil -->
                <button
                  @click="openFilterPanel = !openFilterPanel"
                  class="relative flex h-9 w-9 items-center justify-center rounded-md border border-white/30 transition hover:bg-white/10 sm:hidden"
                  title="Filtreler"
                >
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
           stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h18v2l-6 6v4.6l-4 2V12L3 6z"/>
      </svg>
      <span x-show="activeFilterCount" class="absolute -top-1 -right-1 text-[10px] px-1.5 py-[1px] rounded-full bg-emerald-500 text-black font-semibold">
        <span x-text="activeFilterCount"></span>
      </span>
    </button>
  </div>

  <!-- Evren Se√ßimi -->
  <div class="relative flex-1 basis-0 min-w-0" x-data="{ open:false, filterText:'' }">
    <div :aria-expanded="open" @click="open=!open"
         class="dropdown-btn border rounded-lg px-3 py-1.5 w-full flex items-center justify-between select-none">
      <span class="truncate" x-text="selectedUniverse ? formatUniverseName(selectedUniverse) : 'T√ºm Evrenler'">T√ºm Evrenler</span>
      <svg class="h-4 w-4 opacity-80 ml-2" fill="currentColor" viewBox="0 0 20 20">
        <path clip-rule="evenodd" fill-rule="evenodd"
              d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/>
      </svg>
    </div>
    <div class="dropdown-panel absolute mt-2 left-0 right-0 rounded-xl overflow-hidden"
         style="z-index:60; display:none;" x-show="open" x-transition>
      <div class="p-2 border-b border-white/10">
        <input class="w-full px-3 py-2 rounded-lg border" placeholder="Evren ara..." x-model="filterText">
      </div>
      <ul class="max-h-64 overflow-y-auto">
        <template x-for="u in universeList.filter(u => !filterText || formatUniverseName(u).toLowerCase().includes(filterText.toLowerCase()))" :key="u">
          <li @click="selectedUniverse=u; open=false; filterText=''; applyFilters()"
              class="dropdown-item px-3 py-2" x-text="formatUniverseName(u)"></li>
        </template>
      </ul>
    </div>
  </div>

              <button
                @click="openFilterPanel = !openFilterPanel"
                id="filter_btn"
                class="relative hidden h-9 w-9 items-center justify-center rounded-md border border-white/30 transition hover:bg-white/10 sm:flex"
                title="Filtreler"
              >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
         stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h18v2l-6 6v4.6l-4 2V12L3 6z"/>
    </svg>
    <span x-show="activeFilterCount" class="absolute -top-1 -right-1 text-[10px] px-1.5 py-[1px] rounded-full bg-emerald-500 text-black font-semibold">
      <span x-text="activeFilterCount"></span>
    </span>
  </button>

</div>



  </div>
</div>
</div>
</header>
<!-- Overlay -->
<div
  x-show="openFilterPanel"
  @click="openFilterPanel = false"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70]"
  x-transition.opacity
></div>

<!-- Drawer (Filtre Paneli) -->
<aside
  x-show="openFilterPanel"
  @keydown.escape.window="openFilterPanel=false"
  class="fixed right-0 top-0 bottom-0 w-[92vw] sm:w-[360px] z-[80] glass border-l border-white/20 p-4 overflow-y-auto"
  x-transition:enter="transition ease-out duration-200"
  x-transition:enter-start="translate-x-full"
  x-transition:enter-end="translate-x-0"
  x-transition:leave="transition ease-in duration-150"
  x-transition:leave-start="translate-x-0"
  x-transition:leave-end="translate-x-full"
>
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Filtreler</h3>
    <button @click="openFilterPanel=false" class="w-8 h-8 rounded-full bg-white/10 border border-white/20">‚úï</button>
  </div>

  <!-- Yapƒ±m Tipi -->
  <div class="mb-4">
    <div class="text-sm font-medium mb-2">Yapƒ±m Tipi</div>
    <div class="inline-flex rounded-lg overflow-hidden border border-white/20">
      <button @click="filters.type='all'"  :class="filters.type==='all'  ? 'bg-white/20' : 'bg-white/5'" class="px-3 py-1.5 text-sm">Hepsi</button>
      <button @click="filters.type='film'" :class="filters.type==='film' ? 'bg-white/20' : 'bg-white/5'" class="px-3 py-1.5 text-sm">Film</button>
      <button @click="filters.type='dizi'" :class="filters.type==='dizi' ? 'bg-white/20' : 'bg-white/5'" class="px-3 py-1.5 text-sm">Dizi</button>
    </div>
  </div>

<!-- T√ºr (Genre) -->
<div class="mb-4">
  <div class="text-sm font-medium mb-2">T√ºr</div>
  <div class="flex flex-wrap gap-2">
    <template x-for="g in availableGenres" :key="g">
      <label
        class="px-2 py-1 rounded-full border cursor-pointer select-none text-xs transition"
        :class="filters.genres.includes(g)
          ? 'bg-emerald-500 border-emerald-500 text-black'
          : 'bg-white/5 border-white/20 text-white hover:bg-white/10'">
        
        <input type="checkbox" class="hidden" :value="g" x-model="filters.genres">
        <span x-text="g"></span>
      </label>
    </template>
  </div>
</div>


  <!-- Yƒ±l aralƒ±ƒüƒ± -->
  <div class="mb-4 grid grid-cols-2 gap-2">
    <div>
      <div class="text-sm font-medium mb-1">Yƒ±l (min)</div>
      <input type="number" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" placeholder="2008" x-model.number="filters.yearMin">
    </div>
    <div>
      <div class="text-sm font-medium mb-1">Yƒ±l (max)</div>
      <input type="number" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" placeholder="2025" x-model.number="filters.yearMax">
    </div>
  </div>

  
  <!-- Hazƒ±r Yƒ±l Aralƒ±klarƒ± -->
  <div class="mb-4">
    <div class="text-sm font-medium mb-2">Hazƒ±r Yƒ±l Filtreleri</div>
    <div class="flex flex-wrap gap-2">
      <button @click="filters.yearMin = new Date().getFullYear() - 1; filters.yearMax = new Date().getFullYear(); applyFilters()" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-xs">Son 1 Yƒ±l</button>
      <button @click="filters.yearMin = new Date().getFullYear() - 5; filters.yearMax = new Date().getFullYear(); applyFilters()" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-xs">Son 5 Yƒ±l</button>
      <button @click="filters.yearMin = 2010; filters.yearMax = 2019; applyFilters()" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-xs">2010‚Äì2019</button>
      <button @click="filters.yearMin = 2000; filters.yearMax = 2009; applyFilters()" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-xs">2000‚Äì2009</button>
      <button @click="filters.yearMin = null; filters.yearMax = 1999; applyFilters()" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-xs">2000 √ñncesi</button>
    </div>
  </div>

  <!-- IMDb -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-1">
      <div class="text-sm font-medium">IMDb (en az)</div>
      <div class="text-xs opacity-80" x-text="filters.imdbMin ?? '-'"></div>
    </div>
    <input type="range" min="0" max="10" step="0.1" x-model.number="filters.imdbMin" class="w-full">
    <div class="text-xs opacity-70 mt-1">0 ‚Äì 10</div>
  </div>

  <!-- Aksiyonlar -->
  <div class="flex gap-2">
    <button @click="applyFilters(); openFilterPanel=false" class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white text-sm">Uygula</button>
    <button @click="resetFilters()" class="px-3 py-2 rounded bg-white/10 border border-white/20 text-sm">Sƒ±fƒ±rla</button>
  </div>
</aside>
<div id="network" x-show="selectedUniverse" x-transition x-show="showGraph" x-transition></div>

<div @click.outside="if (!window.Shepherd?.activeTour) modalOpen=false; resetPrettyUrl && resetPrettyUrl()" @keydown.escape.window="modalOpen=false; resetPrettyUrl && resetPrettyUrl()" aria-labelledby="modalTitle" aria-modal="true" class="fixed inset-0 modal-bg flex items-center justify-center z-50 p-4" role="dialog" id="modal_container" x-show="modalOpen" x-transition="">
<div @click.stop="" class="modal-content" style="overflow-y: visible;">
<div class="relative rounded-xl overflow-hidden backdrop-blur-md bg-black/50 text-white max-h-[90vh] overflow-y-visible">
<!-- √úst blur g√∂rsel alanƒ± -->
<div class="relative h-64">
<img :src="modalNode.image" alt="" class="absolute inset-0 w-full h-full object-cover blur-xl brightness-50 scale-105"/>
<div class="absolute inset-0 flex flex-col justify-between p-4 z-10"><div class="absolute top-3 left-3 flex gap-2 items-center"><div class="flex gap-2 items-center">
<button @click="shareToX(modalNode)" class="text-white hover:opacity-80" title="X payla≈ü">
<img alt="X" src="https://img.icons8.com/ios-filled/20/ffffff/twitterx.png"/>
</button>
<button @click="shareToWhatsApp(modalNode)" class="text-white hover:opacity-80" title="WhatsApp">
<img alt="WA" src="https://img.icons8.com/ios-filled/20/ffffff/whatsapp.png"/>
</button>
<button @click="shareToLinkedIn(modalNode)" class="text-white hover:opacity-80" title="LinkedIn">
<img alt="IN" src="https://img.icons8.com/ios-filled/20/ffffff/linkedin.png"/>
</button>
<button @click="copyShare(modalNode)" class="text-white hover:opacity-80" title="Kopyala">üìã</button>
</div></div><div class="absolute top-3 right-3 flex gap-2 items-center z-20"><div @click="modalOpen=false; resetPrettyUrl && resetPrettyUrl()" class="close-btn" id="modal-close">‚úï</div></div>
<!-- √úst √ßubuk -->
<div class="flex justify-between items-start"><div class="absolute top-3 right-3 flex gap-2 items-center z-20"></div></div>
<!-- Alt bilgi -->
<div class="flex justify-between mt-4">
<div class="text-xs bg-black/40 px-3 py-1 rounded-full">
<div class="font-semibold text-white/70 text-[10px]">Vizyon Tarihi</div>
<span x-text="toTRDate(modalNode.release_date)">-</span>
</div>
<div class="text-xs flex gap-2 items-center bg-black/40 px-3 py-1 rounded-full">
<span x-text="modalNode.type || '-'"></span>
<span class="text-white/80">|</span>
<span x-text="'IMDB: ' + (modalNode.imdb_rating || '-')">IMDB</span>
</div>
</div>
</div>
<template x-if="showPosterDialog">
<div @click.self="showPosterDialog = false" class="fixed inset-0 z-\[9999\] z-\[999\] z-50 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center">
<div class="p-4 rounded-xl shadow-2xl max-w-[90vw] max-h-[85vh]" style="z-index:10000;" style="z-index:1000;" style="z-index:60;">
<button @click="showPosterDialog = false" class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/10 border border-white/20 text-white text-sm">‚úï</button>
<img :src="modalNode.image" class="max-w-[75vw] max-h-[70vh] rounded-xl shadow-lg object-cover"/>
</div>
</div>
</template>
<!-- Poster -->
<div class="absolute left-1/2 top-full -translate-x-1/2 -translate-y-1/2 z-20"><div @click="showPosterDialog = true" class="cursor-pointer">
<div @click="showPosterDialog = true" class="cursor-pointer">
<div @click="showPosterDialog = true" class="cursor-pointer"><img :src="modalNode.image" alt=""
class="w-32 h-32 rounded-full object-cover drop-shadow-[0_0_20px_rgba(168,85,247,0.5)] ring-2 ring-purple-400/30"/></div></div>
</div>
</div>
</div>
<!-- ƒ∞√ßerik alanƒ± -->
<div class="p-6 pt-20 space-y-6 overflow-hidden">
<h2 class="text-2xl font-bold text-center" x-text="modalNode.label">
</h2>
<div class="flex justify-center mt-2">
<button :class="isInWatchLater(modalNode?.id) ? 'bg-green-500 border-green-500 text-white' : 'bg-white/10 border-white/20 text-white hover:bg-white/20'" @click="toggleWatchLater(modalNode)" class="px-4 py-2 rounded border text-sm transition" x-text="isInWatchLater(modalNode?.id) ? '‚úî Favorilere Eklendi' : 'Favorilere Ekle'">
</button>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
<div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-1"><div><strong>T√ºr:</strong> <span x-text="modalNode.t√ºr || '-'"></span></div>
<div><strong>Y√∂netmen:</strong> <span x-text="modalNode.y√∂netmen || '-'"></span></div>
<div><strong>Oyuncular:</strong> <span x-text="modalNode.oyuncular || '-'"></span></div>
</div>
<div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-1">
<div><strong>Evren:</strong> <span x-text="formatUniverseName(modalNode.universe)"></span></div>
<template x-if="Array.isArray(modalNode.sources) ? modalNode.sources.length : Object.keys(modalNode.sources || {}).length">


<!-- Kaynaklar -->
<div
  class="mt-4"
  x-data="{ groups: [] }"
  x-effect="
    (() => {
      const raw =
        modalNode?.sources
        || modalNode?.source
        || modalNode?.links
        || null;

      const normalized = normalizeSources(raw);
      const order = ['Kaynaklar','G√∂rsel','Platform'];

      groups = order
        .map(cat => ({ cat, items: (normalized?.[cat] || []) }))
        .filter(g => g.items.length);
    })()
  "
  x-show="groups.length"
>


  <template x-for="g in groups" :key="g.cat">
    <div class="mb-3">
      <h4 class="text-sm font-medium mb-1 inline-flex items-center gap-1">
        <span x-text="getSourceIcon(g.cat)"></span>
        <span x-text="g.cat"></span>
      </h4>
      <ul class="list-disc list-inside text-sm space-y-0.5">
        <template x-for="src in g.items" :key="src.url || src.name">
          <li>
            <a href="#"
               @click.prevent="confirmExternal(src.url)"
               class="text-emerald-400 hover:underline"
               x-text="src.name || src.url"></a>
          </li>
        </template>
      </ul>
    </div>
  </template>
</div>

<!-- Hi√ß kaynak yoksa nazik mesaj -->
<div class="mt-4 text-sm text-white/70" x-show="!groups?.length">
  Bu yapƒ±m i√ßin kayƒ±tlƒ± bir kaynak bulunamadƒ±.
</div>




</template>
</div>
</div>
<!-- √ñzet -->
<div>
<h3 @click="summaryOpen = !summaryOpen" id="content-summary" class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">ƒ∞√ßerik √ñzeti
<svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="!summaryOpen"></path>
<path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="summaryOpen"></path>
</svg>
</h3>
<div class="bg-white/5 p-4 rounded-lg border border-white/10" x-show="summaryOpen" x-text="modalNode.description || '-'"></div>
</div>
<!-- G√∂ndermeler -->
<template x-if="modalNode.refers_to">
  <div>
    <h3 @click="refersOpen = !refersOpen" id="g√∂ndermeler"
        class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">
      G√∂ndermeler
      <svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
           xmlns="http://www.w3.org/2000/svg">
        <path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              x-show="!refersOpen"></path>
        <path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              x-show="refersOpen"></path>
      </svg>
    </h3>

    <div class="text-sm text-red-400 italic mb-2" x-show="refersOpen">
      ‚ö† Bu alan spoiler i√ßerebilir.
    </div>

    <div class="bg-white/5 p-4 rounded-lg border border-white/10 italic text-sm"
         x-show="refersOpen"
         x-html="(() => {
           const t = modalNode.refers_to == null ? '' : String(modalNode.refers_to);

           // G√ºvenlik: HTML escape
           const esc = t
             .replace(/&/g,'&amp;')
             .replace(/</g,'&lt;')
             .replace(/>/g,'&gt;');

           // **Kalƒ±n** -> renkli span
           let out = esc.replace(/\*\*(.+?)\*\*/g,
             '<span class=&quot;text-sky-300 font-semibold underline decoration-dotted&quot;>$1</span>'
           );
           return out;
         })()">
    </div>
  </div>
</template>



<!-- Baƒülantƒ±lƒ± Yapƒ±mlar -->


<h3 @click="linkedOpen = !linkedOpen" id="related-works" class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">Baƒülantƒ±lƒ± Yapƒ±mlar
<svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="!linkedOpen"></path>
<path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="linkedOpen"></path>
</svg>
</h3>
<div x-show="linkedOpen" class="bg-white/5 p-4 rounded-lg border border-white/10">

<template x-if="edgeList.length">
<div class="flex flex-wrap gap-2" x-show="linkedOpen">
<template :key="e.otherNodeId" x-for="e in edgeList">
<div :class="{
  'bg-blue-900/40 border-blue-500/30': e.type === 'Devam',
  'bg-emerald-900/30 border-emerald-500/20': e.type === 'Takƒ±m Kurulumu',
  'bg-slate-900/30 border-slate-500/20': e.type === 'Karakter Ge√ßi≈üi',
  'bg-purple-900/30 border-purple-500/20': e.type === 'Gizli Baƒülantƒ±',
  'bg-red-900/30 border-red-500/20': e.type === 'Psikolojik Etki',
  'bg-violet-900/30 border-violet-500/20': e.type === 'Karakter Baƒülantƒ±sƒ±',
  'bg-rose-900/30 border-rose-500/20': e.type === 'Yeni Tehdit',
  'bg-amber-900/30 border-amber-400/20': e.type === 'Sonsuzluk Ta≈üƒ±',
  'bg-orange-900/30 border-orange-500/20': e.type === 'Siyasi √á√∂z√ºlme',
  'bg-teal-900/30 border-teal-500/20': e.type === 'Kozmik Katƒ±lƒ±m',
  'bg-pink-900/30 border-pink-500/20': e.type === 'Anahtar Karakter',
  'bg-orange-800/30 border-orange-400/20': e.type === '√ñnemli Olay',
  'bg-yellow-900/30 border-yellow-500/20': e.type === 'Mekan Baƒülantƒ±sƒ±',
  'bg-gray-800/30 border-gray-500/20': e.type === 'Paralel Olay',
  'bg-amber-800/30 border-amber-500/20': e.type === 'Anahtar Olay',
  'bg-violet-800/30 border-violet-400/20': e.type === 'Sonrasƒ± Etki',
  'bg-teal-800/30 border-teal-400/20': e.type === 'Kozmik Geni≈üleme',
  'bg-cyan-900/30 border-cyan-500/20': e.type === '√áoklu Evren',
  'bg-red-800/30 border-red-400/20': e.type === 'Evrensel Geli≈üme',
  
  // Eklenen eksik type‚Äôlar:
  'bg-indigo-900/30 border-indigo-500/20': e.type === 'Ana Hikaye Baƒülantƒ±sƒ±',
  'bg-red-950/30 border-red-600/20': e.type === 'Ana Tehdit',
  'bg-sky-900/30 border-sky-500/20': e.type === 'Doƒürudan Devam',
  'bg-emerald-950/30 border-emerald-600/20': e.type === 'Evrensel Baƒülantƒ±',
  'bg-stone-900/30 border-stone-500/20': e.type === 'Ge√ßmi≈ü Hikayesi',
  'bg-green-900/30 border-green-500/20': e.type === 'Hikaye Devamƒ±',
  'bg-cyan-800/30 border-cyan-400/20': e.type === 'Hikaye √ñncesi',
  'bg-slate-800/30 border-slate-400/20': e.type === 'Karakter Devamƒ±',
  'bg-orange-700/30 border-orange-300/20': e.type === 'Siyasi Etki',
  'bg-fuchsia-900/30 border-fuchsia-500/20': e.type === 'Crossover',
  'bg-gray-700/30 border-gray-400/20': e.type === 'Tarihsel Baƒülantƒ±',
  'bg-purple-800/30 border-purple-300/20': e.type === 'T√ºrsel Baƒülantƒ±',

  'bg-white/10 border-white/20': !e.type
         }" @click="__openNode(e.otherNodeId)" class="rounded-xl p-3 text-sm cursor-pointer transition relative border space-y-1">
<div class="font-semibold" x-text="nodes.get(e.otherNodeId)?.label || e.otherNodeId">
</div>
<div class="text-xs text-white/70 italic" x-text="e.type"></div>
<template x-if="e.notes">
<div class="border-l-4 border-blue-500 pl-2 ml-1 text-[12px] text-white/80 italic mt-1">
<span class="text-blue-300">Not:</span>
<span x-text="e.notes"></span>
</div>
</template>
</div>
</template>
</div>
</template>
<template x-if="!edgeList.length">
<p class="text-sm opacity-70">Baƒülantƒ± bulunamadƒ±.</p>
</template>
</div>
<!-- Notlar -->
<div class="bg-white/5 p-4 rounded-lg border border-white/10">
<h3 class="text-lg font-semibold mb-2">Notlar</h3>
<template x-if="!notes[modalNode.id] || !notes[modalNode.id].length">
<p class="text-sm opacity-70">Hen√ºz not eklenmemi≈ü.</p>
</template>

<template :key="i" x-for="(c, i) in (notes[modalNode.id] || [])">
  <div class="bg-white/10 p-2 rounded mb-2">
    <div class="text-xs opacity-70 mb-1">
      <span x-text="new Date(c.ts).toLocaleDateString()"></span>
    </div>
    <template x-if="editingNoteIndex === i">
      <div class="flex flex-col gap-2">
        <textarea x-model="editedNoteText" class="w-full p-2 rounded bg-black/20 text-sm text-white border border-white/20"></textarea>
        <div class="flex justify-end gap-2 text-xs">
          <button @click="saveEditedNote(modalNode.id, i)" class="px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white">Kaydet</button>
          <button @click="cancelEditNote()" class="px-2 py-1 rounded bg-white/20 text-white">Vazge√ß</button>
        </div>
      </div>
    </template>
    <template x-if="editingNoteIndex !== i">
      <div>
        <div class="whitespace-pre-wrap text-sm" x-text="c.text"></div>
        <div class="flex justify-end gap-2 mt-1 text-xs opacity-80">
          <button @click="startEditNote(i, c.text)">‚úèÔ∏è</button>
          <button @click="deleteNote(modalNode.id, i)">üóëÔ∏è</button>
        </div>
      </div>
    </template>
  </div>
</template>

<div class="flex gap-2 mt-2">
<input class="w-full px-3 py-2 rounded bg-white/10 text-white" placeholder="Not ekle... #etiket" x-model="newNote"/>
<button @click="addNote(modalNode.id)" class="px-3 py-2 text-sm border border-white/20 rounded hover:bg-white/20">Ekle</button>
</div>
</div>
</div>
</div>
</div>
</div>

<div x-show="selectedUniverse">
</div>


</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.querySelector('input[placeholder="Not ekle... #etiket"]');
    if (input) {
      input.addEventListener('focus', () => {
        setTimeout(() => {
          input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    }
  });
</script>


    <script>
      function app() {
        return {
          panel: null,
          startTour() {
            const dropdown = document.querySelector(".dropdown-btn");
            dropdown?.classList.add("pointer-events-none", "opacity-50");
            dropdown?.setAttribute("disabled", "true");
            // Shepherd rehberi: Ba≈ütan sona adƒ±mlar

            const tour = new Shepherd.Tour({
              defaultStepOptions: {
                scrollTo: true,
                cancelIcon: { enabled: true },
              },
            });

            // 1. Ho≈ü Geldin
            tour.addStep({
              title: "Ho≈ü Geldin üé¨",
              text: "Film Evreni Aƒüƒ±‚Äôna ho≈ü geldin!",
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 2. Evren Se√ß
            tour.addStep({
              title: "Evren Se√ß üåå",
              text: "Buradan bir evren se√ßebilirsin.",
              attachTo: { element: ".dropdown-btn", on: "bottom" },
              buttons: [
                {
                  text: "ƒ∞leri",
                  action: function () {
                    const dropdown = document.querySelector(".dropdown-btn");
                    dropdown?.classList.remove("pointer-events-none", "opacity-50");
                    dropdown?.removeAttribute("disabled");
                    tour.next();
                  },
                },
              ],
            });

            // 3. ≈ûimdi Evren Se√ß
            const isMobile = window.innerWidth < 640;

            tour.addStep({
              title: "üåå Evren Se√ß",
              text: "L√ºtfen bir evren se√ß.",
              attachTo: {
                element: ".dropdown-btn",
                on: isMobile ? "top" : "left",
              },
              scrollTo: true,
              buttons: [],
              when: {
                show() {
                  const ge√ßerliMi = (val) => val && val !== "" && val !== "all";

                  const kontrolEt = () => {
                    try {
                      const selected =
                        Alpine.store("selectedUniverse") ||
                        Alpine.raw(Alpine.$data(document.querySelector("[x-data]")))
                          .selectedUniverse;

                      if (ge√ßerliMi(selected)) {
                        clearInterval(interval);
                        tour.next();
                      }
                    } catch (e) {
                      // Alpine hazƒ±r deƒüilse sessizce bekle
                    }
                  };

                  kontrolEt();
                  const interval = setInterval(kontrolEt, 400);
                },
              },
            });

            // 4. Arama
            tour.addStep({
              title: "Film Ara üîç",
              text: "Film veya dizi aramak i√ßin burayƒ± kullan.",
              attachTo: { element: "input[type=search]", on: "bottom" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 5. Yapƒ±m Grafiƒüi
            tour.addStep({
              title: "Yapƒ±m Grafiƒüi üìä",
              text: "Se√ßilen evrene ait yapƒ±mlar bu aƒü grafiƒüinde g√∂sterilir. <br><br> Bir yapƒ±ma tƒ±klayarak yapƒ±m bilgi panelini a√ß.",
              attachTo: { element: "#network", on: "top" },
              scrollTo: false,
              buttons: [], // Buton g√∂stermiyoruz
              when: {
                show() {
                  const checkModalOpen = () => {
                    const modal = document.querySelector(".modal-content");
                    const h2 = modal?.querySelector("h2");
                    const isVisible = modal && getComputedStyle(modal).display !== "none";
                    const hasTitle = h2 && h2.textContent.trim().length > 0;
                    return isVisible && hasTitle;
                  };

                  if (checkModalOpen()) {
                    tour.next(); // Zaten a√ßƒ±k ve i√ßerik varsa direkt ge√ß
                    return;
                  }

                  // Aralƒ±kla kontrol et
                  const interval = setInterval(() => {
                    if (checkModalOpen()) {
                      clearInterval(interval);
                      tour.next();
                    }
                  }, 400);
                },
              },
            });

            // 8. Payla≈üƒ±m
            tour.addStep({
              title: "Payla≈üƒ±m üöÄ",
              text: "Bu butonla yapƒ±m baƒülantƒ±sƒ±nƒ± kopyalayabilir veya sosyal medyada payla≈üabilirsin.",
              attachTo: { element: 'button[title="Kopyala"]', on: "bottom" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 9. Vizyon Tarihi
            tour.addStep({
              title: "üé¨ Vizyon Tarihi",
              text: "Burada yapƒ±mƒ±n vizyon tarihini g√∂rebilirsin.",
              attachTo: { element: ".modal-content [x-text*=toTRDate]", on: "bottom" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 10. T√ºr ve IMDB
            tour.addStep({
              title: "‚≠ê T√ºr ve IMDB",
              text: "Yapƒ±mƒ±n t√ºr√º ve IMDB puanƒ± burada.",
              attachTo: { element: ".modal-content .text-xs.flex", on: "bottom" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 6. Favorilere Ekle
            tour.addStep({
              title: "Favorilere Ekle ‚≠ê",
              text: "Bir yapƒ±mƒ± favorilerine eklemek i√ßin bu butonu kullan.",
              attachTo: { element: "[x-text*=Favorilere]", on: "bottom" },
              buttons: [
                {
                  text: "ƒ∞leri",
                  action: function () {
                    const btn = document.querySelector("[x-text*=Favorilere]");
                    if (btn && btn.textContent.includes("‚úî Favorilere Eklendi")) {
                      return tour.next();
                    } else {
                      alert("L√ºtfen √∂nce favorilere ekle.");
                    }
                  },
                },
              ],
            });

            // 11. T√ºr / Y√∂netmen / Oyuncular
            tour.addStep({
              title: "üé≠ T√ºr, Y√∂netmen, Oyuncular",
              text: "Bu b√∂l√ºmde temel bilgiler yer alƒ±r.",
              attachTo: { element: ".modal-content .grid > div:nth-child(1)", on: "bottom" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 12. Evren ve Kaynaklar
            tour.addStep({
              title: "üåå Evren ve Kaynaklar",
              text: "Yapƒ±mƒ±n ait olduƒüu evreni ve kaynaklarƒ± burada g√∂rebilirsin.",
              attachTo: { element: ".modal-content .grid > div:nth-child(2)", on: "bottom" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 13. ƒ∞√ßerik √ñzeti
            tour.addStep({
              title: "üìù ƒ∞√ßerik √ñzeti",
              text: "Burada filmin kƒ±sa √∂zeti yer alƒ±r.",
              attachTo: {
                element: "#content-summary",
                on: "bottom",
              },
              scrollTo: true,
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 14. G√∂ndermeler
            tour.addStep({
              title: "üéØ G√∂ndermeler",
              text: "Filmde yapƒ±lan diƒüer yapƒ±mlara g√∂ndermeleri burada g√∂rebilirsiniz.",
              attachTo: {
                element: "#g√∂ndermeler",
                on: "bottom",
              },
              scrollTo: true,
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 15. Baƒülantƒ±lƒ± Yapƒ±mlar
            tour.addStep({
              title: "üîó Baƒülantƒ±lƒ± Yapƒ±mlar",
              text: "ƒ∞lgili evrende ge√ßen diƒüer yapƒ±mlar bu b√∂l√ºmde g√∂sterilir.",
              attachTo: {
                element: "#related-works",
                on: "bottom",
              },
              scrollTo: true,
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 7. Not Ekle
            tour.addStep({
              title: "Not Ekle üìù",
              text: "Buraya ki≈üisel notlarƒ±nƒ± yazabilir, #etiket ekleyebilirsin.",
              attachTo: {
                element: 'input[placeholder="Not ekle... #etiket"]',
                on: "bottom",
              },
              scrollTo: true,
              buttons: [
                {
                  text: "ƒ∞leri",
                  action: () => tour.next(),
                },
              ],
            });

            // 16. Yapƒ±m Panelini Kapat
            tour.addStep({
              title: "üìï Yapƒ±m Panelini Kapat",
              text: "Bu paneli kapatarak bir sonraki adƒ±ma ge√ßebilirsin.",
              attachTo: { element: "#modal-close", on: "top" },
              scrollTo: true,
              buttons: [],
              when: {
                show() {
                  let modal;

                  const interval = setInterval(() => {
                    modal = document.querySelector("#modal_container");

                    // Modal DOM'da bile deƒüilse ‚Üí kapandƒ± demektir
                    if (!modal) {
                      clearInterval(interval);
                      tour.next();
                      return;
                    }

                    // Modal DOM'da ama g√∂r√ºnm√ºyorsa
                    const style = window.getComputedStyle(modal);
                    const isHidden =
                      style.display === "none" ||
                      style.visibility === "hidden" ||
                      style.opacity === "0" ||
                      modal.classList.contains("hidden") ||
                      modal.offsetWidth === 0 ||
                      modal.offsetHeight === 0;

                    if (isHidden) {
                      clearInterval(interval);
                      tour.next();
                    }
                  }, 300);
                },
              },
            });

            // 17. Oklar (ƒ∞li≈ükiler)
            tour.addStep({
              title: "Oklar Neyi G√∂sterir? üîÅ",
              text: "Grafikteki oklar yapƒ±mlar arasƒ±ndaki ili≈ükiyi g√∂sterir.",
              attachTo: { element: "#network canvas", on: "top" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 18. Legend Alanƒ±
            tour.addStep({
              title: "üìò Baƒülantƒ±lar A√ßƒ±klamasƒ±",
              text: "Baƒülantƒ±lar alanƒ± evren renklerini ve t√ºrlerini a√ßƒ±klar.",
              attachTo: { element: "#legend_bar", on: "top" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // Yardƒ±mcƒ±: ekranda g√∂r√ºnen filtre butonunu bul
            function getVisibleFilterBtn() {
              const btns = document.querySelectorAll('button[title="Filtreler"]');
              for (const el of btns) {
                const r = el.getBoundingClientRect();
                const st = getComputedStyle(el);
                const visible =
                  r.width > 0 &&
                  r.height > 0 &&
                  st.visibility !== "hidden" &&
                  st.display !== "none";
                if (visible) return el;
              }
              return null;
            }

            // (startTour() i√ßindeki mevcut "Filtreler" adƒ±mƒ±nƒ± bununla deƒüi≈ütir)
            tour.addStep({
              title: "üéØ Filtreler",
              text: "Yapƒ±mlarƒ± t√ºr, yƒ±l, IMDb ve tipine g√∂re daraltabilirsin.",
              // ƒ∞lk baƒülama denemesi; show()‚Äôda kesinle≈ütireceƒüiz
              attachTo: { element: "#filter_btn", on: "bottom" },
              buttons: [
                {
                  text: "ƒ∞leri",
                  action: function () {
                    const btn = getVisibleFilterBtn();
                    tour.next();
                  },
                },
              ],
              when: {
                show() {
                  // G√∂r√ºn√ºr butonu bul ve adƒ±mƒ± ona yeniden baƒüla
                  const btn = getVisibleFilterBtn();
                  if (btn) {
                    const step = tour.currentStep;
                    step.updateStepOptions({
                      attachTo: { element: btn, on: "bottom" },
                    });
                  }
                },
              },
            });

            // Timeline
            tour.addStep({
              title: "üìÖ Zaman √áizelgesi",
              text: "Se√ßili evrendeki yapƒ±mlarƒ± √ßƒ±kƒ±≈ü yƒ±llarƒ±na g√∂re sƒ±rayla burada g√∂rebilirsin.",
              attachTo: { element: "#timeline_bar", on: "top" },
              buttons: [
                {
                  text: "ƒ∞leri",
                  action: function () {
                    const btn = document.querySelector("#timeline_bar");
                    if (!btn) return tour.next();

                    tour.next();
                  },
                },
              ],
            });

            // 19. Favori ve Not Paneli
            tour.addStep({
              title: "üìÇ Saƒü Alt Panel",
              text: "Saƒü altta favori ve notlarƒ± g√∂rmek i√ßin bu alanƒ± kullanabilirsin.",
              attachTo: { element: "#panel_bar", on: "top" },
              scrollTo: false,
              buttons: [
                {
                  text: "ƒ∞leri",
                  action: function () {
                    // Panel i√ßeriƒüi DOM'da g√∂r√ºn√ºr m√º kontrol et
                    const panel = document.querySelector('[x-show="panelOpen"]');

                    const isVisible = panel && window.getComputedStyle(panel).display !== "none";

                    if (isVisible) {
                      tour.next();
                      return;
                    }

                    alert("L√ºtfen √∂nce paneli a√ßmalƒ±sƒ±n.");

                    // Panel a√ßƒ±ldƒ±ƒüƒ±nda bekle ve sonra ilerle
                    const interval = setInterval(() => {
                      const nowVisible = panel && window.getComputedStyle(panel).display !== "none";
                      if (nowVisible) {
                        clearInterval(interval);
                        tour.next();
                      }
                    }, 400); // her 0.4 sn'de bir kontrol et
                  },
                },
              ],
            });

            // 20. Favori Y√∂netimi
            tour.addStep({
              title: "‚≠ê Favorileri G√∂r ve Sil",
              text: "Bu alanda favori yapƒ±mlarƒ± g√∂rebilir ve silebilirsin.",
              attachTo: { element: "#fav_bar", on: "left" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 21. Not Y√∂netimi
            tour.addStep({
              title: "üìù Notlarƒ± G√∂r, D√ºzenle, Sil",
              text: "Notlarƒ±nƒ± bu alanda g√∂r√ºnt√ºleyebilir, d√ºzenleyebilir ya da silebilirsin.",
              attachTo: { element: "#notlar_bar", on: "left" },
              buttons: [{ text: "ƒ∞leri", action: tour.next }],
            });

            // 22. Tur Bitti üéâ
            tour.addStep({
              title: "Tebrikler! üéâ",
              text: "Film Evreni Aƒüƒ± rehberini ba≈üarƒ±yla tamamladƒ±n. Ke≈üfetmeye hazƒ±rsƒ±n!",
              buttons: [{ text: "Kapat", action: tour.complete }],
            });
            tour.start();

            document.addEventListener("keydown", function (e) {
              if (e.key === "Enter") {
                // Eƒüer aktif bir step varsa ve ileri butonu varsa ilerlet
                const step = tour.currentStep;
                if (step) {
                  // Eƒüer adƒ±mda butonlar varsa ilk "next" action'ƒ±nƒ± √ßalƒ±≈ütƒ±r
                  const nextBtn = step.options.buttons?.find((b) => b.action === tour.next);
                  if (nextBtn) {
                    tour.next();
                  } else {
                    // Eƒüer √∂zel action varsa onu √ßalƒ±≈ütƒ±r
                    const btnWithAction = step.options.buttons?.[0];
                    btnWithAction?.action?.();
                  }
                }
              }
            });
          },



    editingNoteIndex: null,
    editedNoteText: '',
    startEditNote(i, text) {
      this.editingNoteIndex = i;
      this.editedNoteText = text;
    },
    cancelEditNote() {
      this.editingNoteIndex = null;
      this.editedNoteText = '';
    },
    saveEditedNote(nodeId, i) {
      if (this.notes[nodeId] && this.notes[nodeId][i]) {
        this.notes[nodeId][i].text = this.editedNoteText;
        this.notes[nodeId][i].ts = Date.now();
        this.cancelEditNote();
        if (this.saveNotesToStorage) this.saveNotesToStorage();
      }
    },
    openTimelineNode(id) {
      try {
        if (typeof this.__openNode === 'function') {
          this.__openNode(id);
        } else if (this.nodes && typeof this.nodes.get === 'function') {
          const it = this.nodes.get(id);
          if (it) { this.modalNode = it; this.modalOpen = true; this.$nextTick(()=>{ try{ this.pushPrettyUrl && this.pushPrettyUrl(this.modalNode); }catch(e){} }); }
        } else if (Array.isArray(this.allNodes)) {
          const it = this.allNodes.find(x => x && x.id === id);
          if (it) { this.modalNode = it; this.modalOpen = true; }
        }
      } catch (e) {
        // no-op: fail silently
      } finally {
        this.timelineOpen = false;
      }
    },

    
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
    
        network: null, allNodes: [], allEdges: [], nodes: null, edges: null,
        filteredNodes: [], filteredEdges: [],
        search: '', selectedUniverse: '', modalOpen: false, modalNode: null,
        timelineOpen: false,
        universeList: [], fitTimeout: null, showLegend: true,
        suggestions: [], acOpen: false,
        watchLater: [], watchLaterOpen: false, panelOpen: false, activeTab: 'watch', showGraph: false,
        notes: {}, newNote: '', notesOpen: false, notesUniverseFilter: '', notesTagFilter: '', editingNoteIndex: null, editedNoteText: '',
        bgUrl: 'assets/images/bg.jpg',
        bgMap: {
          "": "assets/images/bg.jpg",
          "avatar": "assets/images/pandora.jpg",
          "dc": "assets/images/dc.jpg",
          "harrypotter": "assets/images/harrypotter.jpg",
          "marvel": "assets/images/marvel.jpg",
          "matrix": "assets/images/matrix.jpg",
          "middleearth": "assets/images/middleearth.jpg",
          "pixar": "assets/images/pixar.jpg",
          "starwars": "assets/images/starwars.jpg"
        },
        get edgeList(){
          if (!this.modalNode || !this.allEdges) return [];
          return this.allEdges
            .filter(e => e.from === this.modalNode.id || e.to === this.modalNode.id)
            .map(e => ({ ...e, otherNodeId: e.from === this.modalNode.id ? e.to : e.from }));
        },
edgeColors: {
  "Ana Hikaye Baƒülantƒ±sƒ±": "#2c3e50", // Koyu mavi-gri - ana hikaye baƒüƒ±
  "Ana Tehdit": "#ff0000",            // Kƒ±rmƒ±zƒ± - ana d√º≈üman
  "Anahtar Karakter": "#e84393",      // Pembe - hikayede kilit ki≈üi
  "Anahtar Olay": "#f39c12",          // Altƒ±n sarƒ±sƒ± - √∂nemli d√∂n√ºm
  "Crossover": "#8e44ad",             // Mor - dizi/film ge√ßi≈üi
  "Devam": "#2980b9",                 // Mavi - ana hikaye devamƒ±
  "Doƒürudan Devam": "#3498db",        // A√ßƒ±k mavi - direkt devam
  "Evrensel Baƒülantƒ±": "#16a085",     // Turkuaz - evrensel baƒü
  "Evrensel Geli≈üme": "#c0392b",      // Kƒ±rmƒ±zƒ± - b√ºy√ºk √ßaplƒ± geli≈üme
  "Ge√ßmi≈ü Hikayesi": "#6e4b25",       // Kahverengi - ge√ßmi≈ü olay
  "Gizli Baƒülantƒ±": "#8e44ad",        // Mor - gizli/arka plan baƒülantƒ±
  "Hikaye Devamƒ±": "#27ae60",         // Ye≈üil - hikaye devamƒ±
  "Hikaye √ñncesi": "#1abc9c",         // Turkuaz-ye≈üil - √∂n hikaye
  "Karakter Baƒülantƒ±sƒ±": "#9b59b6",   // A√ßƒ±k mor - karakter ili≈ükisi
  "Karakter Devamƒ±": "#34495e",       // Koyu gri - karakter hikaye devamƒ±
  "Karakter Ge√ßi≈üi": "#34495e",       // Koyu gri - karakter odaklƒ± ge√ßi≈ü
  "Kozmik Geni≈üleme": "#1abc9c",      // Turkuaz-ye≈üil - evrenin geni≈ülemesi
  "Kozmik Katƒ±lƒ±m": "#16a085",        // Turkuaz - kozmik olaylar
  "Mekan Baƒülantƒ±sƒ±": "#6e4b25",      // Kahverengi - yer odaklƒ± baƒü
  "Paralel Olay": "#7f8c8d",          // Gri - e≈ü zamanlƒ± olaylar
  "Psikolojik Etki": "#e74c3c",       // Kƒ±rmƒ±zƒ± - duygusal/mental etki
  "Siyasi Etki": "#d35400",           // Turuncu - siyasi etki
  "Siyasi √á√∂z√ºlme": "#d35400",        // Turuncu - siyasi √ßatƒ±≈üma
  "Sonrasƒ± Etki": "#9b59b6",          // Mor - olay sonrasƒ± etki
  "Sonsuzluk Ta≈üƒ±": "#f1c40f",        // Altƒ±n - Infinity Stones
  "Takƒ±m Kurulumu": "#27ae60",        // Ye≈üil - birlik ve olu≈üum
  "Tarihsel Baƒülantƒ±": "#95a5a6",     // A√ßƒ±k gri - tarihsel baƒü
  "T√ºrsel Baƒülantƒ±": "#8e44ad",       // Mor - t√ºrsel benzerlik
  "Yeni Tehdit": "#c0392b",           // Koyu kƒ±rmƒ±zƒ± - tehdit
  "√áoklu Evren": "#00bcd4",           // A√ßƒ±k mavi - multiverse
  "√ñnemli Olay": "#e67e22"            // Turuncu - kritik olay
},

edgeStyles: {
  "Ana Hikaye Baƒülantƒ±sƒ±": { width: 3, dashes: false },
  "Ana Tehdit": { width: 3, dashes: [6,4] },
  "Anahtar Karakter": { width: 2.3, dashes: [8,4] },
  "Anahtar Olay": { width: 2.6, dashes: [2,4] },
  "Crossover": { width: 2.5, dashes: [4,8] },
  "Devam": { width: 3, dashes: false },
  "Doƒürudan Devam": { width: 3, dashes: [2,6] },
  "Evrensel Baƒülantƒ±": { width: 2.3, dashes: [5,5] },
  "Evrensel Geli≈üme": { width: 2.5, dashes: [4,4] },
  "Ge√ßmi≈ü Hikayesi": { width: 2.2, dashes: [6,6] },
  "Gizli Baƒülantƒ±": { width: 2.2, dashes: [3,7] },
  "Hikaye Devamƒ±": { width: 2.8, dashes: false },
  "Hikaye √ñncesi": { width: 2.5, dashes: [4,6] },
  "Karakter Baƒülantƒ±sƒ±": { width: 2.2, dashes: [6,4] },
  "Karakter Devamƒ±": { width: 3, dashes: [6,4] },
  "Karakter Ge√ßi≈üi": { width: 3, dashes: [10,4] },
  "Kozmik Geni≈üleme": { width: 2.5, dashes: [4,6] },
  "Kozmik Katƒ±lƒ±m": { width: 2.3, dashes: [5,5] },
  "Mekan Baƒülantƒ±sƒ±": { width: 2, dashes: [8,6] },
  "Paralel Olay": { width: 2, dashes: [12,6] },
  "Psikolojik Etki": { width: 2.5, dashes: [2,6] },
  "Siyasi Etki": { width: 2.4, dashes: [6,8] },
  "Siyasi √á√∂z√ºlme": { width: 2.8, dashes: [6,6] },
  "Sonrasƒ± Etki": { width: 2.4, dashes: [6,8] },
  "Sonsuzluk Ta≈üƒ±": { width: 2.5, dashes: [2,6] },
  "Takƒ±m Kurulumu": { width: 2.8, dashes: false },
  "Tarihsel Baƒülantƒ±": { width: 2.3, dashes: [5,7] },
  "T√ºrsel Baƒülantƒ±": { width: 2.5, dashes: [4,6] },
  "Yeni Tehdit": { width: 2.5, dashes: [4,4] },
  "√áoklu Evren": { width: 2.8, dashes: [6,3] },
  "√ñnemli Olay": { width: 3, dashes: [2,6] }
},

// ---- yardƒ±mcƒ±lar (return {...} i√ßine) ----
normUrl(u) { try { return new URL(u).href; } catch { return u || ''; } },
hostName(u) { try { return new URL(u).hostname.replace(/^www\./,''); } catch { return u || ''; } },
normalizeItem(it) {
  if (!it) return null;
  if (typeof it === 'string') {
    const url = this.normUrl(it);
    return url ? { name: this.hostName(url) || url, url } : null;
  }
  if (typeof it === 'object') {
    const url = this.normUrl(it.url || '');
    const name = it.name || this.hostName(url) || url;
    return (url || name) ? { name, url } : null;
  }
  return null;
},
mapCategory(key) {
  const k = (key || '').toLowerCase();
  if (k.includes('g√∂rsel') || k.includes('gorsel') || k.includes('image') || k.includes('poster')) return 'G√∂rsel';
  if (k.includes('platform') || k.includes('watch') || k.includes('stream')) return 'Platform';
  // default
  return 'Kaynaklar';
},
normalizeSources(src) {
  // Her durumda ≈üu yapƒ±yƒ± d√∂nd√ºr: { Kaynaklar:[], G√∂rsel:[], Platform:[] }
  const out = { Kaynaklar: [], G√∂rsel: [], Platform: [] };

  const push = (cat, item) => {
    const n = this.normalizeItem(item);
    if (n) out[cat].push(n);
  };

  if (!src) return out;

  // Obje: { "Kaynaklar": [...], "G√∂rsel": [...], "Platform": [...] , ... }
  if (typeof src === 'object' && !Array.isArray(src)) {
    for (const [k, v] of Object.entries(src)) {
      const cat = this.mapCategory(k);
      const arr = Array.isArray(v) ? v : [v];
      arr.forEach(it => push(cat, it));
    }
    return out;
  }

  // Dizi:
  // - D√ºz link listesi: [{name,url}] ya da ["https://..."] -> Kaynaklar
  // - Gruplu: [{category:'...', items:[...]}]
  if (Array.isArray(src)) {
    if (!src.length || typeof src[0] !== 'object' || ('url' in src[0]) || ('name' in src[0])) {
      src.forEach(it => push('Kaynaklar', it));
    } else {
      src.forEach(g => {
        const cat = this.mapCategory(g?.category);
        const items = Array.isArray(g?.items) ? g.items : (g?.items ? [g.items] : []);
        items.forEach(it => push(cat, it));
      });
    }
    return out;
  }

  // String / tek obje vs:
  push('Kaynaklar', src);
  return out;
},

getSourceIcon(cat) {
  if (cat === 'G√∂rsel') return 'üñºÔ∏è';
  if (cat === 'Platform') return 'üé¨';
  return 'üìö'; // Kaynaklar
},
confirmExternal(url) {
  const msg = 'Bu baƒülantƒ± sizi harici bir siteye y√∂nlendirecek. Devam etmek istiyor musunuz?';
  if (url && confirm(msg)) window.open(url, '_blank', 'noopener');
},


norm(s) {
  if (!s) return '';
  // TR k√º√ß√ºltme + ƒ±‚Üíi d√ºzeltmesi + aksan temizleme
  return s
    .toLocaleLowerCase('tr')   // ƒ∞‚Üíi, I‚Üíƒ±
    .replace(/ƒ±/g, 'i')        // 'ƒ±'larƒ± da 'i' yap
    .normalize('NFD')          // aksanlarƒ± ayƒ±r
    .replace(/[\u0300-\u036f]/g, ''); // aksanlarƒ± sil
},


        get timelineSortedNodes(){
          const u = this.selectedUniverse;
          return [...this.allNodes]
            .filter(n => n.release_date && (!u || n.universe === u))
            .sort((a, b) => new Date(a.release_date) - new Date(b.release_date));
        },
        get groupTimelineByYear(){
          const groups = new Map();
          for (const n of this.timelineSortedNodes) {
            const y = new Date(n.release_date).getFullYear();
            if (!groups.has(y)) groups.set(y, []);
            groups.get(y).push(n);
          }
          for (const [y, arr] of groups.entries()) { arr.sort((a,b)=> new Date(a.release_date) - new Date(b.release_date)); }
          return Array.from(groups.entries()).sort((a,b)=> b[0]-a[0]);
        },
        
get legendEntries() {
  const usedTypes = new Set(this.filteredEdges.map(e => e.type));
  return Object.entries(this.edgeColors).filter(([t]) =>
    usedTypes.has(t) || this.filteredEdges.length === 0
  );
}
,

openFilterPanel: false,

filters: {
  genres: [],     // ["Aksiyon","Bilim Kurgu"] gibi
  yearMin: null,  // 2008
  yearMax: null,  // 2025
  imdbMin: null,  // 7.0
  type: 'all',    // 'all' | 'film' | 'dizi'
},

get activeFilterCount() {
  let c = 0;
  if (this.filters.genres?.length) c++;
  if (this.filters.yearMin != null || this.filters.yearMax != null) c++;
  if (this.filters.imdbMin != null) c++;
  if (this.filters.type && this.filters.type !== 'all') c++;
  return c;
},

resetFilters() {
  this.filters = { genres: [], yearMin: null, yearMax: null, imdbMin: null, type: 'all' };
  this.applyFilters();
  this.openFilterPanel = false;
},

get availableGenres() {
  const s = new Set();
  for (const n of this.allNodes) {
    const raw = (n.t√ºr || n.genre || n.genres || '').toString();
    raw.split(/[,\|/]/).map(x => x.trim()).filter(Boolean).forEach(g => s.add(g));
  }
  return s.size ? Array.from(s).sort() : [
    "Aksiyon","Macera","Bilim Kurgu","Dram","Fantastik","Animasyon","Komedi","Gerilim"
  ];
},

        get notesSummary(){
          const groups = new Map();
          for (const [nodeId, arr] of Object.entries(this.notes)){
            if (!arr || !arr.length) continue;
            const node = this.nodes?.get(nodeId) || this.allNodes.find(n => String(n.id)===String(nodeId));
            const g = groups.get(nodeId) || { count: 0, tags: new Set(), label: node?.label || nodeId, universe: node?.universe || '' };
            g.count += arr.length;
            for (const n of arr) (n.tags||[]).forEach(t => g.tags.add(t));
            groups.set(nodeId, g);
          }
          const u = this.notesUniverseFilter;
          const tagQ = (this.notesTagFilter || '').trim().replace(/^#/, '').toLowerCase();
          return Array.from(groups.entries()).map(([nodeId, g]) => ({ nodeId, label: g.label, universe: g.universe, count: g.count, tags: Array.from(g.tags) }))
            .filter(x => (!u || x.universe === u) && (!tagQ || x.tags.some(t => t.includes(tagQ))))
            .sort((a,b)=> b.count - a.count || a.label.localeCompare(b.label));
        },
        getAllEdgesWithNotes(nodeId) {
          if (!nodeId) return [];
          return this.allEdges
            .filter(e => e.from === nodeId || e.to === nodeId)
            .map(e => {
              const otherNodeId = e.from === nodeId ? e.to : e.from;
              const otherNode = this.allNodes.find(n => String(n.id) === String(otherNodeId));
              return {
    panel: null,
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     id: e.id || (e.from + "_" + e.to + "_" + (e.type || "")), otherNodeId, otherNodeLabel: otherNode?.label || otherNodeId, type: e.type, edgeHasNotes: !!e.notes, edgeNoteText: e.notes || "", nodeHasNotes: !!(this.notes && this.notes[otherNodeId] && this.notes[otherNodeId].length) };
            });
        },
        formatEdgeType(type) { if (!type) return ''; return type.charAt(0).toUpperCase() + type.slice(1); },
        get topTags(){
          const counts = new Map();
          const u = this.notesUniverseFilter;
          for (const [nodeId, arr] of Object.entries(this.notes)){
            if (!arr || !arr.length) continue;
            const node = this.allNodes.find(n => String(n.id) === String(nodeId));
            if (u && node?.universe !== u) continue;
            for (const n of arr) for (const t of (n.tags || [])) counts.set(t, (counts.get(t) || 0) + 1);
          }
          return Array.from(counts.entries()).sort((a,b) => b[1] - a[1]).slice(0, 10).map(([t]) => t);
        },
        init() {
          
this.resetFilters();


this.$watch && this.$watch('filters', (v) => {
  localStorage.setItem('filters', JSON.stringify(v));
});

  if (window.innerWidth < 640) {
    this.showLegend = false;
  } else {
    this.showLegend = true;
  }
          try { const old = localStorage.getItem('comments'); if (old && !localStorage.getItem('notes')) { localStorage.setItem('notes', old); localStorage.removeItem('comments'); } } catch {}
          this.loadWatchLater(); this.loadNotes(); this.network = null;
          this.setBackgroundFor(this.selectedUniverse); this.warmBackgrounds();
          this.loadData();

this.setupNetwork();
this.applyFilters();



          let debounceTimeout = null;
this.$watch('search', (val) => {
  clearTimeout(debounceTimeout);
  debounceTimeout = setTimeout(() => {
    this.applyFilters();
    if (val) {
      const q = this.norm(val);
      const starts = [], contains = [], seen = new Set();
      for (const n of this.allNodes) {
        const lbl = n.label || '';
        const l = this.norm(lbl);
        if (l.startsWith(q)) {
          if (!seen.has(lbl)) { starts.push(lbl); seen.add(lbl); }
        } else if (l.includes(q)) {
          if (!seen.has(lbl)) { contains.push(lbl); seen.add(lbl); }
        }
        if (starts.length + contains.length >= 10) break;
      }
      this.suggestions = [...starts, ...contains];
    } else {
      this.suggestions = [];
    }
  }, 220);
});

this.$watch('modalOpen', (isOpen) => {
  try {
    if (isOpen && this.modalNode) {
      this.pushPrettyUrl && this.pushPrettyUrl(this.modalNode);
    } else {
      this.resetPrettyUrl && this.resetPrettyUrl();
    }
  } catch(e) { console.warn('modalOpen watch', e); }
});



          
this.$watch('selectedUniverse', (val) => {
  if (val) {
    this.setBackgroundFor(val);
    if (!this.network) this.setupNetwork();
    this.applyFilters();
  }
  this.notesUniverseFilter = val;

  try { this.setParams({ u: val || '', clearNode: true }); } catch {}
});

        },
        async setBackgroundFor(universe){
          const primary = this.bgMap[universe || ""] || this.bgMap[""];
          const fallbacks = ["assets/images/bg.jpg", "assets/images/bg.jpg"];
          const tried = new Set();
          const tryLoad = (url) => new Promise((resolve,reject)=>{ if(!url || tried.has(url)) return reject(); tried.add(url); const img = new Image(); img.onload = () => resolve(url); img.onerror = () => reject(); img.decoding = 'async'; img.referrerPolicy = 'no-referrer'; img.src = url; });
          for (const url of [primary, ...fallbacks]) { try { const ok = await tryLoad(url); this.bgUrl = ok; return; } catch {} }
        },
        warmBackgrounds(){ [...new Set(Object.values(this.bgMap))].forEach(u => { const i = new Image(); i.decoding='async'; i.src = u; }); },
        loadWatchLater(){ try { this.watchLater = JSON.parse(localStorage.getItem('watchLater') || '[]'); } catch { this.watchLater = []; } },
        saveWatchLater(){ localStorage.setItem('watchLater', JSON.stringify(this.watchLater)); },
        isInWatchLater(id){ return !!this.watchLater.find(x => String(x.id) === String(id)); },
        toggleWatchLater(node){ if (!node?.id) return; if (this.isInWatchLater(node.id)) this.watchLater = this.watchLater.filter(x => String(x.id) !== String(node.id)); else this.watchLater.unshift({ id: node.id, label: node.label || String(node.id) }); this.saveWatchLater(); },
        removeWatchLater(id){ this.watchLater = this.watchLater.filter(x => String(x.id) !== String(id)); this.saveWatchLater(); },
        loadNotes(){ try { this.notes = JSON.parse(localStorage.getItem('notes')||'{}'); } catch { this.notes = {}; } },
        saveNotes(){ localStorage.setItem('notes', JSON.stringify(this.notes)); },
        extractTags(t){ return Array.from(t.matchAll(/#([\p{L}\d_-]+)/gu)).map(m=>m[1].toLowerCase()); },
        addNote(nodeId){ const t = (this.newNote || '').trim(); if (!nodeId || !t) return; const item = { text: t, tags: this.extractTags(t), pin: false, ts: Date.now(), editedTs: null }; (this.notes[nodeId] ||= []).unshift(item); this.newNote = ''; this.saveNotes(); },
        togglePin(nodeId, idx){ const n = this.notes[nodeId]?.[idx]; if (!n) return; n.pin = !n.pin; this.saveNotes(); },
        deleteNote(nodeId, idx){ this.notes[nodeId].splice(idx, 1); this.saveNotes(); },
        startEditNote(index, text) {
          this.editingNoteIndex = index;
          this.editedNoteText = text;
        },
        cancelEditNote() {
          this.editingNoteIndex = null;
          this.editedNoteText = '';
        },
        saveEditedNote(nodeId, index) {
          if (!this.notes[nodeId] || !this.notes[nodeId][index]) return;
          const updatedText = (this.editedNoteText || '').trim();
          if (!updatedText) return;
          this.notes[nodeId][index].text = updatedText;
          this.notes[nodeId][index].tags = this.extractTags(updatedText);
          this.notes[nodeId][index].editedTs = Date.now();
          this.saveNotes();
          this.cancelEditNote();
        },

        
makeSlug(str) {
  return (str || '')
    .toLocaleLowerCase('tr')
    .normalize('NFD').replace(/[ÃÄ-\u036f]/g, '')
    .replace(/ƒ±/g,'i').replace(/ƒ∞/g,'i').replace(/≈ü/g,'s')
    .replace(/√ß/g,'c').replace(/ƒü/g,'g').replace(/√∂/g,'o').replace(/√º/g,'u')
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/(^-|-$)/g,'');
},
nodeYear(n) {
  const y = (n?.release_date || n?.date || '').toString();
  const m = y.match(/\d{4}/);
  return m ? m[0] : '';
},
prettyNodePath(node) {
  const name = node?.label || node?.title || node?.name || '';
  const raw = this.makeSlug(name);
  const m = raw.match(/-(\d{4})$/);
  const slugNoYear = m ? raw.slice(0, -5) : raw;
  const yrFromSlug = m ? m[1] : null;
  const yr = yrFromSlug || this.nodeYear(node);
  const finalSlug = yr ? `${slugNoYear}-${yr}` : slugNoYear;

  const parts = location.pathname.split('/').filter(Boolean);
  const base = parts.length ? `/${parts[0]}` : '/evren';
  return `${base}/${finalSlug}`;
},

pushPrettyUrl(node) {
  try {
    const u = node?.universe || '';
    const id = node?.id != null ? String(node.id) : '';
    const url = new URL(location.href);
    url.searchParams.set('u', u);
    url.searchParams.set('node', id);
    history.replaceState({}, '', url);
  } catch (e) {
    console.warn('pushPrettyUrl error', e);
  }
},


resetPrettyUrl() {
  try {
    const url = new URL(location.href);
    url.search = '';
    history.replaceState({}, '', url.origin + url.pathname);
  } catch (e) {
    console.warn('resetPrettyUrl error', e);
  }
}
,

buildNodeUrl(nodeId){ const node = this.nodes?.get(nodeId) || this.allNodes.find(n => String(n.id)===String(nodeId)); const u = node?.universe || ''; const base = location.origin + location.pathname; const params = new URLSearchParams({ u, node: String(nodeId) }); return `${base}?${params.toString()}`; },
        shareNode(node, platform){ if (!node?.id) return; const url = this.buildNodeUrl(node.id); const text = `${node.label || node.id} ‚Äî ${this.formatUniverseName(node.universe)}\n${url}`; const enc = encodeURIComponent(text); const shareUrl = platform === 'whatsapp' ? `https://api.whatsapp.com/send?text=${enc}` : platform === 'x' ? `https://twitter.com/intent/tweet?text=${enc}` : ''; if (shareUrl) window.open(shareUrl, '_blank', 'noopener'); },
        

async loadData() {
  const evrenler = ["avatar","dc","harrypotter","marvel","matrix","middleearth","pixar","starwars"];
  try {
    const results = await Promise.all(
      evrenler.map(evren =>
        fetch('assets/data/' + evren + '.json', { cache: 'no-store' })
          .then(r => { if (!r.ok) throw new Error(evren + ' y√ºklenemedi'); return r.json().then(data => ({ evren, data })); })
      )
    );
    let nodesTemp = [], edgesTemp = [];
    for (const { evren, data } of results) {
      nodesTemp = nodesTemp.concat(data.nodes.map(n => ({ ...n, universe: evren })));
      edgesTemp = edgesTemp.concat(data.edges);
    }
    this.allNodes = nodesTemp;
    this.allEdges = edgesTemp;
    this.universeList = [...new Set(this.allNodes.map(n => n.universe))];

    // Parametreleri oku (hata g√ºvenli)
    let qU = null, qNode = null;
    try {
      const params = new URLSearchParams(location.search);
      qU = params.get('u');
      qNode = params.get('node');
    } catch(_) {}

    if (qU && this.universeList.includes(qU)) {
      this.selectedUniverse = qU;
    }

    // Filtre uygula (network hazƒ±r deƒüilse sorun yok)
    this.applyFilters?.();

    if (qNode) {
      const node = this.allNodes.find(n => String(n.id) === String(qNode));
      if (node) {
        this.$nextTick?.(() => {
          try {
            this.modalNode = node;
            this.modalOpen = true;
            if (this.network) {
              try { this.network.selectNodes([qNode]); } catch {}
              try { this.network.focus(qNode, { animation: true, scale: 1 }); } catch {}
            }
          } catch (e) {
            console.warn('Modal a√ßma sƒ±rasƒ±nda hata:', e);
          }
        });
      }
    }
  } catch (err) {
    console.error('loadData hata:', err);
    alert('Veri y√ºkleme hatasƒ±: ' + (err && err.message ? err.message : String(err)));
  }
},


        openNode(id) { const node = this.nodes?.get(id) || this.allNodes.find(n => String(n.id) === String(id)); if (node) { this.modalNode = node; this.modalOpen = true; window.__modalWasOpened = true; this.network?.selectNodes([id]); this.network?.focus(id, { animation: true, scale: 1 }); } },
        makeOptions() { return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     nodes: { size: 25, font: { color: '#e5e7eb', size: 14 }, borderWidthSelected: 6, color: { border: '#ef4444' } }, edges: { arrows: { to: { enabled: true, scaleFactor: 0.5 } }, smooth: { enabled: true, type: 'dynamic' } }, interaction: { hover: true, tooltipDelay: 200, zoomView: true, dragView: true }, physics: { stabilization: true, barnesHut: { gravitationalConstant: -4000 } }, layout: { improvedLayout: true } }; },
        setupNetwork() { this.nodes = new vis.DataSet(); this.edges = new vis.DataSet(); const container = document.getElementById('network'); this.network = new vis.Network(container, { nodes: this.nodes, edges: this.edges }, this.makeOptions()); this.network.on('click', params => { if (params.nodes.length > 0) { const node = this.nodes.get(params.nodes[0]); requestAnimationFrame(() => { this.modalNode = node; this.modalOpen = true; }); } }); },
        applyFilters() {
  if (!this.nodes || !this.edges) return;

const searchTerm = this.norm(this.search);

  const universe = this.selectedUniverse;

  const f = this.filters || {};
  const yearMin = f.yearMin != null ? Number(f.yearMin) : null;
  const yearMax = f.yearMax != null ? Number(f.yearMax) : null;
  const imdbMin = f.imdbMin != null ? Number(f.imdbMin) : null;
  const chosenGenres = new Set(((f.genres || [])).map(g => (g||'').toLowerCase()));
  const wantedType = (f.type || 'all');

  this.filteredNodes = (this.allNodes || []).filter(n => {
    // Evren + arama
    if (universe && n.universe !== universe) return false;
  if (searchTerm) {
  const lbl = this.norm(n.label);
  if (!lbl.includes(searchTerm)) return false;
}

    // Yƒ±l
    if (yearMin != null || yearMax != null) {
      const y = n.release_date ? new Date(n.release_date).getFullYear() : null;
      if (yearMin != null && (y == null || y < yearMin)) return false;
      if (yearMax != null && (y == null || y > yearMax)) return false;
    }

    // IMDb
    if (imdbMin != null) {
      const r = n.imdb_rating != null ? Number(n.imdb_rating) : null;
      if (r == null || r < imdbMin) return false;
    }

    // T√ºr (genre)
    if (chosenGenres.size) {
      const raw = (n.t√ºr || n.genre || n.genres || '').toString().toLowerCase();
      const nodeGenres = raw.split(/[,\|/]/).map(x => x.trim()).filter(Boolean);
      const hasAny = nodeGenres.some(g => chosenGenres.has(g));
      if (!hasAny) return false;
    }

    // Yapƒ±m tipi (film/dizi)
    if (wantedType !== 'all') {
      const nodeType = (n.type || n.tip || '').toString().trim().toLowerCase();
      const mapped = nodeType == 'movie' ? 'film'
                   : nodeType == 'series' ? 'dizi'
                   : nodeType;
      if (mapped !== wantedType) return false;
    }

    return true;
  });

  const nodeIds = new Set(this.filteredNodes.map(n => n.id));
  this.filteredEdges = (this.allEdges || []).filter(e => nodeIds.has(e.from) && nodeIds.has(e.to));

  this.updateNetwork && this.updateNetwork();
  if (this.network) {
    if (this.fitTimeout) clearTimeout(this.fitTimeout);
    this.fitTimeout = setTimeout(() => this.network.fit({ animation: true }), 220);
  }
},
        updateNetwork() {

            // √áƒ±kƒ±≈ü yƒ±lƒ±na g√∂re renk skalasƒ± (mavi -> kƒ±rmƒ±zƒ±)
            const getColorByYear = (year) => {
              if (!year) return '#888';
              const minYear = 1980;
              const maxYear = new Date().getFullYear();
              const ratio = Math.max(0, Math.min(1, (year - minYear) / (maxYear - minYear)));
              const r = Math.round(255 * ratio);
              const b = Math.round(255 * (1 - ratio));
              return `rgb(${r},50,${b})`;
            };

          this.nodes.clear(); this.edges.clear();
          this.nodes.add(this.filteredNodes.map(n => { const hasImage = !!n.image; const noteCount = (this.notes[n.id]?.length || 0); return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     ...n, label: noteCount ? `${n.label}\nüìù ${noteCount}` : n.label, font: { color: '#e5e7eb', size: 14, multi: true, vadjust: 4 }, shape: hasImage ? 'circularImage' : 'dot', borderWidth: 2, borderWidthSelected: 6, color: hasImage ? { border: getColorByYear(n.release_date ? new Date(n.release_date).getFullYear() : null) } : { background: getColorByYear(n.release_date ? new Date(n.release_date).getFullYear() : null), border: getColorByYear(n.release_date ? new Date(n.release_date).getFullYear() : null) } }; }));
          this.edges.add(this.filteredEdges.map(e => { const color = this.edgeColors[e.type] || '#9ca3af'; const s = this.edgeStyles[e.type] || { width: 1.5, dashes: false }; return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     ...e, arrows: 'to', color: { color }, width: s.width, dashes: s.dashes }; }));
        },
        neighborChips(nodeId) { if (!nodeId || !this.network) return ''; const neighbors = this.network.getConnectedNodes(nodeId).map(id => this.nodes.get(id)).filter(Boolean); if (!neighbors.length) return '<span class="text-sm opacity-70">Baƒülantƒ± bulunamadƒ±.</span>'; return neighbors.map(n => `<button class="chip hover:brightness-110" onclick="window.__openNode('${String(n.id).replace(/'/g,'&#39;')}')">${n.label ? n.label.replace(/</g,'&lt;') : 'ID ' + n.id}</button>`).join(''); },
        formatUniverseName(name) { const map = { "avatar": "Avatar", "dc": "DC", "marvel": "Marvel", "harrypotter": "Harry Potter", "matrix": "Matrix", "middleearth": "Orta D√ºnya", "pixar": "Pixar", "starwars": "Star Wars" }; return map[name] || name; }
      }
    }
    window.openNode = function(id) { const scope = document.querySelector('html')?.__x?.$data; if (!scope?.openNode) return; scope.openNode(id); };
    window.__openNode = function(id) { let scope = document.querySelector('html')?.__x?.$data; if (!scope?.nodes) { for (const el of document.querySelectorAll('[x-data]')) { if (el.__x && el.__x.$data?.nodes) { scope = el.__x.$data; break; } } } if (!scope?.nodes) return; const node = scope.nodes.get(id); if (node) { requestAnimationFrame(() => { scope.modalNode = node; scope.modalOpen = true; scope.network.selectNodes([id]); scope.network.focus(id, { animation: true, scale: 1 }); }); } };
  </script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered', reg.scope))
          .catch(err => console.warn('SW register failed', err));
      });
    }
  </script>
<script>
    const SHARE_PHRASES = { more: 'Devamƒ± i√ßin ziyaret et:', farewell: 'Sinemayla kalƒ±n.', dash: ' ‚Äî ' };
    const EMOJI = { title: 'üé¨', date: 'üìÖ', summary: 'üìù', more: 'üëâ', link: 'üîó', bye: 'üçø' };
    function preferredUrl(node){
  try {
    const url = new URL(location.href);
    url.searchParams.set('u', node?.universe || '');
    url.searchParams.set('node', String(node?.id ?? ''));
    return url.origin + url.pathname + '?' + url.searchParams.toString();
  } catch (_) {
    // Eski tarayƒ±cƒ±lar i√ßin basit fallback
    var u = (node && node.universe) ? node.universe : '';
    var i = (node && node.id != null) ? String(node.id) : '';
    return location.pathname + '?u=' + encodeURIComponent(u) + '&node=' + encodeURIComponent(i);
  }
};
  const slugNoYear = m ? raw.slice(0, -5) : raw;
  const yrFromSlug = m ? m[1] : null;
  const yr = yrFromSlug || (window.app?.nodeYear ? window.app.nodeYear(node) : '');
  const finalSlug = yr ? `${slugNoYear}-${yr}` : slugNoYear;

  const parts = location.pathname.split('/').filter(Boolean);
  const base = parts.length ? `/${parts[0]}` : '/evren';
  return location.origin + `${base}/${finalSlug}`;

    function composeShareText(node) {
      const filmAdi  = node?.label || node?.title || node?.name || 'Bu yapƒ±m';
      const line1 = `${EMOJI.title} ${filmAdi}`;
      const takvimTR = toTRDate(node?.release_date || node?.date);
      const line2 = takvimTR ? `${EMOJI.date} ${takvimTR}` : '';
      const aciklamaFull = (node?.description || '').trim();
      const gondermelerFull = (node?.refers_to || '').trim();
      const aciklama = aciklamaFull.length > 120 ? aciklamaFull.slice(0,117).trimEnd() + '...' : aciklamaFull;
      const gondermeler = gondermelerFull.length > 100 ? gondermelerFull.slice(0,97).trimEnd() + '...' : gondermelerFull;
      let line3 = '';
      if (aciklama && gondermeler) line3 = `${EMOJI.summary} Film √ñzeti: ${aciklama}${SHARE_PHRASES.dash}G√∂ndermeler: ${gondermeler}`;
      else if (aciklama) line3 = `${EMOJI.summary} Film √ñzeti: ${aciklama}`;
      else if (gondermeler) line3 = `${EMOJI.summary} G√∂ndermeler: ${gondermeler}`;
      if (line3 && !/[.!?‚Ä¶]$/.test(line3.trim())) line3 = line3.trim() + '.';
      const url = preferredUrl(node);
      const line4 = `${SHARE_PHRASES.more} ${EMOJI.more}`;
      const line5 = `${EMOJI.link} ${url}`;
      const line6 = `${SHARE_PHRASES.farewell} ${EMOJI.bye}`;
      return [line1, line2, line3, line4, line5, line6].filter(Boolean).join('\n');
    }
    function composeShareTextForX(node, max = 240) { const url = preferredUrl(node); const single = composeShareText(node).replace(/\n+/g, ' | '); const withoutUrl = single.replace(url, '').replace(/\s*\|\s*\|\s*/g, ' | ').trim(); return withoutUrl.length <= max ? withoutUrl : (withoutUrl.slice(0, max - 1) + '‚Ä¶'); }
    window.shareToX = function(node) { const url = preferredUrl(node); const text = composeShareTextForX(node); window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,'_blank','noopener,noreferrer'); };
    window.shareToWhatsApp = function(node) { const text = composeShareText(node); window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`,'_blank','noopener,noreferrer'); };
    window.shareToLinkedIn = function(node) { const url  = preferredUrl(node); const name = node?.label || node?.title || node?.name || 'Bu yapƒ±m'; const sum  = composeShareText(node); window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(name)}&summary=${encodeURIComponent(sum)}`,'_blank','noopener,noreferrer'); };
    window.copyShare = async function(node) { const full = composeShareText(node) + '\n'; try { await navigator.clipboard.writeText(full); alert('Payla≈üƒ±m metni ve link kopyalandƒ±.'); } catch { const ta = document.createElement('textarea'); ta.value = full; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('Payla≈üƒ±m metni ve link kopyalandƒ±.'); } };
  </script>
<script>
    window.toTRDate = function(value) { if (!value) return ''; const s = String(value).trim(); const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s); if (m) return `${m[3]}/${m[2]}/${m[1]}`; const d = new Date(s); if (isNaN(d)) return s; const dd = String(d.getDate()).padStart(2, '0'); const mm = String(d.getMonth() + 1).padStart(2, '0'); const yyyy = d.getFullYear(); return `${dd}/${mm}/${yyyy}`; };
  </script>

</div>
<div id="legendWrap" x-show="selectedUniverse">
<button id="legend_bar" @click="showLegend = !showLegend" class="glass px-3 py-1.5 rounded-lg text-sm hover:bg-white/10 transition" id="legendToggle">Baƒülantƒ±lar <span x-text="showLegend ? '(Gizle)' : '(G√∂ster)'"></span></button>
<div id="legend" x-show="showLegend" x-transition="">
<h3 class="font-bold mb-2">Baƒülantƒ±lar</h3>
<ul>
<template :key="type" x-for="[type, color] in legendEntries">
<li class="flex items-center mb-1"><svg class="mr-2" height="8" width="36"><line :stroke="color" :stroke-dasharray="(edgeStyles[type]?.dashes ? edgeStyles[type].dashes.join(',') : '0')" stroke-width="3" x1="2" x2="34" y1="4" y2="4"></line></svg><span x-text="type"></span></li>
</template>
</ul>
</div>






<!-- Timeline button above Notes & Favorites -->
<button
  id="timeline_bar"
  @click="timelineOpen = !timelineOpen"
  class="fixed right-4 bottom-[8rem] z-[50] glass rounded-full w-12 h-12 grid place-items-center hover:bg-white/10 pointer-events-auto"
  title="Zaman √áizelgesi"
>
  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v3H2V6a2 2 0 0 1 2-2h1V3a1 1 0 1 1 2 0v1z"/>
    <path d="M2 10h20v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8zm6 3a1 1 0 1 0 0 2h5a1 1 0 1 0 0-2H8z"/>
  </svg>
</button>

<!-- Yeni panel a√ßma butonu -->
<button @click="panelOpen = !panelOpen" id="panel_bar" class="fixed right-4 bottom-[4.5rem] z-50 glass rounded-full w-12 h-12 grid place-items-center hover:bg-white/10" title="Notlar ve Favoriler">üìÅ</button>


<!-- Notlar & Favoriler Paneli -->
<div class="fixed right-4 bottom-[9rem] z-[60] glass rounded-xl p-4 w-[22rem] max-h-[45vh] overflow-y-auto text-white text-sm space-y-4"
     x-show="panelOpen" x-transition>

  <!-- Sekmeler -->
  <div class="flex gap-2 mb-1">
    <button id="fav_bar" @click="activeTab = 'watch'" :class="activeTab === 'watch' ? 'bg-white/20 px-3 py-1 rounded' : 'px-3 py-1 rounded hover:bg-white/10'">‚≠ê Favoriler</button>
    <button id="notlar_bar" @click="activeTab = 'notes'" :class="activeTab === 'notes' ? 'bg-white/20 px-3 py-1 rounded' : 'px-3 py-1 rounded hover:bg-white/10'">üìù Notlar</button>
  </div>

  <!-- Favoriler Sekmesi -->
  <div x-show="activeTab === 'watch'" class="space-y-3">
    <template x-if="!watchLater.length">
      <p class="text-sm opacity-70">Hen√ºz favori yok.</p>
    </template>

    <template x-for="item in watchLater" :key="item.id">
      <div class="border border-white/10 rounded-lg overflow-hidden">
        <div class="flex justify-between items-center px-3 py-2 bg-white/10">
          <span class="font-semibold truncate" x-text="item.label || item.id"></span>
          <button @click="removeWatchLater(item.id)" class="text-red-400 hover:text-red-600 text-xs">Sil</button>
        </div>
      </div>
    </template>
  </div>

  <!-- Notlar Sekmesi -->
  <div x-show="activeTab === 'notes'" class="space-y-3">
    <template x-if="!Object.keys(notes).some(k => notes[k]?.length)">
      <p class="text-sm opacity-70">Not bulunamadƒ±.</p>
    </template>

    <template x-for="(entries, nodeId) in Object.fromEntries(Object.entries(notes).filter(([k, arr]) => arr.length))" :key="nodeId">
      <div class="border border-white/10 rounded-lg overflow-hidden">
        <button @click="notesOpen = notesOpen === nodeId ? null : nodeId" class="w-full text-left px-3 py-2 bg-white/10 hover:bg-white/20 font-semibold">
          <span x-text="nodes.get(nodeId)?.label || nodeId"></span>
        </button>

        <div x-show="notesOpen === nodeId" x-transition class="p-3 space-y-2 max-h-[45vh] overflow-y-auto">
          <template x-for="(n, i) in entries" :key="i">
            <div class="bg-white/10 p-2 rounded">
              <div class="text-xs opacity-70 mb-1" x-text="new Date(n.ts).toLocaleDateString()"></div>

              <template x-if="editingNoteIndex === `${nodeId}_${i}`">
                <div class="flex flex-col gap-2">
                  <textarea x-model="editedNoteText" class="w-full p-2 rounded bg-black/20 text-sm text-white border border-white/20"></textarea>
                  <div class="flex justify-end gap-2 text-xs">
                    <button @click="saveEditedNote(nodeId, i)" class="px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white">Kaydet</button>
                    <button @click="cancelEditNote()" class="px-2 py-1 rounded bg-white/20 text-white">Vazge√ß</button>
                  </div>
                </div>
              </template>

              <template x-if="editingNoteIndex !== `${nodeId}_${i}`">
                <div>
                  <div class="whitespace-pre-wrap text-sm mb-1" x-text="n.text"></div>
                  <div class="flex justify-end gap-2 text-xs opacity-80">
                    <button @click="startEditNote(`${nodeId}_${i}`, n.text)">‚úèÔ∏è</button>
                    <button @click="deleteNote(nodeId, i)">üóëÔ∏è</button>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </template>
  </div>
</div>
        </template>
      </div>
    </template>
  </div>
</div>

<!-- Bilgi Panelleri -->
<div x-show="panel === 'hakkimizda'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">‚ÑπÔ∏è Hakkƒ±mƒ±zda</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p><strong>Film Evreni Aƒüƒ±</strong>, sinema ve dizi evrenlerini etkile≈üimli ve g√∂rsel bir bi√ßimde ke≈üfetmek isteyenler i√ßin tasarlanmƒ±≈ü bir bilgi platformudur.</p>
  <p>Amacƒ±mƒ±z, sinema tutkunlarƒ±nƒ±n evrenler arasƒ± ili≈ükileri kolayca anlamasƒ±nƒ± saƒülamak ve her yapƒ±mƒ±n birbirine nasƒ±l baƒülandƒ±ƒüƒ±nƒ± sezgisel olarak sunmaktƒ±r.</p>
  <ul class="list-disc list-inside space-y-1">
    <li>Farklƒ± sinematik evrenleri merkezden uca, zaman √ßizgisi ya da karakter baƒülantƒ±larƒ±yla g√∂rselle≈ütirir.</li>
    <li>Kullanƒ±cƒ±lara ki≈üisel notlar alma, favori yapƒ±mlarƒ±nƒ± i≈üaretleme imkanƒ± tanƒ±r.</li>
    <li>Yapƒ±m bilgileri, karakter ili≈ükileri ve g√∂ndermeler gibi i√ßerikleri zenginle≈ütirir.</li>
    <li>Kullanƒ±cƒ±larƒ±n yorum yazmasƒ±na deƒüil, bilgiye odaklanmasƒ±na olanak saƒülar.</li>
    <li>Hafif, reklamsƒ±z ve √ºyelik gerektirmeyen bir deneyim sunar.</li>
  </ul>
  <p>Film Evreni Aƒüƒ± baƒüƒ±msƒ±z bir giri≈üimdir ve herhangi bir st√ºdyo veya yayƒ±ncƒ±yla baƒülantƒ±sƒ± yoktur.</p>
</div>
    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri D√∂n</button>
    </div>
  </div>
</div>

<div x-show="panel === 'gizlilik'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">üîê Gizlilik Politikasƒ±</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p>Film Evreni Aƒüƒ± olarak gizliliƒüinizi ciddiye alƒ±yoruz. Platformumuz, anonim kullanƒ±cƒ± deneyimi sunar ve size ait verileri if≈üa etmez.</p>

  <h3 class="font-semibold mt-4 mb-1">Toplanan Bilgiler</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Kullanƒ±cƒ±dan aktif olarak <strong>hi√ßbir ki≈üisel bilgi</strong> talep edilmez.</li>
    <li>Ad, e-posta, √ºyelik, ≈üifre vb. sistemde <strong>tutulmaz</strong>.</li>
    <li>Favoriler ve notlar yalnƒ±zca tarayƒ±cƒ± (localStorage) √ºzerinde saklanƒ±r.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Veri Kullanƒ±mƒ±</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Veriler yalnƒ±zca size g√∂r√ºn√ºr ≈üekilde cihazƒ±nƒ±zda tutulur.</li>
    <li>Kullanƒ±cƒ± davranƒ±≈üƒ± izlenmez, analiz yapƒ±lmaz.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">3. Taraflar ve ƒ∞zleme</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Google Analytics, Facebook Pixel gibi izleme ara√ßlarƒ± <strong>kullanƒ±lmaz</strong>.</li>
    <li>Reklam, takip veya sponsor sistemleri entegre edilmemi≈ütir.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Veri Payla≈üƒ±mƒ±</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Hi√ßbir veri 3. ≈üahƒ±slarla <strong>payla≈üƒ±lmaz</strong>.</li>
    <li>Yasal bir zorunluluk olmadƒ±k√ßa veri kaydƒ± yoktur.</li>
  </ul>

 <div class="text-center mt-4">
  <button @click="panel = 'iletisim'" class="px-4 py-2 bg-white/10 border border-white/20 text-white text-sm rounded hover:bg-white/20">
    ƒ∞leti≈üim Formunu A√ß
  </button>
</div>
</div>
    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri D√∂n</button>
    </div>
  </div>
</div>

<div x-show="panel === 'cerez'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">üç™ √áerez Politikasƒ±</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p>Web sitemiz yalnƒ±zca <strong>zorunlu ve deneyimi iyile≈ütiren √ßerezler</strong> kullanƒ±r.</p>

  <h3 class="font-semibold mt-4 mb-1">Kullandƒ±ƒüƒ±mƒ±z √áerez T√ºrleri</h3>
  <ul class="list-disc list-inside space-y-1">
    <li><strong>Oturum √áerezleri:</strong> Ge√ßici olarak tutulur, oturum kapandƒ±ƒüƒ±nda silinir.</li>
    <li><strong>Tercih √áerezleri:</strong> Tema ayarlarƒ±, notlar, favoriler gibi verileri saklar.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Kullanƒ±m Ama√ßlarƒ±</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Karanlƒ±k/aydƒ±nlƒ±k tema tercihini hatƒ±rlama</li>
    <li>Son se√ßilen evreni veya yapƒ±mƒ± hatƒ±rlama</li>
    <li>Ki≈üisel not ve favori listesini koruma</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Toplamadƒ±ƒüƒ±mƒ±z Veriler</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Davranƒ±≈ü analizi, IP adresi, konum, ge√ßmi≈ü gibi veriler toplanmaz.</li>
    <li>Reklam √ßerezi veya sosyal medya takibi <strong>yoktur</strong>.</li>
  </ul>

  <p class="mt-4">√áerezleri tarayƒ±cƒ±nƒ±zdan temizleyebilir veya engelleyebilirsiniz. Bu durumda bazƒ± √∂zellikler √ßalƒ±≈ümayabilir.</p>
</div>
    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri D√∂n</button>
    </div>
  </div>
</div>

<div x-show="panel === 'kullanim'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">üìú Kullanƒ±m Ko≈üullarƒ±</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p>Platformu kullanarak a≈üaƒüƒ±daki ko≈üullarƒ± kabul etmi≈ü sayƒ±lƒ±rsƒ±nƒ±z:</p>

  <h3 class="font-semibold mt-4 mb-1">Kullanƒ±m Amacƒ±</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Yalnƒ±zca <strong>ki≈üisel ve eƒüitsel</strong> kullanƒ±m i√ßindir.</li>
    <li>Herhangi bir ticari faaliyet amacƒ±yla kullanƒ±lamaz.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">ƒ∞√ßerik ve Sorumluluk</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Bilgiler kamuya a√ßƒ±k kaynaklardan derlenmi≈ütir.</li>
    <li>ƒ∞√ßerik doƒüruluƒüu garanti edilmez; referans ama√ßlƒ±dƒ±r.</li>
    <li>Telifli materyallerin sahibi yapƒ±m ≈üirketleridir.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Kƒ±sƒ±tlamalar</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>ƒ∞√ßerik izinsiz kopyalanamaz, daƒüƒ±tƒ±lamaz, satƒ±lamaz.</li>
    <li>Kod yapƒ±sƒ± ve veri yapƒ±larƒ± izinsiz √ßoƒüaltƒ±lamaz.</li>
  </ul>

  <p class="mt-4">Kurallarƒ± ihlal eden kullanƒ±cƒ±larƒ±n eri≈üimi engellenebilir.</p>
</div>
    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri D√∂n</button>
    </div>
  </div>
</div>

<div x-show="panel === 'dmca'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">‚öñÔ∏è DMCA Bildirimi</h2>
<div class="text-base text-white/80 space-y-3 text-left">
  <p>Film Evreni Aƒüƒ± telif hakkƒ± sahiplerine saygƒ± duyar ve ihlal bildirimlerini ciddiyetle ele alƒ±r.</p>

  <h3 class="font-semibold mt-4 mb-1">Bildiriminizde Bulunmasƒ± Gerekenler</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Hak sahibinin adƒ± ve ileti≈üim bilgileri</li>
    <li>ƒ∞hlal ettiƒüi d√º≈ü√ºn√ºlen i√ßeriƒüin tam baƒülantƒ±sƒ± (URL)</li>
    <li>Telif hakkƒ± sahibi olduƒüunuza dair a√ßƒ±k beyan</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">S√ºre√ß</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Bildirimin ardƒ±ndan en ge√ß 48 saat i√ßinde yanƒ±t verilir.</li>
    <li>Uygun g√∂r√ºld√ºƒü√º takdirde i√ßerik yayƒ±ndan kaldƒ±rƒ±lƒ±r.</li>
  </ul>

  <h3 class="font-semibold mt-4 mb-1">Yasal Uyarƒ±</h3>
  <ul class="list-disc list-inside space-y-1">
    <li>Yanlƒ±≈ü beyanla g√∂nderilen bildirimler yasal sorumluluk doƒüurur.</li>
  </ul>

  <div class="text-center mt-4">
  <button @click="panel = 'iletisim'" class="px-4 py-2 bg-white/10 border border-white/20 text-white text-sm rounded hover:bg-white/20">
    ƒ∞leti≈üim Formunu A√ß
  </button>
</div>
</div>

    <div class="text-center">
      <button @click="panel = null" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">Geri D√∂n</button>
    </div>
  </div>
</div>

<div x-show="panel === 'iletisim'" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">üì¨ ƒ∞leti≈üim Formu</h2>

    <form id="iletisimForm" class="space-y-4">
      <div>
        <label class="block mb-1">Adƒ±nƒ±z</label>
        <input type="text" name="name" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" required>
      </div>
      <div>
        <label class="block mb-1">E-posta Adresiniz</label>
        <input type="email" name="email" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" required>
      </div>
      <div>
        <label class="block mb-1">Konu</label>
        <select name="subject" required class="w-full px-3 py-2 rounded bg-white/10 border border-white/20">
          <option disabled selected>Se√ßin</option>
          <option>ƒ∞stek-√ñneri</option>
          <option>DMCA</option>
          <option>ƒ∞leti≈üim</option>
        </select>
      </div>
      <div>
        <label class="block mb-1">Mesajƒ±nƒ±z</label>
        <textarea name="message" rows="5" class="w-full px-3 py-2 rounded bg-white/10 border border-white/20" required></textarea>
      </div>
      <div class="text-center">
        <button type="submit" class="px-4 py-2 bg-white/10 border border-white/20 text-white text-sm rounded hover:bg-white/20">G√∂nder</button>
      </div>
    </form>

    <div class="text-center">
      <button @click="panel = null" class="mt-2 px-4 py-1 text-sm text-white border border-white/20 rounded hover:bg-white/20">ƒ∞ptal</button>
    </div>
  </div>

  <!-- EmailJS entegrasyonu -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("7UKhuE7htA-_Kgs1q"); // public key
    })();

    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("iletisimForm");
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        emailjs.sendForm("service_7klkor6", "template_7shk4yl", form)
          .then(() => {
            alert("Mesajƒ±nƒ±z ba≈üarƒ±yla g√∂nderildi. Te≈üekk√ºr ederiz!");
            form.reset();
            panel = null;
          })
          .catch((error) => {
            alert("Bir hata olu≈ütu: " + JSON.stringify(error));
          });
      });
    });
  </script>
</div>



<footer class="bg-black/70 text-white/70 text-xs text-center py-4 border-t border-white/10 mt-auto relative z-50">
  <div class="space-y-2">
    <div>¬© 2025 Film Evreni Aƒüƒ±</div>
    <div class="flex flex-wrap justify-center gap-x-4 gap-y-1 text-xs">
      <a href="#" @click.prevent="panel='hakkimizda'" class="underline hover:text-white block">Hakkƒ±mƒ±zda</a>
      <a href="#" @click.prevent="panel='gizlilik'" class="underline hover:text-white block">Gizlilik</a>
      <a href="#" @click.prevent="panel='cerez'" class="underline hover:text-white block">√áerez Politikasƒ±</a>
      <a href="#" @click.prevent="panel='kullanim'" class="underline hover:text-white block">Kullanƒ±m Ko≈üullarƒ±</a>
      <a href="#" @click.prevent="panel='dmca'" class="underline hover:text-white block">DMCA</a>
    </div>
  </div>
</footer>

<script>
// Saƒü tƒ±k kapatma
document.addEventListener('contextmenu', e => e.preventDefault(), {passive:false});

// Se√ßimi ve kopyayƒ± zorla≈ütƒ±r (tam g√ºvenlik saƒülamaz)
document.addEventListener('copy', e => e.preventDefault());
document.addEventListener('cut',  e => e.preventDefault());

// Yaygƒ±n kƒ±sayollarƒ± engelle (F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S vs.)
document.addEventListener('keydown', function(e){
  const k = e.key.toLowerCase();
  const ctrl = e.ctrlKey || e.metaKey;
  if (
    k === 'f12' ||
    (ctrl && k === 'u') ||              // Ctrl+U: View Source
    (ctrl && k === 's') ||              // Ctrl+S: Save
    (ctrl && k === 'p') ||              // Ctrl+P: Print
    (ctrl && e.shiftKey && k === 'i') ||// DevTools
    (ctrl && e.shiftKey && k === 'j') ||// DevTools console
    (ctrl && e.shiftKey && k === 'c')   // Open element picker (bazƒ± eklentiler)
  ){
    e.preventDefault();
    e.stopPropagation();
  }
}, {capture:true});
</script> 

<script>
(function(){
  let warned = false;
  function devtoolsLikelyOpen(){
    // pencere √ßer√ßevesi kalƒ±nlƒ±k farkƒ± y√∂ntemi (yanlƒ±≈ü pozitif olabilir)
    const threshold = 160;
    const wDiff = Math.abs(window.outerWidth - window.innerWidth);
    const hDiff = Math.abs(window.outerHeight - window.innerHeight);
    return (wDiff > threshold || hDiff > threshold);
  }
  function check(){
    if (!warned && devtoolsLikelyOpen()){
      warned = true;
      // Basit bir kilit/√∂rt√º
      const div = document.createElement('div');
      div.style.cssText = `
        position:fixed;inset:0;background:#000c;color:#fff;z-index:99999;
        display:grid;place-items:center;font:600 16px/1.4 system-ui`;
      div.textContent = 'G√ºvenlik nedeniyle sayfa ge√ßici olarak kilitlendi.';
      document.body.appendChild(div);
      // ƒ∞stersen buraya y√∂nlendirme koy: location.href = '/';
    }
  }
  setInterval(check, 800);
})();
</script>

<!-- Hidden admin redirect snippet: begin -->
<script>
(function(){
  var target = "./src/admin.html";
  function go(){ try { window.location.href = target; } catch(e){} }

  // 1) Hotkey: Ctrl/Cmd + Alt + A
  window.addEventListener("keydown", function(e){
    var isA = (e.key || "").toLowerCase() === "a";
    if (isA && e.altKey && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      go();
    }
  }, { passive: false });

  // 2) Hash trigger: #admin
  if ((location.hash || "").toLowerCase() === "#admin") {
    go();
  }

  // 3) Type sequence: "admin" within 1.5s anywhere
  var buffer = "";
  var timer = null;
  window.addEventListener("keydown", function(e){
    var k = (e.key || "");
    if (k.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
      buffer += k.toLowerCase();
      if (timer) clearTimeout(timer);
      timer = setTimeout(function(){ buffer = ""; }, 1500);
      if (buffer.endsWith("admin")) {
        go();
      }
    }
  });
})();
</script>
<!-- Hidden admin redirect snippet: end -->
<script>
(function(){
  var logo = document.getElementById('secretAdminTap');
  var tapCount = 0;
  var tapTimer;

  if(logo){
    logo.addEventListener('click', function(){
      tapCount++;
      clearTimeout(tapTimer);
      tapTimer = setTimeout(function(){ tapCount = 0; }, 1000); // 1 sn i√ßinde tƒ±klama sayƒ±lƒ±r

      if(tapCount >= 5){
        window.location.href = "./src/admin.html";
      }
    });
  }
})();
</script>





<!-- Timeline Overlay -->
<div x-show="timelineOpen" @click="timelineOpen=false" class="tl-overlay" x-transition.opacity></div>

<!-- Timeline Panel -->
<section x-show="timelineOpen"
         @keydown.escape.window="timelineOpen=false"
         class="tl-panel glass rounded-t-2xl p-4 no-scrollbar overflow-y-auto"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="translate-y-full"
         x-transition:enter-end="translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="translate-y-0"
         x-transition:leave-end="translate-y-full">

  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">üìÖ Zaman √áizelgesi</h3>
    <button @click="timelineOpen=false" class="w-8 h-8 rounded-full bg-white/10 border border-white/20">‚úï</button>
  </div>

  <div x-ref="tlScroll"
     x-data="{ isDown:false, startX:0, scrollLeft:0 }"
     @mousedown="isDown=true; startX=$event.pageX - $refs.tlScroll.getBoundingClientRect().left; scrollLeft=$refs.tlScroll.scrollLeft"
     @mouseleave="isDown=false"
     @mouseup="isDown=false"
     @mousemove="if(isDown){ $event.preventDefault(); const x=$event.pageX - $refs.tlScroll.getBoundingClientRect().left; $refs.tlScroll.scrollLeft = scrollLeft - (x - startX) }"
     class="tl-scroll overflow-x-auto overflow-y-hidden no-scrollbar whitespace-nowrap cursor-grab"
     :class="isDown ? 'cursor-grabbing' : 'cursor-grab'"
     @wheel.passive="if ($event.deltaY) { $refs.tlScroll.scrollLeft += $event.deltaY }"
     style="touch-action: pan-x;">
    <div class="flex gap-4 pr-4">
      <template x-for="pair in Array.from(groupTimelineByYear)" :key="pair[0]">
        <div class="tl-col">
          <div class="sticky top-0 backdrop-blur-sm bg-black/20 border-b border-white/10 py-1 mb-2">
            <div class="tl-year text-emerald-300 text-xl" x-text="pair[0]"></div>
          </div>
          <div class="space-y-2">
            <template x-for="n in pair[1]" :key="n.id">
              <div class="tl-card" @click="openTimelineNode(n.id)">
                <div class="flex gap-3">
                  <img class="tl-poster" :src="n.image" alt="">
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold truncate" x-text="n.label"></div>
                    <div class="text-xs opacity-80">
                      <span x-text="toTRDate(n.release_date)"></span>
                      <span class="mx-1">‚Ä¢</span>
                      <span x-text="n.type || '-'"></span>
                    </div>
                    <div class="mt-1 flex flex-wrap gap-1">
                      <span class="tl-badge" x-text="formatUniverseName(n.universe)"></span>
                      <template x-if="n.imdb_rating">
                        <span class="tl-badge">IMDb <span x-text="n.imdb_rating"></span></span>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
</section>
<script>
!function(){
  const payload = {
    ts: Date.now(),
    path: location.pathname + location.search,
    ref: document.referrer || 'direct',
    ua: navigator.userAgent || '',
    lang: navigator.language || '',
    w: screen.width, h: screen.height
  };
  fetch('https://evren-analytics.no-reply-bf4.workers.dev/api/analytics/collect', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload),
    keepalive: true
  }).catch(()=>{});
}();
</script>



<script>
  function setParams(patch = {}) {
    const url = new URL(location.href);
    const qs = url.searchParams;
    Object.entries(patch).forEach(([k, v]) => {
      if (v === undefined || v === null || v === '') qs.delete(k);
      else qs.set(k, String(v));
    });
    if (patch.clearNode) qs.delete('node');
    url.search = qs.toString();
    history.replaceState({}, '', url);
  }
  window.pushPrettyUrl = function pushPrettyUrl(node) {
    try {
      const u = node?.universe || '';
      const id = node?.id != null ? String(node.id) : '';
      setParams({ u, node: id });
    } catch(e) { console.warn('pushPrettyUrl', e); }
  };
  window.resetPrettyUrl = function resetPrettyUrl() {
    try { setParams({ clearNode: true }); } catch(e) { console.warn('resetPrettyUrl', e); }
  };
  window.buildNodeUrl = function buildNodeUrl(nodeId){
    const url = new URL(location.href);
    const u = (window.app?.selectedUniverse) || '';
    url.searchParams.set('u', u || '');
    url.searchParams.set('node', String(nodeId));
    return url.origin + url.pathname + '?' + url.searchParams.toString();
  };
  window.preferredUrl = function preferredUrl(node){
  try {
    const url = new URL(location.href);
    url.searchParams.set('u', node?.universe || '');
    url.searchParams.set('node', String(node?.id ?? ''));
    return url.origin + url.pathname + '?' + url.searchParams.toString();
  } catch (_) {
    // Eski tarayƒ±cƒ±lar i√ßin basit fallback
    var u = (node && node.universe) ? node.universe : '';
    var i = (node && node.id != null) ? String(node.id) : '';
    return location.pathname + '?u=' + encodeURIComponent(u) + '&node=' + encodeURIComponent(i);
  }
};
</script>

</body>


</html>
