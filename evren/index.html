<!DOCTYPE html>
<html lang="tr" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film Evreni AÄŸÄ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    :root { color-scheme: dark; }
    html, body {
      height: 100%;
      margin: 0;
      color: #d1d5db;
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: transparent;
    }

    /* Tam ekran arkaplan gÃ¶rseli (IMG tabanlÄ±, mobilde sorunsuz) */
    #bgImg{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: blur(12px) brightness(0.65);
      transform: scale(1.06);
      z-index: -2;
      backface-visibility: hidden;
      will-change: transform;
    }
    #bgOverlay{
      position: fixed;
      inset: 0;
      z-index:-1;
      background: rgba(0,0,0,0.35);
    }

    /* Graph tam ekran; transparan */
    #network { position: fixed; inset: 0; background: transparent; border: none; }

    /* Cam (glass) yÃ¼zey */
    .glass {
      background: rgba(31,41,55,0.45);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    /* Formlar */
    input { color: #e5e7eb; background-color: rgba(55,65,81,0.55); border: 1px solid rgba(255,255,255,0.12); outline: none; }
    input::placeholder { color: #9ca3af; }

    /* Autocomplete paneli */
    .ac-panel {
      background: rgba(31,41,55,0.9);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 14px 28px rgba(0,0,0,0.5);
    }
    .ac-item { cursor: pointer; }
    .ac-item:hover { background: rgba(255,255,255,0.08); }

    /* Custom dropdown (glass) */
    .dropdown-btn { cursor: pointer; }
    .dropdown-panel {
      background: rgba(31,41,55,0.65);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 16px 40px rgba(0,0,0,0.45);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .dropdown-item { cursor: pointer; }
    .dropdown-item:hover { background: rgba(255,255,255,0.06); }

    /* Modal */
    .modal-bg { background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); }
    .modal-content {
      width: 92vw; max-width: 780px;
      max-height: 85vh; overflow-y: auto;
      background: #0f172a; color: #e5e7eb;
      border-radius: 18px; padding: 0;
      box-shadow: 0 12px 24px rgba(0,0,0,0.45); position: relative;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .modal-header {
      display: grid; grid-template-columns: 120px 1fr; gap: 16px;
      padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.06);
      background: radial-gradient(1200px 400px at -20% -40%, rgba(239,68,68,0.08), transparent);
    }
    .poster {
      width: 120px; height: 160px; border-radius: 10px; object-fit: cover;
      background: #111827;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .modal-body { padding: 16px; }
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 4px 10px; border-radius: 999px; font-size: 12px;
    }

    /* Meta tek kolon */
    .meta-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
    .meta-item { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); padding: 10px 12px; border-radius: 12px; }
    .section-title { font-size: 0.9rem; opacity: 0.85; margin-bottom: 6px; }

    .close-btn {
      position: absolute; top: 12px; right: 12px;
      width: 36px; height: 36px; border-radius: 999px;
      display: grid; place-items: center;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
    }
    .close-btn:hover { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.5); }

    /* Legend: Ã¼stte toggle, mobilde kapalÄ± + kÃ¼Ã§Ã¼k */
    #legendWrap { position: fixed; left: 16px; bottom: 16px; z-index: 40; }
    #legendToggle {
      margin-bottom: 8px;
      background: rgba(31,41,55,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    #legend {
      background: rgba(31,41,55,0.45);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 12px; padding: 12px 16px;
      max-width: 320px; max-height: 260px; overflow-y: auto;
      font-size: 0.85rem;
    }
    @media (max-width: 640px) {
      #legend { font-size: 0.72rem; max-width: 220px; padding: 8px 10px; }
    }
  </style>
</head>
<body class="dark" :class="{ 'overflow-hidden': modalOpen }">

<!-- Dinamik arkaplan (IMG + overlay) -->
<img id="bgImg" :src="bgUrl" alt="" />
<div id="bgOverlay"></div>

<!-- Kompakt CAM NAVBAR (mobil tam geniÅŸlik, sm: md, lg: lg) -->
<header class="fixed top-4 left-0 right-0 z-50">
  <div class="w-full sm:max-w-md lg:max-w-lg mx-auto px-3">
    <div class="glass rounded-xl px-3 py-2">
      <div class="flex flex-col gap-2">
        <div class="flex items-center justify-center">
          <h1 class="text-base sm:text-lg font-bold text-center">ðŸŽ¬ Film Evreni AÄŸÄ±</h1>
        </div>

        <div class="flex items-center gap-2">
          <!-- Arama + Autocomplete + X temizle -->
          <div class="relative w-full">
            <input
              x-model="search"
              type="search"
              placeholder="Ara..."
              class="border rounded-lg px-3 py-1.5 w-full pr-8"
              @focus="acOpen = true"
              @blur="setTimeout(() => acOpen = false, 120)"
            />
            <button
              x-show="search"
              @mousedown.prevent
              @click="search=''; suggestions=[]; applyFilters()"
              class="absolute inset-y-0 right-2 my-auto h-6 w-6 rounded-full grid place-items-center opacity-80 hover:opacity-100 hover:bg-white/10"
              aria-label="Temizle">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4Z"/>
              </svg>
            </button>

            <!-- Ã–neriler -->
            <div x-show="acOpen && search && suggestions.length"
                 class="ac-panel absolute z-50 w-full mt-1 rounded-lg overflow-hidden max-h-56 overflow-y-auto">
              <template x-for="(s, idx) in suggestions" :key="s">
                <div class="ac-item px-3 py-1.5"
                     @mousedown.prevent
                     @click="search = s; acOpen=false; applyFilters();">
                  <span x-text="s"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Custom Universe Dropdown (glass) -->
          <div class="relative min-w-[200px]" x-data="{ open:false, filterText:'' }" @keydown.escape="open=false" @click.outside="open=false">
            <div class="dropdown-btn border rounded-lg px-3 py-1.5 w-full flex items-center justify-between select-none"
                 @click="open=!open" :aria-expanded="open">
              <span class="truncate" x-text="selectedUniverse ? formatUniverseName(selectedUniverse) : 'TÃ¼m Evrenler'"></span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-80 ml-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div x-show="open" x-transition class="dropdown-panel absolute mt-2 left-0 right-0 rounded-xl overflow-hidden" style="z-index:60">
              <div class="p-2 border-b border-white/10">
                <input x-model="filterText" placeholder="Evren ara..." class="w-full px-3 py-2 rounded-lg border" />
              </div>
              <ul class="max-h-64 overflow-y-auto">
                <li class="dropdown-item px-3 py-2" @click="selectedUniverse=''; open=false; filterText=''; applyFilters()">TÃ¼m Evrenler</li>
                <template x-for="u in universeList.filter(u => !filterText || formatUniverseName(u).toLowerCase().includes(filterText.toLowerCase()))" :key="u">
                  <li class="dropdown-item px-3 py-2"
                      @click="selectedUniverse=u; open=false; filterText=''; applyFilters()"
                      x-text="formatUniverseName(u)"></li>
                </template>
              </ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</header>

<!-- AÄŸ grafiÄŸi -->
<div id="network"></div>

<!-- GeliÅŸmiÅŸ Modal -->
<div x-show="modalOpen" x-transition class="fixed inset-0 modal-bg flex items-center justify-center z-50 p-4"
     @click.away="modalOpen = false" @keydown.escape.window="modalOpen=false" aria-labelledby="modalTitle" role="dialog" aria-modal="true">
  <div class="modal-content" @click.stop>
    <button class="close-btn" aria-label="Kapat" @click="modalOpen=false">âœ–</button>

    <div class="modal-header">
      <template x-if="modalNode?.image">
        <img :src="modalNode.image" alt="" class="poster" loading="lazy" />
      </template>
      <template x-if="!modalNode?.image">
        <div class="poster"></div>
      </template>

      <div class="flex flex-col gap-2">
        <h2 id="modalTitle" class="text-xl font-semibold" x-text="modalNode?.label"></h2>
        <div class="flex flex-wrap gap-2">
          <span class="chip">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l4 4-10 10H2v-4L12 2z"/><path d="M3 22h18v-2H3v2z"/></svg>
            <span x-text="formatUniverseName(modalNode?.universe)"></span>
          </span>
          <template x-if="modalNode?.type">
            <span class="chip">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c5.421 0 10-4.579 10-10S17.421 2 12 2 2 6.579 2 12s4.579 10 10 10z"/></svg>
              <span x-text="modalNode.type"></span>
            </span>
          </template>
        </div>

        <!-- Meta: tek kolon -->
        <div class="meta-grid">
          <div class="meta-item">
            <div class="section-title">Vizyon</div>
            <div x-text="modalNode?.release_date || '-'"></div>
          </div>
        </div>

        <!-- Watch later butonu -->
        <div class="mt-1">
          <button class="px-3 py-1.5 text-sm rounded-lg border border-white/20 hover:bg-white/10"
                  @click="toggleWatchLater(modalNode)">
            <span x-text="isInWatchLater(modalNode?.id) ? 'Listeden Ã§Ä±kar' : 'Daha sonra izle'"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- GÃ¶vde -->
    <div class="modal-body space-y-4">
      <!-- AÃ§Ä±klama -->
      <div>
        <div class="flex items-center gap-2 mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-red-400" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 5h16v14H4z" fill="none"/><path d="M4 5h16v14H4z"/>
          </svg>
          <span class="font-semibold">AÃ§Ä±klama</span>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-3 leading-relaxed">
          <span x-text="modalNode?.description || 'AÃ§Ä±klama yok.'"></span>
        </div>
      </div>

      <!-- GÃ¶ndermeler -->
      <template x-if="modalNode?.refers_to">
        <div>
          <div class="flex items-center gap-2 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10.59 13.41a1.99 1.99 0 002.82 0l5-5a2 2 0 10-2.82-2.82l-5 5a2 2 0 000 2.82z"/><path d="M13.41 10.59a1.99 1.99 0 000 2.82l5 5a2 2 0 102.82-2.82l-5-5a2 2 0 00-2.82 0z"/>
            </svg>
            <span class="font-semibold">GÃ¶ndermeler</span>
          </div>
          <div class="bg-white/5 border border-white/10 rounded-lg p-3 italic text-sm leading-relaxed">
            <span x-text="modalNode.refers_to"></span>
          </div>
        </div>
      </template>

      <!-- BaÄŸlantÄ±lÄ± yapÄ±mlar -->
      <div>
        <div class="section-title">BaÄŸlantÄ±lÄ± YapÄ±mlar</div>
        <div class="flex flex-wrap gap-2" x-html="neighborChips(modalNode?.id)"></div>
      </div>

      <!-- Yorumlar -->
      <div>
        <div class="section-title">Yorumlar</div>
        <div class="bg-white/5 border border-white/10 rounded-lg p-2 space-y-2">
          <template x-if="!comments[modalNode?.id] || !comments[modalNode?.id].length">
            <div class="text-sm opacity-70">HenÃ¼z yorum yok.</div>
          </template>

          <template x-for="(c, i) in (comments[modalNode?.id] || [])" :key="i">
            <div class="bg-white/5 rounded p-2 text-sm flex justify-between gap-2">
              <span x-text="c.text"></span>
              <button class="opacity-60 hover:opacity-100 text-xs"
                      @click="deleteComment(modalNode.id, i)">Sil</button>
            </div>
          </template>

          <div class="flex gap-2">
            <input x-model="newComment" placeholder="Yorum yaz..." class="border rounded px-2 py-1 w-full" />
            <button class="px-2 py-1 text-sm rounded border border-white/20 hover:bg-white/10"
                    @click="addComment(modalNode.id)">Ekle</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Watch Later (saÄŸ alt mini panel) -->
<button class="fixed right-4 bottom-4 z-40 glass rounded-full w-12 h-12 grid place-items-center hover:bg-white/10"
        title="Daha sonra" @click="watchLaterOpen = !watchLaterOpen">â˜…</button>
<div x-show="watchLaterOpen" x-transition
     class="fixed right-4 bottom-20 z-40 glass rounded-xl p-3 w-64 max-h-72 overflow-y-auto">
  <div class="font-semibold mb-2">Daha sonra</div>
  <template x-if="!watchLater.length">
    <div class="text-sm opacity-70">Liste boÅŸ.</div>
  </template>
  <template x-for="n in watchLater" :key="n.id">
    <div class="flex items-center justify-between gap-2 py-1">
      <button class="text-left hover:underline truncate" @click="__openNode(n.id)"><span x-text="n.label || n.id"></span></button>
      <button class="text-xs opacity-80 hover:opacity-100" @click="removeWatchLater(n.id)">Sil</button>
    </div>
  </template>
</div>

<!-- Legend Toggle + Legend (filtreli + Ã§izgi Ã¶rnekli) -->
<div id="legendWrap">
  <button id="legendToggle"
          class="glass px-3 py-1.5 rounded-lg text-sm hover:bg-white/10 transition"
          @click="showLegend = !showLegend">
    BaÄŸlantÄ±lar <span x-text="showLegend ? '(Gizle)' : '(GÃ¶ster)'"></span>
  </button>

  <div id="legend" x-show="showLegend" x-transition>
    <h3 class="font-bold mb-2">BaÄŸlantÄ±lar</h3>
    <ul>
      <!-- Sadece mevcut grafikte kullanÄ±lan tÃ¼rleri gÃ¶ster; ayrÄ±ca Ã§izgi tipini de gÃ¶ster -->
      <template x-for="[type, color] in legendEntries" :key="type">
        <li class="flex items-center mb-1">
          <svg width="36" height="8" class="mr-2">
            <line x1="2" y1="4" x2="34" y2="4"
                  :stroke="color"
                  stroke-width="3"
                  :stroke-dasharray="(edgeStyles[type]?.dashes ? edgeStyles[type].dashes.join(',') : '0')" />
          </svg>
          <span x-text="type"></span>
        </li>
      </template>
    </ul>
  </div>
</div>

<script>
function app() {
  return {
    /* State */
    network: null,
    allNodes: [], allEdges: [], nodes: null, edges: null,
    filteredNodes: [], filteredEdges: [],
    search: '', selectedUniverse: '',
    modalOpen: false, modalNode: null,
    universeList: [], fitTimeout: null,
    showLegend: true,

    /* Autocomplete */
    suggestions: [],
    acOpen: false,

    /* Watch later */
    watchLater: [],
    watchLaterOpen: false,

    /* Comments */
    comments: {},
    newComment: '',

    /* Dinamik arkaplan */
    bgUrl: 'images/bg.jpg',  // baÅŸlangÄ±Ã§
    bgMap: {
      "": "images/bg.jpg",
      "avatar_last_airbender": "images/avatar.jpg",
      "avatar_pandora": "images/pandora.jpg",
      "dc": "images/dc.jpg",
      "harrypotter": "images/harrypotter.jpg",
      "marvel": "images/marvel.jpg",
      "matrix": "images/matrix.jpg",
      "middleearth": "images/middleearth.jpg",
      "pixar": "images/pixar.jpg",
      "starwars": "images/starwars.jpg"
    },

    /* Renkler ve stiller */
    edgeColors: {
      "devam": "#2980b9", "Ã¶n hikaye": "#e67e22", "yan hikaye": "#8e44ad",
      "evren geÃ§iÅŸi": "#c0392b", "gÃ¶rsel gÃ¶nderme": "#7f8c8d", "karakter gÃ¶ndermesi": "#27ae60",
      "kurumsal gÃ¶nderme": "#6e4b25", "zaman Ã§izgisi baÄŸlantÄ±sÄ±": "#1abc9c", "karakter geÃ§iÅŸi": "#2ecc71",
      "tematik benzerlik": "#f1c40f", "duygu ve bilinÃ§ temasÄ±": "#9b59b6", "konseptsel devam": "#34495e",
      "ÅŸehir yaÅŸamÄ± paralelliÄŸi": "#d35400", "iÃ§ film/karakter kÃ¶keni": "#7d3c98",
      "multiverse birleÅŸmesi": "#e84393", "paralel Kang anlatÄ±mÄ±": "#16a085"
    },
    edgeStyles: {
      "devam": { width: 3, dashes: false },
      "karakter geÃ§iÅŸi": { width: 3, dashes: [10,4] },
      "evren geÃ§iÅŸi": { width: 2.5, dashes: [6,4] },
      "multiverse birleÅŸmesi": { width: 2.5, dashes: [2,6] },
      "gÃ¶rsel gÃ¶nderme": { width: 1.8, dashes: [2,6] },
      "karakter gÃ¶ndermesi": { width: 2, dashes: [6,6] },
      "Ã¶n hikaye": { width: 2.2, dashes: false },
      "yan hikaye": { width: 2, dashes: [8,6] },
      "tematik benzerlik": { width: 1.8, dashes: [12,6] },
      "zaman Ã§izgisi baÄŸlantÄ±sÄ±": { width: 1.8, dashes: [4,4] },
      "kurumsal gÃ¶nderme": { width: 1.8, dashes: [2,8] },
      "konseptsel devam": { width: 2, dashes: false },
      "ÅŸehir yaÅŸamÄ± paralelliÄŸi": { width: 1.8, dashes: [10,8] },
      "iÃ§ film/karakter kÃ¶keni": { width: 2, dashes: [5,5] },
      "paralel Kang anlatÄ±mÄ±": { width: 2.5, dashes: [3,7] }
    },

    /* Legend iÃ§in hesaplanmÄ±ÅŸ liste */
    get legendEntries() {
      const usedTypes = new Set(this.filteredEdges.map(e => e.type));
      const pairs = Object.entries(this.edgeColors)
        .filter(([t]) => usedTypes.has(t) || !this.selectedUniverse);
      return pairs;
    },

    /* ---------- INIT ---------- */
    init() {
      // Legend: mobilde varsayÄ±lan kapalÄ±
      this.showLegend = window.innerWidth >= 640;

      // Local verileri yÃ¼kle
      this.loadWatchLater();
      this.loadComments();

      // Arkaplan ilk yÃ¼kleme + preload
      this.setBackgroundFor(this.selectedUniverse);
      this.warmBackgrounds();

      // Veri
      this.loadData();

      // Arama debounce + autocomplete
      let debounceTimeout = null;
      this.$watch('search', (val) => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          this.applyFilters();
          // Autocomplete Ã¶nerileri
          if (val) {
            const lower = val.toLowerCase();
            // baÅŸta eÅŸleÅŸenleri Ã¶ne al
            const starts = [];
            const contains = [];
            const seen = new Set();
            for (const n of this.allNodes) {
              const lbl = n.label;
              if (!lbl) continue;
              const l = lbl.toLowerCase();
              if (l.startsWith(lower)) {
                if (!seen.has(lbl)) { starts.push(lbl); seen.add(lbl); }
              } else if (l.includes(lower)) {
                if (!seen.has(lbl)) { contains.push(lbl); seen.add(lbl); }
              }
              if (starts.length + contains.length >= 10) break;
            }
            this.suggestions = [...starts, ...contains];
          } else {
            this.suggestions = [];
          }
        }, 220);
      });

      // Evren deÄŸiÅŸince filtre + arkaplan
      this.$watch('selectedUniverse', (val) => {
        this.applyFilters();
        this.setBackgroundFor(val);
      });
    },

    /* ---------- BACKGROUND HELPERS ---------- */
    async setBackgroundFor(universe){
      const primary = this.bgMap[universe || ""] || this.bgMap[""];
      const fallbacks = ["images/bg.jpg", "images/bg.jpg"];
      const tried = new Set();

      const tryLoad = (url) => new Promise((resolve,reject)=>{
        if(!url || tried.has(url)) return reject();
        tried.add(url);
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => reject();
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        img.src = url;
      });

      const candidates = [primary, ...fallbacks];
      for (const url of candidates){
        try {
          const ok = await tryLoad(url);
          this.bgUrl = ok;
          return;
        } catch {}
      }
    },
    warmBackgrounds(){
      const urls = [...new Set(Object.values(this.bgMap))];
      urls.forEach(u => { const i = new Image(); i.decoding='async'; i.src = u; });
    },

    /* ---------- WATCH LATER ---------- */
    loadWatchLater() {
      try { this.watchLater = JSON.parse(localStorage.getItem('watchLater') || '[]'); } catch { this.watchLater = []; }
    },
    saveWatchLater() {
      localStorage.setItem('watchLater', JSON.stringify(this.watchLater));
    },
    isInWatchLater(id) {
      return !!this.watchLater.find(x => x.id === id);
    },
    toggleWatchLater(node) {
      if (!node?.id) return;
      if (this.isInWatchLater(node.id)) {
        this.watchLater = this.watchLater.filter(x => x.id !== node.id);
      } else {
        this.watchLater.unshift({ id: node.id, label: node.label || String(node.id) });
      }
      this.saveWatchLater();
    },
    removeWatchLater(id) {
      this.watchLater = this.watchLater.filter(x => x.id !== id);
      this.saveWatchLater();
    },

    /* ---------- COMMENTS ---------- */
    loadComments() {
      try { this.comments = JSON.parse(localStorage.getItem('comments') || '{}'); } catch { this.comments = {}; }
    },
    saveComments() {
      localStorage.setItem('comments', JSON.stringify(this.comments));
    },
    addComment(nodeId) {
      const t = (this.newComment || '').trim();
      if (!nodeId || !t) return;
      if (!this.comments[nodeId]) this.comments[nodeId] = [];
      this.comments[nodeId].unshift({ text: t, ts: Date.now() });
      this.newComment = '';
      this.saveComments();
    },
    deleteComment(nodeId, idx) {
      if (!this.comments[nodeId]) return;
      this.comments[nodeId].splice(idx, 1);
      this.saveComments();
    },

    /* ---------- DATA & GRAPH ---------- */
    async loadData() {
      const evrenler = ["avatar_last_airbender","avatar_pandora","dc","harrypotter","marvel","matrix","middleearth","pixar","starwars"];
      try {
        const results = await Promise.all(evrenler.map(evren =>
          fetch('data/' + evren + '.json', { cache: 'no-store' }).then(r => {
            if (!r.ok) throw new Error(evren + ' yÃ¼klenemedi');
            return r.json().then(data => ({ evren, data }));
          })
        ));
        let nodesTemp = [], edgesTemp = [];
        for (const { evren, data } of results) {
          nodesTemp = nodesTemp.concat(data.nodes.map(n => ({ ...n, universe: evren })));
          edgesTemp = edgesTemp.concat(data.edges);
        }
        this.allNodes = nodesTemp;
        this.allEdges = edgesTemp;
        this.universeList = [...new Set(this.allNodes.map(n => n.universe))];

        // Posterleri Ä±sÄ±t (cache)
        const posterUrls = this.allNodes.filter(n => n.image).map(n => n.image);
        posterUrls.forEach(u => { const i = new Image(); i.decoding='async'; i.src = u; });

        this.setupNetwork();
        this.applyFilters();
      } catch (err) {
        console.error(err);
        alert('Veri yÃ¼kleme hatasÄ±: ' + err.message);
      }
    },

    makeOptions() {
      return {
        nodes: {
          size: 25,
          font: { color: '#e5e7eb', size: 14 },
          borderWidthSelected: 6,
          color: { border: '#ef4444' }
        },
        edges: {
          arrows: { to: { enabled: true, scaleFactor: 0.5 } },
          smooth: { enabled: true, type: 'dynamic' }
        },
        interaction: { hover: true, tooltipDelay: 200, zoomView: true, dragView: true },
        physics: { stabilization: true, barnesHut: { gravitationalConstant: -4000 } },
        layout: { improvedLayout: true }
      };
    },

    setupNetwork() {
      this.nodes = new vis.DataSet();
      this.edges = new vis.DataSet();
      const container = document.getElementById('network');
      this.network = new vis.Network(container, { nodes: this.nodes, edges: this.edges }, this.makeOptions());

      this.network.on('click', params => {
        if (params.nodes.length > 0) {
          const node = this.nodes.get(params.nodes[0]);
          this.modalNode = node; this.modalOpen = true;
        }
      });
    },

    applyFilters() {
      const searchTerm = (this.search || '').toLowerCase();
      const universe = this.selectedUniverse;

      this.filteredNodes = this.allNodes.filter(n =>
        (!universe || n.universe === universe) &&
        (!searchTerm || (n.label && n.label.toLowerCase().includes(searchTerm)))
      );

      const nodeIds = new Set(this.filteredNodes.map(n => n.id));
      this.filteredEdges = this.allEdges.filter(e => nodeIds.has(e.from) && nodeIds.has(e.to));

      this.updateNetwork();
      if (this.network) {
        if (this.fitTimeout) clearTimeout(this.fitTimeout);
        this.fitTimeout = setTimeout(() => this.network.fit({ animation: true }), 220);
      }
    },

    updateNetwork() {
      this.nodes.clear();
      this.edges.clear();

      // Nodeâ€™lar
      this.nodes.add(this.filteredNodes.map(n => {
        const hasImage = !!n.image;
        return {
          ...n,
          shape: hasImage ? 'circularImage' : 'dot',
          borderWidth: 2, borderWidthSelected: 6,
          color: hasImage ? { border: '#ef4444' } : { background: '#ef4444', border: '#ef4444' }
        };
      }));

      // Edgeâ€™ler (renk + Ã§izgi stili)
      this.edges.add(this.filteredEdges.map(e => {
        const color = this.edgeColors[e.type] || '#9ca3af';
        const s = this.edgeStyles[e.type] || { width: 1.5, dashes: false };
        return { ...e, arrows: 'to', color: { color }, width: s.width, dashes: s.dashes };
      }));
    },

    neighborChips(nodeId) {
      if (!nodeId || !this.network) return '';
      const neighbors = this.network.getConnectedNodes(nodeId)
        .map(id => this.nodes.get(id))
        .filter(Boolean);
      if (!neighbors.length) return '<span class="text-sm opacity-70">BaÄŸlantÄ± bulunamadÄ±.</span>';

      return neighbors.map(n => `
        <button class="chip hover:brightness-110" onclick="window.__openNode('${String(n.id).replace(/'/g,'&#39;')}')">
          ${n.label ? n.label.replace(/</g,'&lt;') : 'ID ' + n.id}
        </button>
      `).join('');
    },

    formatUniverseName(name) {
      const map = {
        "avatar_last_airbender": "Avatar: Son Hava BÃ¼kÃ¼cÃ¼",
        "avatar_pandora": "Avatar (Pandora)",
        "dc": "DC",
        "marvel": "Marvel",
        "harrypotter": "Harry Potter",
        "matrix": "Matrix",
        "middleearth": "Orta DÃ¼nya",
        "pixar": "Pixar",
        "starwars": "Star Wars"
      };
      return map[name] || name;
    }
  }
}

/* Modal iÃ§inden komÅŸu dÃ¼ÄŸÃ¼me atlamak iÃ§in global yardÄ±mcÄ± */
window.__openNode = function(id) {
  const scope = document.querySelector('html')?.__x.$data;
  if (!scope?.nodes) return;
  const node = scope.nodes.get(id);
  if (node) {
    scope.modalNode = node;
    scope.modalOpen = true;
    scope.network.selectNodes([id]);
    scope.network.focus(id, { animation: true, scale: 1 });
  }
};
</script>

<!-- Service Worker kaydÄ± -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered', reg.scope))
      .catch(err => console.warn('SW register failed', err));
  });
}
</script>

</body>
</html>
