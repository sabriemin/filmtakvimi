<!DOCTYPE html>

<html lang="tr" x-data="app()" x-init="init()">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>🎬 Film Evreni Ağı</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.4.1/dist/js/shepherd.min.js"></script>
<<script src="data/shepherd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>
<style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; color: #d1d5db; font-family: 'Segoe UI', system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial, sans-serif; background: transparent; }
    #bgImg{ position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(12px) brightness(0.65); transform: scale(1.06); z-index: -2; backface-visibility: hidden; will-change: transform; }
    #bgOverlay{ position: fixed; inset: 0; z-index:-1; background: rgba(0,0,0,0.35); }
    #network { position: fixed; inset: 0; background: transparent; border: none; }
    .glass { background: rgba(31,41,55,0.45); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 12px 30px rgba(0,0,0,0.35); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); }
    input { color: #e5e7eb; background-color: rgba(55,65,81,0.55); border: 1px solid rgba(255,255,255,0.12); outline: none; }
    input::placeholder { color: #9ca3af; }
    .ac-panel { background: rgba(31,41,55,0.9); border: 1px solid rgba(255,255,255,0.14); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 14px 28px rgba(0,0,0,0.5); }
    .ac-item { cursor: pointer; }
    .ac-item:hover { background: rgba(255,255,255,0.08); }
    .dropdown-btn { cursor: pointer; }
    .dropdown-panel { background: rgba(31,41,55,0.65); border: 1px solid rgba(255,255,255,0.14); box-shadow: 0 16px 40px rgba(0,0,0,0.45); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
    .dropdown-item { cursor: pointer; }
    .dropdown-item:hover { background: rgba(255,255,255,0.06); }
    .modal-bg { background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); }
    .modal-content { width: 92vw; max-width: 780px; max-height: 85vh; overflow-y: auto; background: #0f172a; color: #e5e7eb; border-radius: 18px; padding: 0; box-shadow: 0 12px 24px rgba(0,0,0,0.45); position: relative; border: 1px solid rgba(255,255,255,0.08); }
    .modal-header { display: grid; grid-template-columns: 120px 1fr; gap: 16px; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.06); background: radial-gradient(1200px 400px at -20% -40%, rgba(239,68,68,0.08), transparent); }
    .poster { width: 120px; height: 160px; border-radius: 10px; object-fit: cover; background: #111827; border: 1px solid rgba(255,255,255,0.08); }
    .modal-body { padding: 16px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); padding: 4px 10px; border-radius: 999px; font-size: 12px; }
    .meta-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
    .meta-item { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); padding: 10px 12px; border-radius: 12px; }
    .section-title { font-size: 0.9rem; opacity: 0.85; margin-bottom: 6px; }
    .close-btn { position: absolute; top: 12px; right: 12px; width: 36px; height: 36px; border-radius: 999px; display: grid; place-items: center; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
    .close-btn:hover { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.5); }
    #legendWrap { position: fixed; left: 16px; bottom: 16px; z-index: 40; }
    #legendToggle { margin-bottom: 8px; background: rgba(31,41,55,0.55); border: 1px solid rgba(255,255,255,0.14); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); }
    #legend { background: rgba(31,41,55,0.45); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 8px 18px rgba(0,0,0,0.35); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: 12px; padding: 12px 16px; max-width: 320px; max-height: 260px; overflow-y: auto; font-size: 0.85rem; }
    @media (max-width: 640px) { #legend { font-size: 0.72rem; max-width: 220px; padding: 8px 10px; } }
    .share-bar { position: absolute; top: 8px; left: 12px; right: 56px; display:flex; align-items:center; gap:8px; opacity:.95; }
    .share-btn { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.14); font-size:12px; }
    .share-btn:hover { background: rgba(255,255,255,0.1); }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  </style>

<style>
  #network {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    border: none;
    z-index: 0;
  }
</style>

<style>
  @media (max-width: 640px) {
    .modal-content {
      max-height: 70vh;
      overflow-y: auto;
      scroll-padding-bottom: 8rem; /* klavye için alt boşluk */
    }
  }
</style>


<!-- Shepherd.js CSS ve JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.4.1/dist/js/shepherd.min.js"></script>


<style>
  

  

  

  

  

  .shepherd-cancel-icon {
    color: #fff !important;
  }
</style>


<style>
  

  

  

  

  

  .shepherd-cancel-icon {
    color: #fff !important;
  }
</style>


<style>
.shepherd-element {
  max-width: 85vw;
  min-width: auto;
  max-height: 20vh;
  height: auto;
  overflow-y: auto;
  padding: 0.5rem;
  font-size: 0.2rem;
  backdrop-filter: blur(12px);
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  color: white;
}

@media (min-width: 640px) {
  .shepherd-element {
    max-width: 260px;
  }
}

  .shepherd-text,
  .shepherd-title,
  .shepherd-button {
    color: white !important;
  }

  .shepherd-header {
    background: transparent !important;
    border-bottom: none !important;
  }

  .shepherd-button {
    background-color: #2564eb73;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.7rem;
    border: none;
    margin-left: 0.2rem;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }

  .shepherd-button:hover {
    background-color: #1d4ed8;
  }

  .shepherd-cancel-icon {
    color: white !important;
  }
</style>

</head>



<body :class="{ 'overflow-hidden': modalOpen }" class="dark">
<img :src="bgUrl" alt="" id="bgImg"/>
<div id="bgOverlay"></div>
<style>
  @media (max-width: 639px) {
    .mobile-centered {
      max-height: 70vh;
      overflow-y: auto;
      position: relative;
      top: 42%;
      transform: translateY(-50%);
    }
  }
</style>

<!-- Hoş Geldin Bilgilendirmesi -->
<div x-show="!selectedUniverse"
     class="fixed inset-0 flex items-center justify-center z-50">
  <div style="max-height: 70vh; overflow-y: auto; " class="mobile-centered bg-black/85 text-white border border-white/10 rounded-2xl shadow-2xl p-6 text-sm w-[90%] max-w-2xl backdrop-blur-md space-y-4">
    <h2 class="text-2xl font-bold text-center">🎬 Film Evreni Ağı'na Hoş Geldin!</h2>
    <p class="text-base text-center text-white/80">Bu platform, farklı sinematik evrenler arasında bağ kurmanı ve yapımları daha derinlemesine keşfetmeni sağlar.</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm mt-2">
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">🗺️ Etkileşimli Harita</h3>
        <p>Seçtiğin evrene ait yapımlar arasındaki bağlantıları grafik olarak görebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">🎞️ Yapım Detayları</h3>
        <p>Her film veya diziye tıklayarak özet, oyuncular, göndermeler ve notları görüntüleyebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">📝 Kendi Notlarını Ekle</h3>
        <p>Yapımlara kişisel notlar ekleyebilir, düzenleyebilir veya silebilirsin.</p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 border border-white/10">
        <h3 class="font-semibold mb-2">⭐ Favorilerine Ekle</h3>
        <p>İzlemek istediğin veya beğendiğin yapımları favori listene ekleyebilirsin.</p>
      </div>
    </div>
    <p class="text-center text-white/60 text-sm pt-2">Başlamak için yukarıdan bir <strong>film evreni</strong> seç 🌌</p>
<div class="text-center">
  <button @click="startTour()" class="mt-4 px-5 py-2 bg-white/10 border border-white/20 text-white text-sm rounded-lg hover:bg-white/20 transition">
    🚀 Rehbere Başla
  </button>
</div>

  </div>
</div>

<header class="fixed top-4 left-0 right-0 z-50">
<div class="w-full sm:max-w-md lg:max-w-lg mx-auto px-3">
<div class="glass rounded-xl px-3 py-2">
  <div class="flex flex-col gap-2">
    <div class="flex items-center justify-center">
      <h1 class="text-base sm:text-lg font-bold text-center">🎬 Film Evreni Ağı</h1>
    </div>

    <!-- Mobilde arama ve anasayfa yanyana, dropdown altta olacak sekilde yeniden yapılandırıldı -->
    <div class="flex flex-col sm:flex-row gap-2">

      <div class="flex flex-row items-center gap-2 w-full">
        <!-- Anasayfa Butonu -->
        <a href="/evren" title="Anasayfa" class="text-white border border-white/30 hover:bg-white/10 rounded-md p-2 transition w-9 h-9 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 10v10h6v-6h4v6h6V10L12 3z" />
          </svg>
        </a>

        <!-- Arama Kutusu -->
        <div class="relative w-full">
          <input @blur="setTimeout(() => acOpen = false, 120)" @focus="acOpen = true" class="border rounded-lg px-3 py-1.5 w-full pr-8" placeholder="Ara..." type="search" x-model="search">
          <button @click="search=''; suggestions=[]; applyFilters()" @mousedown.prevent="" aria-label="Temizle" class="absolute inset-y-0 right-2 my-auto h-6 w-6 rounded-full grid place-items-center opacity-80 hover:opacity-100 hover:bg-white/10" x-show="search" style="display: none;">
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4Z"></path></svg>
          </button>
          <div class="ac-panel absolute z-50 w-full mt-1 rounded-lg overflow-hidden max-h-56 overflow-y-auto" x-show="acOpen &amp;&amp; search &amp;&amp; suggestions.length" style="display: none;">
            <template :key="s" x-for="(s, idx) in suggestions">
              <div @click="search = s; acOpen=false; applyFilters();" @mousedown.prevent="" class="ac-item px-3 py-1.5"><span x-text="s"></span></div>
            </template>
          </div>
        </div>
      </div>

      <!-- Dropdown Evren Seçimi -->
      <div @click.outside="open=false" @keydown.escape="open=false" class="relative w-full sm:w-[200px]" x-data="{ open:false, filterText:'' }">
        <div :aria-expanded="open" @click="open=!open" class="dropdown-btn border rounded-lg px-3 py-1.5 w-full flex items-center justify-between select-none" aria-expanded="false">
          <span id="#universe_select" class="truncate" x-text="selectedUniverse ? formatUniverseName(selectedUniverse) : 'Tüm Evrenler'">Tüm Evrenler</span>
          <svg class="h-4 w-4 opacity-80 ml-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" fill-rule="evenodd"></path></svg>
        </div>
        <div class="dropdown-panel absolute mt-2 left-0 right-0 rounded-xl overflow-hidden" style="z-index: 60; display: none;" x-show="open" x-transition="">
          <div class="p-2 border-b border-white/10">
            <input class="w-full px-3 py-2 rounded-lg border" placeholder="Evren ara..." x-model="filterText">
          </div>
          <ul class="max-h-64 overflow-y-auto">
            <template :key="u" x-for="u in universeList.filter(u => !filterText || formatUniverseName(u).toLowerCase().includes(filterText.toLowerCase()))">
              <li @click="selectedUniverse=u; open=false; filterText=''; applyFilters()" class="dropdown-item px-3 py-2" x-text="formatUniverseName(u)"></li>
            </template>
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>
</div>
</header>
<div id="network" x-show="selectedUniverse" x-transition x-show="showGraph" x-transition></div>

<div @click.outside="if (!window.Shepherd?.activeTour) modalOpen = false" @keydown.escape.window="modalOpen=false" aria-labelledby="modalTitle" aria-modal="true" class="fixed inset-0 modal-bg flex items-center justify-center z-50 p-4" role="dialog" id="modal_container" x-show="modalOpen" x-transition="">
<div @click.stop="" class="modal-content" style="overflow-y: visible;">
<div class="relative rounded-xl overflow-hidden backdrop-blur-md bg-black/50 text-white max-h-[90vh] overflow-y-visible">
<!-- Üst blur görsel alanı -->
<div class="relative h-64">
<img :src="modalNode.image" alt="" class="absolute inset-0 w-full h-full object-cover blur-xl brightness-50 scale-105"/>
<div class="absolute inset-0 flex flex-col justify-between p-4 z-10"><div class="absolute top-3 left-3 flex gap-2 items-center"><div class="flex gap-2 items-center">
<button @click="shareToX(modalNode)" class="text-white hover:opacity-80" title="X paylaş">
<img alt="X" src="https://img.icons8.com/ios-filled/20/ffffff/twitterx.png"/>
</button>
<button @click="shareToWhatsApp(modalNode)" class="text-white hover:opacity-80" title="WhatsApp">
<img alt="WA" src="https://img.icons8.com/ios-filled/20/ffffff/whatsapp.png"/>
</button>
<button @click="shareToLinkedIn(modalNode)" class="text-white hover:opacity-80" title="LinkedIn">
<img alt="IN" src="https://img.icons8.com/ios-filled/20/ffffff/linkedin.png"/>
</button>
<button @click="copyShare(modalNode)" class="text-white hover:opacity-80" title="Kopyala">📋</button>
</div></div><div class="absolute top-3 right-3 flex gap-2 items-center z-20"><div @click="modalOpen = false" class="close-btn" id="modal-close">✕</div></div>
<!-- Üst çubuk -->
<div class="flex justify-between items-start"><div class="absolute top-3 right-3 flex gap-2 items-center z-20"></div></div>
<!-- Alt bilgi -->
<div class="flex justify-between mt-4">
<div class="text-xs bg-black/40 px-3 py-1 rounded-full">
<div class="font-semibold text-white/70 text-[10px]">Vizyon Tarihi</div>
<span x-text="toTRDate(modalNode.release_date)">-</span>
</div>
<div class="text-xs flex gap-2 items-center bg-black/40 px-3 py-1 rounded-full">
<span x-text="modalNode.type || '-'"></span>
<span class="text-white/80">|</span>
<span x-text="'IMDB: ' + (modalNode.imdb_rating || '-')">IMDB</span>
</div>
</div>
</div>
<template x-if="showPosterDialog">
<div @click.self="showPosterDialog = false" class="fixed inset-0 z-\[9999\] z-\[999\] z-50 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center">
<div class="p-4 rounded-xl shadow-2xl max-w-[90vw] max-h-[85vh]" style="z-index:10000;" style="z-index:1000;" style="z-index:60;">
<button @click="showPosterDialog = false" class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/10 border border-white/20 text-white text-sm">✕</button>
<img :src="modalNode.image" class="max-w-[75vw] max-h-[70vh] rounded-xl shadow-lg object-cover"/>
</div>
</div>
</template>
<!-- Poster -->
<div class="absolute left-1/2 top-full -translate-x-1/2 -translate-y-1/2 z-20"><div @click="showPosterDialog = true" class="cursor-pointer">
<div @click="showPosterDialog = true" class="cursor-pointer">
<div @click="showPosterDialog = true" class="cursor-pointer"><img :src="modalNode.image" alt=""
class="w-32 h-32 rounded-full object-cover drop-shadow-[0_0_20px_rgba(168,85,247,0.5)] ring-2 ring-purple-400/30"/></div></div>
</div>
</div>
</div>
<!-- İçerik alanı -->
<div class="p-6 pt-20 space-y-6 overflow-hidden">
<h2 class="text-2xl font-bold text-center" x-text="modalNode.label">
</h2>
<div class="flex justify-center mt-2">
<button :class="isInWatchLater(modalNode?.id) ? 'bg-green-500 border-green-500 text-white' : 'bg-white/10 border-white/20 text-white hover:bg-white/20'" @click="toggleWatchLater(modalNode)" class="px-4 py-2 rounded border text-sm transition" x-text="isInWatchLater(modalNode?.id) ? '✔ Favorilere Eklendi' : 'Favorilere Ekle'">
</button>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
<div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-1"><div><strong>Tür:</strong> <span x-text="modalNode.tür || '-'"></span></div>
<div><strong>Yönetmen:</strong> <span x-text="modalNode.yönetmen || '-'"></span></div>
<div><strong>Oyuncular:</strong> <span x-text="modalNode.oyuncular || '-'"></span></div>
</div>
<div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-1">
<div><strong>Evren:</strong> <span x-text="formatUniverseName(modalNode.universe)"></span></div>
<template x-if="modalNode.sources?.length">
<div><strong>Kaynaklar:</strong>
<ul class="list-disc list-inside">
<template :key="src.url" x-for="src in modalNode.sources">
<li><a :href="src.url" class="underline" target="_blank" x-text="src.name"></a></li>
</template>
</ul>
</div>
</template>
</div>
</div>
<!-- Özet -->
<div>
<h3 @click="summaryOpen = !summaryOpen" id="content-summary" class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">İçerik Özeti
<svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="!summaryOpen"></path>
<path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="summaryOpen"></path>
</svg>
</h3>
<div class="bg-white/5 p-4 rounded-lg border border-white/10" x-show="summaryOpen" x-text="modalNode.description || '-'"></div>
</div>
<!-- Göndermeler -->
<template x-if="modalNode.refers_to">
<div>
<h3 @click="refersOpen = !refersOpen" id="göndermeler" class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">Göndermeler
<svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="!refersOpen"></path>
<path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="refersOpen"></path>
</svg>
</h3><div class="text-sm text-red-400 italic mb-2" x-show="refersOpen">⚠ Bu alan spoiler içerebilir.</div>
<div class="bg-white/5 p-4 rounded-lg border border-white/10 italic text-sm" x-show="refersOpen" x-text="modalNode.refers_to"></div>
</div>
</template>
<!-- Bağlantılı Yapımlar -->


<h3 @click="linkedOpen = !linkedOpen" id="related-works" class="text-lg font-semibold mb-2 cursor-pointer flex justify-between items-center border-b border-white/10 pb-1 mb-4">Bağlantılı Yapımlar
<svg class="w-4 h-4 inline-block ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="!linkedOpen"></path>
<path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x-show="linkedOpen"></path>
</svg>
</h3>
<div x-show="linkedOpen" class="bg-white/5 p-4 rounded-lg border border-white/10">

<template x-if="edgeList.length">
<div class="flex flex-wrap gap-2" x-show="linkedOpen">
<template :key="e.otherNodeId" x-for="e in edgeList">
<div :class="{
           'bg-blue-900/40 border-blue-500/30': e.type === 'Devam',
           'bg-yellow-900/30 border-yellow-400/20': e.type === 'Öncesi',
           'bg-purple-900/30 border-purple-500/20': e.type === 'yan hikaye',
           'bg-green-900/30 border-green-500/20': e.type === 'karakter göndermesi',
           'bg-red-900/30 border-red-400/20': e.type === 'Aynı Evren',
           'bg-white/10 border-white/20': !e.type
         }" @click="__openNode(e.otherNodeId)" class="rounded-xl p-3 text-sm cursor-pointer transition relative border space-y-1">
<div class="font-semibold" x-text="nodes.get(e.otherNodeId)?.label || e.otherNodeId">
</div>
<div class="text-xs text-white/70 italic" x-text="e.type"></div>
<template x-if="e.notes">
<div class="border-l-4 border-blue-500 pl-2 ml-1 text-[12px] text-white/80 italic mt-1">
<span class="text-blue-300">Not:</span>
<span x-text="e.notes"></span>
</div>
</template>
</div>
</template>
</div>
</template>
<template x-if="!edgeList.length">
<p class="text-sm opacity-70">Bağlantı bulunamadı.</p>
</template>
</div>
<!-- Notlar -->
<div class="bg-white/5 p-4 rounded-lg border border-white/10">
<h3 class="text-lg font-semibold mb-2">Notlar</h3>
<template x-if="!notes[modalNode.id] || !notes[modalNode.id].length">
<p class="text-sm opacity-70">Henüz not eklenmemiş.</p>
</template>

<template :key="i" x-for="(c, i) in (notes[modalNode.id] || [])">
  <div class="bg-white/10 p-2 rounded mb-2">
    <div class="text-xs opacity-70 mb-1">
      <span x-text="new Date(c.ts).toLocaleDateString()"></span>
    </div>
    <template x-if="editingNoteIndex === i">
      <div class="flex flex-col gap-2">
        <textarea x-model="editedNoteText" class="w-full p-2 rounded bg-black/20 text-sm text-white border border-white/20"></textarea>
        <div class="flex justify-end gap-2 text-xs">
          <button @click="saveEditedNote(modalNode.id, i)" class="px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white">Kaydet</button>
          <button @click="cancelEditNote()" class="px-2 py-1 rounded bg-white/20 text-white">Vazgeç</button>
        </div>
      </div>
    </template>
    <template x-if="editingNoteIndex !== i">
      <div>
        <div class="whitespace-pre-wrap text-sm" x-text="c.text"></div>
        <div class="flex justify-end gap-2 mt-1 text-xs opacity-80">
          <button @click="startEditNote(i, c.text)">✏️</button>
          <button @click="deleteNote(modalNode.id, i)">🗑️</button>
        </div>
      </div>
    </template>
  </div>
</template>

<div class="flex gap-2 mt-2">
<input class="w-full px-3 py-2 rounded bg-white/10 text-white" placeholder="Not ekle... #etiket" x-model="newNote"/>
<button @click="addNote(modalNode.id)" class="px-3 py-2 text-sm border border-white/20 rounded hover:bg-white/20">Ekle</button>
</div>
</div>
</div>
</div>
</div>
</div>

<div x-show="selectedUniverse">
</div>


</div>


<script>
    function app() {
      return {
    startTour() {
      const dropdown = document.querySelector('.dropdown-btn');
      dropdown?.classList.add('pointer-events-none', 'opacity-50');
      dropdown?.setAttribute('disabled', 'true');
      // Shepherd rehberi: Baştan sona adımlar

const tour = new Shepherd.Tour({
  defaultStepOptions: {
    scrollTo: true,
    cancelIcon: { enabled: true }
  }
});

// 1. Hoş Geldin
tour.addStep({
  title: 'Hoş Geldin 🎬',
  text: 'Film Evreni Ağı’na hoş geldin!',
  buttons: [{ text: 'İleri', action: tour.next }]
});

// 2. Evren Seç
tour.addStep({
  title: 'Evren Seç 🌌',
  text: 'Buradan bir evren seçebilirsin.',
  attachTo: { element: '.dropdown-btn', on: 'bottom' },
  buttons: [{
    text: 'Devam',
    action: function () {
      const dropdown = document.querySelector('.dropdown-btn');
      dropdown?.classList.remove('pointer-events-none', 'opacity-50');
      dropdown?.removeAttribute('disabled');
      tour.next();
    }
  }]
});

// 3. Şimdi Evren Seç
const isMobile = window.innerWidth < 640;

tour.addStep({
  title: '🌌 Evren Seç',
  text: 'Lütfen bir evren seç.',
  attachTo: {
    element: '.dropdown-btn',
    on: isMobile ? 'top' : 'left'
  },
  scrollTo: true,
  buttons: [],
  when: {
    show() {
      const geçerliMi = (val) => val && val !== '' && val !== 'all';

      const kontrolEt = () => {
        try {
          const selected = Alpine.store('selectedUniverse') || Alpine.raw(Alpine.$data(document.querySelector('[x-data]'))).selectedUniverse;

          if (geçerliMi(selected)) {
            clearInterval(interval);
            tour.next();
          }
        } catch (e) {
          // Alpine hazır değilse sessizce bekle
        }
      };

      kontrolEt();
      const interval = setInterval(kontrolEt, 400);
    }
  }
});





// 4. Arama
tour.addStep({
  title: 'Film Ara 🔍',
  text: 'Film veya dizi aramak için burayı kullan.',
  attachTo: { element: 'input[type=search]', on: 'bottom' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 5. Yapım Grafiği
tour.addStep({
  title: 'Yapım Grafiği 📊',
  text: 'Seçilen evrene ait yapımlar bu ağ grafiğinde gösterilir. <br><br> Bir yapıma tıklayarak yapım bilgi panelini aç.',
  attachTo: { element: '#network', on: 'top' },
  scrollTo: false,
  buttons: [], // Buton göstermiyoruz
  when: {
    show() {
      const checkModalOpen = () => {
        const modal = document.querySelector('.modal-content');
        const h2 = modal?.querySelector('h2');
        const isVisible = modal && getComputedStyle(modal).display !== 'none';
        const hasTitle = h2 && h2.textContent.trim().length > 0;
        return isVisible && hasTitle;
      };

      if (checkModalOpen()) {
        tour.next(); // Zaten açık ve içerik varsa direkt geç
        return;
      }

      // Aralıkla kontrol et
      const interval = setInterval(() => {
        if (checkModalOpen()) {
          clearInterval(interval);
          tour.next();
        }
      }, 400);
    }
  }
});



// 8. Paylaşım
tour.addStep({
  title: 'Paylaşım 🚀',
  text: 'Bu butonla yapım bağlantısını kopyalayabilir veya sosyal medyada paylaşabilirsin.',
  attachTo: { element: 'button[title="Kopyala"]', on: 'bottom' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 9. Vizyon Tarihi
tour.addStep({
  title: '🎬 Vizyon Tarihi',
  text: 'Burada yapımın vizyon tarihini görebilirsin.',
  attachTo: { element: '.modal-content [x-text*=toTRDate]', on: 'bottom' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 10. Tür ve IMDB
tour.addStep({
  title: '⭐ Tür ve IMDB',
  text: 'Yapımın türü ve IMDB puanı burada.',
  attachTo: { element: '.modal-content .text-xs.flex', on: 'bottom' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 6. Favorilere Ekle
tour.addStep({
  title: 'Favorilere Ekle ⭐',
  text: 'Bir yapımı favorilerine eklemek için bu butonu kullan.',
  attachTo: { element: '[x-text*=Favorilere]', on: 'bottom' },
  buttons: [{
    text: 'Devam',
    action: function () {
      const btn = document.querySelector('[x-text*=Favorilere]');
      if (btn && btn.textContent.includes('✔ Favorilere Eklendi')) {
        return tour.next();
      } else {
        alert('Lütfen önce favorilere ekle.');
      }
    }
  }]
});

// 11. Tür / Yönetmen / Oyuncular
tour.addStep({
  title: '🎭 Tür, Yönetmen, Oyuncular',
  text: 'Bu bölümde temel bilgiler yer alır.',
  attachTo: { element: '.modal-content .grid > div:nth-child(1)', on: 'bottom' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 12. Evren ve Kaynaklar
tour.addStep({
  title: '🌌 Evren ve Kaynaklar',
  text: 'Yapımın ait olduğu evreni ve kaynakları burada görebilirsin.',
  attachTo: { element: '.modal-content .grid > div:nth-child(2)', on: 'bottom' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 13. İçerik Özeti
tour.addStep({
  title: "📝 İçerik Özeti",
  text: "Burada filmin kısa özeti yer alır.",
  attachTo: {
    element: "#content-summary",
    on: "bottom"
  },
  scrollTo: true,
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 14. Göndermeler
tour.addStep({
  title: "🎯 Göndermeler",
  text: "Filmde yapılan diğer yapımlara göndermeleri burada görebilirsiniz.",
  attachTo: {
    element: "#göndermeler",
    on: "bottom"
  },
  scrollTo: true,
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 15. Bağlantılı Yapımlar
tour.addStep({
  title: "🔗 Bağlantılı Yapımlar",
  text: "İlgili evrende geçen diğer yapımlar bu bölümde gösterilir.",
  attachTo: {
    element: "#related-works",
    on: "bottom"
  },
  scrollTo: true,
  buttons: [{ text: 'Devam', action: tour.next }]
});


// 7. Not Ekle
tour.addStep({
  title: 'Not Ekle 📝',
  text: 'Buraya kişisel notlarını yazabilir, #etiket ekleyebilirsin.',
  attachTo: { element: 'input[placeholder="Not ekle... #etiket"]', on: 'bottom' },
  
  buttons: [{
    text: 'Devam',
    action: function () {
      try {
        const items = Array.from(document.querySelectorAll('.modal-content div'));
        const validNotes = items.filter(el =>
          el.classList.contains('bg-white/10') &&
          el.classList.contains('p-2') &&
          el.classList.contains('rounded') &&
          el.classList.contains('mb-2')
        );
        if (validNotes.length > 0) {
          return tour.next();
        } else {
          alert('Lütfen en az bir not ekleyin ve görünür hale getirin.');
        }
      } catch (err) {
        alert('Bir hata oluştu: ' + err.message);
      }
    }
  }]
});


// 16. Yapım Panelini Kapat
tour.addStep({
  title: '📕 Yapım Panelini Kapat',
  text: 'Bu paneli kapatarak bir sonraki adıma geçebilirsin.',
  attachTo: { element: '#modal-close', on: 'top' },
  scrollTo: true,
  buttons: [],
  when: {
    show() {
      let modal;

      const interval = setInterval(() => {
        modal = document.querySelector('#modal_container');

        // Modal DOM'da bile değilse → kapandı demektir
        if (!modal) {
          clearInterval(interval);
          tour.next();
          return;
        }

        // Modal DOM'da ama görünmüyorsa
        const style = window.getComputedStyle(modal);
        const isHidden =
          style.display === 'none' ||
          style.visibility === 'hidden' ||
          style.opacity === '0' ||
          modal.classList.contains('hidden') ||
          modal.offsetWidth === 0 ||
          modal.offsetHeight === 0;

        if (isHidden) {
          clearInterval(interval);
          tour.next();
        }
      }, 300);
    }
  }
});





// 17. Oklar (İlişkiler)
tour.addStep({
  title: 'Oklar Neyi Gösterir? 🔁',
  text: 'Grafikteki oklar yapımlar arasındaki ilişkiyi gösterir.',
  attachTo: { element: '#network canvas', on: 'top' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 18. Legend Alanı
tour.addStep({
  title: '📘 Bağlantılar Açıklaması',
  text: 'Bağlantılar alanı evren renklerini ve türlerini açıklar.',
  attachTo: { element: '#legend_bar', on: 'left' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 19. Favori ve Not Paneli
tour.addStep({
  title: '📂 Sağ Alt Panel',
  text: 'Sağ altta favori ve notları görmek için bu alanı kullanabilirsin.',
  attachTo: { element: '#panel_bar', on: 'top' },
  scrollTo: false,
  buttons: [
    {
      text: 'Devam',
      action: function () {
        // Panel içeriği DOM'da görünür mü kontrol et
        const panel = document.querySelector('[x-show="panelOpen"]');

        const isVisible = panel && window.getComputedStyle(panel).display !== 'none';

        if (isVisible) {
          tour.next();
          return;
        }

        alert('Lütfen önce paneli açmalısın.');

        // Panel açıldığında bekle ve sonra ilerle
        const interval = setInterval(() => {
          const nowVisible = panel && window.getComputedStyle(panel).display !== 'none';
          if (nowVisible) {
            clearInterval(interval);
            tour.next();
          }
        }, 400); // her 0.4 sn'de bir kontrol et
      }
    }
  ]
});






// 20. Favori Yönetimi
tour.addStep({
  title: '⭐ Favorileri Gör ve Sil',
  text: 'Bu alanda favori yapımları görebilir ve silebilirsin.',
  attachTo: { element: '#fav_bar', on: 'left' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 21. Not Yönetimi
tour.addStep({
  title: '📝 Notları Gör, Düzenle, Sil',
  text: 'Notlarını bu alanda görüntüleyebilir, düzenleyebilir ya da silebilirsin.',
  attachTo: { element: '#notlar_bar', on: 'left' },
  buttons: [{ text: 'Devam', action: tour.next }]
});

// 22. Tur Bitti 🎉
tour.addStep({
  title: 'Tebrikler! 🎉',
  text: 'Film Evreni Ağı rehberini başarıyla tamamladın. Keşfetmeye hazırsın!',
  buttons: [{ text: 'Kapat', action: tour.complete }]
});
      tour.start();
    },

 

    editingNoteIndex: null,
    editedNoteText: '',
    startEditNote(i, text) {
      this.editingNoteIndex = i;
      this.editedNoteText = text;
    },
    cancelEditNote() {
      this.editingNoteIndex = null;
      this.editedNoteText = '';
    },
    saveEditedNote(nodeId, i) {
      if (this.notes[nodeId] && this.notes[nodeId][i]) {
        this.notes[nodeId][i].text = this.editedNoteText;
        this.notes[nodeId][i].ts = Date.now();
        this.cancelEditNote();
        if (this.saveNotesToStorage) this.saveNotesToStorage();
      }
    },
    
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
    
        network: null, allNodes: [], allEdges: [], nodes: null, edges: null,
        filteredNodes: [], filteredEdges: [],
        search: '', selectedUniverse: '', modalOpen: false, modalNode: null,
        timelineOpen: false,
        universeList: [], fitTimeout: null, showLegend: true,
        suggestions: [], acOpen: false,
        watchLater: [], watchLaterOpen: false, panelOpen: false, activeTab: 'watch', showGraph: false,
        notes: {}, newNote: '', notesOpen: false, notesUniverseFilter: '', notesTagFilter: '', editingNoteIndex: null, editedNoteText: '',
        bgUrl: 'images/bg.jpg',
        bgMap: {
          "": "images/bg.jpg",
          "avatar_last_airbender": "images/avatar.jpg",
          "avatar_pandora": "images/pandora.jpg",
          "dc": "images/dc.jpg",
          "harrypotter": "images/harrypotter.jpg",
          "marvel": "images/marvel.jpg",
          "matrix": "images/matrix.jpg",
          "middleearth": "images/middleearth.jpg",
          "pixar": "images/pixar.jpg",
          "starwars": "images/starwars.jpg"
        },
        get edgeList(){
          if (!this.modalNode || !this.allEdges) return [];
          return this.allEdges
            .filter(e => e.from === this.modalNode.id || e.to === this.modalNode.id)
            .map(e => ({ ...e, otherNodeId: e.from === this.modalNode.id ? e.to : e.from }));
        },
        edgeColors: {
          "Devam": "#2980b9",
          "Öncesi": "#f39c12", "ön hikaye": "#e67e22", "yan hikaye": "#8e44ad",
          "Aynı Evren": "#c0392b", "görsel gönderme": "#7f8c8d", "karakter göndermesi": "#27ae60",
          "kurumsal gönderme": "#6e4b25", "zaman çizgisi bağlantısı": "#1abc9c", "remake": "#2ecc71",
          "Teori Bağlantısı": "#f1c40f", "duygu ve bilinç teması": "#9b59b6", "konseptsel Devam": "#34495e",
          "şehir yaşamı paralelliği": "#d35400", "karakter_bağlantısı": "#7d3c98",
          "Tema Ortaklığı": "#e84393"
        },
        edgeStyles: {
          "Devam": { width: 3, dashes: false },
          "Öncesi": { width: 2, dashes: [4, 6] }, "karakter geçişi": { width: 3, dashes: [10,4] },
          "evren geçişi": { width: 2.5, dashes: [6,4] }, "multiverse birleşmesi": { width: 2.5, dashes: [2,6] },
          "görsel gönderme": { width: 1.8, dashes: [2,6] }, "karakter göndermesi": { width: 2, dashes: [6,6] },
          "ön hikaye": { width: 2.2, dashes: false }, "yan hikaye": { width: 2, dashes: [8,6] },
          "tematik benzerlik": { width: 1.8, dashes: [12,6] }, "Teori Bağlantısı": { width: 1.8, dashes: [4,4] },
          "kurumsal gönderme": { width: 1.8, dashes: [2,8] }, "konseptsel Devam": { width: 2, dashes: false },
          "şehir yaşamı paralelliği": { width: 1.8, dashes: [10,8] }, "iç film/karakter kökeni": { width: 2, dashes: [5,5] },
          "paralel Kang anlatımı": { width: 2.5, dashes: [3,7] }
        },
        get timelineSortedNodes(){
          const u = this.selectedUniverse;
          return [...this.allNodes]
            .filter(n => n.release_date && (!u || n.universe === u))
            .sort((a, b) => new Date(a.release_date) - new Date(b.release_date));
        },
        get groupTimelineByYear(){
          const groups = new Map();
          for (const n of this.timelineSortedNodes) {
            const y = new Date(n.release_date).getFullYear();
            if (!groups.has(y)) groups.set(y, []);
            groups.get(y).push(n);
          }
          for (const [y, arr] of groups.entries()) { arr.sort((a,b)=> new Date(a.release_date) - new Date(b.release_date)); }
          return Array.from(groups.entries()).sort((a,b)=> b[0]-a[0]);
        },
        
get legendEntries() {
  const usedTypes = new Set(this.filteredEdges.map(e => e.type));
  return Object.entries(this.edgeColors).filter(([t]) =>
    usedTypes.has(t) || this.filteredEdges.length === 0
  );
}
,
        get notesSummary(){
          const groups = new Map();
          for (const [nodeId, arr] of Object.entries(this.notes)){
            if (!arr || !arr.length) continue;
            const node = this.nodes?.get(nodeId) || this.allNodes.find(n => String(n.id)===String(nodeId));
            const g = groups.get(nodeId) || { count: 0, tags: new Set(), label: node?.label || nodeId, universe: node?.universe || '' };
            g.count += arr.length;
            for (const n of arr) (n.tags||[]).forEach(t => g.tags.add(t));
            groups.set(nodeId, g);
          }
          const u = this.notesUniverseFilter;
          const tagQ = (this.notesTagFilter || '').trim().replace(/^#/, '').toLowerCase();
          return Array.from(groups.entries()).map(([nodeId, g]) => ({ nodeId, label: g.label, universe: g.universe, count: g.count, tags: Array.from(g.tags) }))
            .filter(x => (!u || x.universe === u) && (!tagQ || x.tags.some(t => t.includes(tagQ))))
            .sort((a,b)=> b.count - a.count || a.label.localeCompare(b.label));
        },
        getAllEdgesWithNotes(nodeId) {
          if (!nodeId) return [];
          return this.allEdges
            .filter(e => e.from === nodeId || e.to === nodeId)
            .map(e => {
              const otherNodeId = e.from === nodeId ? e.to : e.from;
              const otherNode = this.allNodes.find(n => String(n.id) === String(otherNodeId));
              return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     id: e.id || (e.from + "_" + e.to + "_" + (e.type || "")), otherNodeId, otherNodeLabel: otherNode?.label || otherNodeId, type: e.type, edgeHasNotes: !!e.notes, edgeNoteText: e.notes || "", nodeHasNotes: !!(this.notes && this.notes[otherNodeId] && this.notes[otherNodeId].length) };
            });
        },
        formatEdgeType(type) { if (!type) return ''; return type.charAt(0).toUpperCase() + type.slice(1); },
        get topTags(){
          const counts = new Map();
          const u = this.notesUniverseFilter;
          for (const [nodeId, arr] of Object.entries(this.notes)){
            if (!arr || !arr.length) continue;
            const node = this.allNodes.find(n => String(n.id) === String(nodeId));
            if (u && node?.universe !== u) continue;
            for (const n of arr) for (const t of (n.tags || [])) counts.set(t, (counts.get(t) || 0) + 1);
          }
          return Array.from(counts.entries()).sort((a,b) => b[1] - a[1]).slice(0, 10).map(([t]) => t);
        },
        init() {
          this.showLegend = true;
          try { const old = localStorage.getItem('comments'); if (old && !localStorage.getItem('notes')) { localStorage.setItem('notes', old); localStorage.removeItem('comments'); } } catch {}
          this.loadWatchLater(); this.loadNotes(); this.network = null;
          this.setBackgroundFor(this.selectedUniverse); this.warmBackgrounds();
          this.loadData();

this.setupNetwork();
this.applyFilters();

          let debounceTimeout = null;
          this.$watch('search', (val) => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
              this.applyFilters();
              if (val) {
                const lower = val.toLowerCase(), starts = [], contains = [], seen = new Set();
                for (const n of this.allNodes) {
                  const lbl = n.label; if (!lbl) continue; const l = lbl.toLowerCase();
                  if (l.startsWith(lower)) { if (!seen.has(lbl)) { starts.push(lbl); seen.add(lbl); } }
                  else if (l.includes(lower)) { if (!seen.has(lbl)) { contains.push(lbl); seen.add(lbl); } }
                  if (starts.length + contains.length >= 10) break;
                }
                this.suggestions = [...starts, ...contains];
              } else this.suggestions = [];
            }, 220);
          });
          
this.$watch('selectedUniverse', (val) => {
  if (val) {
    this.setBackgroundFor(val);
    if (!this.network) this.setupNetwork();
    this.applyFilters();
  }
  this.notesUniverseFilter = val;
});

        },
        async setBackgroundFor(universe){
          const primary = this.bgMap[universe || ""] || this.bgMap[""];
          const fallbacks = ["images/bg.jpg", "images/bg.jpg"];
          const tried = new Set();
          const tryLoad = (url) => new Promise((resolve,reject)=>{ if(!url || tried.has(url)) return reject(); tried.add(url); const img = new Image(); img.onload = () => resolve(url); img.onerror = () => reject(); img.decoding = 'async'; img.referrerPolicy = 'no-referrer'; img.src = url; });
          for (const url of [primary, ...fallbacks]) { try { const ok = await tryLoad(url); this.bgUrl = ok; return; } catch {} }
        },
        warmBackgrounds(){ [...new Set(Object.values(this.bgMap))].forEach(u => { const i = new Image(); i.decoding='async'; i.src = u; }); },
        loadWatchLater(){ try { this.watchLater = JSON.parse(localStorage.getItem('watchLater') || '[]'); } catch { this.watchLater = []; } },
        saveWatchLater(){ localStorage.setItem('watchLater', JSON.stringify(this.watchLater)); },
        isInWatchLater(id){ return !!this.watchLater.find(x => String(x.id) === String(id)); },
        toggleWatchLater(node){ if (!node?.id) return; if (this.isInWatchLater(node.id)) this.watchLater = this.watchLater.filter(x => String(x.id) !== String(node.id)); else this.watchLater.unshift({ id: node.id, label: node.label || String(node.id) }); this.saveWatchLater(); },
        removeWatchLater(id){ this.watchLater = this.watchLater.filter(x => String(x.id) !== String(id)); this.saveWatchLater(); },
        loadNotes(){ try { this.notes = JSON.parse(localStorage.getItem('notes')||'{}'); } catch { this.notes = {}; } },
        saveNotes(){ localStorage.setItem('notes', JSON.stringify(this.notes)); },
        extractTags(t){ return Array.from(t.matchAll(/#([\p{L}\d_-]+)/gu)).map(m=>m[1].toLowerCase()); },
        addNote(nodeId){ const t = (this.newNote || '').trim(); if (!nodeId || !t) return; const item = { text: t, tags: this.extractTags(t), pin: false, ts: Date.now(), editedTs: null }; (this.notes[nodeId] ||= []).unshift(item); this.newNote = ''; this.saveNotes(); },
        togglePin(nodeId, idx){ const n = this.notes[nodeId]?.[idx]; if (!n) return; n.pin = !n.pin; this.saveNotes(); },
        deleteNote(nodeId, idx){ this.notes[nodeId].splice(idx, 1); this.saveNotes(); },
        startEditNote(index, text) {
          this.editingNoteIndex = index;
          this.editedNoteText = text;
        },
        cancelEditNote() {
          this.editingNoteIndex = null;
          this.editedNoteText = '';
        },
        saveEditedNote(nodeId, index) {
          if (!this.notes[nodeId] || !this.notes[nodeId][index]) return;
          const updatedText = (this.editedNoteText || '').trim();
          if (!updatedText) return;
          this.notes[nodeId][index].text = updatedText;
          this.notes[nodeId][index].tags = this.extractTags(updatedText);
          this.notes[nodeId][index].editedTs = Date.now();
          this.saveNotes();
          this.cancelEditNote();
        },

        buildNodeUrl(nodeId){ const node = this.nodes?.get(nodeId) || this.allNodes.find(n => String(n.id)===String(nodeId)); const u = node?.universe || ''; const base = location.origin + location.pathname; const params = new URLSearchParams({ u, node: String(nodeId) }); return `${base}?${params.toString()}`; },
        shareNode(node, platform){ if (!node?.id) return; const url = this.buildNodeUrl(node.id); const text = `${node.label || node.id} — ${this.formatUniverseName(node.universe)}\n${url}`; const enc = encodeURIComponent(text); const shareUrl = platform === 'whatsapp' ? `https://api.whatsapp.com/send?text=${enc}` : platform === 'x' ? `https://twitter.com/intent/tweet?text=${enc}` : ''; if (shareUrl) window.open(shareUrl, '_blank', 'noopener'); },
        async loadData() {
          const evrenler = ["avatar_last_airbender","avatar_pandora","dc","harrypotter","marvel","matrix","middleearth","pixar","starwars"];
          try {
            const results = await Promise.all(evrenler.map(evren => fetch('data/' + evren + '.json', { cache: 'no-store' }).then(r => { if (!r.ok) throw new Error(evren + ' yüklenemedi'); return r.json().then(data => ({ evren, data })); })));
            let nodesTemp = [], edgesTemp = [];
            for (const { evren, data } of results) { nodesTemp = nodesTemp.concat(data.nodes.map(n => ({ ...n, universe: evren }))); edgesTemp = edgesTemp.concat(data.edges); }
            this.allNodes = nodesTemp; this.allEdges = edgesTemp; this.universeList = [...new Set(this.allNodes.map(n => n.universe))];
            this.allNodes.filter(n => n.image).forEach(n => { const i = new Image(); i.decoding='async'; i.src = n.image; });
            
            const params = new URLSearchParams(location.search);
            const qU = params.get('u'); const qNode = params.get('node');
            if (qU && this.universeList.includes(qU)) this.selectedUniverse = qU;
            this.applyFilters();
            if (qNode && (this.nodes?.get(qNode))) { this.modalNode = this.nodes.get(qNode); this.modalOpen = true; this.network.selectNodes([qNode]); this.network.focus(qNode, { animation: true, scale: 1 }); }
          } catch (err) { console.error(err); alert('Veri yükleme hatası: ' + err.message); }
        },
        openNode(id) { const node = this.nodes?.get(id) || this.allNodes.find(n => String(n.id) === String(id)); if (node) { this.modalNode = node; this.modalOpen = true; window.__modalWasOpened = true; this.network?.selectNodes([id]); this.network?.focus(id, { animation: true, scale: 1 }); } },
        makeOptions() { return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     nodes: { size: 25, font: { color: '#e5e7eb', size: 14 }, borderWidthSelected: 6, color: { border: '#ef4444' } }, edges: { arrows: { to: { enabled: true, scaleFactor: 0.5 } }, smooth: { enabled: true, type: 'dynamic' } }, interaction: { hover: true, tooltipDelay: 200, zoomView: true, dragView: true }, physics: { stabilization: true, barnesHut: { gravitationalConstant: -4000 } }, layout: { improvedLayout: true } }; },
        setupNetwork() { this.nodes = new vis.DataSet(); this.edges = new vis.DataSet(); const container = document.getElementById('network'); this.network = new vis.Network(container, { nodes: this.nodes, edges: this.edges }, this.makeOptions()); this.network.on('click', params => { if (params.nodes.length > 0) { const node = this.nodes.get(params.nodes[0]); requestAnimationFrame(() => { this.modalNode = node; this.modalOpen = true; }); } }); },
        applyFilters() {
          if (!this.nodes || !this.edges) return;
          const searchTerm = (this.search || '').toLowerCase(); const universe = this.selectedUniverse;
          this.filteredNodes = this.allNodes.filter(n => (!universe || n.universe === universe) && (!searchTerm || (n.label && n.label.toLowerCase().includes(searchTerm))));
          const nodeIds = new Set(this.filteredNodes.map(n => n.id));
          this.filteredEdges = this.allEdges.filter(e => nodeIds.has(e.from) && nodeIds.has(e.to));
          this.updateNetwork();
          if (this.network) { if (this.fitTimeout) clearTimeout(this.fitTimeout); this.fitTimeout = setTimeout(() => this.network.fit({ animation: true }), 220); }
        },
        updateNetwork() {
          this.nodes.clear(); this.edges.clear();
          this.nodes.add(this.filteredNodes.map(n => { const hasImage = !!n.image; const noteCount = (this.notes[n.id]?.length || 0); return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     ...n, label: noteCount ? `${n.label}\n📝 ${noteCount}` : n.label, font: { color: '#e5e7eb', size: 14, multi: true, vadjust: 4 }, shape: hasImage ? 'circularImage' : 'dot', borderWidth: 2, borderWidthSelected: 6, color: hasImage ? { border: '#ef4444' } : { background: '#ef4444', border: '#ef4444' } }; }));
          this.edges.add(this.filteredEdges.map(e => { const color = this.edgeColors[e.type] || '#9ca3af'; const s = this.edgeStyles[e.type] || { width: 1.5, dashes: false }; return {
        linkedOpen: window.innerWidth > 640,
        showFavAdded: false,
        showFavMsg: false,

        summaryOpen: window.innerWidth > 640,
        refersOpen: false,
        showPosterDialog: false,
     ...e, arrows: 'to', color: { color }, width: s.width, dashes: s.dashes }; }));
        },
        neighborChips(nodeId) { if (!nodeId || !this.network) return ''; const neighbors = this.network.getConnectedNodes(nodeId).map(id => this.nodes.get(id)).filter(Boolean); if (!neighbors.length) return '<span class="text-sm opacity-70">Bağlantı bulunamadı.</span>'; return neighbors.map(n => `<button class="chip hover:brightness-110" onclick="window.__openNode('${String(n.id).replace(/'/g,'&#39;')}')">${n.label ? n.label.replace(/</g,'&lt;') : 'ID ' + n.id}</button>`).join(''); },
        formatUniverseName(name) { const map = { "avatar_last_airbender": "Avatar: Son Hava Bükücü", "avatar_pandora": "Avatar (Pandora)", "dc": "DC", "marvel": "Marvel", "harrypotter": "Harry Potter", "matrix": "Matrix", "middleearth": "Orta Dünya", "pixar": "Pixar", "starwars": "Star Wars" }; return map[name] || name; }
      }
    }
    window.openNode = function(id) { const scope = document.querySelector('html')?.__x?.$data; if (!scope?.openNode) return; scope.openNode(id); };
    window.__openNode = function(id) { let scope = document.querySelector('html')?.__x?.$data; if (!scope?.nodes) { for (const el of document.querySelectorAll('[x-data]')) { if (el.__x && el.__x.$data?.nodes) { scope = el.__x.$data; break; } } } if (!scope?.nodes) return; const node = scope.nodes.get(id); if (node) { requestAnimationFrame(() => { scope.modalNode = node; scope.modalOpen = true; scope.network.selectNodes([id]); scope.network.focus(id, { animation: true, scale: 1 }); }); } };
  </script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered', reg.scope))
          .catch(err => console.warn('SW register failed', err));
      });
    }
  </script>
<script>
    const SHARE_PHRASES = { more: 'Devamı için ziyaret et:', farewell: 'Sinemayla kalın.', dash: ' — ' };
    const EMOJI = { title: '🎬', date: '📅', summary: '📝', more: '👉', link: '🔗', bye: '🍿' };
    function preferredUrl(node) { const base = typeof window !== 'undefined' ? window.location.origin + window.location.pathname : ''; const id = node?.id ? `#${node.id}` : ''; return node?.url || base + id; }
    function composeShareText(node) {
      const filmAdi  = node?.label || node?.title || node?.name || 'Bu yapım';
      const line1 = `${EMOJI.title} ${filmAdi}`;
      const takvimTR = toTRDate(node?.release_date || node?.date);
      const line2 = takvimTR ? `${EMOJI.date} ${takvimTR}` : '';
      const aciklamaFull = (node?.description || '').trim();
      const gondermelerFull = (node?.refers_to || '').trim();
      const aciklama = aciklamaFull.length > 120 ? aciklamaFull.slice(0,117).trimEnd() + '...' : aciklamaFull;
      const gondermeler = gondermelerFull.length > 100 ? gondermelerFull.slice(0,97).trimEnd() + '...' : gondermelerFull;
      let line3 = '';
      if (aciklama && gondermeler) line3 = `${EMOJI.summary} Film Özeti: ${aciklama}${SHARE_PHRASES.dash}Göndermeler: ${gondermeler}`;
      else if (aciklama) line3 = `${EMOJI.summary} Film Özeti: ${aciklama}`;
      else if (gondermeler) line3 = `${EMOJI.summary} Göndermeler: ${gondermeler}`;
      if (line3 && !/[.!?…]$/.test(line3.trim())) line3 = line3.trim() + '.';
      const url = preferredUrl(node);
      const line4 = `${SHARE_PHRASES.more} ${EMOJI.more}`;
      const line5 = `${EMOJI.link} ${url}`;
      const line6 = `${SHARE_PHRASES.farewell} ${EMOJI.bye}`;
      return [line1, line2, line3, line4, line5, line6].filter(Boolean).join('\n');
    }
    function composeShareTextForX(node, max = 240) { const url = preferredUrl(node); const single = composeShareText(node).replace(/\n+/g, ' | '); const withoutUrl = single.replace(url, '').replace(/\s*\|\s*\|\s*/g, ' | ').trim(); return withoutUrl.length <= max ? withoutUrl : (withoutUrl.slice(0, max - 1) + '…'); }
    window.shareToX = function(node) { const url = preferredUrl(node); const text = composeShareTextForX(node); window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,'_blank','noopener,noreferrer'); };
    window.shareToWhatsApp = function(node) { const text = composeShareText(node); window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`,'_blank','noopener,noreferrer'); };
    window.shareToLinkedIn = function(node) { const url  = preferredUrl(node); const name = node?.label || node?.title || node?.name || 'Bu yapım'; const sum  = composeShareText(node); window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(name)}&summary=${encodeURIComponent(sum)}`,'_blank','noopener,noreferrer'); };
    window.copyShare = async function(node) { const full = composeShareText(node) + '\n'; try { await navigator.clipboard.writeText(full); alert('Paylaşım metni ve link kopyalandı.'); } catch { const ta = document.createElement('textarea'); ta.value = full; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('Paylaşım metni ve link kopyalandı.'); } };
  </script>
<script>
    window.toTRDate = function(value) { if (!value) return ''; const s = String(value).trim(); const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s); if (m) return `${m[3]}/${m[2]}/${m[1]}`; const d = new Date(s); if (isNaN(d)) return s; const dd = String(d.getDate()).padStart(2, '0'); const mm = String(d.getMonth() + 1).padStart(2, '0'); const yyyy = d.getFullYear(); return `${dd}/${mm}/${yyyy}`; };
  </script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.querySelector('input[placeholder="Not ekle... #etiket"]');
    if (input) {
      input.addEventListener('focus', () => {
        setTimeout(() => {
          input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    }
  });
</script>


</div>
<div id="legendWrap" x-show="selectedUniverse">
<button id="legend_bar" @click="showLegend = !showLegend" class="glass px-3 py-1.5 rounded-lg text-sm hover:bg-white/10 transition" id="legendToggle">Bağlantılar <span x-text="showLegend ? '(Gizle)' : '(Göster)'"></span></button>
<div id="legend" x-show="showLegend" x-transition="">
<h3 class="font-bold mb-2">Bağlantılar</h3>
<ul>
<template :key="type" x-for="[type, color] in legendEntries">
<li class="flex items-center mb-1"><svg class="mr-2" height="8" width="36"><line :stroke="color" :stroke-dasharray="(edgeStyles[type]?.dashes ? edgeStyles[type].dashes.join(',') : '0')" stroke-width="3" x1="2" x2="34" y1="4" y2="4"></line></svg><span x-text="type"></span></li>
</template>
</ul>
</div>





<!-- Yeni panel açma butonu -->
<button @click="panelOpen = !panelOpen" id="panel_bar" class="fixed right-4 bottom-4 z-50 glass rounded-full w-12 h-12 grid place-items-center hover:bg-white/10" title="Notlar ve Favoriler">📁</button>


<!-- Notlar & Favoriler Paneli -->
<div class="fixed right-4 bottom-20 z-50 glass rounded-xl p-4 w-[22rem] max-h-[45vh] overflow-y-auto text-white text-sm space-y-4"
     x-show="panelOpen" x-transition>

  <!-- Sekmeler -->
  <div class="flex gap-2 mb-1">
    <button id="fav_bar" @click="activeTab = 'watch'" :class="activeTab === 'watch' ? 'bg-white/20 px-3 py-1 rounded' : 'px-3 py-1 rounded hover:bg-white/10'">⭐ Favoriler</button>
    <button id="notlar_bar" @click="activeTab = 'notes'" :class="activeTab === 'notes' ? 'bg-white/20 px-3 py-1 rounded' : 'px-3 py-1 rounded hover:bg-white/10'">📝 Notlar</button>
  </div>

  <!-- Favoriler Sekmesi -->
  <div x-show="activeTab === 'watch'" class="space-y-3">
    <template x-if="!watchLater.length">
      <p class="text-sm opacity-70">Henüz favori yok.</p>
    </template>

    <template x-for="item in watchLater" :key="item.id">
      <div class="border border-white/10 rounded-lg overflow-hidden">
        <div class="flex justify-between items-center px-3 py-2 bg-white/10">
          <span class="font-semibold truncate" x-text="item.label || item.id"></span>
          <button @click="removeWatchLater(item.id)" class="text-red-400 hover:text-red-600 text-xs">Sil</button>
        </div>
      </div>
    </template>
  </div>

  <!-- Notlar Sekmesi -->
  <div x-show="activeTab === 'notes'" class="space-y-3">
    <template x-if="!Object.keys(notes).some(k => notes[k]?.length)">
      <p class="text-sm opacity-70">Not bulunamadı.</p>
    </template>

    <template x-for="(entries, nodeId) in Object.fromEntries(Object.entries(notes).filter(([k, arr]) => arr.length))" :key="nodeId">
      <div class="border border-white/10 rounded-lg overflow-hidden">
        <button @click="notesOpen = notesOpen === nodeId ? null : nodeId" class="w-full text-left px-3 py-2 bg-white/10 hover:bg-white/20 font-semibold">
          <span x-text="nodes.get(nodeId)?.label || nodeId"></span>
        </button>

        <div x-show="notesOpen === nodeId" x-transition class="p-3 space-y-2 max-h-[45vh] overflow-y-auto">
          <template x-for="(n, i) in entries" :key="i">
            <div class="bg-white/10 p-2 rounded">
              <div class="text-xs opacity-70 mb-1" x-text="new Date(n.ts).toLocaleDateString()"></div>

              <template x-if="editingNoteIndex === `${nodeId}_${i}`">
                <div class="flex flex-col gap-2">
                  <textarea x-model="editedNoteText" class="w-full p-2 rounded bg-black/20 text-sm text-white border border-white/20"></textarea>
                  <div class="flex justify-end gap-2 text-xs">
                    <button @click="saveEditedNote(nodeId, i)" class="px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white">Kaydet</button>
                    <button @click="cancelEditNote()" class="px-2 py-1 rounded bg-white/20 text-white">Vazgeç</button>
                  </div>
                </div>
              </template>

              <template x-if="editingNoteIndex !== `${nodeId}_${i}`">
                <div>
                  <div class="whitespace-pre-wrap text-sm mb-1" x-text="n.text"></div>
                  <div class="flex justify-end gap-2 text-xs opacity-80">
                    <button @click="startEditNote(`${nodeId}_${i}`, n.text)">✏️</button>
                    <button @click="deleteNote(nodeId, i)">🗑️</button>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </template>
  </div>
</div>
        </template>
      </div>
    </template>
  </div>
</div>

</body>
</html>
