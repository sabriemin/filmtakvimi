<!DOCTYPE html>
<html lang="tr" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film Evreni AÄŸÄ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    html, body, #network {
      height: 100%;
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    #network {
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      border: 1px solid #e2e8f0;
      background: white;
      margin: 12px;
      transition: background-color 0.3s;
    }
    .modal-bg {
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(3px);
    }
    .modal-content {
      max-width: 600px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.25);
      position: relative;
      transition: background-color 0.3s, color 0.3s;
    }
    .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 28px;
      font-weight: 700;
      color: #374151;
      cursor: pointer;
      transition: color 0.2s ease;
      z-index: 10;
    }
    .close-btn:hover {
      color: #ef4444;
    }
    #modalTitle {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
      color: #111827;
    }
    #modalUniverse {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }
    #modalDescription {
      font-size: 1rem;
      color: #374151;
      margin-bottom: 1rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    #modalRefersTo {
      font-style: italic;
      font-size: 0.85rem;
      color: #6b7280;
      border-left: 4px solid #ef4444;
      padding-left: 12px;
    }
    header {
      background: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      padding: 16px 24px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: background-color 0.3s, color 0.3s;
    }
    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      flex-grow: 1;
      transition: color 0.3s;
      min-width: 150px;
    }
    header .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      flex-grow: 2;
      justify-content: flex-end;
    }
    label {
      font-weight: 600;
      color: #374151;
      margin-right: 6px;
      user-select: none;
    }
    input, select, button {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      transition: border-color 0.2s ease, background-color 0.3s, color 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #ef4444;
      box-shadow: 0 0 4px #ef4444aa;
    }
    button {
      background-color: #ef4444;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #dc2626;
    }
    #search {
      width: 180px;
      min-width: 140px;
    }
    #universeFilter, #edgeFilter, #langSelect {
      min-width: 140px;
    }
    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      header h1 {
        flex-grow: 0;
        text-align: center;
      }
      label {
        margin-right: 0;
        margin-bottom: 2px;
      }
      #search, #universeFilter, #edgeFilter, #langSelect {
        width: 100%;
        min-width: unset;
      }
      #network {
        margin: 8px 0 0 0;
        border-radius: 0;
      }
    }
    /* Node hover glow */
    .vis-network .vis-node:hover {
      box-shadow: 0 0 10px 3px #ef4444;
      transition: box-shadow 0.3s ease;
    }
    /* Dark mode */
    body.dark {
      background-color: #111827;
      color: #d1d5db;
    }
    body.dark #network {
      background-color: #1f2937;
      border-color: #374151;
    }
    body.dark header {
      background-color: #1f2937;
      color: #d1d5db;
      box-shadow: 0 1px 4px rgba(0,0,0,0.7);
    }
    body.dark header h1 {
      color: #f9fafb;
    }
    body.dark label {
      color: #d1d5db;
    }
    body.dark input, body.dark select, body.dark button {
      background-color: #374151;
      border-color: #4b5563;
      color: #d1d5db;
    }
    body.dark input:focus, body.dark select:focus {
      border-color: #ef4444;
      box-shadow: 0 0 4px #ef4444aa;
    }
    body.dark button:hover {
      background-color: #dc2626;
    }
    body.dark .modal-content {
      background-color: #1f2937;
      color: #d1d5db;
    }
    body.dark #modalTitle {
      color: #f9fafb;
    }
    /* Legend */
    #legend {
      position: fixed;
      bottom: 16px;
      left: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      max-width: 320px;
      max-height: 240px;
      overflow-y: auto;
      padding: 12px 16px;
      font-size: 0.85rem;
      z-index: 1001;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark #legend {
      background-color: #1f2937;
      color: #d1d5db;
    }
    #legend h3 {
      font-weight: 700;
      margin-bottom: 8px;
    }
    #legend ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #legend li {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    #legend .color-box {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      margin-right: 8px;
      flex-shrink: 0;
    }
    @media (max-width: 640px) {
      #legend {
        max-width: 90vw;
        font-size: 0.75rem;
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="h-full flex flex-col" :class="{dark: isDarkMode}">

<header>
  <h1 x-text="lang === 'tr' ? 'ðŸŽ¬ Film Evreni AÄŸÄ±' : 'ðŸŽ¬ Film Universe Network'"></h1>
  <div class="controls">
    <label for="search" x-text="lang === 'tr' ? 'Ara' : 'Search'"></label>
    <input id="search" x-model="search" :placeholder="lang === 'tr' ? 'Ara...' : 'Search...'" aria-label="Search" />

    <label for="universeFilter" x-text="lang === 'tr' ? 'Evren' : 'Universe'"></label>
    <select id="universeFilter" x-model="selectedUniverse" aria-label="Universe Filter">
      <option value="">{{ lang === 'tr' ? 'TÃ¼m Evrenler' : 'All Universes' }}</option>
      <template x-for="u in universeList" :key="u">
        <option :value="u" x-text="u"></option>
      </template>
    </select>

    <label for="edgeFilter" x-text="lang === 'tr' ? 'BaÄŸlantÄ± TÃ¼rÃ¼' : 'Edge Type'"></label>
    <select id="edgeFilter" x-model="selectedEdgeType" aria-label="Edge Type Filter">
      <option value="">{{ lang === 'tr' ? 'TÃ¼m BaÄŸlantÄ±lar' : 'All Edges' }}</option>
      <template x-for="type in edgeTypeList" :key="type">
        <option :value="type" x-text="type"></option>
      </template>
    </select>

    <button @click="toggleTheme" :aria-pressed="isDarkMode" :title="lang === 'tr' ? 'Tema DeÄŸiÅŸtir' : 'Toggle Theme'" x-text="isDarkMode ? (lang === 'tr' ? 'ðŸŒž AÃ§Ä±k Mod' : 'ðŸŒž Light Mode') : (lang === 'tr' ? 'ðŸŒ™ Koyu Mod' : 'ðŸŒ™ Dark Mode')"></button>

    <label for="langSelect" x-text="lang === 'tr' ? 'Dil' : 'Language'"></label>
    <select id="langSelect" x-model="lang" aria-label="Language Select" class="bg-white text-black">
      <option value="tr">TÃ¼rkÃ§e</option>
      <option value="en">English</option>
    </select>
  </div>
</header>

<div id="network" class="flex-grow"></div>

<!-- Modal -->
<div id="modalOverlay" x-show="modalOpen" x-transition class="fixed inset-0 modal-bg flex items-center justify-center z-50 p-4" @click.away="modalOpen = false" style="display:none;">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle" @click.stop>
    <button id="closeModal" class="close-btn" aria-label="Close" @click="modalOpen = false">âœ–</button>
    <h2 id="modalTitle" x-text="modalNode?.label || ''"></h2>
    <p id="modalUniverse" x-text="(lang === 'tr' ? 'Evren: ' : 'Universe: ') + (modalNode?.universe || '')"></p>
    <p><strong x-text="lang === 'tr' ? 'Vizyon Tarihi: ' : 'Release Date: '"></strong><span x-text="modalNode?.release_date || (lang === 'tr' ? 'Bilinmiyor' : 'Unknown')"></span></p>
    <p><strong x-text="lang === 'tr' ? 'TÃ¼r: ' : 'Type: '"></strong><span x-text="modalNode?.type || modalNode?.category || (lang === 'tr' ? 'Bilinmiyor' : 'Unknown')"></span></p>
    <p id="modalDescription" x-text="modalNode?.description || (lang === 'tr' ? 'AÃ§Ä±klama yok.' : 'No description.')"></p>
    <p id="modalRefersTo" x-text="(lang === 'tr' ? 'GÃ¶ndermeler: ' : 'References: ') + (modalNode?.refers_to || (lang === 'tr' ? 'Yok.' : 'None.'))"></p>
  </div>
</div>

<!-- Legend -->
<div id="legend" aria-label="Edge Types Legend">
  <h3 x-text="lang === 'tr' ? 'BaÄŸlantÄ± TÃ¼rleri' : 'Edge Types'"></h3>
  <ul>
    <template x-for="(color, type) in edgeColors" :key="type">
      <li>
        <span class="color-box" :style="'background-color: ' + color"></span>
        <span x-text="type"></span>
      </li>
    </template>
  </ul>
</div>

<script>
function app() {
  return {
    network: null,
    allNodes: [],
    allEdges: [],
    nodes: null,
    edges: null,
    filteredNodes: [],
    filteredEdges: [],
    search: '',
    selectedUniverse: '',
    selectedEdgeType: '',
    timelineMode: false,
    modalOpen: false,
    modalNode: null,
    universeList: [],
    edgeTypeList: [],
    isDarkMode: false,
    lang: 'tr',

    edgeColors: {
      "devam": "#2980b9",
      "Ã¶n hikaye": "#e67e22",
      "yan hikaye": "#8e44ad",
      "evren geÃ§iÅŸi": "#c0392b",
      "gÃ¶rsel gÃ¶nderme": "#7f8c8d",
      "karakter gÃ¶ndermesi": "#27ae60",
      "kurumsal gÃ¶nderme": "#6e4b25",
      "zaman Ã§izgisi baÄŸlantÄ±sÄ±": "#1abc9c",
      "karakter geÃ§iÅŸi": "#2ecc71",
      "tematik benzerlik": "#f1c40f",
      "duygu ve bilinÃ§ temasÄ±": "#9b59b6",
      "konseptsel devam": "#34495e",
      "ÅŸehir yaÅŸamÄ± paralelliÄŸi": "#d35400",
      "iÃ§ film/karakter kÃ¶keni": "#7d3c98",
      "multiverse birleÅŸmesi": "#e84393",
      "paralel Kang anlatÄ±mÄ±": "#16a085"
    },

    init() {
      this.loadData();
      this.isDarkMode = localStorage.getItem('darkMode') === 'true';
      this.lang = localStorage.getItem('lang') || 'tr';

      let debounceTimeout = null;
      this.$watch('search', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          this.applyFilters();
        }, 300);
      });

      this.$watch('selectedUniverse', () => this.applyFilters());
      this.$watch('selectedEdgeType', () => this.applyFilters());
    },

    async loadData() {
      const evrenler = [
        "avatar_last_airbender",
        "avatar_pandora",
        "dc",
        "harrypotter",
        "marvel",
        "matrix",
        "middleearth",
        "pixar",
        "starwars"
      ];
      let nodesTemp = [];
      let edgesTemp = [];
      for (const evren of evrenler) {
        const res = await fetch('data/' + evren + '.json');
        const data = await res.json();
        nodesTemp = nodesTemp.concat(data.nodes.map(n => ({...n, universe: evren})));
        edgesTemp = edgesTemp.concat(data.edges);
      }
      this.allNodes = nodesTemp;
      this.allEdges = edgesTemp;

      this.universeList = [...new Set(this.allNodes.map(n => n.universe))];
      this.edgeTypeList = [...new Set(this.allEdges.map(e => e.type))].filter(t => t);

      this.setupNetwork();
      this.applyFilters();
    },

    setupNetwork() {
      const fontColor = this.isDarkMode ? '#fff' : '#111827';
      this.nodes = new vis.DataSet();
      this.edges = new vis.DataSet();
      const container = document.getElementById('network');
      const data = { nodes: this.nodes, edges: this.edges };
      const options = {
        nodes: {
          size: 25,
          font: { color: fontColor, size: 14 },
          borderWidthSelected: 6,
          color: { border: '#ef4444' }
        },
        edges: {
          arrows: { to: { enabled: true, scaleFactor: 0.5 } },
          smooth: {
            enabled: true,
            type: 'dynamic'
          }
        },
        interaction: { hover: true, tooltipDelay: 200 },
        physics: {
          stabilization: true,
          barnesHut: { gravitationalConstant: -4000 }
        },
        layout: { improvedLayout: true }
      };
      if(this.network) {
        this.network.setOptions(options);
      } else {
        this.network = new vis.Network(container, data, options);
        this.network.on('click', params => {
          if(params.nodes.length > 0){
            const node = this.nodes.get(params.nodes[0]);
            this.modalNode = node;
            this.modalOpen = true;
          }
        });
      }
    },

    applyFilters() {
      const searchTerm = this.search.toLowerCase();
      const universe = this.selectedUniverse;
      const edgeType = this.selectedEdgeType;

      this.filteredNodes = this.allNodes.filter(n =>
        (!universe || n.universe === universe) &&
        (!searchTerm || (n.label && n.label.toLowerCase().includes(searchTerm)))
      );

      const nodeIds = new Set(this.filteredNodes.map(n => n.id));

      this.filteredEdges = this.allEdges.filter(e =>
        nodeIds.has(e.from) && nodeIds.has(e.to) &&
        (!edgeType || e.type === edgeType)
      );

      this.updateNetwork();
      if(this.network) {
        if(this.fitTimeout) clearTimeout(this.fitTimeout);
        this.fitTimeout = setTimeout(() => {
          this.network.fit({animation: true});
        }, 300);
      }
    },

    updateNetwork() {
      this.nodes.clear();
      this.edges.clear();

      this.nodes.add(this.filteredNodes.map(n => ({
        ...n,
        shape: 'circularImage',
        borderWidth: 2,
        borderWidthSelected: 6,
        color: { border: '#ef4444' }
      })));

      this.edges.add(this.filteredEdges.map(e => {
        let color = this.edgeColors[e.type] || '#888';
        let width = (e.type === 'devam' || e.type === 'karakter geÃ§iÅŸi') ? 3 : 1.5;
        return {
          ...e,
          arrows: 'to',
          color: { color },
          width
        };
      }));
    },

    toggleTheme() {
      this.isDarkMode = !this.isDarkMode;
      this.setupNetwork();
      localStorage.setItem('darkMode', this.isDarkMode);
      if(this.isDarkMode) document.body.classList.add('dark');
      else document.body.classList.remove('dark');
    }
  }
}
</script>

</body>
</html>
