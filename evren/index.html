<!DOCTYPE html>
<html lang="tr" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film Evreni AÄŸÄ± - Evren Filtresi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    html, body, #network {
      height: 100%;
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    #network {
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      border: 1px solid #e2e8f0;
      background: white;
      margin: 12px;
      transition: background-color 0.3s;
    }
    .modal-bg {
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(3px);
    }
    .modal-content {
      max-width: 600px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.25);
      position: relative;
      transition: background-color 0.3s, color 0.3s;
    }
    .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 28px;
      font-weight: 700;
      color: #374151;
      cursor: pointer;
      transition: color 0.2s ease;
      z-index: 10;
    }
    .close-btn:hover {
      color: #ef4444;
    }
    #modalTitle {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
      color: #111827;
    }
    #modalUniverse {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }
    #modalDescription {
      font-size: 1rem;
      color: #374151;
      margin-bottom: 1rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    #modalRefersTo {
      font-style: italic;
      font-size: 0.85rem;
      color: #6b7280;
      border-left: 4px solid #ef4444;
      padding-left: 12px;
    }
    header {
      background: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      padding: 16px 24px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: background-color 0.3s, color 0.3s;
    }
    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      flex-grow: 1;
      transition: color 0.3s;
      min-width: 150px;
    }
    header .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      flex-grow: 2;
      justify-content: flex-end;
    }
    input, select, button {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      transition: border-color 0.2s ease, background-color 0.3s, color 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #ef4444;
      box-shadow: 0 0 4px #ef4444aa;
    }
    button {
      background-color: #ef4444;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #dc2626;
    }
    #search {
      width: 180px;
      min-width: 140px;
    }
    #universeFilter, #langSelect {
      min-width: 140px;
    }
    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      header h1 {
        flex-grow: 0;
        text-align: center;
      }
      #search, #universeFilter, #langSelect {
        width: 100%;
        min-width: unset;
      }
      #network {
        margin: 8px 0 0 0;
        border-radius: 0;
      }
    }
    /* Node hover glow */
    .vis-network .vis-node:hover {
      box-shadow: 0 0 10px 3px #ef4444;
      transition: box-shadow 0.3s ease;
    }
    /* Dark mode */
    body.dark {
      background-color: #111827;
      color: #d1d5db;
    }
    body.dark #network {
      background-color: #1f2937;
      border-color: #374151;
    }
    body.dark header {
      background-color: #1f2937;
      color: #d1d5db;
      box-shadow: 0 1px 4px rgba(0,0,0,0.7);
    }
    body.dark header h1 {
      color: #f9fafb;
    }
    body.dark input, body.dark select, body.dark button {
      background-color: #374151;
      border-color: #4b5563;
      color: #d1d5db;
    }
    body.dark input:focus, body.dark select:focus {
      border-color: #ef4444;
      box-shadow: 0 0 4px #ef4444aa;
    }
    body.dark button:hover {
      background-color: #dc2626;
    }
    body.dark .modal-content {
      background-color: #1f2937;
      color: #d1d5db;
    }
    body.dark #modalTitle {
      color: #f9fafb;
    }
  </style>
</head>
<body class="h-full flex flex-col" :class="{dark: isDarkMode}">

<header>
  <h1 x-text="lang === 'tr' ? 'ðŸŽ¬ Film Evreni AÄŸÄ±' : 'ðŸŽ¬ Film Universe Network'"></h1>
  <div class="controls">
    <input id="search" x-model="search" :placeholder="lang === 'tr' ? 'Ara...' : 'Search...'" aria-label="Search" />
    <select id="universeFilter" x-model="selectedUniverse" aria-label="Universe Filter">
      <option value="">{{ lang === 'tr' ? 'TÃ¼m Evrenler' : 'All Universes' }}</option>
      <template x-for="u in universeList" :key="u">
        <option :value="u" x-text="universeDisplayNames[u] || u"></option>
      </template>
    </select>
    <button @click="toggleTheme" :aria-pressed="isDarkMode" :title="lang === 'tr' ? 'Tema DeÄŸiÅŸtir' : 'Toggle Theme'" x-text="isDarkMode ? (lang === 'tr' ? 'ðŸŒž AÃ§Ä±k Mod' : 'ðŸŒž Light Mode') : (lang === 'tr' ? 'ðŸŒ™ Koyu Mod' : 'ðŸŒ™ Dark Mode')"></button>
    <select id="langSelect" x-model="lang" aria-label="Language Select" class="bg-white text-black">
      <option value="tr">TÃ¼rkÃ§e</option>
      <option value="en">English</option>
    </select>
  </div>
</header>

<div id="network" class="flex-grow"></div>

<!-- Modal -->
<div id="modalOverlay" x-show="modalOpen" x-transition class="fixed inset-0 modal-bg flex items-center justify-center z-50 p-4" @click.away="modalOpen = false" style="display:none;">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle" @click.stop>
    <button id="closeModal" class="close-btn" aria-label="Close" @click="modalOpen = false">âœ–</button>
    <h2 id="modalTitle" x-text="modalNode?.label || ''"></h2>
    <p id="modalUniverse" x-text="(lang === 'tr' ? 'Evren: ' : 'Universe: ') + (modalNode?.universe || '')"></p>
    <p id="modalDescription" x-text="modalNode?.description || (lang === 'tr' ? 'AÃ§Ä±klama yok.' : 'No description.')"></p>
    <p id="modalRefersTo" x-text="(lang === 'tr' ? 'GÃ¶ndermeler: ' : 'References: ') + (modalNode?.refers_to || (lang === 'tr' ? 'Yok.' : 'None.'))"></p>
  </div>
</div>

<script>
function app() {
  return {
    network: null,
    allNodes: [],
    allEdges: [],
    nodes: null,
    edges: null,
    filteredNodes: [],
    filteredEdges: [],
    search: '',
    selectedUniverse: '',
    modalOpen: false,
    modalNode: null,
    universeList: [],
    universeDisplayNames: {
      "avatar_last_airbender": "Avatar: Son Hava BÃ¼kÃ¼cÃ¼",
      "avatar_pandora": "Avatar: Pandora",
      "dc": "DC Evreni",
      "harrypotter": "Harry Potter",
      "marvel": "Marvel Evreni",
      "matrix": "Matrix",
      "middleearth": "Orta DÃ¼nya",
      "pixar": "Pixar Evreni",
      "starwars": "Star Wars"
    },
    isDarkMode: false,
    lang: 'tr',

    init() {
      this.loadData();
      this.isDarkMode = localStorage.getItem('darkMode') === 'true';
      this.lang = localStorage.getItem('lang') || 'tr';
      this.$watch('isDarkMode', val => {
        if(val) document.body.classList.add('dark'); else document.body.classList.remove('dark');
        localStorage.setItem('darkMode', val);
      });
      this.$watch('lang', val => localStorage.setItem('lang', val));
      this.$watch('search', () => this.applyFilters());
      this.$watch('selectedUniverse', () => this.applyFilters());
    },

    async loadData() {
      const evrenler = [
        "avatar_last_airbender",
        "avatar_pandora",
        "dc",
        "harrypotter",
        "marvel",
        "matrix",
        "middleearth",
        "pixar",
        "starwars"
      ];
      let nodesTemp = [];
      let edgesTemp = [];
      for (const evren of evrenler) {
        const res = await fetch('data/' + evren + '.json');
        const data = await res.json();
        nodesTemp = nodesTemp.concat(data.nodes.map(n => ({...n, universe: evren})));
        edgesTemp = edgesTemp.concat(data.edges);
      }
      this.allNodes = nodesTemp;
      this.allEdges = edgesTemp;

      this.universeList = [...new Set(this.allNodes.map(n => n.universe))];

      this.setupNetwork();
      this.applyFilters();
    },

    setupNetwork() {
      this.nodes = new vis.DataSet();
      this.edges = new vis.DataSet();
      const container = document.getElementById('network');
      const data = { nodes: this.nodes, edges: this.edges };
      const options = {
        nodes: {
          size: 25,
          font: { color: '#fff', size: 14 },
          borderWidthSelected: 6,
          color: { border: '#ef4444' }
        },
        edges: {
          arrows: { to: { enabled: true, scaleFactor: 0.5 } },
          smooth: {
            enabled: true,
            type: 'dynamic'
          }
        },
        interaction: { hover: true, tooltipDelay: 200 },
        physics: {
          stabilization: true,
          barnesHut: { gravitationalConstant: -4000 }
        },
        layout: { improvedLayout: true }
      };
      this.network = new vis.Network(container, data, options);

      this.network.on('click', params => {
        if(params.nodes.length > 0){
          const node = this.nodes.get(params.nodes[0]);
          this.modalNode = node;
          this.modalOpen = true;
        }
      });
    },

    applyFilters() {
      const searchTerm = this.search.toLowerCase();
      const universe = this.selectedUniverse;

      this.filteredNodes = this.allNodes.filter(n =>
        (!universe || n.universe === universe) &&
        (!searchTerm || (n.label && n.label.toLowerCase().includes(searchTerm)))
      );

      const nodeIds = new Set(this.filteredNodes.map(n => n.id));

      this.filteredEdges = this.allEdges.filter(e =>
        nodeIds.has(e.from) && nodeIds.has(e.to)
      );

      this.updateNetwork();
      if(this.network) {
        setTimeout(() => this.network.fit({animation: true}), 100);
      }
    },

    updateNetwork() {
      this.nodes.clear();
      this.edges.clear();

      this.nodes.add(this.filteredNodes.map(n => ({
        ...n,
        shape: 'circularImage',
        borderWidth: 2,
        borderWidthSelected: 6,
        color: { border: '#ef4444' }
      })));

      this.edges.add(this.filteredEdges.map(e => ({
        ...e,
        arrows: 'to',
        color: { color: '#888' },
        width: 1.5
      })));
    },

    toggleTheme() {
      this.isDarkMode = !this.isDarkMode;
    }
  }
}
</script>

</body>
</html>
