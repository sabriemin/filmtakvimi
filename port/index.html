<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Marvel Film Ağacı</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #0e0e0e;
      color: #eee;
    }
    svg {
      width: 100vw;
      height: 100vh;
    }
    .node circle.film { fill: #2196f3; }
    .node circle.dizi { fill: #ff4081; }
    .node circle { stroke: #fff; stroke-width: 1.5px; cursor: pointer; }
    .node text { fill: #eee; font-size: 12px; pointer-events: none; }
    .link.devam { stroke: #4caf50; stroke-width: 2; }
    .link.evren-geçişi { stroke: #f44336; stroke-dasharray: 6 3; stroke-width: 2; }
    .link.yan-hikaye { stroke: #ff9800; stroke-dasharray: 2 2; stroke-width: 2; }
    .tooltip {
      position: absolute;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border: 1px solid #ccc;
      pointer-events: none;
      font-size: 13px;
      max-width: 320px;
      z-index: 1000;
    }
    .tooltip img {
      width: 100%;
      margin-top: 5px;
      border-radius: 4px;
    }
    .legend-toggle {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: #222;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 13px;
    }
    .legend {
      position: absolute;
      top: 50px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 13px;
      z-index: 998;
      display: none;
    }
    .legend.show { display: block; }
    .legend div {
      margin-bottom: 5px;
      display: flex;
      align-items: center;
    }
    .legend span {
      display: inline-block;
      width: 16px;
      height: 8px;
      margin-right: 6px;
    }
    .detail-card {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #1e1e1e;
      color: #eee;
      padding: 16px;
      border-radius: 8px;
      width: 320px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      display: none;
      z-index: 1001;
      cursor: move;
    }
    .detail-card img {
      width: 100%;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .detail-card h2 {
      margin: 0 0 5px;
      font-size: 18px;
    }
    .detail-card small {
      color: #bbb;
      font-size: 12px;
    }
    .detail-close {
      position: absolute;
      top: 5px;
      right: 10px;
      cursor: pointer;
      font-size: 20px;
      color: #ccc;
    }
  </style>
</head>
<body>
<div class="tooltip" id="tooltip" style="opacity: 0;"></div>
<div class="detail-card" id="detailCard"><div class="detail-close" onclick="this.parentElement.style.display='none'">×</div></div>
<button class="legend-toggle" onclick="document.querySelector('.legend').classList.toggle('show')">Açıklamalar</button>
<div class="legend">
  <div><span style="background:#4caf50;"></span> Devam</div>
  <div><span style="background:#f44336; border-bottom: 1px dashed #f44336;"></span> Evren Geçişi</div>
  <div><span style="background:#ff9800; border-bottom: 1px dotted #ff9800;"></span> Yan Hikaye</div>
  <div><span style="background:#2196f3; width: 10px; height: 10px; border-radius: 50%;"></span> Film</div>
  <div><span style="background:#ff4081; width: 10px; height: 10px; border-radius: 50%;"></span> Dizi</div>
</div>
<script>
fetch('marvel_tree_detailed.json')
  .then(res => res.json())
  .then(data => {
    const width = window.innerWidth;
    const height = window.innerHeight;

    const svg = d3.select("body")
      .append("svg")
      .call(d3.zoom().on("zoom", (event) => {
        g.attr("transform", event.transform);
      }))
      .append("g")
      .attr("transform", "translate(40,0)");

    const root = d3.hierarchy(data);
    const treeLayout = d3.tree().size([height, width - 160]);
    treeLayout(root);

    const tooltip = d3.select("#tooltip");
    const detailCard = d3.select("#detailCard");

    svg.selectAll('path.link')
      .data(root.links())
      .join('path')
      .attr('class', d => `link ${d.target.data.connection_type}`)
      .attr('fill', 'none')
      .attr('d', d3.linkHorizontal()
        .x(d => d.y)
        .y(d => d.x));

    const node = svg.selectAll('g.node')
      .data(root.descendants())
      .join('g')
      .attr('class', 'node')
      .attr('transform', d => `translate(${d.y},${d.x})`)
      .on("mouseover", (event, d) => {
        const poster = d.data.poster && d.data.poster.startsWith("http") ? d.data.poster : "https://static.wikia.nocookie.net/marvelcinematicuniverse/images/d/d2/Marvel_Studios%27_The_Marvel_Cinematic_Universe-An_Official_Timeline.jpg";
        tooltip.transition().duration(200).style("opacity", 0.95);
        tooltip.html(`
          <strong>${d.data.name}</strong><br/>
          <em>${d.data.release_date} | ${d.data.type}</em><br/>
          <div style="margin-top: 5px;">${(d.data.description || '').slice(0, 200)}...</div>
          <img src="${poster}" alt="poster" /><br/>
          <a href="#" onclick="return false;" style="display:block;margin-top:6px;color:#90caf9;font-size:12px;" data-id="${d.data.id}" class="detail-link">Detay kartını aç</a>
        `).style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 20) + "px");
      })
      .on("mouseout", () => tooltip.transition().duration(300).style("opacity", 0));

    node.append('circle')
      .attr('r', 6)
      .attr('class', d => d.data.type);

    node.append('text')
      .attr('dy', -10)
      .attr('x', d => d.children ? -10 : 10)
      .attr('text-anchor', d => d.children ? 'end' : 'start')
      .text(d => d.data.name);

    document.body.addEventListener('click', function(e) {
      if (e.target.classList.contains('detail-link')) {
        const id = e.target.getAttribute('data-id');
        const match = root.descendants().find(n => n.data.id === id);
        if (match) {
          const d = match.data;
          const poster = d.poster && d.poster.startsWith("http") ? d.poster : "https://static.wikia.nocookie.net/marvelcinematicuniverse/images/d/d2/Marvel_Studios%27_The_Marvel_Cinematic_Universe-An_Official_Timeline.jpg";
          detailCard.html(`
            <div class='detail-close' onclick="this.parentElement.style.display='none'">×</div>
            <img src="${poster}" />
            <h2>${d.name}</h2>
            <small>${d.release_date} | ${d.type}</small>
            <p style="margin-top:10px;">${d.description}</p>
            <p style="margin-top:8px;font-size:13px;color:#ccc;"><strong>Gönderme:</strong><br/>${d.refers_to}</p>
          `);
          detailCard.style("display", "block");
        }
      }
    });

    // Kartı sürüklenebilir hale getir
    const card = document.getElementById("detailCard");
    let isDragging = false, offsetX, offsetY;
    card.addEventListener("mousedown", e => {
      isDragging = true;
      offsetX = e.offsetX;
      offsetY = e.offsetY;
    });
    document.addEventListener("mousemove", e => {
      if (isDragging) {
        card.style.left = e.pageX - offsetX + "px";
        card.style.top = e.pageY - offsetY + "px";
      }
    });
    document.addEventListener("mouseup", () => isDragging = false);
  });
</script>
</body>
</html>